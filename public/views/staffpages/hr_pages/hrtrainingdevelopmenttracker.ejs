<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Training Approval Dashboard</title>
     <link rel="stylesheet" href="/css/hr_trainingdevelopment_tracker.css">
 <link rel="stylesheet" href="/css/sidebar.css"> <!-- Linking Sidebar CSS -->
    <link rel="stylesheet" href="/css/hr_pages.css"> <!-- Linking Main Content CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <%- include('../../partials/hr_partials') %>
    
    <!-- Main content area -->
    <div class="main-content">
        <div class="dashboard-header">
            <h2>HR Training Approval Dashboard</h2>
            <p>Review and approve training requests based on department budgets</p>
        </div>

        <!-- HR APPROVAL SUMMARY CARDS -->
        <div class="approval-summary-cards">
            <div class="approval-summary-card pending">
                <div class="approval-card-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="approval-card-number" id="pendingRequestsCount">0</div>
                <div class="approval-card-label">Pending Requests</div>
                <div class="approval-card-sublabel">Awaiting HR approval</div>
            </div>

            <div class="approval-summary-card budget">
                <div class="approval-card-icon">
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="approval-card-number" id="totalBudgetAmount">â‚±0</div>
                <div class="approval-card-label">Total Budget</div>
                <div class="approval-card-sublabel">All departments</div>
            </div>

            <div class="approval-summary-card approved">
                <div class="approval-card-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="approval-card-number" id="approvedThisMonth">0</div>
                <div class="approval-card-label">Approved This Month</div>
                <div class="approval-card-sublabel">Training requests</div>
            </div>

            <div class="approval-summary-card rejected">
                <div class="approval-card-icon">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="approval-card-number" id="budgetExceeded">0</div>
                <div class="approval-card-label">Budget Exceeded</div>
                <div class="approval-card-sublabel">Departments</div>
            </div>
        </div>

        <!-- TABS CONTAINER -->
        <div class="tabs-container">
            <ul class="tabs-nav">
                <li><button class="tab-button active" data-tab="pending-approvals-tab">
                    <i class="fas fa-tasks"></i> Pending Approvals
                </button></li>
                <li><button class="tab-button" data-tab="budget-management-tab">
                    <i class="fas fa-coins"></i> Budget Management
                </button></li>
                <li><button class="tab-button" data-tab="approved-requests-tab">
                    <i class="fas fa-history"></i> Approval History
                </button></li>
                <li><button class="tab-button" data-tab="training-analytics-tab">
                    <i class="fas fa-chart-line"></i> Training Analytics
                </button></li>

            </ul>

            <!-- Tab Content -->
            <div class="tab-contents">
                <!-- PENDING APPROVALS TAB -->
                <div id="pending-approvals-tab" class="tab-content active">
                    <div class="requests-section">
                        <div class="requests-header">
                            <h3 class="requests-title">Training Requests for Approval</h3>
                            <span class="requests-count" id="pendingCount">0</span>
                        </div>

                        <!-- Search and Filter Section -->
                        <div class="search-filter-section">
                            <div class="search-container">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="search-input" placeholder="Search by employee, training, or department..." id="requestSearch">
                            </div>
                            
                            <select class="form-select" id="departmentFilter">
                                <option value="">All Departments</option>
                                <!-- Will be populated by JavaScript -->
                            </select>
                            
                            <select class="form-select" id="costRangeFilter">
                                <option value="">All Cost Ranges</option>
                                <option value="0-10000">â‚±0 - â‚±10,000</option>
                                <option value="10000-50000">â‚±10,000 - â‚±50,000</option>
                                <option value="50000-100000">â‚±50,000 - â‚±100,000</option>
                                <option value="100000+">â‚±100,000+</option>
                            </select>
                            
                            <button class="btn btn-secondary" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Clear Filters
                            </button>
                        </div>

                        <!-- Training Requests List -->
                        <div id="trainingRequestsList">
                            <!-- Training requests will be populated here -->
                            <div class="loading-state">
                                <i class="fas fa-spinner fa-spin loading-spinner"></i>
                                Loading training requests...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BUDGET MANAGEMENT TAB -->
                <div id="budget-management-tab" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3>Training Budget Overview</h3>
                            <div class="budget-export-section">
                                <button class="export-btn excel" onclick="exportBudgetReport('excel')">
                                    <i class="fas fa-file-excel"></i> Export Excel
                                </button>
                                <button class="export-btn pdf" onclick="exportBudgetReport('pdf')">
                                    <i class="fas fa-file-pdf"></i> Export PDF
                                </button>
                                <button class="btn btn-primary" onclick="refreshBudgetData()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>

                        <!-- Budget Summary Cards -->
                        <div class="budget-overview-grid" id="budgetOverviewGrid">
                            <!-- Loading state -->
                            <div class="loading-state" style="grid-column: 1 / -1;">
                                <i class="fas fa-spinner fa-spin loading-spinner"></i>
                                Loading budget overview...
                            </div>
                        </div>

                        <!-- Training Efficiency Analysis -->
                        <div class="training-efficiency-section" style="margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0; color: #1f2937; font-size: 18px;">
                                    <i class="fas fa-chart-bar" style="color: #8b5cf6; margin-right: 8px;"></i>
                                    Training Efficiency Analysis
                                </h4>
                                <div class="efficiency-controls" style="display: flex; gap: 10px; align-items: center;">
                                    <select id="efficiencyTimeFilter" onchange="updateEfficiencyAnalysis()" style="padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;">
                                        <option value="thisYear">This Year</option>
                                        <option value="lastYear">Last Year</option>
                                        <option value="last6Months">Last 6 Months</option>
                                        <option value="last3Months">Last 3 Months</option>
                                    </select>
                                    <button class="btn btn-secondary" onclick="refreshEfficiencyData()" style="padding: 6px 12px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                            </div>

                            <!-- Efficiency Overview Cards -->
                            <div class="efficiency-overview-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div class="efficiency-card best" style="background: #f0fdf4; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #bbf7d0;">
                                    <div style="font-size: 16px; font-weight: 700; color: #059669;" id="bestEfficiencyScore">0.0</div>
                                    <div style="font-size: 11px; color: #064e3b; margin-bottom: 3px;">Best Efficiency Score</div>
                                    <div style="font-size: 10px; color: #16a34a;" id="bestEfficiencyDept">-</div>
                                </div>
                                <div class="efficiency-card average" style="background: #fffbeb; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #fed7aa;">
                                    <div style="font-size: 16px; font-weight: 700; color: #d97706;" id="avgEfficiencyScore">0.0</div>
                                    <div style="font-size: 11px; color: #92400e; margin-bottom: 3px;">Average Efficiency</div>
                                    <div style="font-size: 10px; color: #d97706;">Organization-wide</div>
                                </div>
                                <div class="efficiency-card lowest" style="background: #fef2f2; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #fecaca;">
                                    <div style="font-size: 16px; font-weight: 700; color: #dc2626;" id="lowestEfficiencyScore">0.0</div>
                                    <div style="font-size: 11px; color: #991b1b; margin-bottom: 3px;">Needs Improvement</div>
                                    <div style="font-size: 10px; color: #dc2626;" id="lowestEfficiencyDept">-</div>
                                </div>
                                <div class="efficiency-card cost" style="background: #f0f9ff; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #bfdbfe;">
                                    <div style="font-size: 16px; font-weight: 700; color: #2563eb;" id="avgCostPerTraining">â‚±0</div>
                                    <div style="font-size: 11px; color: #1e3a8a; margin-bottom: 3px;">Avg Cost Per Training</div>
                                    <div style="font-size: 10px; color: #2563eb;">Across all departments</div>
                                </div>
                            </div>

                            <!-- Department Efficiency Table -->
                            <div id="departmentEfficiencyTable" style="overflow-x: auto;">
                                <!-- Efficiency table will be populated here -->
                                <div class="loading-state" style="text-align: center; padding: 40px 20px; color: #64748b;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                    <p style="margin: 0;">Loading efficiency analysis...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Filters Section -->
                        <div class="budget-filters-section">
                            <div class="budget-filter-group">
                                <label class="budget-filter-label">Status Filter:</label>
                                <select class="budget-filter-select" id="statusFilter" onchange="filterDepartments()">
                                    <option value="">All Departments</option>
                                    <option value="good">Good (< 75%)</option>
                                    <option value="warning">Warning (75-90%)</option>
                                    <option value="critical">Critical (> 90%)</option>
                                </select>
                            </div>

                            <div class="budget-filter-group">
                                <label class="budget-filter-label">Budget Range:</label>
                                <select class="budget-filter-select" id="budgetRangeFilter" onchange="filterDepartments()">
                                    <option value="">All Ranges</option>
                                    <option value="0-50000">â‚±0 - â‚±50,000</option>
                                    <option value="50000-100000">â‚±50,000 - â‚±100,000</option>
                                    <option value="100000-500000">â‚±100,000 - â‚±500,000</option>
                                    <option value="500000+">â‚±500,000+</option>
                                </select>
                            </div>

                            <div class="budget-filter-group" style="flex: 1;">
                                <label class="budget-filter-label">Search Department:</label>
                                <input type="text" class="budget-search-input" id="departmentSearch" 
                                    placeholder="Search by department name..." onkeyup="filterDepartments()">
                            </div>

                            <button class="btn btn-secondary" onclick="clearAllFilters()">
                                <i class="fas fa-times"></i> Clear Filters
                            </button>
                        </div>

                        <!-- Department Budget Table -->
                        <div class="department-budget-table" id="departmentBudgetTable">
                            <!-- Loading state -->
                            <div class="loading-state" style="padding: 40px; text-align: center;">
                                <i class="fas fa-spinner fa-spin loading-spinner"></i>
                                Loading department budget data...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- APPROVAL HISTORY TAB -->
                <div id="approved-requests-tab" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3>Training Approval History</h3>
                            <button class="btn btn-primary" onclick="refreshApprovalHistory()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>

                        <!-- Date Range Filter -->
                        <div class="search-filter-section">
                            <div class="date-range-container">
                                <label>From:</label>
                                <input type="date" class="form-input" id="historyStartDate">
                                <label>To:</label>
                                <input type="date" class="form-input" id="historyEndDate">
                            </div>
                            
                            <select class="form-select" id="historyStatusFilter">
                                <option value="">All Statuses</option>
                                <option value="In Progress">Approved</option>
                                <option value="Cancelled">Rejected</option>
                            </select>
                            
                            <button class="btn btn-primary" onclick="applyHistoryFilters()">
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                        </div>

                        <!-- Approval History List -->
                        <div id="approvalHistoryList">
                            <!-- History items will be populated here -->
                            <div class="loading-state">
                                <i class="fas fa-spinner fa-spin loading-spinner"></i>
                                Loading approval history...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="training-analytics-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3>Training Analytics & Effectiveness</h3>
                    <div class="analytics-export-section">
                        <button class="export-btn excel" onclick="exportAnalyticsReport('excel')">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                        <button class="export-btn pdf" onclick="exportAnalyticsReport('pdf')">
                            <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                        <button class="btn btn-primary" onclick="refreshAnalyticsData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Analytics Summary Cards -->
                <div class="analytics-summary-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
                    <div class="analytics-summary-card needs-vs-completed" style="background: #f0f9ff; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #bfdbfe;">
                        <div class="analytics-summary-icon" style="font-size: 24px; color: #3b82f6; margin-bottom: 10px;">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <div class="analytics-summary-number" id="trainingCompletionRate" style="font-size: 28px; font-weight: 700; color: #1f2937; margin-bottom: 5px;">0%</div>
                        <div class="analytics-summary-label" style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 3px;">Training Completion Rate</div>
                        <div class="analytics-summary-sublabel" style="font-size: 12px; color: #64748b;">Completed vs Required</div>
                    </div>

                    <div class="analytics-summary-card performance-trend" style="background: #f0fdf4; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #bbf7d0;">
                        <div class="analytics-summary-icon" style="font-size: 24px; color: #059669; margin-bottom: 10px;">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="analytics-summary-number" id="performanceImprovement" style="font-size: 28px; font-weight: 700; color: #1f2937; margin-bottom: 5px;">0%</div>
                        <div class="analytics-summary-label" style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 3px;">Performance Improvement</div>
                        <div class="analytics-summary-sublabel" style="font-size: 12px; color: #64748b;">After training completion</div>
                    </div>

                    <div class="analytics-summary-card training-effectiveness" style="background: #fffbeb; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #fed7aa;">
                        <div class="analytics-summary-icon" style="font-size: 24px; color: #d97706; margin-bottom: 10px;">
                            <i class="fas fa-award"></i>
                        </div>
                        <div class="analytics-summary-number" id="trainingEffectiveness" style="font-size: 28px; font-weight: 700; color: #1f2937; margin-bottom: 5px;">0%</div>
                        <div class="analytics-summary-label" style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 3px;">Training Effectiveness</div>
                        <div class="analytics-summary-sublabel" style="font-size: 12px; color: #64748b;">Average success rate</div>
                    </div>

                    <div class="analytics-summary-card total-trainings" style="background: #fef2f2; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #fecaca;">
                        <div class="analytics-summary-icon" style="font-size: 24px; color: #dc2626; margin-bottom: 10px;">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="analytics-summary-number" id="totalTrainingsCompleted" style="font-size: 28px; font-weight: 700; color: #1f2937; margin-bottom: 5px;">0</div>
                        <div class="analytics-summary-label" style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 3px;">Total Trainings</div>
                        <div class="analytics-summary-sublabel" style="font-size: 12px; color: #64748b;">Completed this year</div>
                    </div>
                </div>

                <!-- Analytics Filters -->
                <div class="analytics-filters-section" style="display: flex; gap: 15px; align-items: center; margin: 20px 0; padding: 15px; background: #f8fafc; border-radius: 8px;">
                    <div class="analytics-filter-group">
                        <label class="analytics-filter-label" style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 5px; display: block;">Department:</label>
                        <select class="analytics-filter-select" id="analyticsDepFilter" onchange="applyAnalyticsFilters()" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;">
                            <option value="">All Departments</option>
                        </select>
                    </div>

                    <div class="analytics-filter-group">
                        <label class="analytics-filter-label" style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 5px; display: block;">Category:</label>
                        <select class="analytics-filter-select" id="analyticsCategoryFilter" onchange="applyAnalyticsFilters()" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;">
                            <option value="">All Categories</option>
                        </select>
                    </div>

                    <div class="analytics-filter-group">
                        <label class="analytics-filter-label" style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 5px; display: block;">Time Period:</label>
                        <select class="analytics-filter-select" id="analyticsTimeFilter" onchange="applyAnalyticsFilters()" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px;">
                            <option value="thisYear">This Year</option>
                            <option value="lastYear">Last Year</option>
                            <option value="last6Months">Last 6 Months</option>
                            <option value="last3Months">Last 3 Months</option>
                        </select>
                    </div>

                    <button class="btn btn-secondary" onclick="clearAnalyticsFilters()" style="padding: 8px 12px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>

                <!-- Main Analytics Content -->
                <div class="analytics-main-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    
                    <!-- Training Needs vs Completion Analysis -->
                    <div class="analytics-panel" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 15px 0; color: #1f2937; font-size: 18px;">
                            <i class="fas fa-balance-scale" style="color: #3b82f6; margin-right: 8px;"></i>
                            Training Needs vs Completion
                        </h4>
                        <div id="needsVsCompletionChart" style="min-height: 300px;">
                            <!-- Chart will be populated here -->
                            <div class="loading-analytics" style="text-align: center; padding: 60px 20px; color: #64748b;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                <p style="margin: 0;">Loading needs analysis...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Improvement Trending -->
                    <div class="analytics-panel" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 15px 0; color: #1f2937; font-size: 18px;">
                            <i class="fas fa-chart-line" style="color: #059669; margin-right: 8px;"></i>
                            Performance Improvement Trend
                        </h4>
                        <div id="performanceTrendChart" style="min-height: 300px;">
                            <!-- Chart will be populated here -->
                            <div class="loading-analytics" style="text-align: center; padding: 60px 20px; color: #64748b;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                <p style="margin: 0;">Loading performance trends...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Training Effectiveness Analysis -->
                    <div class="analytics-panel" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 15px 0; color: #1f2937; font-size: 18px;">
                            <i class="fas fa-award" style="color: #d97706; margin-right: 8px;"></i>
                            Training Effectiveness by Category
                        </h4>
                        <div id="effectivenessChart" style="min-height: 300px;">
                            <!-- Chart will be populated here -->
                            <div class="loading-analytics" style="text-align: center; padding: 60px 20px; color: #64748b;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                <p style="margin: 0;">Loading effectiveness data...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Training Category Distribution -->
                    <div class="analytics-panel" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 15px 0; color: #1f2937; font-size: 18px;">
                            <i class="fas fa-pie-chart" style="color: #dc2626; margin-right: 8px;"></i>
                            Training Distribution by Category
                        </h4>
                        <div id="categoryDistributionChart" style="min-height: 300px;">
                            <!-- Chart will be populated here -->
                            <div class="loading-analytics" style="text-align: center; padding: 60px 20px; color: #64748b;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                <p style="margin: 0;">Loading category data...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Department Training Gap Analysis Table -->
                <div class="analytics-panel" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-top: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #1f2937; font-size: 18px;">
                        <i class="fas fa-table" style="color: #8b5cf6; margin-right: 8px;"></i>
                        Department Training Gap Analysis
                    </h4>
                    <div id="trainingGapTable" style="overflow-x: auto;">
                        <!-- Table will be populated here -->
                        <div class="loading-analytics" style="text-align: center; padding: 40px 20px; color: #64748b;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <p style="margin: 0;">Loading gap analysis...</p>
                        </div>
                    </div>
                </div>

                <!-- Budget Impact Analysis -->
                <div class="analytics-panel" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-top: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #1f2937; font-size: 18px;">
                        <i class="fas fa-dollar-sign" style="color: #10b981; margin-right: 8px;"></i>
                        Budget Allocation Recommendations
                    </h4>
                    <div id="budgetRecommendations" style="min-height: 200px;">
                        <!-- Recommendations will be populated here -->
                        <div class="loading-analytics" style="text-align: center; padding: 40px 20px; color: #64748b;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <p style="margin: 0;">Loading budget recommendations...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- APPROVAL MODAL -->
        <div class="approval-modal" id="approvalModal">
            <div class="approval-modal-content">
                <div class="approval-modal-header">
                    <h3 class="approval-modal-title" id="approvalModalTitle">Review Training Request</h3>
                    <button type="button" class="close-btn" onclick="closeApprovalModal()">&times;</button>
                </div>
                
                <div id="approvalModalBody">
                    <!-- Request details will be populated here -->
                </div>

                <form id="approvalForm">
                    <input type="hidden" id="requestId" name="requestId">
                    
                    <div class="approval-form-group">
                        <label class="approval-form-label">HR Decision:</label>
                        <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="decision" value="approved" required>
                                <span style="color: #10b981; font-weight: 600;">Approve</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="decision" value="rejected" required>
                                <span style="color: #ef4444; font-weight: 600;">Reject</span>
                            </label>
                        </div>
                    </div>

                    <div class="approval-form-group">
                        <label class="approval-form-label" for="hrRemarks">HR Remarks:</label>
                        <textarea class="approval-form-textarea" id="hrRemarks" name="remarks" 
                                placeholder="Enter your remarks or reason for the decision..." required></textarea>
                    </div>

                    <div class="approval-modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeApprovalModal()">Cancel</button>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-check"></i> Submit Decision
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Department Details Modal -->
        <div class="modal-overlay" id="departmentDetailsModal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h2 class="modal-title">Department Budget Details</h2>
                    <button type="button" class="close-modal-btn" onclick="closeDepartmentDetailsModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div style="max-height: 70vh; overflow-y: auto;">
                    <!-- Department Overview -->
                    <div class="dept-details-section">
                        <h4>Department Overview</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <p><strong>Department:</strong> <span id="modalDeptName">-</span></p>
                                <p><strong>Department ID:</strong> <span id="modalDeptId">-</span></p>
                                <p><strong>Fiscal Year:</strong> <span id="modalFiscalYear">-</span></p>
                                <p><strong>Employee Count:</strong> <span id="modalEmployeeCount">-</span></p>
                            </div>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                                <h5 style="margin-bottom: 15px; color: #334155;">Budget Summary</h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div style="text-align: center; padding: 10px; background: white; border-radius: 6px;">
                                        <div style="font-size: 18px; font-weight: 600; color: #3b82f6;" id="modalTotalBudget">â‚±0</div>
                                        <div style="font-size: 11px; color: #64748b;">Total Budget</div>
                                    </div>
                                    <div style="text-align: center; padding: 10px; background: white; border-radius: 6px;">
                                        <div style="font-size: 18px; font-weight: 600; color: #dc2626;" id="modalTotalSpent">â‚±0</div>
                                        <div style="font-size: 11px; color: #64748b;">Total Spent</div>
                                    </div>
                                    <div style="text-align: center; padding: 10px; background: white; border-radius: 6px;">
                                        <div style="font-size: 18px; font-weight: 600; color: #10b981;" id="modalRemaining">â‚±0</div>
                                        <div style="font-size: 11px; color: #64748b;">Remaining</div>
                                    </div>
                                    <div style="text-align: center; padding: 10px; background: white; border-radius: 6px;">
                                        <div style="font-size: 18px; font-weight: 600; color: #8b5cf6;" id="modalUtilization">0%</div>
                                        <div style="font-size: 11px; color: #64748b;">Utilization</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Training Requests -->
                    <div class="dept-details-section">
                        <h4>Recent Training Requests</h4>
                        <div class="recent-trainings-list" id="recentTrainingsList">
                            <!-- Training items will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Budget Utilization Chart -->
                    <div class="dept-details-section">
                        <h4>Budget Utilization</h4>
                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px;">
                            <div class="budget-progress-container" style="max-width: 100%; height: 20px; margin-bottom: 10px;">
                                <div class="budget-progress-bar" id="modalProgressBar" style="width: 0%;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #64748b;">
                                <span>â‚±0</span>
                                <span id="modalProgressText">0% Used</span>
                                <span id="modalBudgetLimit">â‚±0</span>
                            </div>
                            
                            <!-- Status and Recommendations -->
                            <div style="margin-top: 15px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span>Status:</span>
                                    <span class="budget-status-badge" id="modalStatusBadge">Good</span>
                                </div>
                                <div style="margin-top: 10px;">
                                    <strong>Recommendations:</strong>
                                    <ul id="modalRecommendations" style="margin: 5px 0 0 20px; font-size: 14px; color: #64748b;">
                                        <!-- Recommendations will be populated by JavaScript -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeDepartmentDetailsModal()">Close</button>
                    <button type="button" class="btn-primary" onclick="editDepartmentBudget()">
                        <i class="fas fa-edit"></i> Edit Budget
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Budget Modal -->
        <div class="modal-overlay" id="editBudgetModal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2 class="modal-title">Edit Department Budget</h2>
                    <button type="button" class="close-modal-btn" onclick="closeEditBudgetModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="editBudgetForm">
                    <div class="form-group">
                        <label class="form-label">Department:</label>
                        <input type="text" class="form-input" id="editDeptName" readonly>
                        <input type="hidden" id="editDeptId">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Budget Amount (PHP):</label>
                        <input type="number" class="form-input" id="editBudgetAmount" 
                            placeholder="Enter budget amount" min="0" step="1000" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Fiscal Year:</label>
                        <select class="form-select" id="editFiscalYear" required>
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notes (Optional):</label>
                        <textarea class="form-textarea" id="editBudgetNotes" 
                                placeholder="Add any notes about this budget allocation..." rows="3"></textarea>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeEditBudgetModal()">Cancel</button>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save"></i> Save Budget
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>

        // Global variables
        let pendingRequests = [];
        let budgetData = null;
        let filteredDepartments = [];
        let currentSelectedDepartment = null;
        let approvalHistory = [];
        let filteredRequests = [];
        let analyticsData = null;
        let filteredAnalyticsData = null;

        // ============================================================================
        // INITIALIZATION - Main entry point
        // ============================================================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ HR Training Approval Dashboard initializing...');
            
            try {
                // Initialize core components in order
                initializeTabs();
                initializeModals();
                initializeFormHandlers();
                
                // Load initial data
                loadPendingRequests();
                
                // Set up tab-specific event listeners
                setupTabEventListeners();
                
                console.log('âœ… HR Training Approval Dashboard initialized successfully');
            } catch (error) {
                console.error('âŒ Error during initialization:', error);
                showNotification('Error initializing dashboard: ' + error.message, 'error');
            }
        });

        // ============================================================================
        // TAB FUNCTIONALITY
        // ============================================================================
        function initializeTabs() {
            console.log('ðŸ”§ Initializing tab functionality...');
            
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            if (tabButtons.length === 0) {
                console.warn('âš ï¸ No tab buttons found');
                return;
            }

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    console.log('ðŸ“± Tab clicked:', button.getAttribute('data-tab'));
                    
                    // Remove active class from all buttons and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked button
                    button.classList.add('active');
                    
                    // Show corresponding content
                    const tabId = button.getAttribute('data-tab');
                    const targetTab = document.getElementById(tabId);
                    if (targetTab) {
                        targetTab.classList.add('active');
                        console.log('âœ… Tab activated:', tabId);
                    } else {
                        console.error('âŒ Tab content not found:', tabId);
                    }
                });
            });
            
            console.log('âœ… Tab functionality initialized');
        }

        function setupTabEventListeners() {
            console.log('ðŸ”§ Setting up tab-specific event listeners...');
            
            // Budget Management Tab - Load budget data when clicked
            const budgetTab = document.querySelector('[data-tab="budget-management-tab"]');
            if (budgetTab) {
                budgetTab.addEventListener('click', function() {
                    console.log('ðŸ¢ Budget tab clicked - loading budget data...');
                    setTimeout(() => {
                        loadBudgetData();
                        loadEfficiencyData();
                    }, 100); // Small delay to ensure tab is active
                });
                console.log('âœ… Budget tab listener added');
            } else {
                console.warn('âš ï¸ Budget tab button not found');
            }

            // Approval History Tab - Load history when clicked
            const historyTab = document.querySelector('[data-tab="approved-requests-tab"]');
            if (historyTab) {
                historyTab.addEventListener('click', function() {
                    console.log('ðŸ“‹ History tab clicked - loading approval history...');
                    setTimeout(() => {
                        loadApprovalHistory();
                        initializeHistoryFilters();
                    }, 100); // Small delay to ensure tab is active
                });
                console.log('âœ… History tab listener added');
            } else {
                console.warn('âš ï¸ History tab button not found');
            }

            const analyticsTab = document.querySelector('[data-tab="training-analytics-tab"]');
            if (analyticsTab) {
                analyticsTab.addEventListener('click', function() {
                    console.log('ðŸ“Š Analytics tab clicked - loading analytics data...');
                    setTimeout(() => {
                        loadTrainingAnalyticsData();
                    }, 100); // Small delay to ensure tab is active
                });
                console.log('âœ… Analytics tab listener added');
            } else {
                console.warn('âš ï¸ Analytics tab button not found');
            }
            
            console.log('âœ… Tab-specific event listeners setup complete');
        }

        // ============================================================================
        // MODAL FUNCTIONALITY
        // ============================================================================
        function initializeModals() {
            console.log('ðŸ”§ Initializing modal functionality...');
            
            // Close modals when clicking outside
            document.addEventListener('click', function(event) {
                const modals = document.querySelectorAll('.modal-overlay, .approval-modal');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        console.log('ðŸ“± Modal overlay clicked - closing modal');
                        modal.classList.remove('show');
                    }
                });
            });

            // Prevent modal close when clicking inside modal content
            document.querySelectorAll('.modal-content, .approval-modal-content').forEach(content => {
                content.addEventListener('click', function(event) {
                    event.stopPropagation(); // Prevent closing when clicking inside modal
                });
            });
            
            console.log('âœ… Modal functionality initialized');
        }

        // ============================================================================
        // FORM HANDLERS INITIALIZATION
        // ============================================================================
        function initializeFormHandlers() {
            console.log('ðŸ”§ Initializing form handlers...');
            
            // Approval form submission
            const approvalForm = document.getElementById('approvalForm');
            if (approvalForm) {
                approvalForm.addEventListener('submit', handleApprovalSubmission);
                console.log('âœ… Approval form handler added');
            } else {
                console.warn('âš ï¸ Approval form not found');
            }

            // Search and filter handlers for pending requests
            const requestSearch = document.getElementById('requestSearch');
            if (requestSearch) {
                requestSearch.addEventListener('input', debounce(filterRequests, 300));
                console.log('âœ… Request search handler added');
            } else {
                console.warn('âš ï¸ Request search input not found');
            }

            const departmentFilter = document.getElementById('departmentFilter');
            if (departmentFilter) {
                departmentFilter.addEventListener('change', filterRequests);
                console.log('âœ… Department filter handler added');
            } else {
                console.warn('âš ï¸ Department filter not found');
            }

            const costRangeFilter = document.getElementById('costRangeFilter');
            if (costRangeFilter) {
                costRangeFilter.addEventListener('change', filterRequests);
                console.log('âœ… Cost range filter handler added');
            } else {
                console.warn('âš ï¸ Cost range filter not found');
            }

            // Budget form handler
            const editBudgetForm = document.getElementById('editBudgetForm');
            if (editBudgetForm) {
                editBudgetForm.addEventListener('submit', handleEditBudgetSubmit);
                console.log('âœ… Budget edit form handler added');
            } else {
                console.warn('âš ï¸ Budget edit form not found');
            }
            
            console.log('âœ… Form handlers initialization complete');
        }

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================

        // Debounce function to limit API calls during typing
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Show notification to user
        function showNotification(message, type = 'info') {
            console.log('ðŸ“¢ Notification:', type, message);
            
            // Remove any existing notifications
            const existingNotification = document.querySelector('.hr-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = 'hr-notification';
            
            // Set background color based on type
            const colors = {
                info: '#3b82f6',
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b'
            };
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: ${colors[type] || colors.info};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 500;
                max-width: 400px;
                animation: slideIn 0.3s ease;
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, 5000);
        }

        // ============================================================================
        // HR TRAINING APPROVAL DASHBOARD - PHASE 2: PENDING REQUESTS MANAGEMENT
        // Replace the placeholder functions from Phase 1 with actual implementations
        // ============================================================================

        // ============================================================================
        // REPLACE: loadPendingRequests() - ACTUAL IMPLEMENTATION
        // ============================================================================
        async function loadPendingRequests() {
            try {
                console.log('ðŸ”„ Loading pending training requests...');
                
                // Show loading state immediately
                showPendingRequestsLoading();
                
                // Fetch pending requests from API
                const response = await fetch('/hr/pending-training-requests', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                // Check if request was successful
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    // Store the data globally
                    pendingRequests = result.data || [];
                    filteredRequests = [...pendingRequests]; // Copy for filtering
                    
                    console.log(`âœ… Loaded ${pendingRequests.length} pending requests`);
                    
                    // Render all the components
                    renderPendingRequests();
                    updateSummaryCards();
                    populateDepartmentFilter();
                    
                    // Show success notification
                    showNotification(`Loaded ${pendingRequests.length} pending requests`, 'success');
                    
                } else {
                    throw new Error(result.message || 'Failed to load pending requests');
                }
                
            } catch (error) {
                console.error('âŒ Error loading pending requests:', error);
                showPendingRequestsError(error.message);
                showNotification('Failed to load pending requests: ' + error.message, 'error');
            }
        }

        // ============================================================================
        // NEW FUNCTION: showPendingRequestsLoading()
        // ============================================================================
        function showPendingRequestsLoading() {
            console.log('ðŸ”„ Showing loading state for pending requests...');
            
            const requestsList = document.getElementById('trainingRequestsList');
            if (requestsList) {
                requestsList.innerHTML = `
                    <div class="loading-state" style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin loading-spinner" style="font-size: 32px; color: #3b82f6; margin-bottom: 15px;"></i>
                        <h3 style="margin: 0 0 10px 0; color: #475569;">Loading Training Requests</h3>
                        <p style="margin: 0; color: #64748b;">Fetching pending requests for HR approval...</p>
                    </div>
                `;
            } else {
                console.warn('âš ï¸ Training requests list element not found');
            }
            
            // Also update summary cards with loading state
            updateSummaryCardsLoading();
        }

        // ============================================================================
        // NEW FUNCTION: showPendingRequestsError()
        // ============================================================================
        function showPendingRequestsError(message) {
            console.log('âŒ Showing error state for pending requests...');
            
            const requestsList = document.getElementById('trainingRequestsList');
            if (requestsList) {
                requestsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px; color: #ef4444;"></i>
                        <h3 style="margin: 0 0 10px 0; color: #475569;">Failed to Load Requests</h3>
                        <p style="margin: 0 0 15px 0;">Error: ${message}</p>
                        <button onclick="loadPendingRequests()" class="btn btn-primary" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            <i class="fas fa-retry"></i> Try Again
                        </button>
                    </div>
                `;
            }
        }

        // ============================================================================
        // NEW FUNCTION: renderPendingRequests()
        // ============================================================================
        function renderPendingRequests() {
            console.log(`ðŸŽ¨ Rendering ${filteredRequests.length} pending requests...`);
            
            const requestsList = document.getElementById('trainingRequestsList');
            const pendingCount = document.getElementById('pendingCount');
            
            // Update the count display
            if (pendingCount) {
                pendingCount.textContent = filteredRequests.length;
            }
            
            // Handle empty state
            if (filteredRequests.length === 0) {
                requestsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 15px; color: #10b981;"></i>
                        <h3 style="margin: 0 0 10px 0; color: #475569;">No Pending Requests</h3>
                        <p style="margin: 0;">
                            ${pendingRequests.length === 0 ? 
                                'All training requests have been reviewed.' : 
                                'No requests match your current filters.'}
                        </p>
                    </div>
                `;
                return;
            }
            
            // Generate HTML for each request
            const requestsHtml = filteredRequests.map(request => {
                const budgetStatusClass = request.budgetSufficient ? 'sufficient' : 'insufficient';
                const budgetStatusText = request.budgetSufficient ? 'Budget Available' : 'Exceeds Budget';
                
                return `
                    <div class="training-request-item" data-request-id="${request.requestId}">
                        <div class="request-header">
                            <div class="request-info">
                                <h4>${request.employeeName}</h4>
                                <div class="request-meta">
                                    ${request.department} â€¢ ${request.jobTitle}<br>
                                    Training: <strong>${request.trainingName}</strong><br>
                                    Requested: ${new Date(request.requestDate).toLocaleDateString()}<br>
                                    ${request.isOnlineArrangement ? 
                                        '<span style="color: #07ACB9;"><i class="fas fa-laptop"></i> Online Training</span>' : 
                                        `<span style="color: #f59e0b;"><i class="fas fa-map-marker-alt"></i> Onsite: ${request.country}</span>`
                                    }
                                </div>
                            </div>
                            <div class="request-actions">
                                <button class="view-details-btn" onclick="showRequestDetails('${request.requestId}')" 
                                        style="padding: 8px 12px; margin: 0 5px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-eye"></i> Details
                                </button>
                                <button class="approve-btn" onclick="openApprovalModal('${request.requestId}', 'approved')" 
                                        style="padding: 8px 12px; margin: 0 5px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; ${!request.budgetSufficient ? 'opacity: 0.6;' : ''}" 
                                        ${!request.budgetSufficient ? 'title="Budget insufficient"' : ''}>
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="reject-btn" onclick="openApprovalModal('${request.requestId}', 'rejected')"
                                        style="padding: 8px 12px; margin: 0 5px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            </div>
                        </div>
                        
                        <div class="request-details">
                            <div>
                                <div class="request-cost" style="font-size: 20px; font-weight: 600; color: #1f2937;">â‚±${request.cost.toLocaleString()}</div>
                                <div style="font-size: 12px; color: #64748b;">Cost</div>
                                ${request.duration ? `<div style="font-size: 12px; margin-top: 5px; color: #64748b;">${request.duration} hours</div>` : ''}
                            </div>
                            
                            <div style="flex: 1; margin: 0 15px;">
                                <div style="font-size: 14px; margin-bottom: 5px; font-weight: 600;">Line Manager Endorsement:</div>
                                <div style="font-size: 13px; color: #64748b; font-style: italic; max-height: 40px; overflow: hidden; line-height: 1.4;">
                                    "${request.lineManagerRemarks || 'No specific remarks provided by line manager'}"
                                </div>
                            </div>
                            
                            <div>
                                <div style="font-size: 14px; margin-bottom: 5px; font-weight: 600;">Budget Status:</div>
                                <div class="budget-status ${budgetStatusClass}" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; 
                                    background-color: ${request.budgetSufficient ? '#dcfce7' : '#fef2f2'}; 
                                    color: ${request.budgetSufficient ? '#166534' : '#dc2626'};">
                                    ${budgetStatusText}
                                </div>
                                ${!request.budgetSufficient ? `
                                    <div style="font-size: 11px; color: #dc2626; margin-top: 2px;">
                                        Available: â‚±${request.availableBudget.toLocaleString()}
                                    </div>
                                    <div style="font-size: 11px; color: #dc2626;">
                                        Shortage: â‚±${(request.cost - request.availableBudget).toLocaleString()}
                                    </div>
                                ` : `
                                    <div style="font-size: 11px; color: #10b981; margin-top: 2px;">
                                        Available: â‚±${request.availableBudget.toLocaleString()}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Set the HTML
            requestsList.innerHTML = requestsHtml;
            
            console.log('âœ… Pending requests rendered successfully');
        }

        // ============================================================================
        // NEW FUNCTION: updateSummaryCards()
        // ============================================================================
        function updateSummaryCards() {
            console.log('ðŸ“Š Updating summary cards...');
            
            if (pendingRequests.length === 0) {
                console.log('ðŸ“Š No data available for summary cards');
                return;
            }
            
            // Calculate summary metrics
            const pendingCount = pendingRequests.length;
            const totalRequestedCost = pendingRequests.reduce((sum, req) => sum + req.cost, 0);
            const budgetExceededCount = pendingRequests.filter(req => !req.budgetSufficient).length;
            
            // Update each summary card
            const pendingCountEl = document.getElementById('pendingRequestsCount');
            if (pendingCountEl) {
                pendingCountEl.textContent = pendingCount;
            }
            
            const totalBudgetEl = document.getElementById('totalBudgetAmount');
            if (totalBudgetEl) {
                totalBudgetEl.textContent = `â‚±${totalRequestedCost.toLocaleString()}`;
            }
            
            const budgetExceededEl = document.getElementById('budgetExceeded');
            if (budgetExceededEl) {
                budgetExceededEl.textContent = budgetExceededCount;
            }
            
            // Note: Approved this month would need to be fetched from backend
            // For now, we'll leave it as is or could be calculated from approval history
            const approvedThisMonthEl = document.getElementById('approvedThisMonth');
            if (approvedThisMonthEl && approvedThisMonthEl.textContent === '0') {
                // Only update if it's still the default value
                approvedThisMonthEl.textContent = '-'; // Placeholder until we have real data
            }
            
            console.log(`âœ… Summary cards updated - ${pendingCount} pending, â‚±${totalRequestedCost.toLocaleString()} total cost, ${budgetExceededCount} over budget`);
        }

        // ============================================================================
        // NEW FUNCTION: updateSummaryCardsLoading()
        // ============================================================================
        function updateSummaryCardsLoading() {
            console.log('ðŸ”„ Setting summary cards to loading state...');
            
            const loadingText = '...';
            
            const pendingCountEl = document.getElementById('pendingRequestsCount');
            if (pendingCountEl) pendingCountEl.textContent = loadingText;
            
            const totalBudgetEl = document.getElementById('totalBudgetAmount');
            if (totalBudgetEl) totalBudgetEl.textContent = loadingText;
            
            const budgetExceededEl = document.getElementById('budgetExceeded');
            if (budgetExceededEl) budgetExceededEl.textContent = loadingText;
        }

        // ============================================================================
        // NEW FUNCTION: populateDepartmentFilter()
        // ============================================================================
        function populateDepartmentFilter() {
            console.log('ðŸ¢ Populating department filter...');
            
            const departmentFilter = document.getElementById('departmentFilter');
            if (!departmentFilter) {
                console.warn('âš ï¸ Department filter element not found');
                return;
            }
            
            // Extract unique departments from pending requests
            const departments = [...new Set(pendingRequests.map(req => req.department))]
                .filter(dept => dept) // Remove any null/undefined departments
                .sort(); // Sort alphabetically
            
            console.log(`ðŸ“‹ Found ${departments.length} unique departments:`, departments);
            
            // Clear existing options and add "All Departments"
            departmentFilter.innerHTML = '<option value="">All Departments</option>';
            
            // Add each department as an option
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentFilter.appendChild(option);
            });
            
            console.log('âœ… Department filter populated');
        }

        // ============================================================================
        // NEW FUNCTION: refreshPendingRequests()
        // ============================================================================
        function refreshPendingRequests() {
            console.log('ðŸ”„ Refreshing pending requests...');
            showNotification('Refreshing pending requests...', 'info');
            loadPendingRequests();
        }

        // ============================================================================
        // REPLACE: openApprovalModal() - ACTUAL IMPLEMENTATION
        // ============================================================================
        function openApprovalModal(requestId, defaultDecision = null) {
            const request = pendingRequests.find(r => r.requestId == requestId);
            if (!request) {
                console.error('âŒ Request not found:', requestId);
                showNotification('Request not found', 'error');
                return;
            }
            
            console.log('ðŸ” Opening approval modal for request:', requestId);
            
            // Set the request ID in the hidden input
            const requestIdInput = document.getElementById('requestId');
            if (requestIdInput) {
                requestIdInput.value = requestId;
            }
            
            // Populate modal with request details
            const modalBody = document.getElementById('approvalModalBody');
            if (modalBody) {
                modalBody.innerHTML = generateApprovalModalContent(request);
            }
            
            // Set default decision if provided
            if (defaultDecision) {
                const radio = document.querySelector(`input[name="decision"][value="${defaultDecision}"]`);
                if (radio) {
                    radio.checked = true;
                    console.log(`âœ… Default decision set to: ${defaultDecision}`);
                }
            }
            
            // Clear previous remarks
            const hrRemarks = document.getElementById('hrRemarks');
            if (hrRemarks) {
                hrRemarks.value = '';
            }
            
            // Show modal
            const approvalModal = document.getElementById('approvalModal');
            if (approvalModal) {
                approvalModal.classList.add('show');
                console.log('âœ… Approval modal displayed');
            } else {
                console.error('âŒ Approval modal element not found');
            }
        }

        // ============================================================================
        // NEW FUNCTION: generateApprovalModalContent()
        // ============================================================================
        function generateApprovalModalContent(request) {
            return `
                <div class="request-overview">
                    <h4 style="margin: 0 0 20px 0; color: #1f2937;">${request.employeeName} - ${request.trainingName}</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
                        <div>
                            <p style="margin: 8px 0;"><strong>Department:</strong> ${request.department}</p>
                            <p style="margin: 8px 0;"><strong>Job Title:</strong> ${request.jobTitle}</p>
                            <p style="margin: 8px 0;"><strong>Training Cost:</strong> â‚±${request.cost.toLocaleString()}</p>
                            <p style="margin: 8px 0;"><strong>Duration:</strong> ${request.duration || 0} hours</p>
                            <p style="margin: 8px 0;"><strong>Mode:</strong> ${request.isOnlineArrangement ? 'Online' : 'Onsite'}</p>
                        </div>
                        <div>
                            <p style="margin: 8px 0;"><strong>Request Date:</strong> ${new Date(request.requestDate).toLocaleDateString()}</p>
                            <p style="margin: 8px 0;"><strong>Budget Status:</strong> 
                                <span class="budget-status ${request.budgetSufficient ? 'sufficient' : 'insufficient'}" 
                                    style="padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: 600; 
                                            background-color: ${request.budgetSufficient ? '#dcfce7' : '#fef2f2'}; 
                                            color: ${request.budgetSufficient ? '#166534' : '#dc2626'};">
                                    ${request.budgetSufficient ? 'Available' : 'Insufficient'}
                                </span>
                            </p>
                            <p style="margin: 8px 0;"><strong>Available Budget:</strong> â‚±${request.availableBudget.toLocaleString()}</p>
                            ${!request.budgetSufficient ? `
                                <p style="margin: 8px 0; color: #dc2626;"><strong>Shortage:</strong> â‚±${(request.cost - request.availableBudget).toLocaleString()}</p>
                            ` : ''}
                            ${!request.isOnlineArrangement ? `
                                <p style="margin: 8px 0;"><strong>Location:</strong> ${request.address || 'N/A'}, ${request.country || 'N/A'}</p>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h5 style="margin: 0 0 10px 0; color: #334155;">ðŸ“š Training Description:</h5>
                        <p style="margin: 0; font-size: 14px; color: #64748b; line-height: 1.5;">${request.trainingDesc || 'No description provided'}</p>
                    </div>
                    
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6; margin: 15px 0;">
                        <h5 style="margin: 0 0 10px 0; color: #1e40af;">ðŸ‘¨â€ðŸ’¼ Line Manager Endorsement:</h5>
                        <p style="margin: 0; font-size: 14px; color: #64748b; font-style: italic; line-height: 1.5;">
                            "${request.lineManagerRemarks || 'No specific remarks provided by line manager'}"
                        </p>
                    </div>
                    
                    ${!request.budgetSufficient ? `
                        <div style="background: #fef2f2; padding: 15px; border-radius: 8px; border-left: 4px solid #ef4444; margin-top: 15px;">
                            <h5 style="margin: 0 0 10px 0; color: #dc2626;">âš ï¸ Budget Warning</h5>
                            <p style="margin: 0; font-size: 14px; color: #dc2626; line-height: 1.5;">
                                This training request exceeds the available department budget by â‚±${(request.cost - request.availableBudget).toLocaleString()}.
                                Approval will require budget reallocation or additional budget approval.
                            </p>
                        </div>
                    ` : `
                        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981; margin-top: 15px;">
                            <h5 style="margin: 0 0 10px 0; color: #166534;">âœ… Budget Available</h5>
                            <p style="margin: 0; font-size: 14px; color: #166534; line-height: 1.5;">
                                Sufficient budget is available for this training request.
                            </p>
                        </div>
                    `}
                </div>
            `;
        }

        // ============================================================================
        // NEW FUNCTION: closeApprovalModal()
        // ============================================================================
        function closeApprovalModal() {
            console.log('âŒ Closing approval modal...');
            
            const approvalModal = document.getElementById('approvalModal');
            if (approvalModal) {
                approvalModal.classList.remove('show');
            }
            
            // Reset the form
            const approvalForm = document.getElementById('approvalForm');
            if (approvalForm) {
                approvalForm.reset();
            }
            
            console.log('âœ… Approval modal closed and form reset');
        }

        // ============================================================================
        // REPLACE: handleApprovalSubmission() - ACTUAL IMPLEMENTATION
        // ============================================================================
        async function handleApprovalSubmission(e) {
            e.preventDefault();
            
            console.log('ðŸ”„ Processing approval submission...');
            
            // Get form data
            const formData = new FormData(e.target);
            const requestId = formData.get('requestId');
            const decision = formData.get('decision');
            const remarks = formData.get('remarks');
            
            // Validate required fields
            if (!requestId || !decision || !remarks.trim()) {
                console.error('âŒ Missing required fields');
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            console.log(`ðŸ“ Submitting: Request ${requestId}, Decision: ${decision}`);
            
            try {
                // Show loading state on submit button
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                submitBtn.disabled = true;
                
                // Make API request
                const response = await fetch('/hr/approve-training-request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        requestId: requestId,
                        decision: decision,
                        remarks: remarks
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    const actionText = decision === 'approved' ? 'approved' : 'rejected';
                    console.log(`âœ… Request ${requestId} ${actionText} successfully`);
                    
                    showNotification(`Training request ${actionText} successfully!`, 'success');
                    closeApprovalModal();
                    
                    // Reload pending requests to reflect changes
                    await loadPendingRequests();
                    
                } else {
                    throw new Error(result.message || 'Failed to process request');
                }
                
                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
            } catch (error) {
                console.error('âŒ Error processing approval:', error);
                showNotification('Error processing request: ' + error.message, 'error');
                
                // Reset button state
                const submitBtn = e.target.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-check"></i> Submit Decision';
                    submitBtn.disabled = false;
                }
            }
        }

        // ============================================================================
        // REPLACE: showRequestDetails() - ACTUAL IMPLEMENTATION
        // ============================================================================
        function showRequestDetails(requestId) {
            const request = pendingRequests.find(r => r.requestId == requestId);
            if (!request) {
                console.error('âŒ Request not found:', requestId);
                showNotification('Request not found', 'error');
                return;
            }
            
            console.log('ðŸ“‹ Showing details for request:', requestId);
            
            // Create detailed view modal HTML
            const detailsHtml = generateRequestDetailsModal(request);
            
            // Remove existing modal if any
            const existingModal = document.getElementById('requestDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', detailsHtml);
            
            console.log('âœ… Request details modal displayed');
        }

        // ============================================================================
        // NEW FUNCTION: generateRequestDetailsModal()
        // ============================================================================
        function generateRequestDetailsModal(request) {
            return `
                <div class="modal-overlay" id="requestDetailsModal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div class="modal-content" style="background: white; border-radius: 12px; max-width: 800px; width: 90%; max-height: 90vh; overflow: hidden; position: relative;">
                        <div class="modal-header" style="padding: 20px 20px 0 20px; border-bottom: 1px solid #e5e7eb;">
                            <h2 class="modal-title" style="margin: 0 0 15px 0; color: #1f2937;">Training Request Details</h2>
                            <button type="button" class="close-btn" onclick="closeRequestDetailsModal()" 
                                    style="position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; padding: 5px;">&times;</button>
                        </div>
                        
                        <div style="max-height: 60vh; overflow-y: auto; padding: 20px;">
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin: 0 0 20px 0; color: #1f2937;">${request.employeeName} - ${request.trainingName}</h4>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                                    <div>
                                        <h5 style="color: #334155; margin-bottom: 10px; font-size: 16px;">Employee Information</h5>
                                        <p style="margin: 5px 0;"><strong>Name:</strong> ${request.employeeName}</p>
                                        <p style="margin: 5px 0;"><strong>Department:</strong> ${request.department}</p>
                                        <p style="margin: 5px 0;"><strong>Job Title:</strong> ${request.jobTitle}</p>
                                        <p style="margin: 5px 0;"><strong>Department ID:</strong> ${request.departmentId}</p>
                                    </div>
                                    <div>
                                        <h5 style="color: #334155; margin-bottom: 10px; font-size: 16px;">Training Information</h5>
                                        <p style="margin: 5px 0;"><strong>Training:</strong> ${request.trainingName}</p>
                                        <p style="margin: 5px 0;"><strong>Cost:</strong> â‚±${request.cost.toLocaleString()}</p>
                                        <p style="margin: 5px 0;"><strong>Duration:</strong> ${request.duration || 0} hours</p>
                                        <p style="margin: 5px 0;"><strong>Mode:</strong> ${request.isOnlineArrangement ? 'Online' : 'Onsite'}</p>
                                        <p style="margin: 5px 0;"><strong>Requested:</strong> ${new Date(request.requestDate).toLocaleDateString()}</p>
                                    </div>
                                </div>
                                
                                ${!request.isOnlineArrangement ? `
                                <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #f59e0b;">
                                    <h5 style="margin: 0 0 10px 0; color: #92400e;">ðŸ“ Training Location</h5>
                                    <p style="margin: 0; font-weight: 600;">${request.address || 'Address not provided'}</p>
                                    <p style="margin: 5px 0 0 0; color: #92400e;">${request.country || 'Country not provided'}</p>
                                </div>
                                ` : ''}
                                
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                    <h5 style="margin: 0 0 10px 0; color: #334155;">ðŸ“š Training Description</h5>
                                    <p style="margin: 0; color: #64748b; line-height: 1.5;">${request.trainingDesc || 'No description provided'}</p>
                                </div>
                                
                                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6; margin: 15px 0;">
                                    <h5 style="margin: 0 0 10px 0; color: #1e40af;">ðŸ‘¨â€ðŸ’¼ Line Manager Endorsement</h5>
                                    <p style="margin: 0; color: #64748b; font-style: italic; line-height: 1.5;">
                                        "${request.lineManagerRemarks || 'No specific remarks provided by line manager'}"
                                    </p>
                                </div>
                                
                                <div style="background: ${request.budgetSufficient ? '#f0fdf4' : '#fef2f2'}; padding: 15px; border-radius: 8px; border-left: 4px solid ${request.budgetSufficient ? '#10b981' : '#ef4444'}; margin: 15px 0;">
                                    <h5 style="margin: 0 0 10px 0; color: ${request.budgetSufficient ? '#166534' : '#dc2626'};">
                                        ${request.budgetSufficient ? 'ðŸ’° Budget Analysis - Available' : 'âš ï¸ Budget Analysis - Insufficient'}
                                    </h5>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div>
                                            <p style="margin: 5px 0;"><strong>Training Cost:</strong> â‚±${request.cost.toLocaleString()}</p>
                                            <p style="margin: 5px 0;"><strong>Available Budget:</strong> â‚±${request.availableBudget.toLocaleString()}</p>
                                        </div>
                                        <div>
                                            <p style="margin: 5px 0;"><strong>Status:</strong> 
                                                <span style="color: ${request.budgetSufficient ? '#10b981' : '#ef4444'}; font-weight: 600;">
                                                    ${request.budgetSufficient ? 'Budget Available' : 'Insufficient Budget'}
                                                </span>
                                            </p>
                                            ${!request.budgetSufficient ? `
                                                <p style="margin: 5px 0; color: #dc2626;"><strong>Shortage:</strong> â‚±${(request.cost - request.availableBudget).toLocaleString()}</p>
                                            ` : `
                                                <p style="margin: 5px 0; color: #10b981;"><strong>Remaining After:</strong> â‚±${(request.availableBudget - request.cost).toLocaleString()}</p>
                                            `}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="modal-actions" style="padding: 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" class="btn-secondary" onclick="closeRequestDetailsModal()" 
                                    style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 6px; cursor: pointer;">
                                Close
                            </button>
                            <button type="button" class="btn-primary" onclick="closeRequestDetailsModal(); openApprovalModal('${request.requestId}')"
                                    style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-gavel"></i> Review & Decide
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================================================
        // NEW FUNCTION: closeRequestDetailsModal()
        // ============================================================================
        function closeRequestDetailsModal() {
            console.log('âŒ Closing request details modal...');
            
            const modal = document.getElementById('requestDetailsModal');
            if (modal) {
                modal.remove();
                console.log('âœ… Request details modal closed');
            }
        }

        // ============================================================================
        // GLOBAL FUNCTION EXPORTS FOR HTML ONCLICK HANDLERS
        // ============================================================================
        window.openApprovalModal = openApprovalModal;
        window.closeApprovalModal = closeApprovalModal;
        window.showRequestDetails = showRequestDetails;
        window.closeRequestDetailsModal = closeRequestDetailsModal;

        console.log('âœ… Phase 3: Approval Modal Functionality implemented');

        // ============================================================================
        // REPLACE: loadBudgetData() - ACTUAL IMPLEMENTATION
        // ============================================================================
        async function loadBudgetData() {
            try {
                console.log('ðŸ¢ Loading HR budget data...');
                
                // Show loading state
                showBudgetLoading();
                
                const response = await fetch('/hr/budget-overview', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    budgetData = result.data;
                    filteredDepartments = [...budgetData.departments];
                    
                    console.log('âœ… Budget data loaded:', budgetData);
                    
                    renderBudgetOverview();
                    renderDepartmentTable();
                    
                    showNotification('Budget data loaded successfully', 'success');
                    
                } else {
                    throw new Error(result.message || 'Failed to load budget data');
                }
                
            } catch (error) {
                console.error('âŒ Error loading budget data:', error);
                showBudgetError(error.message);
                showNotification('Failed to load budget data: ' + error.message, 'error');
            }
        }

        // ============================================================================
        // NEW FUNCTION: showBudgetLoading()
        // ============================================================================
        function showBudgetLoading() {
            console.log('ðŸ”„ Showing budget loading state...');
            
            const overviewGrid = document.getElementById('budgetOverviewGrid');
            const departmentTable = document.getElementById('departmentBudgetTable');
            
            if (overviewGrid) {
                overviewGrid.innerHTML = `
                    <div class="loading-state" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin loading-spinner" style="font-size: 32px; color: #3b82f6; margin-bottom: 15px;"></i>
                        <h3 style="margin: 0 0 10px 0; color: #475569;">Loading Budget Overview</h3>
                        <p style="margin: 0; color: #64748b;">Fetching department budget data...</p>
                    </div>
                `;
            }
            
            if (departmentTable) {
                departmentTable.innerHTML = `
                    <div class="loading-state" style="padding: 40px; text-align: center;">
                        <i class="fas fa-spinner fa-spin loading-spinner" style="font-size: 32px; color: #3b82f6; margin-bottom: 15px;"></i>
                        <h3 style="margin: 0 0 10px 0; color: #475569;">Loading Department Data</h3>
                        <p style="margin: 0; color: #64748b;">Please wait...</p>
                    </div>
                `;
            }
        }

        // ============================================================================
        // NEW FUNCTION: showBudgetError()
        // ============================================================================
        function showBudgetError(message) {
            console.log('âŒ Showing budget error state...');
            
            const overviewGrid = document.getElementById('budgetOverviewGrid');
            const departmentTable = document.getElementById('departmentBudgetTable');
            
            const errorHTML = `
                <div style="text-align: center; padding: 40px; color: #64748b;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px; color: #ef4444;"></i>
                    <h3 style="margin: 0 0 10px 0; color: #475569;">Failed to Load Budget Data</h3>
                    <p style="margin: 0 0 15px 0;">${message}</p>
                    <button onclick="loadBudgetData()" class="btn btn-primary" 
                            style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-retry"></i> Try Again
                    </button>
                </div>
            `;
            
            if (overviewGrid) {
                overviewGrid.innerHTML = errorHTML;
            }
            
            if (departmentTable) {
                departmentTable.innerHTML = errorHTML;
            }
        }

        // ============================================================================
        // NEW FUNCTION: renderBudgetOverview()
        // ============================================================================
        function renderBudgetOverview() {
            console.log('ðŸ“Š Rendering budget overview...');
            
            const overviewGrid = document.getElementById('budgetOverviewGrid');
            if (!overviewGrid || !budgetData) {
                console.warn('âš ï¸ Budget overview grid not found or no budget data');
                return;
            }
            
            const { totalAllocated, totalSpent, totalRemaining } = budgetData;
            const overallUtilization = totalAllocated > 0 ? Math.round((totalSpent / totalAllocated) * 100) : 0;
            
            overviewGrid.innerHTML = `
                <div class="budget-summary-card total" style="background: #f8fafc; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #e2e8f0;">
                    <div class="budget-summary-icon" style="font-size: 24px; color: #3b82f6; margin-bottom: 10px;">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="budget-summary-number" style="font-size: 28px; font-weight: 700; color: #1f2937; margin-bottom: 5px;">â‚±${totalAllocated.toLocaleString()}</div>
                    <div class="budget-summary-label" style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 3px;">Total Budget</div>
                    <div class="budget-summary-sublabel" style="font-size: 12px; color: #64748b;">${budgetData.departments.length} departments</div>
                </div>
                
                <div class="budget-summary-card spent" style="background: #fef2f2; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #fecaca;">
                    <div class="budget-summary-icon" style="font-size: 24px; color: #dc2626; margin-bottom: 10px;">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <div class="budget-summary-number" style="font-size: 28px; font-weight: 700; color: #1f2937; margin-bottom: 5px;">â‚±${totalSpent.toLocaleString()}</div>
                    <div class="budget-summary-label" style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 3px;">Total Spent</div>
                    <div class="budget-summary-sublabel" style="font-size: 12px; color: #64748b;">Training expenses</div>
                </div>
                
                <div class="budget-summary-card remaining" style="background: #f0fdf4; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #bbf7d0;">
                    <div class="budget-summary-icon" style="font-size: 24px; color: #059669; margin-bottom: 10px;">
                        <i class="fas fa-piggy-bank"></i>
                    </div>
                    <div class="budget-summary-number" style="font-size: 28px; font-weight: 700; color: #1f2937; margin-bottom: 5px;">â‚±${totalRemaining.toLocaleString()}</div>
                    <div class="budget-summary-label" style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 3px;">Remaining Budget</div>
                    <div class="budget-summary-sublabel" style="font-size: 12px; color: #64748b;">Available funds</div>
                </div>
                
                <div class="budget-summary-card utilization" style="background: #fefbeb; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #fed7aa;">
                    <div class="budget-summary-icon" style="font-size: 24px; color: #d97706; margin-bottom: 10px;">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <div class="budget-summary-number" style="font-size: 28px; font-weight: 700; color: #1f2937; margin-bottom: 5px;">${overallUtilization}%</div>
                    <div class="budget-summary-label" style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 3px;">Overall Utilization</div>
                    <div class="budget-summary-sublabel" style="font-size: 12px; color: #64748b;">Budget usage</div>
                </div>
            `;
            
            console.log('âœ… Budget overview rendered');
        }

        // ============================================================================
        // NEW FUNCTION: renderDepartmentTable()
        // ============================================================================
        function renderDepartmentTable() {
            console.log(`ðŸ“‹ Rendering department table with ${filteredDepartments.length} departments...`);
            
            const departmentTable = document.getElementById('departmentBudgetTable');
            if (!departmentTable || !filteredDepartments) {
                console.warn('âš ï¸ Department table element not found or no filtered departments');
                return;
            }
            
            if (filteredDepartments.length === 0) {
                departmentTable.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; color: #cbd5e1;"></i>
                        <h3 style="margin: 0 0 10px 0; color: #475569;">No Departments Found</h3>
                        <p style="margin: 0;">Try adjusting your filters or search criteria.</p>
                    </div>
                `;
                return;
            }
            
            const tableHTML = `
                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <thead>
                        <tr style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                            <th style="padding: 15px 12px; text-align: left; font-weight: 600; color: #374151; font-size: 14px;">Department</th>
                            <th style="padding: 15px 12px; text-align: right; font-weight: 600; color: #374151; font-size: 14px;">Budget Allocated</th>
                            <th style="padding: 15px 12px; text-align: right; font-weight: 600; color: #374151; font-size: 14px;">Amount Spent</th>
                            <th style="padding: 15px 12px; text-align: right; font-weight: 600; color: #374151; font-size: 14px;">Remaining</th>
                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #374151; font-size: 14px;">Utilization</th>
                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #374151; font-size: 14px;">Status</th>
                            <th style="padding: 15px 12px; text-align: center; font-weight: 600; color: #374151; font-size: 14px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredDepartments.map(dept => {
                            const statusColors = {
                                good: { bg: '#dcfce7', color: '#166534', progress: '#10b981' },
                                warning: { bg: '#fef3c7', color: '#92400e', progress: '#f59e0b' },
                                critical: { bg: '#fef2f2', color: '#dc2626', progress: '#ef4444' }
                            };
                            const colors = statusColors[dept.status] || statusColors.good;
                            
                            return `
                                <tr onclick="showDepartmentDetails(${dept.departmentId})" 
                                    style="cursor: pointer; border-bottom: 1px solid #e2e8f0; transition: background-color 0.2s;"
                                    onmouseover="this.style.backgroundColor='#f8fafc'" 
                                    onmouseout="this.style.backgroundColor='white'">
                                    <td class="dept-name-cell" style="padding: 15px 12px;">
                                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 2px;">${dept.departmentName}</div>
                                        <div style="font-size: 12px; color: #6b7280;">ID: ${dept.departmentId}</div>
                                    </td>
                                    <td class="budget-amount" style="padding: 15px 12px; text-align: right; font-weight: 600; color: #1f2937;">â‚±${dept.allocated.toLocaleString()}</td>
                                    <td class="spent-amount" style="padding: 15px 12px; text-align: right; font-weight: 600; color: #dc2626;">â‚±${dept.spent.toLocaleString()}</td>
                                    <td class="remaining-amount" style="padding: 15px 12px; text-align: right; font-weight: 600; color: ${dept.remaining >= 0 ? '#059669' : '#dc2626'};">
                                        â‚±${dept.remaining.toLocaleString()}
                                    </td>
                                    <td style="padding: 15px 12px; text-align: center;">
                                        <div style="width: 100px; height: 8px; background: #f1f5f9; border-radius: 4px; margin: 0 auto 5px; overflow: hidden;">
                                            <div style="width: ${Math.min(dept.utilization, 100)}%; height: 100%; background: ${colors.progress}; transition: width 0.3s;"></div>
                                        </div>
                                        <div style="font-size: 12px; font-weight: 600; color: #374151;">${dept.utilization}%</div>
                                    </td>
                                    <td style="padding: 15px 12px; text-align: center;">
                                        <span style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; background: ${colors.bg}; color: ${colors.color};">
                                            ${dept.status.charAt(0).toUpperCase() + dept.status.slice(1)}
                                        </span>
                                    </td>
                                    <td onclick="event.stopPropagation()" style="padding: 15px 12px; text-align: center;">
                                        <button onclick="showDepartmentDetails(${dept.departmentId})" 
                                                style="padding: 6px 10px; margin: 0 2px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                        <button onclick="editDepartmentBudget(${dept.departmentId})"
                                                style="padding: 6px 10px; margin: 0 2px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            departmentTable.innerHTML = tableHTML;
            console.log('âœ… Department table rendered');
        }

        // ============================================================================
        // NEW FUNCTION: filterDepartments()
        // ============================================================================
        function filterDepartments() {
            if (!budgetData || !budgetData.departments) {
                console.warn('âš ï¸ No budget data available for filtering');
                return;
            }
            
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            const budgetRangeFilter = document.getElementById('budgetRangeFilter')?.value || '';
            const searchTerm = document.getElementById('departmentSearch')?.value.toLowerCase() || '';
            
            console.log('ðŸ” Filtering departments:', { statusFilter, budgetRangeFilter, searchTerm });
            
            filteredDepartments = budgetData.departments.filter(dept => {
                // Status filter
                if (statusFilter && dept.status !== statusFilter) {
                    return false;
                }
                
                // Budget range filter
                if (budgetRangeFilter) {
                    const budget = dept.allocated;
                    switch (budgetRangeFilter) {
                        case '0-50000':
                            if (budget < 0 || budget > 50000) return false;
                            break;
                        case '50000-100000':
                            if (budget < 50000 || budget > 100000) return false;
                            break;
                        case '100000-500000':
                            if (budget < 100000 || budget > 500000) return false;
                            break;
                        case '500000+':
                            if (budget < 500000) return false;
                            break;
                    }
                }
                
                // Search filter
                if (searchTerm && !dept.departmentName.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                return true;
            });
            
            console.log(`âœ… Filtered to ${filteredDepartments.length} departments`);
            renderDepartmentTable();
        }

        // ============================================================================
        // NEW FUNCTION: clearAllFilters()
        // ============================================================================
        function clearAllFilters() {
            console.log('ðŸ§¹ Clearing all budget filters...');
            
            const statusFilter = document.getElementById('statusFilter');
            const budgetRangeFilter = document.getElementById('budgetRangeFilter');
            const departmentSearch = document.getElementById('departmentSearch');
            
            if (statusFilter) statusFilter.value = '';
            if (budgetRangeFilter) budgetRangeFilter.value = '';
            if (departmentSearch) departmentSearch.value = '';
            
            if (budgetData) {
                filteredDepartments = [...budgetData.departments];
                renderDepartmentTable();
            }
            
            showNotification('Budget filters cleared', 'info');
        }

        // ============================================================================
        // NEW FUNCTION: refreshBudgetData()
        // ============================================================================
        function refreshBudgetData() {
            console.log('ðŸ”„ Refreshing budget data...');
            showNotification('Refreshing budget data...', 'info');
            loadBudgetData();
        }


        // ============================================================================
        // GLOBAL FUNCTION EXPORTS FOR HTML ONCLICK HANDLERS
        // ============================================================================
        window.loadBudgetData = loadBudgetData;
        window.filterDepartments = filterDepartments;
        window.clearAllFilters = clearAllFilters;
        window.showDepartmentDetails = showDepartmentDetails;
        window.editDepartmentBudget = editDepartmentBudget;
        window.refreshBudgetData = refreshBudgetData;

        console.log('âœ… Phase 4: Budget Management implemented');

        // ============================================================================
        // HR TRAINING APPROVAL DASHBOARD - PHASE 5: DEPARTMENT DETAILS & BUDGET EDITING
        // Replace the placeholder functions and add department management functionality
        // ============================================================================

        // ============================================================================
        // REPLACE: showDepartmentDetails() - ACTUAL IMPLEMENTATION
        // ============================================================================
        function showDepartmentDetails(departmentId) {
            console.log('ðŸ¢ Showing details for department:', departmentId);
            
            const department = budgetData.departments.find(d => d.departmentId === departmentId);
            if (!department) {
                console.error('âŒ Department not found:', departmentId);
                showNotification('Department not found', 'error');
                return;
            }
            
            currentSelectedDepartment = department;
            
            // Update modal content
            populateDepartmentDetailsModal(department);
            
            // Show modal
            const modal = document.getElementById('departmentDetailsModal');
            if (modal) {
                modal.classList.add('show');
                console.log('âœ… Department details modal displayed');
            } else {
                console.error('âŒ Department details modal not found');
            }
        }

        // ============================================================================
        // NEW FUNCTION: populateDepartmentDetailsModal()
        // ============================================================================
        function populateDepartmentDetailsModal(department) {
            console.log('ðŸ“ Populating department details modal...');
            
            // Update basic information
            const modalDeptName = document.getElementById('modalDeptName');
            const modalDeptId = document.getElementById('modalDeptId');
            const modalFiscalYear = document.getElementById('modalFiscalYear');
            const modalEmployeeCount = document.getElementById('modalEmployeeCount');
            
            if (modalDeptName) modalDeptName.textContent = department.departmentName;
            if (modalDeptId) modalDeptId.textContent = department.departmentId;
            if (modalFiscalYear) modalFiscalYear.textContent = '2025';
            if (modalEmployeeCount) modalEmployeeCount.textContent = department.employeeCount || 'N/A';
            
            // Update budget summary
            const modalTotalBudget = document.getElementById('modalTotalBudget');
            const modalTotalSpent = document.getElementById('modalTotalSpent');
            const modalRemaining = document.getElementById('modalRemaining');
            const modalUtilization = document.getElementById('modalUtilization');
            
            if (modalTotalBudget) modalTotalBudget.textContent = `â‚±${department.allocated.toLocaleString()}`;
            if (modalTotalSpent) modalTotalSpent.textContent = `â‚±${department.spent.toLocaleString()}`;
            if (modalRemaining) modalRemaining.textContent = `â‚±${department.remaining.toLocaleString()}`;
            if (modalUtilization) modalUtilization.textContent = `${department.utilization}%`;
            
            // Update progress bar
            const progressBar = document.getElementById('modalProgressBar');
            if (progressBar) {
                const statusColors = {
                    good: '#10b981',
                    warning: '#f59e0b', 
                    critical: '#ef4444'
                };
                progressBar.style.width = `${Math.min(department.utilization, 100)}%`;
                progressBar.style.backgroundColor = statusColors[department.status] || statusColors.good;
            }
            
            const modalProgressText = document.getElementById('modalProgressText');
            const modalBudgetLimit = document.getElementById('modalBudgetLimit');
            if (modalProgressText) modalProgressText.textContent = `${department.utilization}% Used`;
            if (modalBudgetLimit) modalBudgetLimit.textContent = `â‚±${department.allocated.toLocaleString()}`;
            
            // Update status badge
            const statusBadge = document.getElementById('modalStatusBadge');
            if (statusBadge) {
                const statusColors = {
                    good: { bg: '#dcfce7', color: '#166534' },
                    warning: { bg: '#fef3c7', color: '#92400e' },
                    critical: { bg: '#fef2f2', color: '#dc2626' }
                };
                const colors = statusColors[department.status] || statusColors.good;
                statusBadge.style.backgroundColor = colors.bg;
                statusBadge.style.color = colors.color;
                statusBadge.textContent = department.status.charAt(0).toUpperCase() + department.status.slice(1);
            }
            
            // Update recommendations
            updateDepartmentRecommendations(department);
            
            // Load recent training requests for this department
            loadRecentTrainingRequests(department.departmentId);
        }

        // ============================================================================
        // NEW FUNCTION: updateDepartmentRecommendations()
        // ============================================================================
        function updateDepartmentRecommendations(department) {
            const recommendationsList = document.getElementById('modalRecommendations');
            if (!recommendationsList) return;
            
            const recommendations = [];
            
            if (department.status === 'good') {
                recommendations.push('Budget is well-managed with good utilization');
                recommendations.push('Consider planning additional training opportunities');
                if (department.utilization < 50) {
                    recommendations.push('Low utilization - encourage more training requests');
                }
            } else if (department.status === 'warning') {
                recommendations.push('Monitor spending closely to avoid budget overrun');
                recommendations.push('Review upcoming training requests carefully');
                recommendations.push('Consider reallocating budget if needed');
            } else if (department.status === 'critical') {
                recommendations.push('âš ï¸ Budget is critically low - immediate attention required');
                recommendations.push('Suspend non-essential training requests');
                recommendations.push('Consider emergency budget reallocation');
                recommendations.push('Review all pending training costs');
            }
            
            recommendationsList.innerHTML = recommendations.map(rec => `<li>${rec}</li>`).join('');
        }

        // ============================================================================
        // NEW FUNCTION: loadRecentTrainingRequests()
        // ============================================================================
        function loadRecentTrainingRequests(departmentId) {
            console.log('ðŸ“‹ Loading recent training requests for department:', departmentId);
            
            const recentTrainingsList = document.getElementById('recentTrainingsList');
            if (!recentTrainingsList) return;
            
            // Filter recent requests from pending requests and approval history
            const departmentRequests = [
                ...pendingRequests.filter(req => req.departmentId === departmentId),
                ...(approvalHistory || []).filter(req => req.departmentId === departmentId)
            ].slice(0, 5); // Show last 5 requests
            
            if (departmentRequests.length === 0) {
                recentTrainingsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #64748b;">
                        <i class="fas fa-inbox" style="font-size: 24px; margin-bottom: 10px; color: #cbd5e1;"></i>
                        <p style="margin: 0;">No recent training requests found</p>
                    </div>
                `;
                return;
            }
            
            const requestsHtml = departmentRequests.map(request => {
                const isPending = pendingRequests.some(pr => pr.requestId === request.requestId);
                const statusColor = isPending ? '#f59e0b' : (request.isApproved ? '#10b981' : '#ef4444');
                const statusText = isPending ? 'Pending' : (request.isApproved ? 'Approved' : 'Rejected');
                
                return `
                    <div style="padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">${request.employeeName}</div>
                                <div style="font-size: 14px; color: #64748b; margin-bottom: 4px;">${request.trainingName}</div>
                                <div style="font-size: 12px; color: #64748b;">
                                    Cost: â‚±${request.cost.toLocaleString()} â€¢ 
                                    ${new Date(request.requestDate).toLocaleDateString()}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <span style="padding: 2px 6px; border-radius: 12px; font-size: 11px; font-weight: 600; 
                                            background-color: ${statusColor}20; color: ${statusColor};">
                                    ${statusText}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            recentTrainingsList.innerHTML = requestsHtml;
        }

        // ============================================================================
        // NEW FUNCTION: closeDepartmentDetailsModal()
        // ============================================================================
        function closeDepartmentDetailsModal() {
            console.log('âŒ Closing department details modal...');
            
            const modal = document.getElementById('departmentDetailsModal');
            if (modal) {
                modal.classList.remove('show');
            }
            
            currentSelectedDepartment = null;
            console.log('âœ… Department details modal closed');
        }

        // ============================================================================
        // REPLACE: editDepartmentBudget() - ACTUAL IMPLEMENTATION
        // ============================================================================
        function editDepartmentBudget(departmentId) {
            const department = departmentId ? 
                budgetData.departments.find(d => d.departmentId === departmentId) : 
                currentSelectedDepartment;
            
            if (!department) {
                console.error('âŒ Department not found for editing:', departmentId);
                showNotification('Department not found', 'error');
                return;
            }
            
            console.log('âœï¸ Opening budget edit modal for department:', department.departmentName);
            
            // Close details modal if open
            closeDepartmentDetailsModal();
            
            // Populate edit form
            const editDeptName = document.getElementById('editDeptName');
            const editDeptId = document.getElementById('editDeptId');
            const editBudgetAmount = document.getElementById('editBudgetAmount');
            const editFiscalYear = document.getElementById('editFiscalYear');
            const editBudgetNotes = document.getElementById('editBudgetNotes');
            
            if (editDeptName) editDeptName.value = department.departmentName;
            if (editDeptId) editDeptId.value = department.departmentId;
            if (editBudgetAmount) editBudgetAmount.value = department.allocated;
            if (editFiscalYear) editFiscalYear.value = '2025';
            if (editBudgetNotes) editBudgetNotes.value = '';
            
            // Show edit modal
            const editModal = document.getElementById('editBudgetModal');
            if (editModal) {
                editModal.classList.add('show');
                console.log('âœ… Budget edit modal displayed');
            } else {
                console.error('âŒ Budget edit modal not found');
            }
        }

        // ============================================================================
        // NEW FUNCTION: closeEditBudgetModal()
        // ============================================================================
        function closeEditBudgetModal() {
            console.log('âŒ Closing budget edit modal...');
            
            const modal = document.getElementById('editBudgetModal');
            if (modal) {
                modal.classList.remove('show');
            }
            
            // Reset form
            const form = document.getElementById('editBudgetForm');
            if (form) {
                form.reset();
            }
            
            console.log('âœ… Budget edit modal closed');
        }

        // ============================================================================
        // REPLACE: handleEditBudgetSubmit() - ACTUAL IMPLEMENTATION
        // ============================================================================
        async function handleEditBudgetSubmit(e) {
            e.preventDefault();
            
            console.log('ðŸ’° Processing budget edit submission...');
            
            // Get form data
            const departmentId = document.getElementById('editDeptId')?.value;
            const budgetAmount = parseFloat(document.getElementById('editBudgetAmount')?.value);
            const fiscalYear = document.getElementById('editFiscalYear')?.value;
            const notes = document.getElementById('editBudgetNotes')?.value;
            
            // Validate inputs
            if (!departmentId || !budgetAmount || budgetAmount < 0) {
                showNotification('Please enter a valid budget amount', 'error');
                return;
            }
            
            console.log(`ðŸ“ Updating budget for department ${departmentId}: â‚±${budgetAmount.toLocaleString()}`);
            
            try {
                // Show loading state
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                submitBtn.disabled = true;
                
                // Make API request
                const response = await fetch('/hr/update-budget', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        departmentId: parseInt(departmentId),
                        amount: budgetAmount,
                        fiscalYear: fiscalYear,
                        notes: notes
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('âœ… Budget updated successfully');
                    
                    showNotification('Budget updated successfully!', 'success');
                    closeEditBudgetModal();
                    
                    // Refresh budget data to show updated information
                    await loadBudgetData();
                    
                } else {
                    throw new Error(result.message || 'Failed to update budget');
                }
                
                // Reset button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
            } catch (error) {
                console.error('âŒ Error updating budget:', error);
                showNotification('Error updating budget: ' + error.message, 'error');
                
                // Reset button
                const submitBtn = e.target.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Budget';
                    submitBtn.disabled = false;
                }
            }
        }

        async function loadEfficiencyData() {
            try {
                console.log('ðŸ“Š Loading efficiency data...');
                
                const timeFilter = document.getElementById('efficiencyTimeFilter')?.value || 'thisYear';
                
                const response = await fetch(`/hr/training-efficiency?timePeriod=${timeFilter}`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    updateEfficiencyDisplay(result.data);
                    showNotification('Efficiency data loaded successfully', 'success');
                } else {
                    throw new Error(result.message || 'Failed to load efficiency data');
                }
                
            } catch (error) {
                console.error('âŒ Error loading efficiency data:', error);
                showEfficiencyError(error.message);
                showNotification('Failed to load efficiency data: ' + error.message, 'error');
            }
        }

        function updateEfficiencyDisplay(data) {
            // Update summary cards
            const bestScore = document.getElementById('bestEfficiencyScore');
            const avgScore = document.getElementById('avgEfficiencyScore');
            const lowestScore = document.getElementById('lowestEfficiencyScore');
            const avgCost = document.getElementById('avgCostPerTraining');
            const bestDept = document.getElementById('bestEfficiencyDept');
            const lowestDept = document.getElementById('lowestEfficiencyDept');
            
            if (bestScore) bestScore.textContent = data.summary.bestEfficiencyScore;
            if (avgScore) avgScore.textContent = data.summary.avgEfficiencyScore;
            if (lowestScore) lowestScore.textContent = data.summary.lowestEfficiencyScore;
            if (avgCost) avgCost.textContent = `â‚±${data.summary.avgCostPerTraining.toLocaleString()}`;
            if (bestDept) bestDept.textContent = data.summary.bestEfficiencyDept;
            if (lowestDept) lowestDept.textContent = data.summary.lowestEfficiencyDept;
            
            // Update efficiency table
            renderEfficiencyTable(data.departmentEfficiency);
        }

        function renderEfficiencyTable(efficiencyData) {
            const tableContainer = document.getElementById('departmentEfficiencyTable');
            if (!tableContainer) return;
            
            if (efficiencyData.length === 0) {
                tableContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <p>No efficiency data available</p>
                    </div>
                `;
                return;
            }
            
            const tableHTML = `
                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                    <thead>
                        <tr style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Department</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Efficiency Score</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Total Trainings</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Completed</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Avg Cost</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${efficiencyData.map(dept => `
                            <tr style="border-bottom: 1px solid #e2e8f0;">
                                <td style="padding: 12px; font-weight: 500; color: #1f2937;">${dept.departmentName}</td>
                                <td style="padding: 12px; text-align: center; font-weight: 600; color: ${dept.efficiencyScore >= 5 ? '#10b981' : dept.efficiencyScore >= 3 ? '#f59e0b' : '#ef4444'};">
                                    ${dept.efficiencyScore}
                                </td>
                                <td style="padding: 12px; text-align: center; color: #64748b;">${dept.totalTrainings}</td>
                                <td style="padding: 12px; text-align: center; color: #64748b;">${dept.completedTrainings}</td>
                                <td style="padding: 12px; text-align: center; color: #64748b;">â‚±${dept.avgCostPerTraining.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            tableContainer.innerHTML = tableHTML;
        }

        function showEfficiencyError(message) {
            const tableContainer = document.getElementById('departmentEfficiencyTable');
            if (tableContainer) {
                tableContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px; color: #ef4444;"></i>
                        <p style="margin: 0;">Error loading efficiency data: ${message}</p>
                        <button onclick="refreshEfficiencyData()" style="margin-top: 10px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        function updateEfficiencyAnalysis() {
            console.log('ðŸ”„ Updating efficiency analysis...');
            loadEfficiencyData();
        }

        function refreshEfficiencyData() {
            console.log('ðŸ”„ Refreshing efficiency data...');
            showNotification('Refreshing efficiency data...', 'info');
            loadEfficiencyData();
        }

        // ============================================================================
        // NEW FUNCTION: exportBudgetReport()
        // ============================================================================
        function exportBudgetReport(format) {
            console.log(`ðŸ“Š Exporting budget report in ${format} format...`);
            
            if (!budgetData || !budgetData.departments) {
                showNotification('No budget data available to export', 'error');
                return;
            }
            
            try {
                if (format === 'excel') {
                    exportBudgetToExcel();
                } else if (format === 'pdf') {
                    exportBudgetToPDF();
                } else {
                    showNotification('Unsupported export format', 'error');
                }
            } catch (error) {
                console.error('âŒ Error in export function:', error);
                showNotification('Export failed: ' + error.message, 'error');
            }
        }

        // ============================================================================
        // NEW FUNCTION: exportBudgetToExcel()
        // ============================================================================
        function exportBudgetToExcel() {
            console.log('ðŸ“— Exporting budget data to Excel...');
            
            if (!budgetData || !budgetData.departments) {
                showNotification('No budget data available to export', 'error');
                return;
            }
            
            try {
                // Create comprehensive CSV with multiple sheets worth of data
                let csvContent = '';
                
                // Header information
                csvContent += `Training Budget Report\n`;
                csvContent += `Generated,${new Date().toLocaleDateString()}\n`;
                csvContent += `Fiscal Year,2025\n`;
                csvContent += `Total Departments,${budgetData.departments.length}\n\n`;
                
                // Summary section
                csvContent += `BUDGET SUMMARY\n`;
                csvContent += `Metric,Amount\n`;
                csvContent += `Total Allocated,${budgetData.totalAllocated}\n`;
                csvContent += `Total Spent,${budgetData.totalSpent}\n`;
                csvContent += `Total Remaining,${budgetData.totalRemaining}\n`;
                csvContent += `Overall Utilization %,${budgetData.totalAllocated > 0 ? Math.round((budgetData.totalSpent / budgetData.totalAllocated) * 100) : 0}\n\n`;
                
                // Department details section
                csvContent += `DEPARTMENT BUDGET DETAILS\n`;
                const headers = [
                    'Department ID',
                    'Department Name', 
                    'Budget Allocated',
                    'Amount Spent',
                    'Remaining Budget',
                    'Utilization %',
                    'Status',
                    'Employee Count',
                    'Avg Spend Per Employee',
                    'Risk Level'
                ];
                csvContent += headers.join(',') + '\n';
                
                budgetData.departments.forEach(dept => {
                    const avgSpendPerEmployee = dept.employeeCount > 0 ? Math.round(dept.spent / dept.employeeCount) : 0;
                    const riskLevel = dept.utilization >= 90 ? 'High' : dept.utilization >= 75 ? 'Medium' : 'Low';
                    
                    const row = [
                        dept.departmentId,
                        `"${dept.departmentName}"`,
                        dept.allocated,
                        dept.spent,
                        dept.remaining,
                        dept.utilization,
                        dept.status,
                        dept.employeeCount || 0,
                        avgSpendPerEmployee,
                        riskLevel
                    ];
                    csvContent += row.join(',') + '\n';
                });
                
                // Status summary section
                csvContent += `\nSTATUS SUMMARY\n`;
                csvContent += `Status,Count,Percentage\n`;
                const statusCounts = {
                    good: budgetData.departments.filter(d => d.status === 'good').length,
                    warning: budgetData.departments.filter(d => d.status === 'warning').length,
                    critical: budgetData.departments.filter(d => d.status === 'critical').length
                };
                
                Object.entries(statusCounts).forEach(([status, count]) => {
                    const percentage = Math.round((count / budgetData.departments.length) * 100);
                    csvContent += `${status.charAt(0).toUpperCase() + status.slice(1)},${count},${percentage}%\n`;
                });
                
                // Download CSV file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `training-budget-report-${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                window.URL.revokeObjectURL(url);
                
                showNotification('Budget report exported to Excel format successfully!', 'success');
                
            } catch (error) {
                console.error('âŒ Error exporting to Excel:', error);
                showNotification('Error exporting to Excel: ' + error.message, 'error');
            }
        }

        // ============================================================================
        // NEW FUNCTION: exportBudgetToPDF()
        // ============================================================================
        function exportBudgetToPDF() {
            console.log('ðŸ“• Exporting budget data to PDF...');
            
            if (!budgetData || !budgetData.departments) {
                showNotification('No budget data available to export', 'error');
                return;
            }
            
            try {
                // Check if jsPDF is available
                if (typeof window.jspdf === 'undefined') {
                    showNotification('PDF library not loaded. Please refresh the page.', 'error');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Set up the PDF
                let yPosition = 20;
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                const contentWidth = pageWidth - (margin * 2);
                
                // Header with background
                doc.setFillColor(59, 130, 246);
                doc.rect(0, 0, pageWidth, 45, 'F');
                
                // Title in white
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('TRAINING BUDGET REPORT', margin, 25);
                
                doc.setFontSize(12);
                doc.text(`Generated: ${new Date().toLocaleDateString()} | Fiscal Year: 2025`, margin, 37);
                
                // Reset text color
                doc.setTextColor(0, 0, 0);
                yPosition = 60;
                
                // Executive Summary Box
                doc.setFillColor(248, 250, 252);
                doc.rect(margin, yPosition - 5, contentWidth, 50, 'F');
                doc.setDrawColor(59, 130, 246);
                doc.setLineWidth(1);
                doc.rect(margin, yPosition - 5, contentWidth, 50);
                
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('BUDGET OVERVIEW', margin + 5, yPosition + 8);
                
                // Calculate summary metrics
                const { totalAllocated, totalSpent, totalRemaining } = budgetData;
                const overallUtilization = totalAllocated > 0 ? Math.round((totalSpent / totalAllocated) * 100) : 0;
                
                // Summary metrics in a professional grid
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                
                const summaryMetrics = [
                    [`Total Allocated:`, `â‚±${totalAllocated.toLocaleString()}`],
                    [`Total Spent:`, `â‚±${totalSpent.toLocaleString()}`],
                    [`Remaining Budget:`, `â‚±${totalRemaining.toLocaleString()}`],
                    [`Overall Utilization:`, `${overallUtilization}%`]
                ];
                
                let summaryY = yPosition + 20;
                summaryMetrics.forEach((metric, index) => {
                    const xPos = margin + 10 + (index % 2) * 85;
                    const yPos = summaryY + Math.floor(index / 2) * 10;
                    
                    doc.setFont('helvetica', 'bold');
                    doc.text(metric[0], xPos, yPos);
                    doc.setFont('helvetica', 'normal');
                    doc.text(metric[1], xPos + 35, yPos);
                });
                
                yPosition += 65;
                
                // Department Budget Status Overview
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('DEPARTMENT STATUS SUMMARY', margin, yPosition);
                yPosition += 10;
                
                // Status breakdown
                const statusCounts = {
                    good: budgetData.departments.filter(d => d.status === 'good').length,
                    warning: budgetData.departments.filter(d => d.status === 'warning').length,
                    critical: budgetData.departments.filter(d => d.status === 'critical').length
                };
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text(`â€¢ Good Status (< 75% utilization): ${statusCounts.good} departments`, margin + 5, yPosition);
                yPosition += 7;
                doc.text(`â€¢ Warning Status (75-90% utilization): ${statusCounts.warning} departments`, margin + 5, yPosition);
                yPosition += 7;
                doc.text(`â€¢ Critical Status (> 90% utilization): ${statusCounts.critical} departments`, margin + 5, yPosition);
                yPosition += 15;
                
                // Main Department Budget Table
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('DETAILED DEPARTMENT BUDGET ANALYSIS', margin, yPosition);
                yPosition += 10;
                
                // Check if autoTable is available for professional tables
                if (doc.autoTable) {
                    // Prepare table data
                    const tableData = budgetData.departments.map(dept => [
                        dept.departmentName,
                        `â‚±${dept.allocated.toLocaleString()}`,
                        `â‚±${dept.spent.toLocaleString()}`,
                        `â‚±${dept.remaining.toLocaleString()}`,
                        `${dept.utilization}%`,
                        dept.status.charAt(0).toUpperCase() + dept.status.slice(1)
                    ]);
                    
                    doc.autoTable({
                        head: [['Department', 'Budget Allocated', 'Amount Spent', 'Remaining', 'Utilization', 'Status']],
                        body: tableData,
                        startY: yPosition,
                        margin: { left: margin, right: margin },
                        styles: { 
                            fontSize: 9,
                            cellPadding: 3,
                            lineColor: [200, 200, 200],
                            lineWidth: 0.1
                        },
                        headStyles: { 
                            fillColor: [59, 130, 246],
                            textColor: [255, 255, 255],
                            fontStyle: 'bold',
                            fontSize: 10
                        },
                        columnStyles: {
                            0: { cellWidth: 35 }, // Department name
                            1: { cellWidth: 30, halign: 'right' }, // Budget
                            2: { cellWidth: 30, halign: 'right' }, // Spent
                            3: { cellWidth: 30, halign: 'right' }, // Remaining
                            4: { cellWidth: 20, halign: 'center' }, // Utilization
                            5: { cellWidth: 25, halign: 'center' } // Status
                        },
                        didParseCell: function(data) {
                            // Color-code status cells
                            if (data.column.index === 5) { // Status column
                                const status = data.cell.text[0].toLowerCase();
                                if (status.includes('good')) {
                                    data.cell.styles.fillColor = [220, 252, 231]; // Light green
                                    data.cell.styles.textColor = [22, 101, 52]; // Dark green
                                } else if (status.includes('warning')) {
                                    data.cell.styles.fillColor = [254, 243, 199]; // Light yellow
                                    data.cell.styles.textColor = [146, 64, 14]; // Dark yellow
                                } else if (status.includes('critical')) {
                                    data.cell.styles.fillColor = [254, 242, 242]; // Light red
                                    data.cell.styles.textColor = [220, 38, 38]; // Dark red
                                }
                            }
                            
                            // Color-code utilization cells
                            if (data.column.index === 4) { // Utilization column
                                const utilization = parseInt(data.cell.text[0]);
                                if (utilization >= 90) {
                                    data.cell.styles.textColor = [220, 38, 38]; // Red
                                    data.cell.styles.fontStyle = 'bold';
                                } else if (utilization >= 75) {
                                    data.cell.styles.textColor = [217, 119, 6]; // Orange
                                    data.cell.styles.fontStyle = 'bold';
                                } else {
                                    data.cell.styles.textColor = [22, 101, 52]; // Green
                                }
                            }
                        }
                    });
                    
                    yPosition = doc.lastAutoTable.finalY + 20;
                } else {
                    // Fallback table without autoTable
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    
                    // Table headers
                    const headers = ['Department', 'Budget', 'Spent', 'Remaining', 'Util%', 'Status'];
                    let xPos = margin;
                    headers.forEach((header, index) => {
                        doc.text(header, xPos, yPosition);
                        xPos += [40, 25, 25, 25, 15, 20][index];
                    });
                    
                    yPosition += 8;
                    doc.setFont('helvetica', 'normal');
                    
                    // Table rows
                    budgetData.departments.forEach(dept => {
                        if (yPosition > pageHeight - 30) {
                            doc.addPage();
                            yPosition = 30;
                        }
                        
                        xPos = margin;
                        const rowData = [
                            dept.departmentName.substring(0, 15), // Truncate long names
                            `â‚±${(dept.allocated / 1000).toFixed(0)}k`,
                            `â‚±${(dept.spent / 1000).toFixed(0)}k`,
                            `â‚±${(dept.remaining / 1000).toFixed(0)}k`,
                            `${dept.utilization}%`,
                            dept.status.charAt(0).toUpperCase() + dept.status.slice(1)
                        ];
                        
                        rowData.forEach((data, index) => {
                            doc.text(data, xPos, yPosition);
                            xPos += [40, 25, 25, 25, 15, 20][index];
                        });
                        
                        yPosition += 6;
                    });
                    
                    yPosition += 15;
                }
                
                // Check if we need a new page
                if (yPosition > pageHeight - 80) {
                    doc.addPage();
                    yPosition = 30;
                }
                
                // Budget Recommendations Section
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('BUDGET RECOMMENDATIONS', margin, yPosition);
                yPosition += 10;
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                
                // Generate recommendations based on department status
                const recommendations = [];
                
                budgetData.departments.forEach(dept => {
                    if (dept.status === 'critical') {
                        recommendations.push({
                            type: 'URGENT',
                            department: dept.departmentName,
                            action: 'Immediate budget review required',
                            reason: `Department has exceeded 90% budget utilization (${dept.utilization}%). Risk of budget overrun.`
                        });
                    } else if (dept.status === 'warning') {
                        recommendations.push({
                            type: 'MONITOR',
                            department: dept.departmentName,
                            action: 'Close monitoring recommended',
                            reason: `Department utilization at ${dept.utilization}%. Approaching budget limits.`
                        });
                    } else if (dept.utilization < 30) {
                        recommendations.push({
                            type: 'OPPORTUNITY',
                            department: dept.departmentName,
                            action: 'Consider additional training programs',
                            reason: `Low utilization (${dept.utilization}%). Opportunity for more training initiatives.`
                        });
                    }
                });
                
                // Limit to top 8 recommendations to fit on page
                recommendations.slice(0, 8).forEach((rec, index) => {
                    if (yPosition > pageHeight - 40) {
                        doc.addPage();
                        yPosition = 30;
                    }
                    
                    // Recommendation header with colored indicator
                    doc.setFont('helvetica', 'bold');
                    let color = rec.type === 'URGENT' ? [220, 38, 38] : 
                            rec.type === 'MONITOR' ? [217, 119, 6] : [22, 101, 52];
                    
                    doc.setTextColor(...color);
                    doc.text(`${index + 1}. [${rec.type}] ${rec.department}`, margin, yPosition);
                    yPosition += 6;
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`   Action: ${rec.action}`, margin + 5, yPosition);
                    yPosition += 5;
                    
                    // Wrap long reason text
                    const reasonLines = doc.splitTextToSize(`   Reason: ${rec.reason}`, contentWidth - 10);
                    doc.text(reasonLines, margin + 5, yPosition);
                    yPosition += reasonLines.length * 5 + 3;
                });
                
                // Check if we need a new page for summary
                if (yPosition > pageHeight - 60) {
                    doc.addPage();
                    yPosition = 30;
                }
                
                // Key Insights Summary
                yPosition += 10;
                doc.setFillColor(240, 249, 255);
                doc.rect(margin, yPosition - 5, contentWidth, 35, 'F');
                doc.setDrawColor(59, 130, 246);
                doc.rect(margin, yPosition - 5, contentWidth, 35);
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('KEY INSIGHTS', margin + 5, yPosition + 5);
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                const insights = [
                    `â€¢ ${budgetData.departments.length} departments tracked with total budget of â‚±${totalAllocated.toLocaleString()}`,
                    `â€¢ Overall utilization rate: ${overallUtilization}% (â‚±${totalSpent.toLocaleString()} spent)`,
                    `â€¢ ${statusCounts.critical} departments require immediate attention`,
                    `â€¢ â‚±${totalRemaining.toLocaleString()} remaining budget available for allocation`
                ];
                
                let insightY = yPosition + 15;
                insights.forEach(insight => {
                    doc.text(insight, margin + 5, insightY);
                    insightY += 5;
                });
                
                // Footer on each page
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(100, 100, 100);
                    
                    // Page number
                    doc.text(`Page ${i} of ${pageCount}`, pageWidth - 30, pageHeight - 10);
                    
                    // Document info
                    doc.text('HR Training Budget Report - Confidential', margin, pageHeight - 10);
                    
                    // Generation timestamp
                    doc.text(`Generated: ${new Date().toLocaleString()}`, pageWidth / 2 - 30, pageHeight - 10);
                }
                
                // Save the PDF
                const fileName = `training-budget-report-${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showNotification('Budget report exported to PDF successfully!', 'success');
                console.log('âœ… Budget PDF exported successfully');
                
            } catch (error) {
                console.error('âŒ Error generating budget PDF:', error);
                showNotification('Error generating budget PDF: ' + error.message, 'error');
            }
        }

        // ============================================================================
        // GLOBAL FUNCTION EXPORTS FOR HTML ONCLICK HANDLERS
        // ============================================================================
        window.showDepartmentDetails = showDepartmentDetails;
        window.closeDepartmentDetailsModal = closeDepartmentDetailsModal;
        window.editDepartmentBudget = editDepartmentBudget;
        window.closeEditBudgetModal = closeEditBudgetModal;
        window.handleEditBudgetSubmit = handleEditBudgetSubmit;
        window.exportBudgetReport = exportBudgetReport;

        console.log('âœ… Phase 5: Department Details & Budget Editing implemented');

        // ============================================================================
        // REPLACE: loadApprovalHistory() - ACTUAL IMPLEMENTATION
        // ============================================================================
        async function loadApprovalHistory() {
            try {
                console.log('ðŸ“‹ Loading approval history...');
                
                // Show loading state
                showApprovalHistoryLoading();
                
                const response = await fetch('/hr/training-approval-history', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    approvalHistory = result.data || [];
                    console.log(`âœ… Loaded ${approvalHistory.length} approval records`);
                    
                    renderApprovalHistory();
                    showNotification(`Loaded ${approvalHistory.length} approval records`, 'success');
                    
                } else {
                    throw new Error(result.message || 'Failed to load approval history');
                }
                
            } catch (error) {
                console.error('âŒ Error loading approval history:', error);
                showApprovalHistoryError(error.message);
                showNotification('Failed to load approval history: ' + error.message, 'error');
            }
        }

        // ============================================================================
        // NEW FUNCTION: showApprovalHistoryLoading()
        // ============================================================================
        function showApprovalHistoryLoading() {
            console.log('ðŸ”„ Showing approval history loading state...');
            
            const historyList = document.getElementById('approvalHistoryList');
            if (historyList) {
                historyList.innerHTML = `
                    <div class="loading-state" style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin loading-spinner" style="font-size: 32px; color: #3b82f6; margin-bottom: 15px;"></i>
                        <h3 style="margin: 0 0 10px 0; color: #475569;">Loading Approval History</h3>
                        <p style="margin: 0; color: #64748b;">Fetching training approval records...</p>
                    </div>
                `;
            }
        }

        // ============================================================================
        // NEW FUNCTION: showApprovalHistoryError()
        // ============================================================================
        function showApprovalHistoryError(message) {
            console.log('âŒ Showing approval history error state...');
            
            const historyList = document.getElementById('approvalHistoryList');
            if (historyList) {
                historyList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px; color: #ef4444;"></i>
                        <h3 style="margin: 0 0 10px 0; color: #475569;">Failed to Load History</h3>
                        <p style="margin: 0 0 15px 0;">Error: ${message}</p>
                        <button onclick="loadApprovalHistory()" class="btn btn-primary" 
                                style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            <i class="fas fa-retry"></i> Try Again
                        </button>
                    </div>
                `;
            }
        }

        // ============================================================================
        // NEW FUNCTION: renderApprovalHistory()
        // ============================================================================
        function renderApprovalHistory() {
            console.log(`ðŸŽ¨ Rendering ${approvalHistory.length} approval history records...`);
            
            const historyList = document.getElementById('approvalHistoryList');
            if (!historyList) {
                console.warn('âš ï¸ Approval history list element not found');
                return;
            }
            
            if (approvalHistory.length === 0) {
                historyList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <i class="fas fa-history" style="font-size: 48px; margin-bottom: 15px; color: #cbd5e1;"></i>
                        <h3 style="margin: 0 0 10px 0; color: #475569;">No Approval History</h3>
                        <p style="margin: 0;">No training approvals have been processed yet.</p>
                    </div>
                `;
                return;
            }
            
            const historyHtml = approvalHistory.map(record => {
                const isApproved = record.isApproved;
                const statusClass = isApproved ? 'approved' : 'rejected';
                const statusText = isApproved ? 'Approved' : 'Rejected';
                const statusIcon = isApproved ? 'fa-check-circle' : 'fa-times-circle';
                const statusColor = isApproved ? '#10b981' : '#ef4444';
                
                return `
                    <div class="training-request-item" style="margin-bottom: 15px; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div class="request-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div class="request-info" style="flex: 1;">
                                <h4 style="margin: 0 0 8px 0; color: #1f2937; font-size: 18px;">${record.employeeName}</h4>
                                <div class="request-meta" style="color: #64748b; font-size: 14px; line-height: 1.5;">
                                    ${record.department} â€¢ ${record.jobTitle}<br>
                                    Training: <strong style="color: #1f2937;">${record.trainingName}</strong><br>
                                    Decision Date: ${new Date(record.hrDecisionDate).toLocaleDateString()}<br>
                                    Cost: â‚±${record.cost.toLocaleString()}
                                    ${record.duration ? ` â€¢ ${record.duration} hours` : ''}
                                </div>
                            </div>
                            <div class="request-actions" style="text-align: right;">
                                <div style="margin-bottom: 10px;">
                                    <i class="fas ${statusIcon}" style="color: ${statusColor}; margin-right: 5px;"></i>
                                    <span style="color: ${statusColor}; font-weight: 600; font-size: 16px;">${statusText}</span>
                                </div>
                                <span class="status-badge" style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; 
                                                                background-color: ${statusColor}20; color: ${statusColor};">
                                    ${record.status || 'Completed'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="request-details" style="display: flex; gap: 20px; align-items: start; background: #f8fafc; padding: 15px; border-radius: 6px;">
                            <div style="flex: 1;">
                                <div style="font-size: 14px; margin-bottom: 5px; font-weight: 600; color: #374151;">HR Decision:</div>
                                <div style="font-size: 13px; color: ${statusColor}; font-weight: 600;">
                                    ${statusText}
                                </div>
                                <div style="font-size: 11px; color: #64748b; margin-top: 2px;">
                                    ${new Date(record.hrDecisionDate).toLocaleDateString()} at ${new Date(record.hrDecisionDate).toLocaleTimeString()}
                                </div>
                            </div>
                            
                            <div style="flex: 2; margin: 0 15px;">
                                <div style="font-size: 14px; margin-bottom: 5px; font-weight: 600; color: #374151;">HR Remarks:</div>
                                <div style="font-size: 13px; color: #64748b; font-style: italic; max-height: 60px; overflow: hidden; line-height: 1.4;">
                                    "${record.hrDecisionRemarks || 'No remarks provided'}"
                                </div>
                            </div>
                            
                            <div style="flex: 1;">
                                <div style="font-size: 14px; margin-bottom: 5px; font-weight: 600; color: #374151;">Training Mode:</div>
                                ${record.isOnlineArrangement ? 
                                    '<div style="font-size: 11px; color: #07ACB9; margin-top: 5px;"><i class="fas fa-laptop"></i> Online Training</div>' : 
                                    '<div style="font-size: 11px; color: #f59e0b; margin-top: 5px;"><i class="fas fa-map-marker-alt"></i> Onsite Training</div>'
                                }
                                <div style="font-size: 11px; color: #64748b; margin-top: 5px;">
                                    Request ID: ${record.requestId || 'N/A'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            historyList.innerHTML = historyHtml;
            console.log('âœ… Approval history rendered successfully');
        }

        // ============================================================================
        // NEW FUNCTION: applyHistoryFilters()
        // ============================================================================
        function applyHistoryFilters() {
            console.log('ðŸ” Applying history filters...');
            
            const startDate = document.getElementById('historyStartDate')?.value;
            const endDate = document.getElementById('historyEndDate')?.value;
            const statusFilter = document.getElementById('historyStatusFilter')?.value;
            
            console.log('Filter criteria:', { startDate, endDate, statusFilter });
            
            let filteredHistory = [...approvalHistory];
            
            // Apply date filters
            if (startDate) {
                const startDateTime = new Date(startDate);
                filteredHistory = filteredHistory.filter(record => 
                    new Date(record.hrDecisionDate) >= startDateTime
                );
                console.log(`After start date filter: ${filteredHistory.length} records`);
            }
            
            if (endDate) {
                const endDateTime = new Date(endDate + 'T23:59:59'); // Include full end date
                filteredHistory = filteredHistory.filter(record => 
                    new Date(record.hrDecisionDate) <= endDateTime
                );
                console.log(`After end date filter: ${filteredHistory.length} records`);
            }
            
            // Apply status filter (maps to approval status)
            if (statusFilter) {
                if (statusFilter === 'In Progress') {
                    // Show approved requests
                    filteredHistory = filteredHistory.filter(record => record.isApproved === true);
                } else if (statusFilter === 'Cancelled') {
                    // Show rejected requests
                    filteredHistory = filteredHistory.filter(record => record.isApproved === false);
                }
                console.log(`After status filter: ${filteredHistory.length} records`);
            }
            
            // Temporarily replace history for rendering
            const originalHistory = [...approvalHistory];
            approvalHistory = filteredHistory;
            renderApprovalHistory();
            approvalHistory = originalHistory;
            
            showNotification(`Found ${filteredHistory.length} records matching your criteria`, 'info');
            console.log(`âœ… History filtered to ${filteredHistory.length} records`);
        }

        // ============================================================================
        // NEW FUNCTION: refreshApprovalHistory()
        // ============================================================================
        function refreshApprovalHistory() {
            console.log('ðŸ”„ Refreshing approval history...');
            showNotification('Refreshing approval history...', 'info');
            loadApprovalHistory();
        }

        // ============================================================================
        // REPLACE: filterRequests() - ACTUAL IMPLEMENTATION (Complete pending requests filtering)
        // ============================================================================
        function filterRequests() {
            if (!pendingRequests || pendingRequests.length === 0) {
                console.warn('âš ï¸ No pending requests available for filtering');
                return;
            }
            
            const searchTerm = document.getElementById('requestSearch')?.value.toLowerCase() || '';
            const departmentFilter = document.getElementById('departmentFilter')?.value || '';
            const costRangeFilter = document.getElementById('costRangeFilter')?.value || '';
            
            console.log('ðŸ” Filtering pending requests:', { searchTerm, departmentFilter, costRangeFilter });
            
            filteredRequests = pendingRequests.filter(request => {
                // Search filter - check multiple fields
                if (searchTerm) {
                    const searchableText = `${request.employeeName} ${request.department} ${request.trainingName} ${request.jobTitle}`.toLowerCase();
                    if (!searchableText.includes(searchTerm)) {
                        return false;
                    }
                }
                
                // Department filter
                if (departmentFilter && request.department !== departmentFilter) {
                    return false;
                }
                
                // Cost range filter
                if (costRangeFilter) {
                    const cost = request.cost;
                    switch (costRangeFilter) {
                        case '0-10000':
                            if (cost < 0 || cost > 10000) return false;
                            break;
                        case '10000-50000':
                            if (cost < 10000 || cost > 50000) return false;
                            break;
                        case '50000-100000':
                            if (cost < 50000 || cost > 100000) return false;
                            break;
                        case '100000+':
                            if (cost < 100000) return false;
                            break;
                    }
                }
                
                return true;
            });
            
            console.log(`âœ… Filtered to ${filteredRequests.length} of ${pendingRequests.length} requests`);
            renderPendingRequests();
        }

        // ============================================================================
        // NEW FUNCTION: clearFilters() - Clear pending requests filters
        // ============================================================================
        function clearFilters() {
            console.log('ðŸ§¹ Clearing pending request filters...');
            
            const requestSearch = document.getElementById('requestSearch');
            const departmentFilter = document.getElementById('departmentFilter');
            const costRangeFilter = document.getElementById('costRangeFilter');
            
            if (requestSearch) requestSearch.value = '';
            if (departmentFilter) departmentFilter.value = '';
            if (costRangeFilter) costRangeFilter.value = '';
            
            // Reset to show all requests
            filteredRequests = [...pendingRequests];
            renderPendingRequests();
            
            showNotification('Filters cleared', 'info');
            console.log('âœ… Pending request filters cleared');
        }

        // ============================================================================
        // NEW FUNCTION: clearHistoryFilters() - Clear history filters
        // ============================================================================
        function clearHistoryFilters() {
            console.log('ðŸ§¹ Clearing history filters...');
            
            const historyStartDate = document.getElementById('historyStartDate');
            const historyEndDate = document.getElementById('historyEndDate');
            const historyStatusFilter = document.getElementById('historyStatusFilter');
            
            if (historyStartDate) historyStartDate.value = '';
            if (historyEndDate) historyEndDate.value = '';
            if (historyStatusFilter) historyStatusFilter.value = '';
            
            // Re-render original history
            renderApprovalHistory();
            
            showNotification('History filters cleared', 'info');
            console.log('âœ… History filters cleared');
        }

        // ============================================================================
        // NEW FUNCTION: setDefaultHistoryDates() - Helper to set common date ranges
        // ============================================================================
        function setDefaultHistoryDates() {
            const historyStartDate = document.getElementById('historyStartDate');
            const historyEndDate = document.getElementById('historyEndDate');
            
            if (historyStartDate && historyEndDate) {
                // Set to current month by default
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                
                historyStartDate.value = firstDay.toISOString().split('T')[0];
                historyEndDate.value = lastDay.toISOString().split('T')[0];
                
                console.log('ðŸ“… Default history date range set to current month');
            }
        }

        // ============================================================================
        // NEW FUNCTION: initializeHistoryFilters() - Set up history tab default state
        // ============================================================================
        function initializeHistoryFilters() {
            console.log('ðŸ”§ Initializing history filters...');
            
            // Set default date range when history tab is activated
            setDefaultHistoryDates();
            
            // Add event listeners for filter changes
            const historyStartDate = document.getElementById('historyStartDate');
            const historyEndDate = document.getElementById('historyEndDate');
            const historyStatusFilter = document.getElementById('historyStatusFilter');
            
            if (historyStartDate) {
                historyStartDate.addEventListener('change', applyHistoryFilters);
            }
            if (historyEndDate) {
                historyEndDate.addEventListener('change', applyHistoryFilters);
            }
            if (historyStatusFilter) {
                historyStatusFilter.addEventListener('change', applyHistoryFilters);
            }
            
            console.log('âœ… History filters initialized');
        }

        // ============================================================================
        // GLOBAL FUNCTION EXPORTS FOR HTML ONCLICK HANDLERS
        // ============================================================================
        window.loadApprovalHistory = loadApprovalHistory;
        window.refreshApprovalHistory = refreshApprovalHistory;
        window.applyHistoryFilters = applyHistoryFilters;
        window.clearFilters = clearFilters;
        window.clearHistoryFilters = clearHistoryFilters;
        window.filterRequests = filterRequests;
        window.setDefaultHistoryDates = setDefaultHistoryDates;

        console.log('âœ… Phase 6: Approval History & Filtering (Final Phase) implemented');
        // ============================================================================
        // ERROR HANDLING
        // ============================================================================
        window.addEventListener('error', function(e) {
            console.error('âŒ JavaScript Error:', e.error);
            showNotification('An unexpected error occurred. Please refresh the page.', 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('âŒ Unhandled Promise Rejection:', e.reason);
            showNotification('An unexpected error occurred. Please try again.', 'error');
        });

        async function loadTrainingAnalyticsData() {
            try {
                console.log('ðŸ“Š Loading training analytics data...');
                
                // Show loading state
                showAnalyticsLoading();
                
                const response = await fetch('/hr/training-analytics', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    analyticsData = result.data;
                    filteredAnalyticsData = { ...analyticsData };
                    
                    console.log('âœ… Analytics data loaded:', analyticsData);
                    
                    renderAnalyticsSummary();
                    renderNeedsVsCompletionChart();
                    renderPerformanceTrendChart();
                    renderEffectivenessChart();
                    renderCategoryDistributionChart();
                    renderTrainingGapTable();
                    renderBudgetRecommendations();
                    populateAnalyticsFilters();
                    
                    showNotification('Training analytics loaded successfully', 'success');
                    
                } else {
                    throw new Error(result.message || 'Failed to load training analytics');
                }
                
            } catch (error) {
                console.error('âŒ Error loading analytics data:', error);
                showAnalyticsError(error.message);
                showNotification('Failed to load analytics: ' + error.message, 'error');
            }
        }

        function showAnalyticsLoading() {
            console.log('ðŸ”„ Showing analytics loading state...');
            
            // Update summary cards to loading state
            const summaryElements = [
                'trainingCompletionRate',
                'performanceImprovement', 
                'trainingEffectiveness',
                'totalTrainingsCompleted'
            ];
            
            summaryElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = '...';
            });
        }

        function showAnalyticsError(message) {
            console.log('âŒ Showing analytics error state...');
            
            const errorHTML = `
                <div style="text-align: center; padding: 40px; color: #64748b;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px; color: #ef4444;"></i>
                    <h3 style="margin: 0 0 10px 0; color: #475569;">Failed to Load Analytics</h3>
                    <p style="margin: 0 0 15px 0;">${message}</p>
                    <button onclick="loadTrainingAnalyticsData()" class="btn btn-primary" 
                            style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-retry"></i> Try Again
                    </button>
                </div>
            `;
            
            // Apply error state to all charts
            const chartContainers = [
                'needsVsCompletionChart',
                'performanceTrendChart', 
                'effectivenessChart',
                'categoryDistributionChart',
                'trainingGapTable',
                'budgetRecommendations'
            ];
            
            chartContainers.forEach(id => {
                const container = document.getElementById(id);
                if (container) container.innerHTML = errorHTML;
            });
        }

        function renderAnalyticsSummary() {
            console.log('ðŸ“Š Rendering analytics summary cards...');
            
            if (!filteredAnalyticsData) return;
            
            const { summary } = filteredAnalyticsData;
            
            // Update summary cards
            const completionRate = document.getElementById('trainingCompletionRate');
            if (completionRate) completionRate.textContent = `${summary.completionRate}%`;
            
            const performanceImprovement = document.getElementById('performanceImprovement');
            if (performanceImprovement) performanceImprovement.textContent = `${summary.avgPerformanceImprovement}%`;
            
            const effectiveness = document.getElementById('trainingEffectiveness');
            if (effectiveness) effectiveness.textContent = `${summary.avgEffectiveness}%`;
            
            const totalTrainings = document.getElementById('totalTrainingsCompleted');
            if (totalTrainings) totalTrainings.textContent = summary.totalCompletedTrainings;
            
            console.log('âœ… Analytics summary cards updated');
        }

        function renderNeedsVsCompletionChart() {
            console.log('ðŸ“Š Rendering needs vs completion chart...');
            
            if (!filteredAnalyticsData) return;
            
            const container = document.getElementById('needsVsCompletionChart');
            if (!container) return;
            
            const { needsVsCompletion } = filteredAnalyticsData;
            
            let chartHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 12px; font-weight: 600; color: #374151;">Training Category</span>
                        <span style="font-size: 12px; font-weight: 600; color: #374151;">Completion Rate</span>
                    </div>
            `;
            
            needsVsCompletion.forEach(item => {
                const completionPercentage = item.required > 0 ? Math.round((item.completed / item.required) * 100) : 0;
                const barColor = completionPercentage >= 80 ? '#10b981' : completionPercentage >= 60 ? '#f59e0b' : '#ef4444';
                
                chartHTML += `
                    <div style="margin-bottom: 12px; padding: 10px; background: #f8fafc; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span style="font-size: 14px; font-weight: 500; color: #1f2937;">${item.category}</span>
                            <span style="font-size: 12px; color: #64748b;">${item.completed}/${item.required}</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${completionPercentage}%; height: 100%; background: ${barColor}; transition: width 0.3s;"></div>
                        </div>
                        <div style="text-align: right; margin-top: 2px;">
                            <span style="font-size: 11px; font-weight: 600; color: ${barColor};">${completionPercentage}%</span>
                        </div>
                    </div>
                `;
            });
            
            chartHTML += '</div>';
            container.innerHTML = chartHTML;
            
            console.log('âœ… Needs vs completion chart rendered');
        }

        function renderPerformanceTrendChart() {
            console.log('ðŸ“Š Rendering performance trend chart...');
            
            if (!filteredAnalyticsData) return;
            
            const container = document.getElementById('performanceTrendChart');
            if (!container) return;
            
            const { performanceTrend } = filteredAnalyticsData;
            
            let chartHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 12px; font-weight: 600; color: #374151;">Month</span>
                        <span style="font-size: 12px; font-weight: 600; color: #374151;">Avg Improvement</span>
                    </div>
            `;
            
            const maxImprovement = Math.max(...performanceTrend.map(item => item.avgImprovement));
            
            performanceTrend.forEach(item => {
                const barHeight = maxImprovement > 0 ? Math.round((item.avgImprovement / maxImprovement) * 100) : 0;
                const barColor = item.avgImprovement >= 15 ? '#10b981' : item.avgImprovement >= 10 ? '#f59e0b' : '#ef4444';
                
                chartHTML += `
                    <div style="margin-bottom: 12px; padding: 10px; background: #f8fafc; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span style="font-size: 14px; font-weight: 500; color: #1f2937;">${item.month}</span>
                            <span style="font-size: 12px; color: #64748b;">${item.trainingCount} trainings</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${barHeight}%; height: 100%; background: ${barColor}; transition: width 0.3s;"></div>
                        </div>
                        <div style="text-align: right; margin-top: 2px;">
                            <span style="font-size: 11px; font-weight: 600; color: ${barColor};">+${item.avgImprovement}%</span>
                        </div>
                    </div>
                `;
            });
            
            chartHTML += '</div>';
            container.innerHTML = chartHTML;
            
            console.log('âœ… Performance trend chart rendered');
        }

        function renderEffectivenessChart() {
            console.log('ðŸ“Š Rendering effectiveness chart...');
            
            if (!filteredAnalyticsData) return;
            
            const container = document.getElementById('effectivenessChart');
            if (!container) return;
            
            const { effectiveness } = filteredAnalyticsData;
            
            let chartHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 12px; font-weight: 600; color: #374151;">Training Type</span>
                        <span style="font-size: 12px; font-weight: 600; color: #374151;">Success Rate</span>
                    </div>
            `;
            
            effectiveness.forEach(item => {
                const barColor = item.successRate >= 80 ? '#10b981' : item.successRate >= 60 ? '#f59e0b' : '#ef4444';
                
                chartHTML += `
                    <div style="margin-bottom: 12px; padding: 10px; background: #f8fafc; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span style="font-size: 14px; font-weight: 500; color: #1f2937;">${item.category}</span>
                            <span style="font-size: 12px; color: #64748b;">${item.totalTrainings} trainings</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${item.successRate}%; height: 100%; background: ${barColor}; transition: width 0.3s;"></div>
                        </div>
                        <div style="text-align: right; margin-top: 2px;">
                            <span style="font-size: 11px; font-weight: 600; color: ${barColor};">${item.successRate}%</span>
                        </div>
                    </div>
                `;
            });
            
            chartHTML += '</div>';
            container.innerHTML = chartHTML;
            
            console.log('âœ… Effectiveness chart rendered');
        }

        function renderCategoryDistributionChart() {
            console.log('ðŸ“Š Rendering category distribution chart...');
            
            if (!filteredAnalyticsData) return;
            
            const container = document.getElementById('categoryDistributionChart');
            if (!container) return;
            
            const { categoryDistribution } = filteredAnalyticsData;
            const total = categoryDistribution.reduce((sum, item) => sum + item.count, 0);
            
            let chartHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <span style="font-size: 24px; font-weight: 700; color: #1f2937;">${total}</span>
                        <div style="font-size: 12px; color: #64748b;">Total Trainings</div>
                    </div>
            `;
            
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
            
            categoryDistribution.forEach((item, index) => {
                const percentage = total > 0 ? Math.round((item.count / total) * 100) : 0;
                const color = colors[index % colors.length];
                
                chartHTML += `
                    <div style="display: flex; align-items: center; margin-bottom: 8px; padding: 8px; background: #f8fafc; border-radius: 6px;">
                        <div style="width: 12px; height: 12px; background: ${color}; border-radius: 50%; margin-right: 10px;"></div>
                        <div style="flex: 1;">
                            <div style="font-size: 14px; font-weight: 500; color: #1f2937;">${item.category}</div>
                            <div style="font-size: 12px; color: #64748b;">${item.count} trainings</div>
                        </div>
                        <div style="font-size: 14px; font-weight: 600; color: ${color};">${percentage}%</div>
                    </div>
                `;
            });
            
            chartHTML += '</div>';
            container.innerHTML = chartHTML;
            
            console.log('âœ… Category distribution chart rendered');
        }

        function renderTrainingGapTable() {
            console.log('ðŸ“Š Rendering training gap table...');
            
            if (!filteredAnalyticsData) return;
            
            const container = document.getElementById('trainingGapTable');
            if (!container) return;
            
            const { departmentGaps } = filteredAnalyticsData;
            
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; background: white;">
                    <thead>
                        <tr style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Department</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Required</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Completed</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Gap</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Completion Rate</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Priority</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            departmentGaps.forEach(dept => {
                const completionRate = dept.required > 0 ? Math.round((dept.completed / dept.required) * 100) : 0;
                const gap = dept.required - dept.completed;
                const priority = gap > 10 ? 'High' : gap > 5 ? 'Medium' : 'Low';
                const priorityColor = priority === 'High' ? '#ef4444' : priority === 'Medium' ? '#f59e0b' : '#10b981';
                
                tableHTML += `
                    <tr style="border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 12px; font-weight: 500; color: #1f2937;">${dept.departmentName}</td>
                        <td style="padding: 12px; text-align: center; color: #64748b;">${dept.required}</td>
                        <td style="padding: 12px; text-align: center; color: #64748b;">${dept.completed}</td>
                        <td style="padding: 12px; text-align: center; font-weight: 600; color: ${gap > 0 ? '#ef4444' : '#10b981'};">${gap}</td>
                        <td style="padding: 12px; text-align: center; font-weight: 600; color: ${completionRate >= 80 ? '#10b981' : completionRate >= 60 ? '#f59e0b' : '#ef4444'};">${completionRate}%</td>
                        <td style="padding: 12px; text-align: center;">
                            <span style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; background-color: ${priorityColor}20; color: ${priorityColor};">
                                ${priority}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
            console.log('âœ… Training gap table rendered');
        }

        function renderBudgetRecommendations() {
            console.log('ðŸ“Š Rendering budget recommendations...');
            
            if (!filteredAnalyticsData) return;
            
            const container = document.getElementById('budgetRecommendations');
            if (!container) return;
            
            const { budgetRecommendations } = filteredAnalyticsData;
            
            let recommendationsHTML = `
                <div style="margin-bottom: 15px;">
            `;
            
            budgetRecommendations.forEach((rec, index) => {
                const iconColor = rec.type === 'increase' ? '#10b981' : rec.type === 'decrease' ? '#ef4444' : '#3b82f6';
                const icon = rec.type === 'increase' ? 'fa-arrow-up' : rec.type === 'decrease' ? 'fa-arrow-down' : 'fa-balance-scale';
                
                recommendationsHTML += `
                    <div style="margin-bottom: 12px; padding: 15px; background: #f8fafc; border-radius: 8px; border-left: 4px solid ${iconColor};">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <i class="fas ${icon}" style="color: ${iconColor}; margin-right: 8px; font-size: 16px;"></i>
                            <span style="font-size: 16px; font-weight: 600; color: #1f2937;">${rec.department}</span>
                            <span style="margin-left: auto; font-size: 14px; font-weight: 600; color: ${iconColor};">â‚±${rec.recommendedAmount.toLocaleString()}</span>
                        </div>
                        <p style="margin: 0; color: #64748b; font-size: 14px; line-height: 1.5;">${rec.reason}</p>
                        <div style="margin-top: 8px; font-size: 12px; color: #8b5cf6;">
                            <strong>Expected Impact:</strong> ${rec.expectedImpact}
                        </div>
                    </div>
                `;
            });
            
            recommendationsHTML += '</div>';
            container.innerHTML = recommendationsHTML;
            
            console.log('âœ… Budget recommendations rendered');
        }

        function populateAnalyticsFilters() {
            console.log('ðŸ“Š Populating analytics filters...');
            
            if (!analyticsData) return;
            
            // Populate department filter
            const depFilter = document.getElementById('analyticsDepFilter');
            if (depFilter && analyticsData.departments) {
                depFilter.innerHTML = '<option value="">All Departments</option>';
                analyticsData.departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    depFilter.appendChild(option);
                });
            }
            
            // Populate category filter
            const categoryFilter = document.getElementById('analyticsCategoryFilter');
            if (categoryFilter && analyticsData.categories) {
                categoryFilter.innerHTML = '<option value="">All Categories</option>';
                analyticsData.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                });
            }
            
            console.log('âœ… Analytics filters populated');
        }

        function applyAnalyticsFilters() {
            console.log('ðŸ” Applying analytics filters...');
            // This will be implemented later when we have the backend
            showNotification('Filters applied', 'info');
        }

        function clearAnalyticsFilters() {
            console.log('ðŸ§¹ Clearing analytics filters...');
            
            const depFilter = document.getElementById('analyticsDepFilter');
            const categoryFilter = document.getElementById('analyticsCategoryFilter');
            const timeFilter = document.getElementById('analyticsTimeFilter');
            
            if (depFilter) depFilter.value = '';
            if (categoryFilter) categoryFilter.value = '';
            if (timeFilter) timeFilter.value = 'thisYear';
            
            // Reload data
            if (analyticsData) {
                filteredAnalyticsData = { ...analyticsData };
                renderAnalyticsSummary();
                renderNeedsVsCompletionChart();
                renderPerformanceTrendChart();
                renderEffectivenessChart();
                renderCategoryDistributionChart();
                renderTrainingGapTable();
                renderBudgetRecommendations();
            }
            
            showNotification('Analytics filters cleared', 'info');
        }

        function refreshAnalyticsData() {
            console.log('ðŸ”„ Refreshing analytics data...');
            showNotification('Refreshing analytics data...', 'info');
            loadTrainingAnalyticsData();
        }

        function exportAnalyticsReport(format) {
            console.log(`ðŸ“Š Exporting analytics report in ${format} format...`);
            
            if (!filteredAnalyticsData) {
                showNotification('No analytics data available to export', 'error');
                return;
            }
            
            if (format === 'excel') {
                exportAnalyticsToExcel();
            } else if (format === 'pdf') {
                // Show PDF options
                const pdfOption = confirm('Choose PDF type:\nOK = Detailed Report\nCancel = Summary Only');
                if (pdfOption) {
                    exportAnalyticsToPDF(); // Detailed
                } else {
                    exportAnalyticsSummaryPDF(); // Summary
                }
            } else {
                showNotification('Unsupported export format', 'error');
            }
        }

        function exportAnalyticsToExcel() {
            console.log('ðŸ“— Exporting analytics data to Excel...');
            
            // Create CSV data for department gaps
            const headers = ['Department', 'Required Trainings', 'Completed Trainings', 'Gap', 'Completion Rate %', 'Priority'];
            const rows = filteredAnalyticsData.departmentGaps.map(dept => {
                const completionRate = dept.required > 0 ? Math.round((dept.completed / dept.required) * 100) : 0;
                const gap = dept.required - dept.completed;
                const priority = gap > 10 ? 'High' : gap > 5 ? 'Medium' : 'Low';
                
                return [
                    dept.departmentName,
                    dept.required,
                    dept.completed,
                    gap,
                    completionRate,
                    priority
                ];
            });
            
            const csvContent = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
            
            // Download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `training-analytics-report-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            window.URL.revokeObjectURL(url);
            
            showNotification('Analytics report exported to Excel format', 'success');
        }

        function exportAnalyticsToPDF() {
            console.log('ðŸ“• Exporting analytics data to PDF...');
            
            if (!filteredAnalyticsData) {
                showNotification('No analytics data available to export', 'error');
                return;
            }
            
            try {
                // Check if jsPDF is available
                if (typeof window.jspdf === 'undefined') {
                    showNotification('PDF library not loaded. Please refresh the page.', 'error');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Set up the PDF
                let yPosition = 20;
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 20;
                const contentWidth = pageWidth - (margin * 2);
                
                // Title
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('Training Analytics Report', margin, yPosition);
                
                yPosition += 10;
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, margin, yPosition);
                
                yPosition += 20;
                
                // Summary Section
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Executive Summary', margin, yPosition);
                yPosition += 10;
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                
                const summary = filteredAnalyticsData.summary;
                const summaryText = [
                    `Training Completion Rate: ${summary.completionRate}%`,
                    `Average Performance Improvement: ${summary.avgPerformanceImprovement}%`,
                    `Training Effectiveness: ${summary.avgEffectiveness}%`,
                    `Total Trainings Completed: ${summary.totalCompletedTrainings}`
                ];
                
                summaryText.forEach(text => {
                    doc.text(text, margin, yPosition);
                    yPosition += 6;
                });
                
                yPosition += 10;
                
                // Training Needs vs Completion Table
                if (filteredAnalyticsData.needsVsCompletion && filteredAnalyticsData.needsVsCompletion.length > 0) {
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Training Needs vs Completion Analysis', margin, yPosition);
                    yPosition += 10;
                    
                    // Check if autoTable is available
                    if (doc.autoTable) {
                        doc.autoTable({
                            head: [['Category', 'Required', 'Completed', 'Completion Rate']],
                            body: filteredAnalyticsData.needsVsCompletion.map(item => [
                                item.category,
                                item.required.toString(),
                                item.completed.toString(),
                                `${item.required > 0 ? Math.round((item.completed / item.required) * 100) : 0}%`
                            ]),
                            startY: yPosition,
                            margin: { left: margin, right: margin },
                            styles: { fontSize: 10 },
                            headStyles: { fillColor: [59, 130, 246] }
                        });
                        
                        yPosition = doc.lastAutoTable.finalY + 15;
                    } else {
                        // Fallback if autoTable is not available
                        doc.setFontSize(10);
                        filteredAnalyticsData.needsVsCompletion.forEach(item => {
                            const completionRate = item.required > 0 ? Math.round((item.completed / item.required) * 100) : 0;
                            doc.text(`${item.category}: ${item.completed}/${item.required} (${completionRate}%)`, margin, yPosition);
                            yPosition += 5;
                        });
                        yPosition += 10;
                    }
                }
                
                // Check if we need a new page
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Department Gap Analysis
                if (filteredAnalyticsData.departmentGaps && filteredAnalyticsData.departmentGaps.length > 0) {
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Department Training Gap Analysis', margin, yPosition);
                    yPosition += 10;
                    
                    if (doc.autoTable) {
                        doc.autoTable({
                            head: [['Department', 'Required', 'Completed', 'Gap', 'Completion Rate', 'Priority']],
                            body: filteredAnalyticsData.departmentGaps.map(dept => {
                                const completionRate = dept.required > 0 ? Math.round((dept.completed / dept.required) * 100) : 0;
                                const gap = dept.required - dept.completed;
                                const priority = gap > 10 ? 'High' : gap > 5 ? 'Medium' : 'Low';
                                
                                return [
                                    dept.departmentName,
                                    dept.required.toString(),
                                    dept.completed.toString(),
                                    gap.toString(),
                                    `${completionRate}%`,
                                    priority
                                ];
                            }),
                            startY: yPosition,
                            margin: { left: margin, right: margin },
                            styles: { fontSize: 9 },
                            headStyles: { fillColor: [139, 92, 246] }
                        });
                        
                        yPosition = doc.lastAutoTable.finalY + 15;
                    } else {
                        // Fallback without autoTable
                        doc.setFontSize(10);
                        filteredAnalyticsData.departmentGaps.forEach(dept => {
                            const completionRate = dept.required > 0 ? Math.round((dept.completed / dept.required) * 100) : 0;
                            const gap = dept.required - dept.completed;
                            doc.text(`${dept.departmentName}: ${completionRate}% (Gap: ${gap})`, margin, yPosition);
                            yPosition += 5;
                        });
                        yPosition += 10;
                    }
                }
                
                // Check if we need a new page
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Training Effectiveness
                if (filteredAnalyticsData.effectiveness && filteredAnalyticsData.effectiveness.length > 0) {
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Training Effectiveness by Category', margin, yPosition);
                    yPosition += 10;
                    
                    if (doc.autoTable) {
                        doc.autoTable({
                            head: [['Training Category', 'Total Trainings', 'Success Rate']],
                            body: filteredAnalyticsData.effectiveness.map(item => [
                                item.category,
                                item.totalTrainings.toString(),
                                `${item.successRate}%`
                            ]),
                            startY: yPosition,
                            margin: { left: margin, right: margin },
                            styles: { fontSize: 10 },
                            headStyles: { fillColor: [217, 119, 6] }
                        });
                        
                        yPosition = doc.lastAutoTable.finalY + 15;
                    } else {
                        // Fallback without autoTable
                        doc.setFontSize(10);
                        filteredAnalyticsData.effectiveness.forEach(item => {
                            doc.text(`${item.category}: ${item.successRate}% (${item.totalTrainings} trainings)`, margin, yPosition);
                            yPosition += 5;
                        });
                        yPosition += 10;
                    }
                }
                
                // Check if we need a new page
                if (yPosition > 220) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Budget Recommendations
                if (filteredAnalyticsData.budgetRecommendations && filteredAnalyticsData.budgetRecommendations.length > 0) {
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Budget Allocation Recommendations', margin, yPosition);
                    yPosition += 10;
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    
                    filteredAnalyticsData.budgetRecommendations.forEach((rec, index) => {
                        if (yPosition > 260) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        
                        // Department name
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${index + 1}. ${rec.department}`, margin, yPosition);
                        yPosition += 6;
                        
                        // Recommendation details
                        doc.setFont('helvetica', 'normal');
                        doc.text(`   Recommended Amount: â‚±${rec.recommendedAmount.toLocaleString()}`, margin, yPosition);
                        yPosition += 5;
                        doc.text(`   Type: ${rec.type.charAt(0).toUpperCase() + rec.type.slice(1)}`, margin, yPosition);
                        yPosition += 5;
                        
                        // Wrap long text
                        const reasonLines = doc.splitTextToSize(`   Reason: ${rec.reason}`, contentWidth - 10);
                        doc.text(reasonLines, margin, yPosition);
                        yPosition += reasonLines.length * 5;
                        
                        const impactLines = doc.splitTextToSize(`   Expected Impact: ${rec.expectedImpact}`, contentWidth - 10);
                        doc.text(impactLines, margin, yPosition);
                        yPosition += impactLines.length * 5 + 5;
                    });
                }
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Page ${i} of ${pageCount}`, pageWidth - 30, doc.internal.pageSize.getHeight() - 10);
                    doc.text('HR Training Analytics Report', margin, doc.internal.pageSize.getHeight() - 10);
                }
                
                // Save the PDF
                const fileName = `training-analytics-report-${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showNotification('Training analytics report exported to PDF successfully!', 'success');
                console.log('âœ… PDF exported successfully');
                
            } catch (error) {
                console.error('âŒ Error generating PDF:', error);
                showNotification('Error generating PDF: ' + error.message, 'error');
            }
        }

        // Enhanced PDF export with charts 
        function exportAnalyticsToAdvancedPDF() {
            console.log('ðŸ“• Exporting advanced analytics PDF with charts...');
            
            if (!filteredAnalyticsData) {
                showNotification('No analytics data available to export', 'error');
                return;
            }
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Advanced PDF with visual elements
                let yPosition = 20;
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 20;
                
                // Header with background
                doc.setFillColor(59, 130, 246);
                doc.rect(0, 0, pageWidth, 40, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('TRAINING ANALYTICS REPORT', margin, 25);
                
                doc.setFontSize(12);
                doc.text(`Generated: ${new Date().toLocaleDateString()} | Confidential`, margin, 35);
                
                // Reset text color
                doc.setTextColor(0, 0, 0);
                yPosition = 60;
                
                // Executive Summary Box
                doc.setFillColor(248, 250, 252);
                doc.rect(margin, yPosition - 5, pageWidth - (margin * 2), 40, 'F');
                doc.setDrawColor(59, 130, 246);
                doc.rect(margin, yPosition - 5, pageWidth - (margin * 2), 40);
                
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('EXECUTIVE SUMMARY', margin + 5, yPosition + 5);
                
                // Summary metrics in a grid
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                const summary = filteredAnalyticsData.summary;
                
                const summaryMetrics = [
                    [`Completion Rate: ${summary.completionRate}%`, `Performance Improvement: +${summary.avgPerformanceImprovement}%`],
                    [`Training Effectiveness: ${summary.avgEffectiveness}%`, `Total Trainings: ${summary.totalCompletedTrainings}`]
                ];
                
                let summaryY = yPosition + 15;
                summaryMetrics.forEach(row => {
                    doc.text(row[0], margin + 5, summaryY);
                    doc.text(row[1], margin + 90, summaryY);
                    summaryY += 8;
                });
                
                yPosition += 50;
                
                // Use the same table logic as the basic PDF but with enhanced styling
                // ... rest of the content similar to exportAnalyticsToPDF but with better formatting
                
                // Save with timestamp
                const fileName = `training-analytics-advanced-${new Date().toISOString().split('T')[0]}-${Date.now()}.pdf`;
                doc.save(fileName);
                
                showNotification('Advanced analytics report exported successfully!', 'success');
                
            } catch (error) {
                console.error('âŒ Error generating advanced PDF:', error);
                showNotification('Error generating advanced PDF: ' + error.message, 'error');
            }
        }

        // Quick summary PDF export
        function exportAnalyticsSummaryPDF() {
            console.log('ðŸ“„ Exporting analytics summary PDF...');
            
            if (!filteredAnalyticsData) {
                showNotification('No analytics data available to export', 'error');
                return;
            }
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const margin = 20;
                let yPosition = 30;
                
                // Title
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('Training Analytics Summary', margin, yPosition);
                
                yPosition += 20;
                
                // Key Metrics
                doc.setFontSize(14);
                doc.text('Key Performance Indicators', margin, yPosition);
                yPosition += 10;
                
                const summary = filteredAnalyticsData.summary;
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                
                const kpis = [
                    `Training Completion Rate: ${summary.completionRate}%`,
                    `Average Performance Improvement: ${summary.avgPerformanceImprovement}%`,
                    `Training Effectiveness: ${summary.avgEffectiveness}%`,
                    `Total Completed Trainings: ${summary.totalCompletedTrainings}`
                ];
                
                kpis.forEach(kpi => {
                    doc.text(`â€¢ ${kpi}`, margin + 5, yPosition);
                    yPosition += 8;
                });
                
                yPosition += 10;
                
                // Top Recommendations
                if (filteredAnalyticsData.budgetRecommendations && filteredAnalyticsData.budgetRecommendations.length > 0) {
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Top Recommendations', margin, yPosition);
                    yPosition += 10;
                    
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'normal');
                    
                    filteredAnalyticsData.budgetRecommendations.slice(0, 3).forEach((rec, index) => {
                        doc.text(`${index + 1}. ${rec.department}: ${rec.type} budget`, margin + 5, yPosition);
                        yPosition += 6;
                        const reasonLines = doc.splitTextToSize(`   ${rec.reason}`, 160);
                        doc.text(reasonLines, margin + 10, yPosition);
                        yPosition += reasonLines.length * 5 + 5;
                    });
                }
                
                // Footer
                doc.setFontSize(8);
                doc.text(`Generated: ${new Date().toLocaleString()}`, margin, 280);
                
                // Save
                const fileName = `training-summary-${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showNotification('Training summary exported to PDF!', 'success');
                
            } catch (error) {
                console.error('âŒ Error generating summary PDF:', error);
                showNotification('Error generating summary PDF: ' + error.message, 'error');
            }
        }


        // Export functions for HTML onclick handlers
        window.loadTrainingAnalyticsData = loadTrainingAnalyticsData;
        window.refreshAnalyticsData = refreshAnalyticsData;
        window.applyAnalyticsFilters = applyAnalyticsFilters;
        window.clearAnalyticsFilters = clearAnalyticsFilters;
        window.exportAnalyticsReport = exportAnalyticsReport;
        window.updateEfficiencyAnalysis = updateEfficiencyAnalysis;
        window.refreshEfficiencyData = refreshEfficiencyData;
        window.loadEfficiencyData = loadEfficiencyData;

        // ============================================================================
        // INITIALIZATION COMPLETE
        // ============================================================================
        console.log('ðŸ“¦ HR Training Approval Dashboard Core JavaScript loaded');
    </script>
</body>
</html>