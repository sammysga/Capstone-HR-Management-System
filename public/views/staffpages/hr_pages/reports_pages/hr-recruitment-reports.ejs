<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recruitment Dashboard & Reports</title>
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/hr_pages.css">
    <link rel="stylesheet" href="/css/recruitment_reports.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <%- include('../../../partials/hr_partials') %>
    
    <div class="main-content">
        <!-- Header -->
        <div class="recruitment-header">
            <h1><i class="fas fa-users"></i> Recruitment Dashboard & Reports</h1>
            <p>Comprehensive recruitment analytics and detailed reporting for applicants, hirees, and recruitment processes</p>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" data-tab="dashboard">
                <i class="fas fa-chart-line"></i> Dashboard
            </button>
            <button class="tab-button" data-tab="reports">
                <i class="fas fa-file-alt"></i> Reports
            </button>
        </div>
        
        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard-tab">
            <!-- Statistics Overview -->
            <div class="stats-container">
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <h3>Total Applicants</h3>
                        <div class="stat-value" id="total-applicants">0</div>
                        <div class="stat-label">All time applications received</div>
                    </div>
                    
                    <div class="stat-card success">
                        <h3>Total Hirees</h3>
                        <div class="stat-value" id="total-hirees">0</div>
                        <div class="stat-label">Successfully hired candidates</div>
                    </div>
                    
                    <div class="stat-card warning">
                        <h3>Pending Applications</h3>
                        <div class="stat-value" id="pending-applications">0</div>
                        <div class="stat-label">Applications awaiting review</div>
                    </div>
                    
                    <div class="stat-card info">
                        <h3>Active MRFs</h3>
                        <div class="stat-value" id="active-mrfs">0</div>
                        <div class="stat-label">Open manpower requisitions</div>
                    </div>
                    
                    <div class="stat-card danger">
                        <h3>Avg. Processing Time</h3>
                        <div class="stat-value" id="avg-processing-time">0</div>
                        <div class="stat-label">Average days to hire</div>
                    </div>
                    
                    <div class="stat-card primary">
                        <h3>This Month Applications</h3>
                        <div class="stat-value" id="monthly-applicants">0</div>
                        <div class="stat-label">New applications this month</div>
                    </div>
                </div>
            </div>
            
            <!-- Charts -->
            <div class="charts-container">
                <div class="chart-card">
                    <h3>Application Status Distribution</h3>
                    <canvas id="statusDistributionChart"></canvas>
                </div>
                
                <div class="chart-card">
                    <h3>Monthly Application Trends</h3>
                    <canvas id="monthlyTrendsChart"></canvas>
                </div>
                
                <div class="chart-card">
                    <h3>Applications by Department</h3>
                    <canvas id="departmentChart"></canvas>
                </div>
                
                <div class="chart-card">
                    <h3>MRF to Hire Timeline</h3>
                    <canvas id="timelineChart"></canvas>
                </div>

                <div class="chart-card funnel-chart">
                    <h3><i class="fas fa-filter"></i> Recruitment Funnel Analysis</h3>
                    <div class="funnel-content">
                        <div class="funnel-metrics">
                            <div class="funnel-metric">
                                <span class="metric-label">Overall Conversion Rate</span>
                                <span class="metric-value" id="overall-conversion-rate">0%</span>
                            </div>
                            <div class="funnel-metric">
                                <span class="metric-label">Biggest Drop-off</span>
                                <span class="metric-value" id="biggest-dropoff">-</span>
                            </div>
                        </div>
                        
                        <!-- CSS Funnel Visualization -->
                        <div class="css-funnel" id="funnel-visualization">
                            <!-- Funnel stages will be generated by JavaScript -->
                        </div>
                        
                        <div class="conversion-rates" id="conversion-rates"></div>
                    </div>
                </div>

                <div class="chart-card time-to-hire-chart">
                    <h3><i class="fas fa-clock"></i> Time-to-Hire Breakdown</h3>
                    <div class="time-to-hire-content">
                        <div class="time-metrics">
                            <div class="time-metric">
                                <span class="metric-label">Average Time-to-Hire</span>
                                <span class="metric-value" id="avg-time-to-hire">0 days</span>
                            </div>
                            <div class="time-metric">
                                <span class="metric-label">Slowest Stage</span>
                                <span class="metric-value" id="slowest-stage">-</span>
                            </div>
                        </div>
                        <canvas id="timeToHireChart"></canvas>
                        <div class="bottleneck-alerts" id="bottleneck-alerts"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Reports Tab -->
        <div class="tab-content" id="reports-tab">
            <div class="reports-container">
                <!-- 1. Applicants Report -->
                <div class="report-card">
                    <div class="report-card-header">
                        <div class="report-icon applicants">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div>
                            <h3 class="report-title">Applicants Report</h3>
                            <p class="report-description">Comprehensive overview of all job applicants with detailed information, screening scores, and status tracking across all recruitment phases</p>
                        </div>
                    </div>
                    
                    <form class="report-form" id="applicants-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="applicants-filter-type">Filter Type</label>
                                <select id="applicants-filter-type" name="filterType" onchange="toggleDateInputs('applicants')">
                                    <option value="month">This Month</option>
                                    <option value="last-month">Last Month</option>
                                    <option value="quarter">This Quarter</option>
                                    <option value="year">This Year</option>
                                    <option value="custom">Custom Date Range</option>
                                </select>
                            </div>
                            <div class="form-group custom-dates" id="applicants-custom-dates" style="display: none;">
                                <label for="applicants-start">Start Date</label>
                                <input type="date" id="applicants-start" name="startDate">
                            </div>
                            <div class="form-group custom-dates" id="applicants-custom-dates-end" style="display: none;">
                                <label for="applicants-end">End Date</label>
                                <input type="date" id="applicants-end" name="endDate">
                            </div>
                            <div class="btn-group">
                                <button type="button" class="btn btn-primary" onclick="generateReport('applicants', 'view')">
                                    <i class="fas fa-eye"></i> View Report
                                </button>
                                <button type="button" class="btn btn-outline" onclick="generateReport('applicants', 'pdf')">
                                    <i class="fas fa-file-pdf"></i> Download PDF
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <div class="report-results" id="applicants-results"></div>
                </div>
                
                <!-- 2. Hirees Report -->
                <div class="report-card">
                    <div class="report-card-header">
                        <div class="report-icon hirees">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div>
                            <h3 class="report-title">Hirees Report</h3>
                            <p class="report-description">Track successfully hired candidates with onboarding timelines, job types, department distribution, and employment details</p>
                        </div>
                    </div>
                    
                    <form class="report-form" id="hirees-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="hirees-filter-type">Filter Type</label>
                                <select id="hirees-filter-type" name="filterType" onchange="toggleDateInputs('hirees')">
                                    <option value="month">This Month</option>
                                    <option value="last-month">Last Month</option>
                                    <option value="quarter">This Quarter</option>
                                    <option value="year">This Year</option>
                                    <option value="custom">Custom Date Range</option>
                                </select>
                            </div>
                            <div class="form-group custom-dates" id="hirees-custom-dates" style="display: none;">
                                <label for="hirees-start">Start Date</label>
                                <input type="date" id="hirees-start" name="startDate">
                            </div>
                            <div class="form-group custom-dates" id="hirees-custom-dates-end" style="display: none;">
                                <label for="hirees-end">End Date</label>
                                <input type="date" id="hirees-end" name="endDate">
                            </div>
                            <div class="btn-group">
                                <button type="button" class="btn btn-primary" onclick="generateReport('hirees', 'view')">
                                    <i class="fas fa-eye"></i> View Report
                                </button>
                                <button type="button" class="btn btn-outline" onclick="generateReport('hirees', 'pdf')">
                                    <i class="fas fa-file-pdf"></i> Download PDF
                                </button>
                            </div>
                        </div>
                    </form>
                    <div class="report-results" id="hirees-results"></div>
                </div>
                
                <!-- 3. Individual Applicant Status Report -->
                <div class="report-card">
                    <div class="report-card-header">
                        <div class="report-icon status">
                            <i class="fas fa-user-cog"></i>
                        </div>
                        <div>
                            <h3 class="report-title">Individual Applicant Status</h3>
                            <p class="report-description">Detailed status tracking and timeline for individual applicant progress through all recruitment stages with comprehensive history</p>
                        </div>
                    </div>
                    
                    <form class="report-form" id="status-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="applicant-search">Select Applicant</label>
                                <div class="searchable-dropdown" id="applicant-dropdown">
                                    <input 
                                        type="text" 
                                        id="applicant-search" 
                                        name="applicantName" 
                                        placeholder="Type applicant name to search..."
                                        autocomplete="off"
                                        required
                                    >
                                    <i class="fas fa-chevron-down dropdown-icon"></i>
                                    <div class="dropdown-menu" id="applicant-dropdown-menu"></div>
                                </div>
                            </div>
                            <div class="btn-group">
                                <button type="button" class="btn btn-primary" onclick="generateReport('status', 'view')">
                                    <i class="fas fa-eye"></i> View Status
                                </button>
                                <button type="button" class="btn btn-outline" onclick="generateReport('status', 'pdf')">
                                    <i class="fas fa-file-pdf"></i> Download PDF
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <div class="report-results" id="status-results"></div>
                </div>
                
                <!-- 4. MRF to Onboarding Timeline -->
                <div class="report-card">
                    <div class="report-card-header">
                        <div class="report-icon timeline">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <div>
                            <h3 class="report-title">MRF to Onboarding Timeline</h3>
                            <p class="report-description">Track manpower requisition forms from initial request through to successful onboarding completion with detailed timeline analysis</p>
                        </div>
                    </div>
                    
                    <form class="report-form" id="timeline-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="timeline-filter-type">Filter Type</label>
                                <select id="timeline-filter-type" name="filterType" onchange="toggleDateInputs('timeline')">
                                    <option value="month">This Month</option>
                                    <option value="last-month">Last Month</option>
                                    <option value="quarter">This Quarter</option>
                                    <option value="year">This Year</option>
                                    <option value="custom">Custom Date Range</option>
                                </select>
                            </div>
                            <div class="form-group custom-dates" id="timeline-custom-dates" style="display: none;">
                                <label for="timeline-start">Start Date</label>
                                <input type="date" id="timeline-start" name="startDate">
                            </div>
                            <div class="form-group custom-dates" id="timeline-custom-dates-end" style="display: none;">
                                <label for="timeline-end">End Date</label>
                                <input type="date" id="timeline-end" name="endDate">
                            </div>
                            <div class="btn-group">
                                <button type="button" class="btn btn-primary" onclick="generateReport('timeline', 'view')">
                                    <i class="fas fa-eye"></i> View Report
                                </button>
                                <button type="button" class="btn btn-outline" onclick="generateReport('timeline', 'pdf')">
                                    <i class="fas fa-file-pdf"></i> Download PDF
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <div class="report-results" id="timeline-results"></div>
                </div>

                <!-- 5. MRF Efficiency Report -->
                <div class="report-card">
                    <div class="report-card-header">
                        <div class="report-icon efficiency">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div>
                            <h3 class="report-title">MRF Efficiency Analysis</h3>
                            <p class="report-description">Track manpower requisition fulfillment rates with intelligent analysis of department performance, bottlenecks, and actionable recommendations for improvement</p>
                        </div>
                    </div>
                    
                    <form class="report-form" id="mrf-efficiency-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="mrf-efficiency-filter-type">Filter Type</label>
                                <select id="mrf-efficiency-filter-type" name="filterType" onchange="toggleDateInputs('mrf-efficiency')">
                                    <option value="month">This Month</option>
                                    <option value="last-month">Last Month</option>
                                    <option value="quarter">This Quarter</option>
                                    <option value="year">This Year</option>
                                    <option value="custom">Custom Date Range</option>
                                </select>
                            </div>
                            <div class="form-group custom-dates" id="mrf-efficiency-custom-dates" style="display: none;">
                                <label for="mrf-efficiency-start">Start Date</label>
                                <input type="date" id="mrf-efficiency-start" name="startDate">
                            </div>
                            <div class="form-group custom-dates" id="mrf-efficiency-custom-dates-end" style="display: none;">
                                <label for="mrf-efficiency-end">End Date</label>
                                <input type="date" id="mrf-efficiency-end" name="endDate">
                            </div>
                            <div class="btn-group">
                                <button type="button" class="btn btn-primary" onclick="generateReport('mrf-efficiency', 'view')">
                                    <i class="fas fa-eye"></i> View Analysis
                                </button>
                                <button type="button" class="btn btn-outline" onclick="generateReport('mrf-efficiency', 'pdf')">
                                    <i class="fas fa-file-pdf"></i> Download PDF
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <div class="report-results" id="mrf-efficiency-results"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        // Global chart variables
        let statusChart, trendsChart, departmentChart, timelineChart;
        let applicantDropdown;
        let funnelChart, timeToHireChart;


        // Tab functionality
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all buttons and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding content
                    button.classList.add('active');
                    const tabId = `${button.dataset.tab}-tab`;
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Load dashboard data when page loads
            loadDashboardData();
            loadChartsData();
            setDefaultDates();

            // Initialize the searchable dropdown
            applicantDropdown = new SearchableApplicantDropdown();
        });
        
        // Load dashboard statistics
        async function loadDashboardData() {
            try {
                console.log('🔄 [Frontend] Loading dashboard data...');
                
                const response = await fetch('/hr/recruitment/dashboard/stats');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('📊 [Frontend] Dashboard response:', result);
                
                if (!result.success) {
                    throw new Error(result.message || 'Failed to fetch dashboard stats');
                }
                
                const stats = result.stats;
                
                // Update dashboard stats with real data
                document.getElementById('total-applicants').textContent = stats.totalApplicants;
                document.getElementById('total-hirees').textContent = stats.totalHirees;
                document.getElementById('pending-applications').textContent = stats.pendingApplications;
                document.getElementById('active-mrfs').textContent = stats.activeMRFs;
                document.getElementById('avg-processing-time').textContent = stats.avgProcessingTime;
                document.getElementById('monthly-applicants').textContent = stats.monthlyApplicants;
                
                console.log('✅ [Frontend] Dashboard updated successfully');
                
            } catch (error) {
                console.error('❌ [Frontend] Error loading dashboard data:', error);
                
                // Show user-friendly error and keep defaults
                alert('Could not load dashboard statistics. Please refresh the page.');
                
                // Fallback to default values on error
                document.getElementById('total-applicants').textContent = '0';
                document.getElementById('total-hirees').textContent = '0';
                document.getElementById('pending-applications').textContent = '0';
                document.getElementById('active-mrfs').textContent = '0';
                document.getElementById('avg-processing-time').textContent = '0';
                document.getElementById('monthly-applicants').textContent = '0';
            }
        }

        // Load real chart data
        async function loadChartsData() {
            try {
                console.log('🔄 [Frontend] Loading all chart data...');
                
                // Load all chart data in parallel
                const [dashboardResponse, funnelResponse, timeToHireResponse] = await Promise.all([
                    fetch('/hr/recruitment/dashboard/charts'),
                    fetch('/hr/recruitment/dashboard/funnel'),
                    fetch('/hr/recruitment/dashboard/time-to-hire')
                ]);
                
                // Check responses
                if (!dashboardResponse.ok || !funnelResponse.ok || !timeToHireResponse.ok) {
                    throw new Error('Failed to fetch chart data');
                }
                
                const [dashboardData, funnelData, timeToHireData] = await Promise.all([
                    dashboardResponse.json(),
                    funnelResponse.json(),
                    timeToHireResponse.json()
                ]);
                
                // Initialize existing charts
                if (dashboardData.success) {
                    initializeChartsWithData(dashboardData.chartData);
                }
                
                // Initialize funnel chart
                if (funnelData.success) {
                    initializeFunnelChart(funnelData.funnelData);
                } else {
                    console.warn('Funnel data failed, using fallback');
                    initializeFunnelChart(createFallbackFunnelData());
                }
                
                // Initialize time-to-hire chart
                if (timeToHireData.success) {
                    initializeTimeToHireChart(timeToHireData.timeToHireData);
                } else {
                    console.warn('Time-to-hire data failed, using fallback');
                    initializeTimeToHireChart(createFallbackTimeToHireData());
                }
                
                console.log('✅ [Frontend] All charts updated successfully');
                
            } catch (error) {
                console.error('❌ [Frontend] Error loading chart data:', error);
                // Fall back to existing charts + fallback for new ones
                initializeChartsWithMockData();
                initializeFunnelChart(createFallbackFunnelData());
                initializeTimeToHireChart(createFallbackTimeToHireData());
            }
        }
        
        // Initialize charts with real data
        function initializeChartsWithData(chartData) {
            // Destroy existing charts if they exist
            if (statusChart) statusChart.destroy();
            if (trendsChart) trendsChart.destroy();
            if (departmentChart) departmentChart.destroy();
            if (timelineChart) timelineChart.destroy();

            // 1. Status Distribution Chart
            const statusCtx = document.getElementById('statusDistributionChart').getContext('2d');
            statusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: chartData.statusDistribution.labels,
                    datasets: [{
                        data: chartData.statusDistribution.data,
                        backgroundColor: [
                            '#ffc107', // Pending - Yellow
                            '#17a2b8', // P1 Passed - Teal
                            '#2385B0', // P2 Passed - Blue
                            '#28a745', // Hired - Green
                            '#dc3545'  // Failed - Red
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed * 100) / total).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // 2. Monthly Trends Chart
            const trendsCtx = document.getElementById('monthlyTrendsChart').getContext('2d');
            trendsChart = new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: chartData.monthlyTrends.labels,
                    datasets: [{
                        label: 'Applications',
                        data: chartData.monthlyTrends.applications,
                        borderColor: '#2385B0',
                        backgroundColor: 'rgba(35, 133, 176, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Hires',
                        data: chartData.monthlyTrends.hires,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
            
            // 3. Department Chart
            const deptCtx = document.getElementById('departmentChart').getContext('2d');
            departmentChart = new Chart(deptCtx, {
                type: 'bar',
                data: {
                    labels: chartData.departmentDistribution.labels,
                    datasets: [{
                        label: 'Applications',
                        data: chartData.departmentDistribution.data,
                        backgroundColor: '#2385B0',
                        borderColor: '#1a5f78',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed.y * 100) / total).toFixed(1);
                                    return `${context.dataset.label}: ${context.parsed.y} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // 4. Timeline Chart
            const timelineCtx = document.getElementById('timelineChart').getContext('2d');
            timelineChart = new Chart(timelineCtx, {
                type: 'bar',
                data: {
                    labels: chartData.timeline.labels,
                    datasets: [{
                        label: 'Number of Hires',
                        data: chartData.timeline.data,
                        backgroundColor: '#28a745',
                        borderColor: '#1e7e34',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y} candidate${context.parsed.y !== 1 ? 's' : ''}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Funnel Chart Implementation
        function initializeFunnelChart(funnelData) {
            // Update metrics
            document.getElementById('overall-conversion-rate').textContent = 
                funnelData.conversionRates.overallConversion + '%';
            document.getElementById('biggest-dropoff').textContent = 
                funnelData.insights.biggestDropOff.name + ' (' + funnelData.insights.biggestDropOff.dropOffRate + '%)';
            
            // Create CSS funnel
            createCSSFunnel(funnelData.funnelStages);
            
            // Display conversion rates
            displayConversionRates(funnelData.conversionRates);
        }

        function createCSSFunnel(stageData) {
            const container = document.getElementById('funnel-visualization');
            const stages = stageData.labels;
            const values = stageData.values;
            const colors = [
                '#2385B0',  // Applications
                '#1a73e8',  // Initial Screening
                '#17a2b8',  // HR Interview
                '#20c997',  // Panel Interview
                '#ffc107',  // Offers Extended
                '#28a745'   // Hired
            ];
            
            const maxValue = Math.max(...values);
            
            container.innerHTML = stages.map((stage, index) => {
                const value = values[index];
                const percentage = Math.max((value / maxValue) * 100, 10); // Minimum 10% width for visibility
                
                // Calculate conversion rate from previous stage
                let conversionRate = '';
                if (index > 0) {
                    const prevValue = values[index - 1];
                    const rate = prevValue > 0 ? Math.round((value / prevValue) * 100) : 0;
                    conversionRate = `<div class="stage-conversion">${rate}% conversion</div>`;
                }
                
                return `
                    <div class="funnel-stage funnel-stage-${index + 1}" 
                        style="width: ${percentage}%; background: ${colors[index]};"
                        onclick="showStageDetails('${stage}', ${value}, ${index})">
                        <div class="stage-text">
                            <span class="stage-name">${stage}</span>
                            <span class="stage-value">${value}</span>
                        </div>
                        ${conversionRate}
                    </div>
                `;
            }).join('');
        }

        function showStageDetails(stage, value, index) {
            // Create a more sophisticated modal or tooltip
            const modal = document.createElement('div');
            modal.className = 'stage-modal';
            modal.innerHTML = `
                <div class="stage-modal-content">
                    <div class="stage-modal-header">
                        <h4>${stage}</h4>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                    </div>
                    <div class="stage-modal-body">
                        <p><strong>Candidates:</strong> ${value}</p>
                        <p><strong>Stage:</strong> ${index + 1} of 6</p>
                        <p><strong>Description:</strong> ${getStageDescription(index)}</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.remove();
                }
            }, 5000);
        }

        function getStageDescription(index) {
            const descriptions = [
                'Total applications received through all channels',
                'Candidates who completed initial screening assessment',
                'Candidates who passed HR interview evaluation',
                'Candidates who completed panel/line manager interview',
                'Candidates who received job offers',
                'Candidates who accepted offers and were hired'
            ];
            return descriptions[index] || 'Stage information';
        }

        function displayConversionRates(rates) {
            const conversions = [
                { stage: 'App → Screening', rate: rates.applicationToScreening },
                { stage: 'Screening → HR', rate: rates.screeningToHR },
                { stage: 'HR → Panel', rate: rates.hrToPanel },
                { stage: 'Panel → Offer', rate: rates.panelToOffer },
                { stage: 'Offer → Hire', rate: rates.offerToHire }
            ];
            
            const container = document.getElementById('conversion-rates');
            container.innerHTML = conversions.map(conv => {
                const rateClass = conv.rate >= 80 ? 'excellent' : 
                                conv.rate >= 60 ? 'good' : 
                                conv.rate >= 40 ? 'average' : 'poor';
                
                return `
                    <div class="conversion-rate-item">
                        <div class="conversion-stage">${conv.stage}</div>
                        <div class="conversion-percentage ${rateClass}">${conv.rate}%</div>
                    </div>
                `;
            }).join('');
        }

        // Time-to-Hire Chart Implementation
        function initializeTimeToHireChart(timeToHireData) {
            // Destroy existing chart
            if (timeToHireChart) timeToHireChart.destroy();
            
            // Update metrics
            document.getElementById('avg-time-to-hire').textContent = 
                timeToHireData.insights.totalAverageTimeToHire + ' days';
            document.getElementById('slowest-stage').textContent = 
                timeToHireData.insights.slowestStage.name + ' (' + timeToHireData.insights.slowestStage.days + ' days)';
            
            // Create waterfall-style chart using bar chart
            const timeCtx = document.getElementById('timeToHireChart').getContext('2d');
            timeToHireChart = new Chart(timeCtx, {
                type: 'bar',
                data: {
                    labels: timeToHireData.stageBreakdown.labels,
                    datasets: [{
                        label: 'Actual Days',
                        data: timeToHireData.stageBreakdown.values,
                        backgroundColor: timeToHireData.stageBreakdown.values.map((value, index) => {
                            const target = timeToHireData.stageBreakdown.targets[index];
                            return value > target * 1.5 ? '#dc3545' : // Critical
                                value > target ? '#ffc107' :        // Warning
                                '#28a745';                          // Good
                        }),
                        borderColor: '#2385B0',
                        borderWidth: 2
                    }, {
                        label: 'Target Days',
                        data: timeToHireData.stageBreakdown.targets,
                        backgroundColor: 'rgba(35, 133, 176, 0.3)',
                        borderColor: '#2385B0',
                        borderWidth: 2,
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    if (context.datasetIndex === 0) {
                                        const target = timeToHireData.stageBreakdown.targets[context.dataIndex];
                                        const actual = context.parsed.y;
                                        const variance = actual - target;
                                        const status = variance > target * 0.5 ? 'Over Target' : 
                                                    variance > 0 ? 'Above Target' : 'On Target';
                                        return `Target: ${target} days | ${status}`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Days'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            
            // Display bottleneck alerts
            displayBottleneckAlerts(timeToHireData.bottlenecks);
        }

        function displayBottleneckAlerts(bottlenecks) {
            const container = document.getElementById('bottleneck-alerts');
            
            if (bottlenecks.length === 0) {
                container.innerHTML = `
                    <div class="bottleneck-alert">
                        <i class="fas fa-check-circle"></i>
                        <div class="bottleneck-text">No critical bottlenecks detected. All stages are performing within acceptable ranges.</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = bottlenecks.map(bottleneck => {
                const isCritical = bottleneck.days > bottleneck.target * 2;
                
                return `
                    <div class="bottleneck-alert ${isCritical ? 'critical' : ''}">
                        <i class="fas ${isCritical ? 'fa-exclamation-triangle' : 'fa-clock'}"></i>
                        <div class="bottleneck-text">
                            <strong>${bottleneck.stage}</strong> is taking ${bottleneck.days} days 
                            (target: ${bottleneck.target} days). Consider process optimization.
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Fallback data functions
        function createFallbackFunnelData() {
            return {
                funnelStages: {
                    labels: ['Applications', 'Initial Screening', 'HR Interview', 'Panel Interview', 'Offers Extended', 'Hired'],
                    values: [100, 80, 60, 40, 25, 20]
                },
                conversionRates: {
                    applicationToScreening: 80,
                    screeningToHR: 75,
                    hrToPanel: 67,
                    panelToOffer: 63,
                    offerToHire: 80,
                    overallConversion: 20
                },
                insights: {
                    biggestDropOff: { name: 'HR to Panel', dropOffRate: 33 }
                }
            };
        }

        function createFallbackTimeToHireData() {
            return {
                stageBreakdown: {
                    labels: ['App to Screening', 'Screening to HR', 'HR to Panel', 'Panel to Hire'],
                    values: [4, 6, 8, 6],
                    targets: [3, 5, 7, 5]
                },
                insights: {
                    totalAverageTimeToHire: 24,
                    slowestStage: { name: 'HR to Panel', days: 8 }
                },
                bottlenecks: [
                    { stage: 'HR to Panel Interview', days: 8, target: 7 }
                ]
            };
        }
        
        // generateReport function
        async function generateReport(reportType, format) {

            // Special handling for status report with dropdown 
            if (reportType === 'status') {
                const selectedApplicant = applicantDropdown?.getSelectedApplicant();

                if (!selectedApplicant) {
                    alert('Please select an applicant from the dropdown first.');
                    return;
                }
            }

            
            const form = document.getElementById(`${reportType}-form`);
            const button = event.target;
            const resultsDiv = document.getElementById(`${reportType}-results`);
            
            // Add loading state
            button.classList.add('loading');
            button.disabled = true;
            
            try {
                console.log(`🔄 [Frontend] Generating ${reportType} report...`);
                
                // Get form data
                const formData = new FormData(form);
                const params = new URLSearchParams();

                if (reportType === 'status' && applicantDropdown?.getSelectedApplicant()) {
                    params.append('applicantName', applicantDropdown.getSelectedApplicant().name);
                } else {
                    // Handle smart date filtering
                    const filterType = document.getElementById(`${reportType}-filter-type`)?.value;
                    
                    if (filterType && filterType !== 'custom') {
                        // Use preset date range
                        const dateRange = calculateDateRange(filterType);
                        if (dateRange) {
                            params.append('startDate', dateRange.startDate);
                            params.append('endDate', dateRange.endDate);
                            params.append('filterType', filterType); // For display purposes
                        }
                    } else {
                        // Use custom dates from form
                        for (let [key, value] of formData.entries()) {
                            if (value) params.append(key, value);
                        }
                    }
                }
                
                if (format) params.append('format', format);
                
                console.log(`📋 [Frontend] Form parameters:`, Object.fromEntries(params));
                
                // Endpoint based on report type
                let endpoint = '';
                switch(reportType) {
                    case 'applicants':
                        endpoint = '/hr/recruitment/reports/applicants';
                        break;
                    case 'hirees':
                        endpoint = '/hr/recruitment/reports/hirees';
                        break;
                    case 'status':
                        endpoint = '/hr/recruitment/reports/applicant-status';
                        break;
                    case 'timeline':
                        endpoint = '/hr/recruitment/reports/timeline';
                        break;
                    // ADD THESE NEW CASES:
                    case 'mrf-efficiency':
                        endpoint = '/hr/recruitment/reports/mrf-efficiency';
                        break;
                    default:
                        throw new Error('Unknown report type: ' + reportType);
                }
                
                if (format === 'pdf') {
                    console.log(`📄 [Frontend] PDF generation requested for ${reportType}`);
                    
                    // Fetch data first
                    const response = await fetch(`${endpoint}?${params.toString()}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.message || 'Failed to generate report');
                    }
                    
                    // Generate PDF directly here
                    try {
                        // Check if jsPDF is loaded
                        if (typeof window.jspdf === 'undefined') {
                            throw new Error('jsPDF library is not loaded. Please refresh the page and try again.');
                        }
                        
                        // Import jsPDF
                        let jsPDF;
                        if (window.jspdf && window.jspdf.jsPDF) {
                            jsPDF = window.jspdf.jsPDF;
                        } else if (window.jsPDF) {
                            jsPDF = window.jsPDF;
                        } else {
                            throw new Error('jsPDF not found. Please refresh the page.');
                        }
                        
                        const doc = new jsPDF();
                        
                        // Set up document
                        doc.setFontSize(20);
                        doc.setTextColor(35, 133, 176);
                        doc.text('Recruitment Management System', 20, 20);
                        
                        doc.setFontSize(16);
                        doc.setTextColor(0, 0, 0);
                        const reportTitles = {
                            'applicants': 'Applicants Report',
                            'hirees': 'Hirees Report',
                            'status': 'Individual Applicant Status Report',
                            'timeline': 'MRF to Onboarding Timeline Report',
                            'mrf-efficiency': 'MRF Efficiency Analysis Report'
                        };
                        doc.text(reportTitles[reportType], 20, 35);
                        
                        // Add generation date
                        doc.setFontSize(10);
                        doc.setTextColor(100, 100, 100);
                        doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 45);
                        
                        let yPosition = 60;
                        
                        // Add summary
                        if (data.summary && reportType !== 'timeline') {
                            doc.setFontSize(14);
                            doc.setTextColor(0, 0, 0);
                            doc.text('Summary', 20, yPosition);
                            yPosition += 10;
                            
                            doc.setFontSize(10);
                            Object.entries(data.summary).forEach(([key, value]) => {
                                const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                                doc.text(`${label}: ${value}`, 25, yPosition);
                                yPosition += 6;
                            });
                            yPosition += 10;
                        }
                        
                        // Add data tables based on report type
                        if (reportType === 'applicants' && data.data) {
                            const tableData = data.data.map(applicant => [
                                applicant.applicantId || '',
                                `${applicant.firstName || ''} ${applicant.lastName || ''}`,
                                applicant.email || '',
                                applicant.jobTitle || '',
                                applicant.department || '',
                                applicant.status || '',
                                applicant.initialScreeningScore || 'N/A',
                                applicant.hrInterviewScore || 'N/A',
                                applicant.lineManagerScore || 'N/A',
                                applicant.totalScore || 'N/A'
                            ]);
                            
                            doc.autoTable({
                                startY: yPosition,
                                head: [['ID', 'Name', 'Email', 'Job Title', 'Department', 'Status', 'Initial Score', 'HR Score', 'Line Manager Score', 'Total Score']],
                                body: tableData,
                                styles: { fontSize: 8 },
                                headStyles: { fillColor: [35, 133, 176] },
                                margin: { top: 60 }
                            });
                        }
                        else if (reportType === 'hirees' && data.data) {
                            const tableData = data.data.map(hiree => [
                                hiree.hireId || '',
                                `${hiree.firstName || ''} ${hiree.lastName || ''}`,
                                hiree.email || '',
                                hiree.jobTitle || '',
                                hiree.department || '',
                                hiree.jobType || '',
                                hiree.hireDate || ''
                            ]);
                            
                            doc.autoTable({
                                startY: yPosition,
                                head: [['Hire ID', 'Name', 'Email', 'Job Title', 'Department', 'Job Type', 'Hire Date']],
                                body: tableData,
                                styles: { fontSize: 8 },
                                headStyles: { fillColor: [35, 133, 176] },
                                margin: { top: 60 }
                            });
                        }
                        else if (reportType === 'status' && data.applicant) {
                            // Enhanced applicant information table matching your exact format
                            const applicantInfo = [
                                ['Last Name', data.applicant.lastName || 'N/A'],
                                ['First Name', data.applicant.firstName || 'N/A'],
                                ['Middle Initial', data.applicant.middleInitial || 'N/A'],
                                ['Email', data.applicant.email || 'N/A'],
                                ['Phone', data.applicant.phoneNumber || 'N/A'],
                                ['Birth Date', data.applicant.birthDate || 'N/A'],
                                ['Job Position', data.applicant.jobPosition || 'N/A'],
                                ['Department', data.applicant.department || 'N/A'],
                                ['Application Date', data.applicant.applicationDate || 'N/A'],
                                ['Days in Process', `${data.applicant.daysInProcess || 0} days`],
                                ['Current Status', data.applicant.currentStatus || 'Pending'],
                                ['HR Screening Approved', data.applicant.hrScreeningApproved || 'Pending'],
                                ['Panel Screening Approved', data.applicant.panelScreeningApproved || 'Pending'],
                                ['Is Hired', data.applicant.isHired || 'Pending']
                            ];
                            
                            // Add enhanced title
                            doc.setFontSize(14);
                            doc.setTextColor(0, 0, 0);
                            doc.text('Applicant Information', 20, yPosition);
                            yPosition += 10;
                            
                            doc.autoTable({
                                startY: yPosition,
                                body: applicantInfo,
                                styles: { 
                                    fontSize: 9,
                                    cellPadding: 3,
                                    lineColor: [200, 200, 200],
                                    lineWidth: 0.1
                                },
                                columnStyles: { 
                                    0: { 
                                        fontStyle: 'bold', 
                                        fillColor: [240, 240, 240],
                                        cellWidth: 50
                                    },
                                    1: {
                                        cellWidth: 80
                                    }
                                },
                                margin: { top: 60, left: 20, right: 20 },
                                tableWidth: 130
                            });
                            
                            yPosition = doc.lastAutoTable.finalY + 20;
                            
                            // Enhanced status history section
                            if (data.statusHistory && data.statusHistory.length > 0) {
                                doc.setFontSize(14);
                                doc.setTextColor(0, 0, 0);
                                doc.text('Status History Timeline', 20, yPosition);
                                yPosition += 10;
                                
                                const historyData = data.statusHistory.map(history => [
                                    history.status || 'Status Update',
                                    history.date || 'N/A',
                                    history.notes || 'No additional notes'
                                ]);
                                
                                doc.autoTable({
                                    startY: yPosition,
                                    head: [['Status Update', 'Date', 'Notes & Comments']],
                                    body: historyData,
                                    styles: { 
                                        fontSize: 8,
                                        cellPadding: 3,
                                        overflow: 'linebreak'
                                    },
                                    headStyles: { 
                                        fillColor: [35, 133, 176],
                                        textColor: [255, 255, 255],
                                        fontStyle: 'bold'
                                    },
                                    columnStyles: {
                                        0: { cellWidth: 40 },
                                        1: { cellWidth: 25 },
                                        2: { cellWidth: 95 }
                                    },
                                    margin: { left: 20, right: 20 }
                                });
                            }
                        }
                        else if (reportType === 'timeline') {
                            // Enhanced MRF to Onboarding Timeline Report
                            doc.setFontSize(18);
                            doc.setTextColor(0, 0, 0);
                            doc.text('MRF To Onboarding Timeline Report (HR)', 20, 35);
                            
                            // Add generation date and filters
                            doc.setFontSize(10);
                            doc.setTextColor(100, 100, 100);

                            const generationDate = new Date().toLocaleDateString('en-US', { 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric'
                            });
                            doc.text(`Generated on: ${generationDate}`, 20, 45);
                            
                            if (data.filters && (data.filters.startDate || data.filters.endDate)) {
                                const dateFilter = `Date Range: ${data.filters.startDate || 'Start'} to ${data.filters.endDate || 'End'}`;
                                doc.text(dateFilter, 20, 52);
                            }
                            
                            let yPosition = 65;
                            
                            // MRF to Onboarding Summary Statistics
                            if (data.summaryStats) {
                                doc.setFontSize(14);
                                doc.setTextColor(0, 0, 0);
                                doc.text('MRF to Onboarding Summary Statistics', 20, yPosition);
                                yPosition += 10;
                                
                                const summaryData = [
                                    ['Average MRF to Onboarding', `${data.summaryStats.averageMrfToOnboarding} days`],
                                    ['Shortest Timeline', `${data.summaryStats.shortestTimeline} days`],
                                    ['Longest Timeline', `${data.summaryStats.longestTimeline} days`],
                                    ['Target Timeline', `${data.summaryStats.targetTimeline} days`]
                                ];
                                
                                doc.autoTable({
                                    startY: yPosition,
                                    body: summaryData,
                                    styles: { 
                                        fontSize: 10,
                                        cellPadding: 4
                                    },
                                    columnStyles: { 
                                        0: { fontStyle: 'bold', fillColor: [240, 240, 240], cellWidth: 70 },
                                        1: { cellWidth: 40, halign: 'center' }
                                    },
                                    margin: { left: 20, right: 20 }
                                });
                                
                                yPosition = doc.lastAutoTable.finalY + 20;
                            }
                            
                            // MRF to Onboarding Breakdown
                            if (data.summaryStats && data.summaryStats.averageStages) {
                                doc.setFontSize(14);
                                doc.setTextColor(0, 0, 0);
                                doc.text('MRF to Onboarding Breakdown', 20, yPosition);
                                yPosition += 10;
                                
                                const breakdownData = [
                                    ['MRF to Job Posting', `${data.summaryStats.averageStages.mrfToJobPosting} days`],
                                    ['Job Posting to Initial Interview', `${data.summaryStats.averageStages.jobPostingToInitialInterview} days`],
                                    ['Initial Interview to Final Interview', `${data.summaryStats.averageStages.initialInterviewToFinalInterview} days`],
                                    ['Final Interview to Onboarding', `${data.summaryStats.averageStages.finalInterviewToOnboarding} days`]
                                ];
                                
                                doc.autoTable({
                                    startY: yPosition,
                                    head: [['Stage', 'Days']],
                                    body: breakdownData,
                                    styles: { 
                                        fontSize: 10,
                                        cellPadding: 4
                                    },
                                    headStyles: { 
                                        fillColor: [35, 133, 176],
                                        textColor: [255, 255, 255],
                                        fontStyle: 'bold'
                                    },
                                    columnStyles: {
                                        0: { cellWidth: 100 },
                                        1: { cellWidth: 30, halign: 'center', fontStyle: 'bold' }
                                    },
                                    margin: { left: 20, right: 20 }
                                });
                                
                                yPosition = doc.lastAutoTable.finalY + 20;
                            }
                            
                            // Monthly Timeline Analysis
                            if (data.monthlyData && data.monthlyData.length > 0) {
                                // Check if we need a new page
                                if (yPosition > 180) {
                                    doc.addPage();
                                    yPosition = 20;
                                }
                                
                                doc.setFontSize(14);
                                doc.setTextColor(0, 0, 0);
                                doc.text('Monthly Timeline Analysis', 20, yPosition);
                                yPosition += 10;
                                
                                const monthlyTableData = data.monthlyData.map(month => [
                                    month.monthName || '',
                                    month.hires || 0,
                                    `${month.averageDays || 0} days`
                                ]);
                                
                                doc.autoTable({
                                    startY: yPosition,
                                    head: [['Month', 'Hires Completed', 'Average Days to Hire']],
                                    body: monthlyTableData,
                                    styles: { 
                                        fontSize: 9,
                                        cellPadding: 3
                                    },
                                    headStyles: { 
                                        fillColor: [35, 133, 176],
                                        textColor: [255, 255, 255],
                                        fontStyle: 'bold'
                                    },
                                    columnStyles: {
                                        0: { cellWidth: 60 },
                                        1: { cellWidth: 35, halign: 'center' },
                                        2: { cellWidth: 45, halign: 'center' }
                                    },
                                    margin: { left: 20, right: 20 }
                                });
                                
                                yPosition = doc.lastAutoTable.finalY + 20;
                            }
                            
                            // Individual Hiring Timelines
                            if (data.timelineData && data.timelineData.length > 0) {
                                // Check if we need a new page
                                if (yPosition > 150) {
                                    doc.addPage();
                                    yPosition = 20;
                                }
                                
                                doc.setFontSize(14);
                                doc.setTextColor(0, 0, 0);
                                doc.text('Individual Hiring Timelines', 20, yPosition);
                                yPosition += 10;
                                
                                const timelineTableData = data.timelineData.map(timeline => [
                                    timeline.name || '',
                                    timeline.position || '',
                                    timeline.department || '',
                                    timeline.applicationDate || '',
                                    `${timeline.totalDays || 0} days`,
                                    timeline.status || ''
                                ]);
                                
                                doc.autoTable({
                                    startY: yPosition,
                                    head: [['Name', 'Position', 'Department', 'Application Date', 'Total Days', 'Status']],
                                    body: timelineTableData,
                                    styles: { 
                                        fontSize: 8,
                                        cellPadding: 2,
                                        overflow: 'linebreak'
                                    },
                                    headStyles: { 
                                        fillColor: [35, 133, 176],
                                        textColor: [255, 255, 255],
                                        fontStyle: 'bold',
                                        fontSize: 8
                                    },
                                    columnStyles: {
                                        0: { cellWidth: 30 },
                                        1: { cellWidth: 35 },
                                        2: { cellWidth: 25 },
                                        3: { cellWidth: 25 },
                                        4: { cellWidth: 20, halign: 'center' },
                                        5: { cellWidth: 25 }
                                    },
                                    margin: { left: 10, right: 10 }
                                });
                            }

                            else if (reportType === 'mrf-efficiency') {
                                // Enhanced MRF Efficiency Analysis Report
                                doc.setFontSize(18);
                                doc.setTextColor(0, 0, 0);
                                doc.text('MRF Efficiency Analysis Report', 20, 35);

                                // Add generation date and filters
                                doc.setFontSize(10);
                                doc.setTextColor(100, 100, 100);
                                const generationDate = new Date().toLocaleDateString('en-US', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric'
                                });
                                doc.text(`Generated on: ${generationDate}`, 20, 45);
                                
                                // Add generation date and filters
                                doc.setFontSize(10);
                                doc.setTextColor(100, 100, 100);
                                doc.text(`Generated on: ${data.generatedOn || new Date().toLocaleDateString()}`, 20, 45);
                                
                                if (data.filters && (data.filters.startDate || data.filters.endDate)) {
                                    const dateFilter = `Date Range: ${data.filters.startDate || 'Start'} to ${data.filters.endDate || 'End'}`;
                                    doc.text(dateFilter, 20, 52);
                                }
                                
                                let yPosition = 65;
                                
                                // Executive Summary
                                if (data.summary) {
                                    doc.setFontSize(14);
                                    doc.setTextColor(0, 0, 0);
                                    doc.text('Executive Summary', 20, yPosition);
                                    yPosition += 10;
                                    
                                    const summaryData = [
                                        ['Total MRFs', data.summary.totalMRFs],
                                        ['Personnel Required', data.summary.totalRequired],
                                        ['Personnel Hired', data.summary.totalHired],
                                        ['Overall Fill Rate', `${data.summary.overallFillRate}%`],
                                        ['Overdue MRFs', data.summary.overdueMRFs],
                                        ['Average Days Open', `${data.summary.avgDaysOpen} days`]
                                    ];
                                    
                                    doc.autoTable({
                                        startY: yPosition,
                                        body: summaryData,
                                        styles: { 
                                            fontSize: 10,
                                            cellPadding: 4
                                        },
                                        columnStyles: { 
                                            0: { fontStyle: 'bold', fillColor: [240, 240, 240], cellWidth: 70 },
                                            1: { cellWidth: 40, halign: 'center', fontStyle: 'bold' }
                                        },
                                        margin: { left: 20, right: 20 }
                                    });
                                    
                                    yPosition = doc.lastAutoTable.finalY + 20;
                                }
                                
                                // Department Performance Analysis
                                if (data.departmentComparison && data.departmentComparison.length > 0) {
                                    // Check if we need a new page
                                    if (yPosition > 150) {
                                        doc.addPage();
                                        yPosition = 20;
                                    }
                                    
                                    doc.setFontSize(14);
                                    doc.setTextColor(0, 0, 0);
                                    doc.text('Department Performance Analysis', 20, yPosition);
                                    yPosition += 10;
                                    
                                    const deptTableData = data.departmentComparison.map(dept => [
                                        dept.department,
                                        dept.totalMRFs,
                                        dept.totalRequired,
                                        dept.totalHired,
                                        `${dept.fillRate}%`,
                                        `${dept.completionRate}%`,
                                        `${dept.avgDaysOpen} days`,
                                        dept.overdueMRFs
                                    ]);
                                    
                                    doc.autoTable({
                                        startY: yPosition,
                                        head: [['Department', 'MRFs', 'Required', 'Hired', 'Fill Rate', 'Completion', 'Avg Days', 'Overdue']],
                                        body: deptTableData,
                                        styles: { 
                                            fontSize: 8,
                                            cellPadding: 2
                                        },
                                        headStyles: { 
                                            fillColor: [35, 133, 176],
                                            textColor: [255, 255, 255],
                                            fontStyle: 'bold',
                                            fontSize: 8
                                        },
                                        columnStyles: {
                                            0: { cellWidth: 25 },
                                            1: { cellWidth: 15, halign: 'center' },
                                            2: { cellWidth: 20, halign: 'center' },
                                            3: { cellWidth: 15, halign: 'center' },
                                            4: { cellWidth: 20, halign: 'center', fontStyle: 'bold' },
                                            5: { cellWidth: 20, halign: 'center' },
                                            6: { cellWidth: 20, halign: 'center' },
                                            7: { cellWidth: 15, halign: 'center' }
                                        },
                                        margin: { left: 15, right: 15 }
                                    });
                                    
                                    yPosition = doc.lastAutoTable.finalY + 20;
                                }
                                
                                // Line Manager Performance Analysis
                                if (data.lineManagerComparison && data.lineManagerComparison.length > 0) {
                                    // Check if we need a new page
                                    if (yPosition > 120) {
                                        doc.addPage();
                                        yPosition = 20;
                                    }
                                    
                                    doc.setFontSize(14);
                                    doc.setTextColor(0, 0, 0);
                                    doc.text('Line Manager Performance Analysis', 20, yPosition);
                                    yPosition += 10;
                                    
                                    const managerTableData = data.lineManagerComparison.map(manager => [
                                        manager.lineManager,
                                        manager.totalMRFs,
                                        manager.totalRequired,
                                        manager.totalHired,
                                        `${manager.fillRate}%`,
                                        `${manager.avgDaysOpen} days`,
                                        manager.overdueMRFs
                                    ]);
                                    
                                    doc.autoTable({
                                        startY: yPosition,
                                        head: [['Line Manager', 'MRFs', 'Required', 'Hired', 'Fill Rate', 'Avg Days', 'Overdue']],
                                        body: managerTableData,
                                        styles: { 
                                            fontSize: 8,
                                            cellPadding: 2
                                        },
                                        headStyles: { 
                                            fillColor: [35, 133, 176],
                                            textColor: [255, 255, 255],
                                            fontStyle: 'bold',
                                            fontSize: 8
                                        },
                                        columnStyles: {
                                            0: { cellWidth: 35 },
                                            1: { cellWidth: 15, halign: 'center' },
                                            2: { cellWidth: 20, halign: 'center' },
                                            3: { cellWidth: 15, halign: 'center' },
                                            4: { cellWidth: 20, halign: 'center', fontStyle: 'bold' },
                                            5: { cellWidth: 20, halign: 'center' },
                                            6: { cellWidth: 15, halign: 'center' }
                                        },
                                        margin: { left: 15, right: 15 }
                                    });
                                    
                                    yPosition = doc.lastAutoTable.finalY + 20;
                                }
                                
                                // Monthly Trends Analysis
                                if (data.monthlyData && data.monthlyData.length > 0) {
                                    // Check if we need a new page
                                    if (yPosition > 150) {
                                        doc.addPage();
                                        yPosition = 20;
                                    }
                                    
                                    doc.setFontSize(14);
                                    doc.setTextColor(0, 0, 0);
                                    doc.text('Monthly Trends Analysis', 20, yPosition);
                                    yPosition += 10;
                                    
                                    const monthlyTableData = data.monthlyData.map(month => {
                                        const monthlyFillRate = month.personnelRequired > 0 ? 
                                            Math.round((month.personnelHired / month.personnelRequired) * 100) : 0;
                                        
                                        return [
                                            month.month,
                                            month.mrfsCreated,
                                            month.personnelRequired,
                                            month.personnelHired,
                                            `${monthlyFillRate}%`
                                        ];
                                    });
                                    
                                    doc.autoTable({
                                        startY: yPosition,
                                        head: [['Month', 'MRFs Created', 'Personnel Required', 'Personnel Hired', 'Fill Rate']],
                                        body: monthlyTableData,
                                        styles: { 
                                            fontSize: 9,
                                            cellPadding: 3
                                        },
                                        headStyles: { 
                                            fillColor: [35, 133, 176],
                                            textColor: [255, 255, 255],
                                            fontStyle: 'bold'
                                        },
                                        columnStyles: {
                                            0: { cellWidth: 40 },
                                            1: { cellWidth: 30, halign: 'center' },
                                            2: { cellWidth: 35, halign: 'center' },
                                            3: { cellWidth: 30, halign: 'center' },
                                            4: { cellWidth: 25, halign: 'center', fontStyle: 'bold' }
                                        },
                                        margin: { left: 20, right: 20 }
                                    });
                                    
                                    yPosition = doc.lastAutoTable.finalY + 20;
                                }
                                
                                // Individual MRF Details (show top 20 most critical)
                                if (data.mrfData && data.mrfData.length > 0) {
                                    // Check if we need a new page
                                    if (yPosition > 100) {
                                        doc.addPage();
                                        yPosition = 20;
                                    }
                                    
                                    doc.setFontSize(14);
                                    doc.setTextColor(0, 0, 0);
                                    doc.text('Critical MRF Details (Top Issues)', 20, yPosition);
                                    yPosition += 10;
                                    
                                    // Sort by overdue days descending and take top 20
                                    const criticalMRFs = data.mrfData
                                        .sort((a, b) => (b.daysOverdue || 0) - (a.daysOverdue || 0))
                                        .slice(0, 20);
                                    
                                    const mrfTableData = criticalMRFs.map(mrf => [
                                        mrf.mrfId,
                                        mrf.positionTitle.length > 15 ? mrf.positionTitle.substring(0, 15) + '...' : mrf.positionTitle,
                                        mrf.department,
                                        mrf.lineManager.length > 12 ? mrf.lineManager.substring(0, 12) + '...' : mrf.lineManager,
                                        mrf.personnelRequired,
                                        mrf.personnelHired,
                                        `${mrf.fillRate}%`,
                                        `${mrf.daysOpen}d`,
                                        mrf.daysOverdue > 0 ? `${mrf.daysOverdue}d` : '-',
                                        mrf.status.length > 8 ? mrf.status.substring(0, 8) + '...' : mrf.status
                                    ]);
                                    
                                    doc.autoTable({
                                        startY: yPosition,
                                        head: [['MRF ID', 'Position', 'Dept', 'Line Mgr', 'Req', 'Hired', 'Fill%', 'Days', 'Over', 'Status']],
                                        body: mrfTableData,
                                        styles: { 
                                            fontSize: 7,
                                            cellPadding: 1.5,
                                            overflow: 'linebreak'
                                        },
                                        headStyles: { 
                                            fillColor: [35, 133, 176],
                                            textColor: [255, 255, 255],
                                            fontStyle: 'bold',
                                            fontSize: 7
                                        },
                                        columnStyles: {
                                            0: { cellWidth: 15, fontStyle: 'bold' },
                                            1: { cellWidth: 20 },
                                            2: { cellWidth: 15 },
                                            3: { cellWidth: 18 },
                                            4: { cellWidth: 12, halign: 'center' },
                                            5: { cellWidth: 12, halign: 'center' },
                                            6: { cellWidth: 12, halign: 'center', fontStyle: 'bold' },
                                            7: { cellWidth: 12, halign: 'center' },
                                            8: { cellWidth: 12, halign: 'center' },
                                            9: { cellWidth: 15 }
                                        },
                                        margin: { left: 10, right: 10 }
                                    });
                                    
                                    // Add note if there are more MRFs
                                    if (data.mrfData.length > 20) {
                                        yPosition = doc.lastAutoTable.finalY + 10;
                                        doc.setFontSize(8);
                                        doc.setTextColor(100, 100, 100);
                                        doc.text(`Note: Showing top 20 critical MRFs. Total MRFs in report: ${data.mrfData.length}`, 20, yPosition);
                                    }
                                }
                                
                                // Add footer with page numbers and recommendations
                                const pageCount = doc.internal.getNumberOfPages();
                                for (let i = 1; i <= pageCount; i++) {
                                    doc.setPage(i);
                                    doc.setFontSize(8);
                                    doc.setTextColor(128, 128, 128);
                                    doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10);
                                    doc.text('MRF Efficiency Analysis Report - Confidential', 20, doc.internal.pageSize.height - 10);
                                    
                                    // Add key insights on first page footer
                                    if (i === 1 && data.summary) {
                                        doc.text(`Overall Fill Rate: ${data.summary.overallFillRate}% | Overdue MRFs: ${data.summary.overdueMRFs}`, 20, doc.internal.pageSize.height - 20);
                                    }
                                }
                            }
                            
                            // Add footer with page numbers and additional info
                            const pageCount = doc.internal.getNumberOfPages();
                            for (let i = 1; i <= pageCount; i++) {
                                doc.setPage(i);
                                doc.setFontSize(8);
                                doc.setTextColor(128, 128, 128);
                                doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10);
                                doc.text('MRF to Onboarding Timeline Report - Confidential', 20, doc.internal.pageSize.height - 10);
                                
                                // Add summary info on first page footer
                                if (i === 1 && data.totalMRFs !== undefined && data.totalHired !== undefined) {
                                    doc.text(`Total MRFs: ${data.totalMRFs} | Total Hired: ${data.totalHired}`, 20, doc.internal.pageSize.height - 20);
                                }
                            }
                        }
                        
                        // Download the PDF
                        const filename = `${reportType}_report_${new Date().toISOString().split('T')[0]}.pdf`;
                        doc.save(filename);
                        
                        console.log(`✅ PDF generated and downloaded: ${filename}`);
                        
                    } catch (pdfError) {
                        console.error('❌ Error generating PDF:', pdfError);
                        alert('Error generating PDF: ' + pdfError.message);
                    }
                    
                } else {
                    console.log(`👁️ [Frontend] View mode requested for ${reportType}`);
                    // Fetch actual data from backend for viewing
                    const response = await fetch(`${endpoint}?${params.toString()}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log(`✅ [Frontend] Received data:`, data);
                    
                    if (!data.success) {
                        throw new Error(data.message || 'Failed to fetch report data');
                    }
                    
                    // Display the real data
                    displayReportResults(resultsDiv, data, reportType);
                    console.log(`✅ [Frontend] ${reportType} report displayed successfully`);
                }
                
            } catch (error) {
                console.error(`❌ [Frontend] Error generating ${reportType} report:`, error);
                alert('Error generating report: ' + error.message);
            } finally {
                // Remove loading state
                button.classList.remove('loading');
                button.disabled = false;
            }
        }
        
        // Display report results in the UI
        function displayReportResults(resultsDiv, data, reportType) {
        resultsDiv.style.display = 'block';
        
        let html = '<div class="results-header"><h4>Report Results</h4></div>';
        
        // Add summary if available (for non-timeline reports)
        // if (data.summary && reportType !== 'timeline') {
        //     html += '<div class="results-summary">';
            
        //     Object.entries(data.summary).forEach(([key, value]) => {
        //         html += `
        //             <div class="summary-item">
        //                 <div class="summary-value">${value}</div>
        //                 <div class="summary-label">${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</div>
        //             </div>
        //         `;
        //     });
            
        //     html += '</div>';
        // }
        
        // Add data table based on report type
        if (reportType === 'applicants' && data.data && data.data.length > 0) {
            
            // Add Department Performance Summary (NEW)
            if (data.departmentAnalysis) {
                html += `
                    <div class="department-summary" style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px;">Department Performance Summary</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                `;
                
                data.departmentAnalysis.forEach(dept => {
                    const successRate = dept.totalApplicants > 0 ? Math.round((dept.hired / dept.totalApplicants) * 100) : 0;
                    const rateColor = successRate >= 70 ? '#28a745' : successRate >= 50 ? '#ffc107' : '#dc3545';
                    
                    html += `
                        <div style="background: white; padding: 10px; border-radius: 3px; border-left: 3px solid ${rateColor};">
                            <strong>${dept.department}</strong><br>
                            <small>${dept.totalApplicants} applicants → ${dept.hired} hired</small><br>
                            <span style="color: ${rateColor}; font-weight: bold;">${successRate}% success rate</span>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }

            // Add Month-over-Month Comparison (NEW)
            if (data.trendComparison) {
                html += `
                    <div style="background: #e9ecef; padding: 10px; border-radius: 3px; margin-bottom: 15px;">
                        <strong>📈 Trend Analysis:</strong> 
                        ${data.trendComparison.currentMonth} applicants this period vs ${data.trendComparison.previousMonth} last period 
                        (<span style="color: ${data.trendComparison.change >= 0 ? '#28a745' : '#dc3545'};">
                            ${data.trendComparison.change >= 0 ? '+' : ''}${data.trendComparison.change}%
                        </span>)
                    </div>
                `;
            }

            // Regular data table (keep existing)
            html += `
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Department</th>
                                <th>Applicant ID</th>
                                <th>Last Name</th>
                                <th>First Name</th>
                                <th>Middle Initial</th>
                                <th>Email</th>
                                <th>Phone Number</th>
                                <th>Job Title</th>
                                <th>Application Date</th>
                                <th>Status</th>
                                <th>Initial Screening Score</th>
                                <th>HR Interview Score</th>
                                <th>Line Manager Score</th>
                                <th>Total Score</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.data.forEach(applicant => {
                const statusClass = getStatusClass(applicant.status);
                html += `
                    <tr>
                        <td>${applicant.department}</td>
                        <td><strong>${applicant.applicantId}</strong></td>
                        <td>${applicant.lastName}</td>
                        <td>${applicant.firstName}</td>
                        <td>${applicant.middleInitial || ''}</td>
                        <td>${applicant.email}</td>
                        <td>${applicant.phoneNumber}</td>
                        <td>${applicant.jobTitle}</td>
                        <td>${applicant.applicationDate}</td>
                        <td><span class="status-badge ${statusClass}">${applicant.status}</span></td>
                        <td>${applicant.initialScreeningScore || 'N/A'}</td>
                        <td>${applicant.hrInterviewScore || 'N/A'}</td>
                        <td>${applicant.lineManagerScore || 'N/A'}</td>
                        <td><strong>${applicant.totalScore || 'N/A'}</strong></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            
            // Add Actionable Insights (NEW)
            if (data.insights && data.insights.length > 0) {
                html += `
                    <div style="background: #d1ecf1; padding: 10px; border-radius: 3px; margin-top: 15px;">
                        <strong>💡 Key Insights & Recommendations:</strong>
                        <ul style="margin: 5px 0 0 20px;">
                `;
                
                data.insights.forEach(insight => {
                    html += `<li>${insight}</li>`;
                });
                
                html += '</ul></div>';
            }
        }
        
        else if (reportType === 'hirees' && data.data && data.data.length > 0) {
    
            // === BUSINESS INTELLIGENCE DASHBOARD ===
            
            // 1. Intelligence Summary Cards
            if (data.intelligence) {
                html += `
                    <div class="intelligence-dashboard">
                        <h4><i class="fas fa-brain"></i> Business Intelligence Summary</h4>
                        <div class="intelligence-cards">
                            <div class="intel-card quality">
                                <div class="intel-icon"><i class="fas fa-star"></i></div>
                                <div class="intel-content">
                                    <div class="intel-value">${data.intelligence.qualityAnalysis.excellentHires.length}</div>
                                    <div class="intel-label">Excellent Hires</div>
                                    <div class="intel-sublabel">Scores ≥90%</div>
                                </div>
                            </div>
                            
                            <div class="intel-card velocity">
                                <div class="intel-icon"><i class="fas fa-rocket"></i></div>
                                <div class="intel-content">
                                    <div class="intel-value">${data.summary.avgTimeToHire}</div>
                                    <div class="intel-label">Avg Time to Hire</div>
                                    <div class="intel-sublabel">${data.summary.avgTimeToHire <= 21 ? 'Excellent' : data.summary.avgTimeToHire <= 45 ? 'Good' : 'Needs Improvement'}</div>
                                </div>
                            </div>
                            
                            <div class="intel-card success">
                                <div class="intel-icon"><i class="fas fa-trophy"></i></div>
                                <div class="intel-content">
                                    <div class="intel-value">${data.summary.successRate}%</div>
                                    <div class="intel-label">Success Rate</div>
                                    <div class="intel-sublabel">Excellent + Good hires</div>
                                </div>
                            </div>
                            
                            <div class="intel-card risk ${data.intelligence.qualityAnalysis.riskHires.length > 0 ? 'warning' : 'safe'}">
                                <div class="intel-icon"><i class="fas fa-shield-alt"></i></div>
                                <div class="intel-content">
                                    <div class="intel-value">${data.intelligence.qualityAnalysis.riskHires.length}</div>
                                    <div class="intel-label">Risk Hires</div>
                                    <div class="intel-sublabel">Need monitoring</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // 2. Key Insights Section
            if (data.insights && data.insights.length > 0) {
                html += `
                    <div class="insights-section">
                        <h4><i class="fas fa-lightbulb"></i> Key Insights</h4>
                        <div class="insights-grid">
                `;
                
                data.insights.forEach(insight => {
                    const insightType = insight.includes('🌟') ? 'positive' : 
                                    insight.includes('⚠️') || insight.includes('📉') ? 'warning' : 
                                    insight.includes('🚀') || insight.includes('🏆') ? 'success' : 'info';
                    
                    html += `
                        <div class="insight-item ${insightType}">
                            <div class="insight-text">${insight}</div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }

            // // 3. Action Items (if any)
            // if (data.actionItems && data.actionItems.length > 0) {
            //     html += `
            //         <div class="action-items-section">
            //             <h4><i class="fas fa-tasks"></i> Required Actions</h4>
            //             <div class="action-items-list">
            //     `;
                
            //     data.actionItems.forEach(action => {
            //         html += `
            //             <div class="action-item urgent">
            //                 <i class="fas fa-exclamation-triangle"></i>
            //                 <span>${action}</span>
            //             </div>
            //         `;
            //     });
                
            //     html += '</div></div>';
            // }

            // // 4. Department Performance Comparison
            // if (data.intelligence && data.intelligence.departmentComparison && data.intelligence.departmentComparison.length > 0) {
            //     html += `
            //         <div class="department-performance">
            //             <h4><i class="fas fa-building"></i> Department Performance Analysis</h4>
            //             <div class="department-cards">
            //     `;
                
            //     data.intelligence.departmentComparison.slice(0, 6).forEach(dept => {
            //         const efficiencyClass = dept.hiringEfficiency === 'Excellent' ? 'excellent' : 
            //                             dept.hiringEfficiency === 'Good' ? 'good' : 'average';
                    
            //         html += `
            //             <div class="dept-card ${efficiencyClass}">
            //                 <div class="dept-header">
            //                     <h5>${dept.department}</h5>
            //                     <span class="efficiency-badge ${efficiencyClass}">${dept.hiringEfficiency}</span>
            //                 </div>
            //                 <div class="dept-metrics">
            //                     <div class="metric">
            //                         <span class="metric-value">${dept.totalHires}</span>
            //                         <span class="metric-label">Total Hires</span>
            //                     </div>
            //                     <div class="metric">
            //                         <span class="metric-value">${dept.avgTimeToHire}d</span>
            //                         <span class="metric-label">Avg Days</span>
            //                     </div>
            //                     <div class="metric">
            //                         <span class="metric-value">${dept.avgScore || 'N/A'}</span>
            //                         <span class="metric-label">Avg Score</span>
            //                     </div>
            //                 </div>
            //             </div>
            //         `;
            //     });
                
            //     html += '</div></div>';
            // }

            // // 5. Quality Distribution Visualization
            // if (data.intelligence && data.intelligence.qualityAnalysis) {
            //     const qa = data.intelligence.qualityAnalysis;
            //     html += `
            //         <div class="quality-analysis">
            //             <h4><i class="fas fa-chart-pie"></i> Hire Quality Distribution</h4>
            //             <div class="quality-bars">
            //                 <div class="quality-bar excellent">
            //                     <div class="bar-label">Excellent (≥90%)</div>
            //                     <div class="bar-container">
            //                         <div class="bar-fill" style="width: ${data.data.length > 0 ? (qa.excellentHires.length / data.data.length) * 100 : 0}%"></div>
            //                     </div>
            //                     <div class="bar-value">${qa.excellentHires.length}</div>
            //                 </div>
                            
            //                 <div class="quality-bar good">
            //                     <div class="bar-label">Good (70-89%)</div>
            //                     <div class="bar-container">
            //                         <div class="bar-fill" style="width: ${data.data.length > 0 ? (qa.goodHires.length / data.data.length) * 100 : 0}%"></div>
            //                     </div>
            //                     <div class="bar-value">${qa.goodHires.length}</div>
            //                 </div>
                            
            //                 <div class="quality-bar average">
            //                     <div class="bar-label">Average (50-69%)</div>
            //                     <div class="bar-container">
            //                         <div class="bar-fill" style="width: ${data.data.length > 0 ? (qa.averageHires.length / data.data.length) * 100 : 0}%"></div>
            //                     </div>
            //                     <div class="bar-value">${qa.averageHires.length}</div>
            //                 </div>
                            
            //                 <div class="quality-bar risk">
            //                     <div class="bar-label">Risk (<50%)</div>
            //                     <div class="bar-container">
            //                         <div class="bar-fill" style="width: ${data.data.length > 0 ? (qa.riskHires.length / data.data.length) * 100 : 0}%"></div>
            //                     </div>
            //                     <div class="bar-value">${qa.riskHires.length}</div>
            //                 </div>
            //             </div>
            //         </div>
            //     `;
            // }

            // // 6. Velocity Analysis
            // if (data.intelligence && data.intelligence.velocityAnalysis) {
            //     const va = data.intelligence.velocityAnalysis;
            //     html += `
            //         <div class="velocity-analysis">
            //             <h4><i class="fas fa-tachometer-alt"></i> Hiring Velocity Analysis</h4>
            //             <div class="velocity-metrics">
            //                 <div class="velocity-metric fast">
            //                     <div class="velocity-icon"><i class="fas fa-rocket"></i></div>
            //                     <div class="velocity-data">
            //                         <div class="velocity-number">${va.fastHires.length}</div>
            //                         <div class="velocity-label">Fast Hires</div>
            //                         <div class="velocity-desc">≤21 days</div>
            //                     </div>
            //                 </div>
                            
            //                 <div class="velocity-metric standard">
            //                     <div class="velocity-icon"><i class="fas fa-clock"></i></div>
            //                     <div class="velocity-data">
            //                         <div class="velocity-number">${va.standardHires.length}</div>
            //                         <div class="velocity-label">Standard</div>
            //                         <div class="velocity-desc">22-45 days</div>
            //                     </div>
            //                 </div>
                            
            //                 <div class="velocity-metric slow">
            //                     <div class="velocity-icon"><i class="fas fa-hourglass-half"></i></div>
            //                     <div class="velocity-data">
            //                         <div class="velocity-number">${va.slowHires.length}</div>
            //                         <div class="velocity-label">Slow</div>
            //                         <div class="velocity-desc">45+ days</div>
            //                     </div>
            //                 </div>
            //             </div>
            //         </div>
            //     `;
            // }

            // 7. Success Metrics
            if (data.successMetrics && data.successMetrics.length > 0) {
                html += `
                    <div class="success-metrics">
                        <h4><i class="fas fa-medal"></i> Success Metrics</h4>
                        <div class="metrics-list">
                `;
                
                data.successMetrics.forEach(metric => {
                    html += `
                        <div class="success-metric">
                            <i class="fas fa-check-circle"></i>
                            <span>${metric}</span>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }

            // // 8. Recommendations
            // if (data.recommendations && data.recommendations.length > 0) {
            //     html += `
            //         <div class="recommendations-section">
            //             <h4><i class="fas fa-clipboard-list"></i> Strategic Recommendations</h4>
            //             <div class="recommendations-list">
            //     `;
                
            //     data.recommendations.forEach(rec => {
            //         html += `
            //             <div class="recommendation-item">
            //                 <i class="fas fa-arrow-right"></i>
            //                 <span>${rec}</span>
            //             </div>
            //         `;
            //     });
                
            //     html += '</div></div>';
            // }

            // 9. Enhanced Data Table with Intelligence Flags
            html += `
                <div class="data-table-container">
                    <h4><i class="fas fa-table"></i> Detailed Hirees Data</h4>
                    <table class="data-table enhanced">
                        <thead>
                            <tr>
                                <th>Hire ID</th>
                                <th>Name</th>
                                <th>Department</th>
                                <th>Job Title</th>
                                <th>Job Type</th>
                                <th>Hire Date</th>
                                <th>Days to Hire</th>
                                <th>Total Score</th>
                                <th>Quality</th>
                                <th>Risk Level</th>
                                <th>Flags</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.data.forEach(hiree => {
                const qualityClass = hiree.hireQuality === 'Excellent' ? 'excellent' : 
                                    hiree.hireQuality === 'Good' ? 'good' : 
                                    hiree.hireQuality === 'Average' ? 'average' : 'risk';
                
                const riskClass = hiree.retentionRisk === 'Low' ? 'low-risk' : 
                                hiree.retentionRisk === 'Medium' ? 'medium-risk' : 'high-risk';
                
                // Generate flags display
                let flagsHtml = '';
                if (hiree.intelligenceFlags && hiree.intelligenceFlags.length > 0) {
                    hiree.intelligenceFlags.forEach(flag => {
                        const flagClass = flag === 'top-performer' ? 'flag-excellent' : 
                                        flag === 'fast-hire' ? 'flag-fast' : 
                                        flag === 'retention-risk' ? 'flag-risk' : 
                                        flag === 'onboarding' ? 'flag-onboarding' : 'flag-normal';
                        
                        flagsHtml += `<span class="intelligence-flag ${flagClass}">${flag.replace('-', ' ')}</span>`;
                    });
                }
                
                html += `
                    <tr class="enhanced-row">
                        <td><strong>${hiree.hireId}</strong></td>
                        <td>${hiree.firstName} ${hiree.lastName}</td>
                        <td>${hiree.department}</td>
                        <td>${hiree.jobTitle}</td>
                        <td>${hiree.jobType}</td>
                        <td>${hiree.hireDate}</td>
                        <td><span class="days-badge ${hiree.daysToHire <= 21 ? 'fast' : hiree.daysToHire <= 45 ? 'standard' : 'slow'}">${hiree.daysToHire}d</span></td>
                        <td><strong>${hiree.totalScore}</strong></td>
                        <td><span class="quality-badge ${qualityClass}">${hiree.hireQuality}</span></td>
                        <td><span class="risk-badge ${riskClass}">${hiree.retentionRisk}</span></td>
                        <td class="flags-cell">${flagsHtml}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';

            // 10. Seasonal Insights (if available)
            if (data.intelligence && data.intelligence.seasonalAnalysis && data.summary.peakHiringMonth) {
                html += `
                    <div class="seasonal-insights">
                        <h4><i class="fas fa-calendar-alt"></i> Seasonal Hiring Insights</h4>
                        <div class="seasonal-content">
                            <div class="peak-month">
                                <i class="fas fa-chart-line"></i>
                                <span>Peak hiring month: <strong>${data.summary.peakHiringMonth}</strong></span>
                            </div>
                            <div class="seasonal-tip">
                                <i class="fas fa-info-circle"></i>
                                <span>Plan increased recruitment activities around this period for optimal results</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        else if (reportType === 'status' && data.applicant) {
    
            // // === INTELLIGENCE HEADER WITH PRIORITY & RISK ===
            // html += `
            //     <div class="applicant-intelligence-header">
            //         <div class="applicant-overview">
            //             <div class="applicant-name">
            //                 <h4><i class="fas fa-user-circle"></i> ${data.applicant.firstName} ${data.applicant.lastName}</h4>
            //                 <div class="applicant-id">ID: ${data.applicant.applicantId}</div>
            //             </div>
            //             <div class="intelligence-badges">
            //                 <span class="priority-badge priority-${data.applicant.priorityLevel.toLowerCase()}">${data.applicant.priorityLevel} Priority</span>
            //                 <span class="risk-badge risk-${data.applicant.riskLevel.toLowerCase()}">${data.applicant.riskLevel} Risk</span>
            //                 <span class="urgency-badge urgency-${data.applicant.urgencyLevel.toLowerCase().replace(' ', '-')}">${data.applicant.urgencyLevel}</span>
            //             </div>
            //         </div>
                    
            //         <div class="intelligence-score">
            //             <div class="score-circle priority-${data.applicant.priorityLevel.toLowerCase()}">
            //                 <span class="score-value">${data.applicant.priorityScore || 0}</span>
            //                 <span class="score-label">Priority Score</span>
            //             </div>
            //         </div>
            //     </div>
            // `;

            // // === CRITICAL ALERTS SECTION ===
            // if (data.intelligence && (data.intelligence.nextActions.length > 0 || data.applicant.urgencyLevel === 'Critical')) {
            //     html += `
            //         <div class="critical-alerts">
            //             <h4><i class="fas fa-exclamation-triangle"></i> Immediate Action Required</h4>
            //             <div class="alerts-container">
            //     `;
                
            //     if (data.applicant.urgencyLevel === 'Critical') {
            //         html += `
            //             <div class="alert critical">
            //                 <i class="fas fa-fire"></i>
            //                 <div class="alert-content">
            //                     <div class="alert-title">CRITICAL: ${data.applicant.daysInProcess} days in process</div>
            //                     <div class="alert-desc">Candidate may lose interest - immediate decision required</div>
            //                 </div>
            //             </div>
            //         `;
            //     }
                
            //     if (data.intelligence.nextActions && data.intelligence.nextActions.length > 0) {
            //         data.intelligence.nextActions.forEach(action => {
            //             const isUrgent = action.includes('REQUIRED') || action.includes('ESCALATION');
            //             html += `
            //                 <div class="alert ${isUrgent ? 'urgent' : 'normal'}">
            //                     <i class="fas ${isUrgent ? 'fa-bolt' : 'fa-arrow-right'}"></i>
            //                     <div class="alert-content">
            //                         <div class="alert-title">${isUrgent ? 'URGENT ACTION' : 'Next Action'}</div>
            //                         <div class="alert-desc">${action}</div>
            //                     </div>
            //                 </div>
            //             `;
            //         });
            //     }
                
            //     html += '</div></div>';
            // }

            // // === INTELLIGENCE DASHBOARD ===
            // html += `
            //     <div class="status-intelligence-dashboard">
            //         <div class="intelligence-metrics">
            //             <div class="metric-card candidate-quality">
            //                 <div class="metric-icon quality-${data.applicant.candidateQuality.toLowerCase().replace(' ', '-')}">
            //                     <i class="fas fa-star"></i>
            //                 </div>
            //                 <div class="metric-content">
            //                     <div class="metric-value">${data.applicant.candidateQuality}</div>
            //                     <div class="metric-label">Candidate Quality</div>
            //                 </div>
            //             </div>
                        
            //             <div class="metric-card process-efficiency">
            //                 <div class="metric-icon efficiency-${data.applicant.processEfficiency.toLowerCase().replace(' ', '-')}">
            //                     <i class="fas fa-cogs"></i>
            //                 </div>
            //                 <div class="metric-content">
            //                     <div class="metric-value">${data.applicant.processEfficiency}</div>
            //                     <div class="metric-label">Process Efficiency</div>
            //                 </div>
            //             </div>
                        
            //             <div class="metric-card timeline-status">
            //                 <div class="metric-icon timeline-${data.applicant.daysInProcess <= 30 ? 'good' : data.applicant.daysInProcess <= 45 ? 'warning' : 'critical'}">
            //                     <i class="fas fa-clock"></i>
            //                 </div>
            //                 <div class="metric-content">
            //                     <div class="metric-value">${data.applicant.daysInProcess} days</div>
            //                     <div class="metric-label">In Process</div>
            //                 </div>
            //             </div>
                        
            //             <div class="metric-card total-score">
            //                 <div class="metric-icon score-${data.applicant.totalScore === 'N/A' ? 'none' : data.applicant.totalScore >= 240 ? 'excellent' : data.applicant.totalScore >= 180 ? 'good' : 'average'}">
            //                     <i class="fas fa-chart-bar"></i>
            //                 </div>
            //                 <div class="metric-content">
            //                     <div class="metric-value">${data.applicant.totalScore}</div>
            //                     <div class="metric-label">Total Score</div>
            //                 </div>
            //             </div>
            //         </div>
            //     </div>
            // `;

            // // === PERFORMANCE INDICATORS ===
            // if (data.intelligence && data.intelligence.performanceIndicators && data.intelligence.performanceIndicators.length > 0) {
            //     html += `
            //         <div class="performance-indicators">
            //             <h4><i class="fas fa-chart-line"></i> Performance Indicators</h4>
            //             <div class="indicators-grid">
            //     `;
                
            //     data.intelligence.performanceIndicators.forEach(indicator => {
            //         const indicatorType = indicator.includes('Top-tier') || indicator.includes('excellent') ? 'positive' : 
            //                             indicator.includes('Below-average') || indicator.includes('carefully') ? 'warning' : 'neutral';
                    
            //         html += `
            //             <div class="indicator-item ${indicatorType}">
            //                 <i class="fas ${indicatorType === 'positive' ? 'fa-arrow-up' : indicatorType === 'warning' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
            //                 <span>${indicator}</span>
            //             </div>
            //         `;
            //     });
                
            //     html += '</div></div>';
            // }

            // // === PROCESS TIMELINE VISUALIZATION ===
            // html += `
            //     <div class="process-timeline">
            //         <h4><i class="fas fa-route"></i> Application Process Timeline</h4>
            //         <div class="timeline-progress">
            //             <div class="timeline-step ${data.applicant.hrScreeningApproved !== 'Pending' ? 'completed' : 'current'}">
            //                 <div class="step-circle">
            //                     <i class="fas ${data.applicant.hrScreeningApproved === 'Yes' ? 'fa-check' : data.applicant.hrScreeningApproved === 'No' ? 'fa-times' : 'fa-clock'}"></i>
            //                 </div>
            //                 <div class="step-content">
            //                     <div class="step-title">HR Screening</div>
            //                     <div class="step-status status-${data.applicant.hrScreeningApproved.toLowerCase()}">${data.applicant.hrScreeningApproved}</div>
            //                     <div class="step-score">HR Score: ${data.applicant.hrInterviewScore}</div>
            //                 </div>
            //             </div>
                        
            //             <div class="timeline-connector ${data.applicant.hrScreeningApproved === 'Yes' ? 'active' : ''}"></div>
                        
            //             <div class="timeline-step ${data.applicant.panelScreeningApproved !== 'Pending' ? 'completed' : data.applicant.hrScreeningApproved === 'Yes' ? 'current' : ''}">
            //                 <div class="step-circle">
            //                     <i class="fas ${data.applicant.panelScreeningApproved === 'Yes' ? 'fa-check' : data.applicant.panelScreeningApproved === 'No' ? 'fa-times' : 'fa-clock'}"></i>
            //                 </div>
            //                 <div class="step-content">
            //                     <div class="step-title">Panel/Line Manager Review</div>
            //                     <div class="step-status status-${data.applicant.panelScreeningApproved.toLowerCase()}">${data.applicant.panelScreeningApproved}</div>
            //                     <div class="step-score">Manager Score: ${data.applicant.lineManagerScore}</div>
            //                 </div>
            //             </div>
                        
            //             <div class="timeline-connector ${data.applicant.panelScreeningApproved === 'Yes' ? 'active' : ''}"></div>
                        
            //             <div class="timeline-step ${data.applicant.isHired === 'Hired' ? 'completed' : data.applicant.panelScreeningApproved === 'Yes' ? 'current' : ''}">
            //                 <div class="step-circle">
            //                     <i class="fas ${data.applicant.isHired === 'Hired' ? 'fa-user-check' : data.applicant.isHired === 'Rejected' ? 'fa-user-times' : 'fa-hourglass-half'}"></i>
            //                 </div>
            //                 <div class="step-content">
            //                     <div class="step-title">Final Decision</div>
            //                     <div class="step-status status-${data.applicant.isHired.toLowerCase().replace(' ', '-')}">${data.applicant.isHired}</div>
            //                     <div class="step-score">Total: ${data.applicant.totalScore}</div>
            //                 </div>
            //             </div>
            //         </div>
            //     </div>
            // `;

            // === DETAILED APPLICANT INFORMATION ===
            html += `
                <div class="applicant-details-section">
                    <h4><i class="fas fa-id-card"></i> Applicant Information</h4>
                    <div class="details-grid">
                        <div class="detail-group personal">
                            <h5><i class="fas fa-user"></i> Personal Details</h5>
                            <div class="detail-items">
                                <div class="detail-item">
                                    <span class="detail-label">Full Name:</span>
                                    <span class="detail-value">${data.applicant.firstName} ${data.applicant.middleInitial} ${data.applicant.lastName}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Email:</span>
                                    <span class="detail-value">${data.applicant.email}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Phone:</span>
                                    <span class="detail-value">${data.applicant.phoneNumber}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Birth Date:</span>
                                    <span class="detail-value">${data.applicant.birthDate}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="detail-group position">
                            <h5><i class="fas fa-briefcase"></i> Position Details</h5>
                            <div class="detail-items">
                                <div class="detail-item">
                                    <span class="detail-label">Job Position:</span>
                                    <span class="detail-value">${data.applicant.jobPosition}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Department:</span>
                                    <span class="detail-value">${data.applicant.department}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Application Date:</span>
                                    <span class="detail-value">${data.applicant.applicationDate}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Current Status:</span>
                                    <span class="detail-value status-badge">${data.applicant.currentStatus}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="detail-group scores">
                            <h5><i class="fas fa-chart-bar"></i> Evaluation Scores</h5>
                            <div class="score-breakdown">
                                <div class="score-item">
                                    <span class="score-label">Initial Screening:</span>
                                    <div class="score-bar">
                                        <div class="score-fill" style="width: ${data.applicant.initialScreeningScore !== 'N/A' ? (data.applicant.initialScreeningScore / 100) * 100 : 0}%"></div>
                                        <span class="score-text">${data.applicant.initialScreeningScore}</span>
                                    </div>
                                </div>
                                <div class="score-item">
                                    <span class="score-label">HR Interview:</span>
                                    <div class="score-bar">
                                        <div class="score-fill" style="width: ${data.applicant.hrInterviewScore !== 'N/A' ? (data.applicant.hrInterviewScore / 100) * 100 : 0}%"></div>
                                        <span class="score-text">${data.applicant.hrInterviewScore}</span>
                                    </div>
                                </div>
                                <div class="score-item">
                                    <span class="score-label">Line Manager:</span>
                                    <div class="score-bar">
                                        <div class="score-fill" style="width: ${data.applicant.lineManagerScore !== 'N/A' ? (data.applicant.lineManagerScore / 100) * 100 : 0}%"></div>
                                        <span class="score-text">${data.applicant.lineManagerScore}</span>
                                    </div>
                                </div>
                                <div class="score-item total">
                                    <span class="score-label">Total Score:</span>
                                    <div class="score-bar total">
                                        <div class="score-fill" style="width: ${data.applicant.totalScore !== 'N/A' ? (data.applicant.totalScore / 300) * 100 : 0}%"></div>
                                        <span class="score-text total">${data.applicant.totalScore}/300</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // === RECOMMENDATIONS SECTION ===
            if (data.intelligence && data.intelligence.recommendations && data.intelligence.recommendations.length > 0) {
                html += `
                    <div class="recommendations-section">
                        <h4><i class="fas fa-lightbulb"></i> Recommendations</h4>
                        <div class="recommendations-list">
                `;
                
                data.intelligence.recommendations.forEach(rec => {
                    html += `
                        <div class="recommendation-item">
                            <i class="fas fa-arrow-right"></i>
                            <span>${rec}</span>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }

            // === STATUS HISTORY WITH ENHANCED TIMELINE ===
            if (data.statusHistory && data.statusHistory.length > 0) {
                html += `
                    <div class="status-history-section">
                        <h4><i class="fas fa-history"></i> Detailed Status History</h4>
                        <div class="history-timeline">
                `;
                
                data.statusHistory.forEach((history, index) => {
                    const isFirst = index === 0;
                    const isLast = index === data.statusHistory.length - 1;
                    
                    html += `
                        <div class="history-item ${isFirst ? 'first' : ''} ${isLast ? 'last' : ''}">
                            <div class="history-marker">
                                <div class="history-dot"></div>
                                ${!isLast ? '<div class="history-line"></div>' : ''}
                            </div>
                            <div class="history-content">
                                <div class="history-header">
                                    <span class="history-status">${history.status}</span>
                                    <span class="history-date">${history.date}</span>
                                </div>
                                <div class="history-notes">${history.notes}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }

            // // === INTELLIGENCE SUMMARY ===
            // html += `
            //     <div class="intelligence-summary">
            //         <h4><i class="fas fa-brain"></i> Intelligence Summary</h4>
            //         <div class="summary-grid">
            //             <div class="summary-item">
            //                 <i class="fas fa-shield-alt"></i>
            //                 <div class="summary-content">
            //                     <div class="summary-label">Risk Assessment</div>
            //                     <div class="summary-value risk-${data.applicant.riskLevel.toLowerCase()}">${data.applicant.riskLevel} Risk Level</div>
            //                 </div>
            //             </div>
                        
            //             <div class="summary-item">
            //                 <i class="fas fa-bolt"></i>
            //                 <div class="summary-content">
            //                     <div class="summary-label">Urgency Level</div>
            //                     <div class="summary-value urgency-${data.applicant.urgencyLevel.toLowerCase().replace(' ', '-')}">${data.applicant.urgencyLevel}</div>
            //                 </div>
            //             </div>
                        
            //             <div class="summary-item">
            //                 <i class="fas fa-star"></i>
            //                 <div class="summary-content">
            //                     <div class="summary-label">Quality Rating</div>
            //                     <div class="summary-value quality-${data.applicant.candidateQuality.toLowerCase().replace(' ', '-')}">${data.applicant.candidateQuality}</div>
            //                 </div>
            //             </div>
                        
            //             <div class="summary-item">
            //                 <i class="fas fa-cogs"></i>
            //                 <div class="summary-content">
            //                     <div class="summary-label">Process Status</div>
            //                     <div class="summary-value efficiency-${data.applicant.processEfficiency.toLowerCase().replace(' ', '-')}">${data.applicant.processEfficiency}</div>
            //                 </div>
            //             </div>
            //         </div>
            //     </div>
            // `;
        }
        
        else if (reportType === 'timeline') {
    
            // // === PROCESS HEALTH DASHBOARD ===
            // if (data.intelligence && data.intelligence.optimizationAnalysis) {
            //     const health = data.intelligence.optimizationAnalysis;
            //     html += `
            //         <div class="process-health-dashboard">
            //             <div class="health-overview">
            //                 <div class="health-score-circle health-${health.processHealth.toLowerCase()}">
            //                     <div class="health-score-value">${health.healthScore}</div>
            //                     <div class="health-score-label">Health Score</div>
            //                 </div>
            //                 <div class="health-status">
            //                     <h3>Process Health: ${health.processHealth}</h3>
            //                     <div class="health-indicators">
            //                         <div class="health-indicator ${health.processEfficiencies.length > 0 ? 'positive' : 'neutral'}">
            //                             <i class="fas fa-check-circle"></i>
            //                             <span>${health.processEfficiencies.length} Strengths Identified</span>
            //                         </div>
            //                         <div class="health-indicator ${health.criticalIssues.length > 0 ? 'critical' : 'positive'}">
            //                             <i class="fas ${health.criticalIssues.length > 0 ? 'fa-exclamation-triangle' : 'fa-shield-check'}"></i>
            //                             <span>${health.criticalIssues.length > 0 ? health.criticalIssues.length + ' Critical Issues' : 'No Critical Issues'}</span>
            //                         </div>
            //                     </div>
            //                 </div>
            //             </div>
            //         </div>
            //     `;
            // }

            // === CRITICAL ALERTS FOR TIMELINE ISSUES ===
            if (data.intelligence && (data.intelligence.bottleneckAnalysis.criticalBottleneck || (data.actionItems && data.actionItems.length > 0))) {
                html += `
                    <div class="timeline-critical-alerts">
                        <h4><i class="fas fa-exclamation-triangle"></i> Critical Timeline Issues</h4>
                        <div class="timeline-alerts-container">
                `;
                
                if (data.intelligence.bottleneckAnalysis.criticalBottleneck) {
                    const severity = data.intelligence.bottleneckAnalysis.bottleneckSeverity;
                    html += `
                        <div class="timeline-alert bottleneck severity-${severity.toLowerCase()}">
                            <i class="fas fa-roadblock"></i>
                            <div class="alert-content">
                                <div class="alert-title">BOTTLENECK DETECTED</div>
                                <div class="alert-desc">${data.intelligence.bottleneckAnalysis.criticalBottleneck} - ${severity} Severity</div>
                            </div>
                        </div>
                    `;
                }
                
                if (data.actionItems && data.actionItems.length > 0) {
                    data.actionItems.slice(0, 3).forEach(action => {
                        html += `
                            <div class="timeline-alert action-required">
                                <i class="fas fa-bolt"></i>
                                <div class="alert-content">
                                    <div class="alert-title">ACTION REQUIRED</div>
                                    <div class="alert-desc">${action}</div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div></div>';
            }

            // === ENHANCED SUMMARY STATISTICS ===
            if (data.summaryStats) {
                html += `
                    <div class="timeline-enhanced-summary">
                        <h4><i class="fas fa-chart-dashboard"></i> Timeline Performance Metrics</h4>
                        <div class="timeline-metrics-grid">
                            <div class="timeline-metric primary">
                                <div class="metric-icon">
                                    <i class="fas fa-stopwatch"></i>
                                </div>
                                <div class="metric-content">
                                    <div class="metric-value">${data.summaryStats.averageMrfToOnboarding}</div>
                                    <div class="metric-label">Average Days</div>
                                    <div class="metric-sublabel">MRF to Onboarding</div>
                                </div>
                                <div class="metric-status ${data.summaryStats.averageMrfToOnboarding <= 30 ? 'excellent' : data.summaryStats.averageMrfToOnboarding <= 45 ? 'good' : 'poor'}">
                                    ${data.summaryStats.averageMrfToOnboarding <= 30 ? 'Excellent' : data.summaryStats.averageMrfToOnboarding <= 45 ? 'Good' : 'Needs Work'}
                                </div>
                            </div>
                            
                            <div class="timeline-metric success">
                                <div class="metric-icon">
                                    <i class="fas fa-rocket"></i>
                                </div>
                                <div class="metric-content">
                                    <div class="metric-value">${data.summaryStats.fastHireRate || 0}%</div>
                                    <div class="metric-label">Fast Hire Rate</div>
                                    <div class="metric-sublabel">≤21 days</div>
                                </div>
                                <div class="metric-status ${(data.summaryStats.fastHireRate || 0) >= 50 ? 'excellent' : (data.summaryStats.fastHireRate || 0) >= 30 ? 'good' : 'poor'}">
                                    ${(data.summaryStats.fastHireRate || 0) >= 50 ? 'Excellent' : (data.summaryStats.fastHireRate || 0) >= 30 ? 'Good' : 'Low'}
                                </div>
                            </div>
                            
                            <div class="timeline-metric warning">
                                <div class="metric-icon">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                                <div class="metric-content">
                                    <div class="metric-value">${data.summaryStats.bottleneckSeverity || 'None'}</div>
                                    <div class="metric-label">Bottleneck Level</div>
                                    <div class="metric-sublabel">Process Constraints</div>
                                </div>
                                <div class="metric-status ${data.summaryStats.bottleneckSeverity === 'Low' || !data.summaryStats.bottleneckSeverity ? 'excellent' : data.summaryStats.bottleneckSeverity === 'Medium' ? 'good' : 'poor'}">
                                    ${!data.summaryStats.bottleneckSeverity || data.summaryStats.bottleneckSeverity === 'Low' ? 'Healthy' : 'Issues Found'}
                                </div>
                            </div>
                            
                            <div class="timeline-metric info">
                                <div class="metric-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="metric-content">
                                    <div class="metric-value">${data.summaryStats.processHealthScore || 0}</div>
                                    <div class="metric-label">Health Score</div>
                                    <div class="metric-sublabel">Out of 100</div>
                                </div>
                                <div class="metric-status ${(data.summaryStats.processHealthScore || 0) >= 80 ? 'excellent' : (data.summaryStats.processHealthScore || 0) >= 60 ? 'good' : 'poor'}">
                                    ${(data.summaryStats.processHealthScore || 0) >= 80 ? 'Excellent' : (data.summaryStats.processHealthScore || 0) >= 60 ? 'Good' : 'Poor'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // // === TIMELINE ANALYSIS VISUALIZATION ===
            // if (data.intelligence && data.intelligence.timelineAnalysis) {
            //     const ta = data.intelligence.timelineAnalysis;
            //     html += `
            //         <div class="timeline-analysis-section">
            //             <h4><i class="fas fa-chart-bar"></i> Timeline Performance Distribution</h4>
            //             <div class="timeline-distribution">
            //                 <div class="timeline-category excellent">
            //                     <div class="category-header">
            //                         <i class="fas fa-rocket"></i>
            //                         <div class="category-info">
            //                             <div class="category-title">Fast Track</div>
            //                             <div class="category-desc">≤21 days</div>
            //                         </div>
            //                     </div>
            //                     <div class="category-count">${ta.fast.length}</div>
            //                     <div class="category-bar">
            //                         <div class="bar-fill" style="width: ${data.totalHired > 0 ? (ta.fast.length / data.totalHired) * 100 : 0}%"></div>
            //                     </div>
            //                 </div>
                            
            //                 <div class="timeline-category good">
            //                     <div class="category-header">
            //                         <i class="fas fa-clock"></i>
            //                         <div class="category-info">
            //                             <div class="category-title">Standard</div>
            //                             <div class="category-desc">22-45 days</div>
            //                         </div>
            //                     </div>
            //                     <div class="category-count">${ta.standard.length}</div>
            //                     <div class="category-bar">
            //                         <div class="bar-fill" style="width: ${data.totalHired > 0 ? (ta.standard.length / data.totalHired) * 100 : 0}%"></div>
            //                     </div>
            //                 </div>
                            
            //                 <div class="timeline-category warning">
            //                     <div class="category-header">
            //                         <i class="fas fa-hourglass-half"></i>
            //                         <div class="category-info">
            //                             <div class="category-title">Slow</div>
            //                             <div class="category-desc">46-75 days</div>
            //                         </div>
            //                     </div>
            //                     <div class="category-count">${ta.slow.length}</div>
            //                     <div class="category-bar">
            //                         <div class="bar-fill" style="width: ${data.totalHired > 0 ? (ta.slow.length / data.totalHired) * 100 : 0}%"></div>
            //                     </div>
            //                 </div>
                            
            //                 <div class="timeline-category critical">
            //                     <div class="category-header">
            //                         <i class="fas fa-exclamation-triangle"></i>
            //                         <div class="category-info">
            //                             <div class="category-title">Critical</div>
            //                             <div class="category-desc">75+ days</div>
            //                         </div>
            //                     </div>
            //                     <div class="category-count">${ta.critical.length}</div>
            //                     <div class="category-bar">
            //                         <div class="bar-fill" style="width: ${data.totalHired > 0 ? (ta.critical.length / data.totalHired) * 100 : 0}%"></div>
            //                     </div>
            //                 </div>
            //             </div>
            //         </div>
            //     `;
            // }

            // // === BOTTLENECK ANALYSIS ===
            // if (data.intelligence && data.intelligence.bottleneckAnalysis) {
            //     const ba = data.intelligence.bottleneckAnalysis;
            //     html += `
            //         <div class="bottleneck-analysis">
            //             <h4><i class="fas fa-search"></i> Bottleneck Analysis</h4>
            //             <div class="bottleneck-stages">
            //                 <div class="stage-analysis hr-stage">
            //                     <div class="stage-header">
            //                         <i class="fas fa-user-tie"></i>
            //                         <div class="stage-info">
            //                             <div class="stage-title">HR Interview Stage</div>
            //                             <div class="stage-desc">Candidates stuck >14 days</div>
            //                         </div>
            //                     </div>
            //                     <div class="stage-count ${ba.stageAnalysis.hrStage > 5 ? 'high' : ba.stageAnalysis.hrStage > 0 ? 'medium' : 'low'}">
            //                         ${ba.stageAnalysis.hrStage}
            //                     </div>
            //                     <div class="stage-status">
            //                         ${ba.stageAnalysis.hrStage > 5 ? 'High Concern' : ba.stageAnalysis.hrStage > 0 ? 'Monitor' : 'Healthy'}
            //                     </div>
            //                 </div>
                            
            //                 <div class="stage-analysis manager-stage">
            //                     <div class="stage-header">
            //                         <i class="fas fa-users-cog"></i>
            //                         <div class="stage-info">
            //                             <div class="stage-title">Line Manager Stage</div>
            //                             <div class="stage-desc">Candidates stuck >21 days</div>
            //                         </div>
            //                     </div>
            //                     <div class="stage-count ${ba.stageAnalysis.lineManagerStage > 5 ? 'high' : ba.stageAnalysis.lineManagerStage > 0 ? 'medium' : 'low'}">
            //                         ${ba.stageAnalysis.lineManagerStage}
            //                     </div>
            //                     <div class="stage-status">
            //                         ${ba.stageAnalysis.lineManagerStage > 5 ? 'High Concern' : ba.stageAnalysis.lineManagerStage > 0 ? 'Monitor' : 'Healthy'}
            //                     </div>
            //                 </div>
                            
            //                 <div class="stage-analysis screening-stage">
            //                     <div class="stage-header">
            //                         <i class="fas fa-filter"></i>
            //                         <div class="stage-info">
            //                             <div class="stage-title">Initial Screening</div>
            //                             <div class="stage-desc">Candidates stuck >7 days</div>
            //                         </div>
            //                     </div>
            //                     <div class="stage-count ${ba.stageAnalysis.initialScreening > 5 ? 'high' : ba.stageAnalysis.initialScreening > 0 ? 'medium' : 'low'}">
            //                         ${ba.stageAnalysis.initialScreening}
            //                     </div>
            //                     <div class="stage-status">
            //                         ${ba.stageAnalysis.initialScreening > 5 ? 'High Concern' : ba.stageAnalysis.initialScreening > 0 ? 'Monitor' : 'Healthy'}
            //                     </div>
            //                 </div>
            //             </div>
                        
            //             ${ba.criticalBottleneck ? `
            //                 <div class="critical-bottleneck-alert">
            //                     <i class="fas fa-exclamation-circle"></i>
            //                     <div class="bottleneck-content">
            //                         <div class="bottleneck-title">Critical Bottleneck Identified</div>
            //                         <div class="bottleneck-desc">${ba.criticalBottleneck} requires immediate attention</div>
            //                     </div>
            //                 </div>
            //             ` : ''}
            //         </div>
            //     `;
            // }

            // // === DEPARTMENT COMPARISON ===
            // if (data.intelligence && data.intelligence.departmentComparison && data.intelligence.departmentComparison.length > 0) {
            //     html += `
            //         <div class="department-timeline-comparison">
            //             <h4><i class="fas fa-building"></i> Department Timeline Efficiency</h4>
            //             <div class="department-timeline-grid">
            //     `;
                
            //     data.intelligence.departmentComparison.slice(0, 6).forEach(dept => {
            //         const efficiencyClass = dept.efficiency === 'Excellent' ? 'excellent' : 
            //                             dept.efficiency === 'Good' ? 'good' : 
            //                             dept.efficiency === 'Average' ? 'average' : 'poor';
                    
            //         html += `
            //             <div class="dept-timeline-card ${efficiencyClass}">
            //                 <div class="dept-timeline-header">
            //                     <h5>${dept.department}</h5>
            //                     <span class="efficiency-badge ${efficiencyClass}">${dept.efficiency}</span>
            //                 </div>
            //                 <div class="dept-timeline-metrics">
            //                     <div class="timeline-metric-item">
            //                         <span class="metric-label">Hires</span>
            //                         <span class="metric-value">${dept.hires}</span>
            //                     </div>
            //                     <div class="timeline-metric-item">
            //                         <span class="metric-label">Avg Days</span>
            //                         <span class="metric-value">${dept.avgDays}d</span>
            //                     </div>
            //                     <div class="timeline-metric-item">
            //                         <span class="metric-label">Fast Rate</span>
            //                         <span class="metric-value">${dept.fastHireRate}%</span>
            //                     </div>
            //                 </div>
            //                 <div class="dept-timeline-bar">
            //                     <div class="timeline-bar-fill ${efficiencyClass}" style="width: ${Math.max(10, 100 - (dept.avgDays - 20))}%"></div>
            //                 </div>
            //             </div>
            //         `;
            //     });
                
            //     html += '</div></div>';
            // }

            // === KEY INSIGHTS ===
            if (data.insights && data.insights.length > 0) {
                html += `
                    <div class="timeline-insights">
                        <h4><i class="fas fa-lightbulb"></i> Timeline Intelligence Insights</h4>
                        <div class="timeline-insights-grid">
                `;
                
                data.insights.forEach(insight => {
                    const insightType = insight.includes('🚀') || insight.includes('💪') || insight.includes('✅') ? 'positive' : 
                                    insight.includes('🚨') || insight.includes('⚠️') || insight.includes('📉') ? 'critical' : 
                                    insight.includes('🔴') || insight.includes('⏰') ? 'warning' : 'info';
                    
                    html += `
                        <div class="timeline-insight-item ${insightType}">
                            <div class="insight-icon">
                                <i class="fas ${insightType === 'positive' ? 'fa-check-circle' : 
                                            insightType === 'critical' ? 'fa-exclamation-triangle' : 
                                            insightType === 'warning' ? 'fa-clock' : 'fa-info-circle'}"></i>
                            </div>
                            <div class="insight-text">${insight}</div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }

            // // === OPTIMIZATION RECOMMENDATIONS ===
            // if (data.recommendations && data.recommendations.length > 0) {
            //     html += `
            //         <div class="timeline-optimization">
            //             <h4><i class="fas fa-cogs"></i> Process Optimization Recommendations</h4>
            //             <div class="optimization-list">
            //     `;
                
            //     data.recommendations.forEach((rec, index) => {
            //         html += `
            //             <div class="optimization-item">
            //                 <div class="optimization-priority">${index + 1}</div>
            //                 <div class="optimization-content">
            //                     <i class="fas fa-arrow-right"></i>
            //                     <span>${rec}</span>
            //                 </div>
            //             </div>
            //         `;
            //     });
                
            //     html += '</div></div>';
            // }

            // // === ENHANCED SUMMARY BREAKDOWN ===
            // if (data.summaryStats && data.summaryStats.averageStages) {
            //     html += `
            //         <div class="timeline-breakdown-section">
            //             <h4><i class="fas fa-sitemap"></i> MRF to Onboarding Stage Breakdown</h4>
            //             <div class="stages-breakdown">
            //                 <div class="stage-breakdown-item">
            //                     <div class="stage-icon">
            //                         <i class="fas fa-file-alt"></i>
            //                     </div>
            //                     <div class="stage-content">
            //                         <div class="stage-title">MRF to Job Posting</div>
            //                         <div class="stage-days">${data.summaryStats.averageStages.mrfToJobPosting} days</div>
            //                         <div class="stage-bar">
            //                             <div class="stage-fill" style="width: ${(data.summaryStats.averageStages.mrfToJobPosting / 14) * 100}%"></div>
            //                         </div>
            //                     </div>
            //                 </div>
                            
            //                 <div class="stage-breakdown-item">
            //                     <div class="stage-icon">
            //                         <i class="fas fa-search"></i>
            //                     </div>
            //                     <div class="stage-content">
            //                         <div class="stage-title">Job Posting to Initial Interview</div>
            //                         <div class="stage-days">${data.summaryStats.averageStages.jobPostingToInitialInterview} days</div>
            //                         <div class="stage-bar">
            //                             <div class="stage-fill" style="width: ${(data.summaryStats.averageStages.jobPostingToInitialInterview / 21) * 100}%"></div>
            //                         </div>
            //                     </div>
            //                 </div>
                            
            //                 <div class="stage-breakdown-item">
            //                     <div class="stage-icon">
            //                         <i class="fas fa-users"></i>
            //                     </div>
            //                     <div class="stage-content">
            //                         <div class="stage-title">Initial to Final Interview</div>
            //                         <div class="stage-days">${data.summaryStats.averageStages.initialInterviewToFinalInterview} days</div>
            //                         <div class="stage-bar">
            //                             <div class="stage-fill" style="width: ${(data.summaryStats.averageStages.initialInterviewToFinalInterview / 15) * 100}%"></div>
            //                         </div>
            //                     </div>
            //                 </div>
                            
            //                 <div class="stage-breakdown-item">
            //                     <div class="stage-icon">
            //                         <i class="fas fa-user-check"></i>
            //                     </div>
            //                     <div class="stage-content">
            //                         <div class="stage-title">Final Interview to Onboarding</div>
            //                         <div class="stage-days">${data.summaryStats.averageStages.finalInterviewToOnboarding} days</div>
            //                         <div class="stage-bar">
            //                             <div class="stage-fill" style="width: ${(data.summaryStats.averageStages.finalInterviewToOnboarding / 17) * 100}%"></div>
            //                         </div>
            //                     </div>
            //                 </div>
            //             </div>
            //         </div>
            //     `;
            // }

            // === MONTHLY TIMELINE DATA ===
            if (data.monthlyData && data.monthlyData.length > 0) {
                html += `
                    <div class="monthly-timeline-section">
                        <h4><i class="fas fa-calendar-alt"></i> Monthly Timeline Analysis</h4>
                        <div class="monthly-timeline-table">
                            <table class="timeline-data-table">
                                <thead>
                                    <tr>
                                        <th>Month</th>
                                        <th>Hires Completed</th>
                                        <th>Average Days</th>
                                        <th>Efficiency</th>
                                        <th>Performance</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                data.monthlyData.forEach(month => {
                    const efficiencyClass = month.efficiency === 'Excellent' ? 'excellent' : 
                                        month.efficiency === 'Good' ? 'good' : 
                                        month.efficiency === 'Average' ? 'average' : 'poor';
                    
                    html += `
                        <tr>
                            <td><strong>${month.monthName}</strong></td>
                            <td><span class="hire-count">${month.hires}</span></td>
                            <td><span class="days-value ${month.averageDays <= 30 ? 'fast' : month.averageDays <= 45 ? 'standard' : 'slow'}">${month.averageDays} days</span></td>
                            <td><span class="efficiency-badge ${efficiencyClass}">${month.efficiency}</span></td>
                            <td>
                                <div class="performance-bar">
                                    <div class="performance-fill ${efficiencyClass}" style="width: ${Math.max(10, 100 - month.averageDays)}%"></div>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div></div>';
            }

            // === INDIVIDUAL TIMELINE DETAILS ===
            if (data.timelineData && data.timelineData.length > 0) {
                html += `
                    <div class="individual-timelines">
                        <h4><i class="fas fa-user-clock"></i> Individual Hiring Timelines</h4>
                        <div class="timeline-details-table">
                            <table class="enhanced-timeline-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Position</th>
                                        <th>Department</th>
                                        <th>Application Date</th>
                                        <th>Total Days</th>
                                        <th>Category</th>
                                        <th>Efficiency</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                data.timelineData.forEach(timeline => {
                    const categoryClass = timeline.timelineCategory === 'Fast' ? 'fast' : 
                                        timeline.timelineCategory === 'Standard' ? 'standard' : 
                                        timeline.timelineCategory === 'Slow' ? 'slow' : 'critical';
                    
                    const efficiencyClass = timeline.efficiencyFlag;
                    
                    html += `
                        <tr class="timeline-row ${categoryClass}">
                            <td><strong>${timeline.name}</strong></td>
                            <td>${timeline.position}</td>
                            <td>${timeline.department}</td>
                            <td>${timeline.applicationDate}</td>
                            <td><span class="timeline-days ${categoryClass}">${timeline.totalDays}d</span></td>
                            <td><span class="category-badge ${categoryClass}">${timeline.timelineCategory}</span></td>
                            <td>
                                <div class="efficiency-indicator ${efficiencyClass}">
                                    <i class="fas ${efficiencyClass === 'excellent' ? 'fa-star' : 
                                                efficiencyClass === 'good' ? 'fa-thumbs-up' : 
                                                efficiencyClass === 'average' ? 'fa-minus' : 'fa-exclamation-triangle'}"></i>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div></div>';
            }
        }

        else if (reportType === 'mrf-efficiency') {
            
            // === EXECUTIVE SUMMARY DASHBOARD ===
            if (data.summary) {
                html += `
                    <div class="intelligence-dashboard">
                        <h4><i class="fas fa-chart-line"></i> MRF Efficiency Executive Summary</h4>
                        <div class="intelligence-cards">
                            <div class="intel-card">
                                <div class="intel-icon"><i class="fas fa-clipboard-list"></i></div>
                                <div class="intel-content">
                                    <div class="intel-value">${data.summary.totalMRFs}</div>
                                    <div class="intel-label">Total MRFs</div>
                                    <div class="intel-sublabel">Under analysis</div>
                                </div>
                            </div>
                            
                            <div class="intel-card">
                                <div class="intel-icon"><i class="fas fa-percentage"></i></div>
                                <div class="intel-content">
                                    <div class="intel-value">${data.summary.overallFillRate}%</div>
                                    <div class="intel-label">Overall Fill Rate</div>
                                    <div class="intel-sublabel">${data.summary.overallFillRate >= 75 ? 'Excellent' : data.summary.overallFillRate >= 60 ? 'Good' : 'Needs Work'}</div>
                                </div>
                            </div>
                            
                            <div class="intel-card">
                                <div class="intel-icon"><i class="fas fa-clock"></i></div>
                                <div class="intel-content">
                                    <div class="intel-value">${data.summary.avgDaysOpen}</div>
                                    <div class="intel-label">Avg Days Open</div>
                                    <div class="intel-sublabel">${data.summary.avgDaysOpen <= 35 ? 'Fast' : data.summary.avgDaysOpen <= 50 ? 'Standard' : 'Slow'}</div>
                                </div>
                            </div>
                            
                            <div class="intel-card">
                                <div class="intel-icon"><i class="fas fa-exclamation-triangle"></i></div>
                                <div class="intel-content">
                                    <div class="intel-value">${data.summary.overdueMRFs}</div>
                                    <div class="intel-label">Overdue MRFs</div>
                                    <div class="intel-sublabel">${data.summary.overdueMRFs === 0 ? 'On Track' : 'Needs Attention'}</div>
                                </div>
                            </div>
                            
                            <div class="intel-card">
                                <div class="intel-icon"><i class="fas fa-star"></i></div>
                                <div class="intel-content">
                                    <div class="intel-value">${data.summary.avgEfficiencyScore || 0}</div>
                                    <div class="intel-label">Efficiency Score</div>
                                    <div class="intel-sublabel">Out of 100</div>
                                </div>
                            </div>
                            
                            <div class="intel-card">
                                <div class="intel-icon"><i class="fas fa-shield-alt"></i></div>
                                <div class="intel-content">
                                    <div class="intel-value">${data.summary.processHealth || 'Good'}</div>
                                    <div class="intel-label">Process Health</div>
                                    <div class="intel-sublabel">Overall status</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // // === KEY INSIGHTS ===
            // if (data.insights && data.insights.length > 0) {
            //     html += `
            //         <div class="insights-section">
            //             <h4><i class="fas fa-lightbulb"></i> MRF Efficiency Insights</h4>
            //             <div class="insights-grid">
            //     `;
                
            //     data.insights.forEach(insight => {
            //         const insightType = insight.includes('🎯') || insight.includes('🏆') || insight.includes('✅') ? 'positive' : 
            //                         insight.includes('📉') || insight.includes('⚠️') || insight.includes('🚨') ? 'warning' : 
            //                         insight.includes('📈') || insight.includes('🔧') ? 'success' : 'info';
                    
            //         html += `
            //             <div class="insight-item ${insightType}">
            //                 <div class="insight-text">${insight}</div>
            //             </div>
            //         `;
            //     });
                
            //     html += '</div></div>';
            // }

            // // === CRITICAL ACTION ITEMS ===
            // if (data.actionItems && data.actionItems.length > 0) {
            //     html += `
            //         <div class="action-items-section">
            //             <h4><i class="fas fa-tasks"></i> Critical Action Items</h4>
            //             <div class="action-items-list">
            //     `;
                
            //     data.actionItems.forEach(action => {
            //         html += `
            //             <div class="action-item urgent">
            //                 <i class="fas fa-exclamation-triangle"></i>
            //                 <span>${action}</span>
            //             </div>
            //         `;
            //     });
                
            //     html += '</div></div>';
            // }

            // === DEPARTMENT PERFORMANCE COMPARISON ===
            if (data.departmentComparison && data.departmentComparison.length > 0) {
                html += `
                    <div class="department-performance">
                        <h4><i class="fas fa-building"></i> Department Performance Analysis</h4>
                        <div class="department-cards">
                `;
                
                data.departmentComparison.slice(0, 6).forEach(dept => {
                    const efficiencyClass = dept.performanceGrade === 'A' ? 'excellent' : 
                                        dept.performanceGrade === 'B' ? 'good' : 
                                        dept.performanceGrade === 'C' ? 'average' : 'poor';
                    
                    html += `
                        <div class="dept-card ${efficiencyClass}">
                            <div class="dept-header">
                                <h5>${dept.department}</h5>
                                <span class="efficiency-badge ${efficiencyClass}">Grade ${dept.performanceGrade}</span>
                            </div>
                            <div class="dept-metrics">
                                <div class="metric">
                                    <span class="metric-value">${dept.fillRate}%</span>
                                    <span class="metric-label">Fill Rate</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-value">${dept.avgDaysOpen}d</span>
                                    <span class="metric-label">Avg Days</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-value">${dept.overdueMRFs}</span>
                                    <span class="metric-label">Overdue</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }

            // === LINE MANAGER PERFORMANCE ===
            if (data.lineManagerComparison && data.lineManagerComparison.length > 0) {
                html += `
                    <div class="data-section">
                        <h4><i class="fas fa-users-cog"></i> Line Manager Performance</h4>
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Line Manager</th>
                                        <th>Total MRFs</th>
                                        <th>Fill Rate</th>
                                        <th>Avg Days</th>
                                        <th>Overdue</th>
                                        <th>Performance</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                data.lineManagerComparison.slice(0, 10).forEach(manager => {
                    const performanceClass = manager.managerEfficiency === 'High Performer' ? 'status-hired' : 
                                            manager.managerEfficiency === 'Good Performer' ? 'status-passed' : 
                                            manager.managerEfficiency === 'Average Performer' ? 'status-pending' : 'status-failed';
                    
                    html += `
                        <tr>
                            <td><strong>${manager.lineManager}</strong></td>
                            <td>${manager.totalMRFs}</td>
                            <td><strong>${manager.fillRate}%</strong></td>
                            <td>${manager.avgDaysOpen} days</td>
                            <td>${manager.overdueMRFs}</td>
                            <td><span class="status-badge ${performanceClass}">${manager.managerEfficiency}</span></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div></div>';
            }

            // // === OPTIMIZATION RECOMMENDATIONS ===
            // if (data.optimizations && data.optimizations.length > 0) {
            //     html += `
            //         <div class="recommendations-section">
            //             <h4><i class="fas fa-cogs"></i> Process Optimization Opportunities</h4>
            //             <div class="recommendations-list">
            //     `;
                
            //     data.optimizations.forEach((opt, index) => {
            //         html += `
            //             <div class="recommendation-item">
            //                 <div class="recommendation-priority">${index + 1}</div>
            //                 <i class="fas fa-arrow-right"></i>
            //                 <span>${opt}</span>
            //             </div>
            //         `;
            //     });
                
            //     html += '</div></div>';
            // }

            // === MONTHLY TRENDS ===
            if (data.monthlyData && data.monthlyData.length > 0) {
                html += `
                    <div class="data-section">
                        <h4><i class="fas fa-chart-line"></i> Monthly Trends Analysis</h4>
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Month</th>
                                        <th>MRFs Created</th>
                                        <th>Personnel Required</th>
                                        <th>Personnel Hired</th>
                                        <th>Monthly Fill Rate</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                data.monthlyData.forEach(month => {
                    const monthlyFillRate = month.personnelRequired > 0 ? 
                        Math.round((month.personnelHired / month.personnelRequired) * 100) : 0;
                    
                    const fillRateClass = monthlyFillRate >= 80 ? 'status-hired' : 
                                        monthlyFillRate >= 60 ? 'status-passed' : 
                                        monthlyFillRate >= 40 ? 'status-pending' : 'status-failed';
                    
                    html += `
                        <tr>
                            <td><strong>${month.month}</strong></td>
                            <td>${month.mrfsCreated}</td>
                            <td>${month.personnelRequired}</td>
                            <td>${month.personnelHired}</td>
                            <td><span class="status-badge ${fillRateClass}">${monthlyFillRate}%</span></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div></div>';
            }

            // === INDIVIDUAL MRF DETAILS ===
            if (data.mrfData && data.mrfData.length > 0) {
                html += `
                    <div class="data-section">
                        <h4><i class="fas fa-list-alt"></i> Individual MRF Performance Details</h4>
                        <div class="data-table-container">
                            <table class="data-table enhanced">
                                <thead>
                                    <tr>
                                        <th>MRF ID</th>
                                        <th>Position</th>
                                        <th>Department</th>
                                        <th>Line Manager</th>
                                        <th>Required</th>
                                        <th>Hired</th>
                                        <th>Fill Rate</th>
                                        <th>Days Open</th>
                                        <th>Status</th>
                                        <th>Performance</th>
                                        <th>Risk Level</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                data.mrfData.forEach(mrf => {
                    const performanceClass = mrf.performanceLevel === 'Excellent' ? 'status-hired' : 
                                            mrf.performanceLevel === 'Good' ? 'status-passed' : 
                                            mrf.performanceLevel === 'Average' ? 'status-pending' : 'status-failed';
                    
                    const riskClass = mrf.riskLevel === 'Low' ? 'status-passed' : 
                                    mrf.riskLevel === 'Medium' ? 'status-pending' : 'status-failed';
                    
                    const urgencyClass = mrf.urgencyLevel === 'Critical' ? 'status-failed' : 
                                        mrf.urgencyLevel === 'High' ? 'status-pending' : 'status-passed';
                    
                    html += `
                        <tr class="enhanced-row ${mrf.isOverdue ? 'overdue-row' : ''}">
                            <td><strong>${mrf.mrfId}</strong></td>
                            <td>${mrf.positionTitle}</td>
                            <td>${mrf.department}</td>
                            <td>${mrf.lineManager.split('@')[0]}</td>
                            <td>${mrf.personnelRequired}</td>
                            <td>${mrf.personnelHired}</td>
                            <td><strong>${mrf.fillRate}%</strong></td>
                            <td>
                                <span class="days-badge ${mrf.daysOpen <= 35 ? 'fast' : mrf.daysOpen <= 50 ? 'standard' : 'slow'}">
                                    ${mrf.daysOpen}d
                                </span>
                            </td>
                            <td>${mrf.status}</td>
                            <td><span class="status-badge ${performanceClass}">${mrf.performanceLevel}</span></td>
                            <td>
                                <span class="status-badge ${riskClass}">${mrf.riskLevel}</span>
                                ${mrf.urgencyLevel !== 'Normal' ? `<span class="status-badge ${urgencyClass}">${mrf.urgencyLevel}</span>` : ''}
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div></div>';
            }

            // // === STRATEGIC RECOMMENDATIONS ===
            // if (data.recommendations && data.recommendations.length > 0) {
            //     html += `
            //         <div class="success-metrics">
            //             <h4><i class="fas fa-clipboard-list"></i> Strategic Recommendations</h4>
            //             <div class="metrics-list">
            //     `;
                
            //     data.recommendations.forEach(rec => {
            //         html += `
            //             <div class="success-metric">
            //                 <i class="fas fa-lightbulb"></i>
            //                 <span>${rec}</span>
            //             </div>
            //         `;
            //     });
                
            //     html += '</div></div>';
            // }
        }
        
        resultsDiv.innerHTML = html;
    }
        
        // Get status CSS class
        function getStatusClass(status) {
            if (!status) return '';
            
            const statusLower = status.toLowerCase();
            if (statusLower.includes('pending') || statusLower.includes('awaiting')) return 'status-pending';
            if (statusLower.includes('passed') || statusLower.includes('approved') || statusLower.includes('completed')) return 'status-passed';
            if (statusLower.includes('failed') || statusLower.includes('rejected')) return 'status-failed';
            if (statusLower.includes('hired')) return 'status-hired';
            if (statusLower.includes('progress')) return 'status-pending';
            
            return 'status-pending';
        }
        
        // Set default dates
        function setDefaultDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            // REPLACE your existing code with this:
            const startDateInputs = document.querySelectorAll('input[name="startDate"]');
            const endDateInputs = document.querySelectorAll('input[name="endDate"]');
            
            startDateInputs.forEach(input => {
                input.value = firstDay.toISOString().split('T')[0];
            });
            
            endDateInputs.forEach(input => {
                input.value = lastDay.toISOString().split('T')[0];
            });
        }

        function toggleDateInputs(reportType) {
            const filterType = document.getElementById(`${reportType}-filter-type`).value;
            const customDatesStart = document.getElementById(`${reportType}-custom-dates`);
            const customDatesEnd = document.getElementById(`${reportType}-custom-dates-end`);
            
            if (filterType === 'custom') {
                customDatesStart.style.display = 'block';
                customDatesEnd.style.display = 'block';
            } else {
                customDatesStart.style.display = 'none';
                customDatesEnd.style.display = 'none';
            }
        }

        function calculateDateRange(filterType) {
            const today = new Date();
            let startDate, endDate;
            
            switch (filterType) {
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'last-month':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
                case 'quarter':
                    const currentQuarter = Math.floor(today.getMonth() / 3);
                    startDate = new Date(today.getFullYear(), currentQuarter * 3, 1);
                    endDate = new Date(today.getFullYear(), (currentQuarter + 1) * 3, 0);
                    break;
                case 'year':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    break;
                default:
                    return null;
            }
            
            return {
                startDate: startDate.toISOString().split('T')[0],
                endDate: endDate.toISOString().split('T')[0]
            };
        }

        function getMonthName(filterType) {
            const today = new Date();
            
            switch (filterType) {
                case 'month':
                    return today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                case 'last-month':
                    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    return lastMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                case 'quarter':
                    const quarter = Math.floor(today.getMonth() / 3) + 1;
                    return `Q${quarter} ${today.getFullYear()}`;
                case 'year':
                    return today.getFullYear().toString();
                default:
                    return 'Custom Range';
            }
        }

        // Searchable Dropdown Class
        class SearchableApplicantDropdown {
            constructor() {
                this.container = document.getElementById('applicant-dropdown');
                this.input = document.getElementById('applicant-search');
                this.menu = document.getElementById('applicant-dropdown-menu');
                this.icon = this.container?.querySelector('.dropdown-icon');
                
                this.searchTimeout = null;
                this.currentRequest = null;
                this.selectedApplicant = null;
                this.highlightedIndex = -1;
                this.applicants = [];
                this.allApplicants = []; // Store all applicants for filtering
                this.isLoaded = false; // Track if we've loaded all applicants
                
                if (this.container && this.input && this.menu) {
                    this.init();
                }
            }
            
            init() {
                this.bindEvents();
                // Load all applicants when initialized
                this.loadAllApplicants();
            }
            
            bindEvents() {
                // Input events
                this.input.addEventListener('input', (e) => this.handleInput(e));
                this.input.addEventListener('focus', (e) => this.handleFocus(e));
                this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
                
                // Click on dropdown icon to show all applicants
                if (this.icon) {
                    this.icon.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.input.focus();
                        if (this.isMenuVisible()) {
                            this.hideMenu();
                        } else {
                            this.showAllApplicants();
                        }
                    });
                }
                
                // Click outside to close
                document.addEventListener('click', (e) => {
                    if (!this.container.contains(e.target)) {
                        this.hideMenu();
                    }
                });
            }
            
            async loadAllApplicants() {
                try {
                    console.log('🔄 Loading all applicants for dropdown...');
                    
                    const response = await fetch('/hr/recruitment/reports/search-applicants?query=all&loadAll=true');
                    
                    if (!response.ok) {
                        throw new Error('Failed to load applicants');
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.allApplicants = data.applicants;
                        this.isLoaded = true;
                        console.log(`✅ Loaded ${this.allApplicants.length} applicants for dropdown`);
                    } else {
                        console.error('❌ Failed to load applicants:', data.message);
                    }
                    
                } catch (error) {
                    console.error('❌ Error loading all applicants:', error);
                }
            }
            
            handleInput(e) {
                const query = e.target.value.trim();
                
                // Clear previous timeout
                if (this.searchTimeout) {
                    clearTimeout(this.searchTimeout);
                }
                
                // Reset selection if input changes
                if (this.selectedApplicant && this.selectedApplicant.name !== query) {
                    this.selectedApplicant = null;
                }
                
                // If input is empty, show all applicants
                if (query.length === 0) {
                    this.showAllApplicants();
                    return;
                }
                
                // Filter applicants based on input
                this.searchTimeout = setTimeout(() => {
                    this.filterApplicants(query);
                }, 150); // Reduced debounce for better responsiveness
            }
            
            handleFocus(e) {
                // Show all applicants when focused
                if (this.isLoaded) {
                    this.showAllApplicants();
                } else {
                    this.showLoading();
                    // Wait for loading to complete, then show
                    const checkLoaded = setInterval(() => {
                        if (this.isLoaded) {
                            clearInterval(checkLoaded);
                            this.showAllApplicants();
                        }
                    }, 100);
                }
            }
            
            handleKeydown(e) {
                if (!this.isMenuVisible()) return;
                
                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        this.highlightNext();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        this.highlightPrevious();
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (this.highlightedIndex >= 0 && this.applicants[this.highlightedIndex]) {
                            this.selectApplicant(this.applicants[this.highlightedIndex]);
                        }
                        break;
                    case 'Escape':
                        this.hideMenu();
                        this.input.blur();
                        break;
                }
            }
            
            showAllApplicants() {
                if (!this.isLoaded) {
                    this.showLoading();
                    return;
                }
                
                this.applicants = this.allApplicants;
                this.displayResults(this.applicants);
            }
            
            filterApplicants(query) {
                if (!this.isLoaded) {
                    this.showLoading();
                    return;
                }
                
                const searchTerm = query.toLowerCase();
                
                // Filter from all applicants
                const filtered = this.allApplicants.filter(applicant => {
                    const name = applicant.name.toLowerCase();
                    const email = applicant.email.toLowerCase();
                    const position = applicant.position.toLowerCase();
                    const department = applicant.department.toLowerCase();
                    
                    return name.includes(searchTerm) || 
                        email.includes(searchTerm) || 
                        position.includes(searchTerm) ||
                        department.includes(searchTerm);
                });
                
                this.applicants = filtered;
                this.displayResults(this.applicants);
            }
            
            showLoading() {
                this.menu.innerHTML = `
                    <div class="dropdown-loading">
                        <span class="search-loading-spinner"></span>
                        Loading applicants...
                    </div>
                `;
                this.showMenu();
            }
            
            displayResults(applicants) {
                this.highlightedIndex = -1;
                
                if (applicants.length === 0) {
                    this.showNoResults();
                    return;
                }
                
                // Limit display to first 50 for performance
                const displayApplicants = applicants.slice(0, 50);
                
                const html = displayApplicants.map((applicant, index) => `
                    <div class="dropdown-item" data-index="${index}">
                        <div class="applicant-name">${applicant.name}</div>
                        <div class="applicant-details">
                            ${applicant.email} • ${applicant.position} • ${applicant.department}
                            <span class="applicant-status-badge ${this.getStatusClass(applicant.status)}">${applicant.status}</span>
                        </div>
                    </div>
                `).join('');
                
                // Add "showing X of Y" if there are more results
                let footerHtml = '';
                if (applicants.length > 50) {
                    footerHtml = `
                        <div class="dropdown-footer">
                            Showing 50 of ${applicants.length} applicants. Type to narrow results.
                        </div>
                    `;
                }
                
                this.menu.innerHTML = html + footerHtml;
                
                // Add click listeners
                this.menu.querySelectorAll('.dropdown-item').forEach((item, index) => {
                    item.addEventListener('click', () => this.selectApplicant(displayApplicants[index]));
                    item.addEventListener('mouseenter', () => this.highlightItem(index));
                });
                
                this.showMenu();
            }
            
            showNoResults() {
                const query = this.input.value.trim();
                this.menu.innerHTML = `
                    <div class="dropdown-no-results">
                        ${query ? `No applicants found for "${query}".` : 'No applicants found.'} 
                        <br><small>Try a different search term.</small>
                    </div>
                `;
                this.showMenu();
            }
            
            showError() {
                this.menu.innerHTML = `
                    <div class="dropdown-no-results">
                        Error loading applicants. Please try again.
                    </div>
                `;
                this.showMenu();
            }
            
            selectApplicant(applicant) {
                this.selectedApplicant = applicant;
                this.input.value = applicant.name;
                this.hideMenu();
                
                console.log('Selected applicant:', applicant);
            }
            
            highlightNext() {
                const maxIndex = Math.min(this.applicants.length - 1, 49); // Max 50 displayed items
                if (this.highlightedIndex < maxIndex) {
                    this.highlightItem(this.highlightedIndex + 1);
                }
            }
            
            highlightPrevious() {
                if (this.highlightedIndex > 0) {
                    this.highlightItem(this.highlightedIndex - 1);
                }
            }
            
            highlightItem(index) {
                // Remove previous highlight
                this.menu.querySelectorAll('.dropdown-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Add new highlight
                const items = this.menu.querySelectorAll('.dropdown-item');
                if (items[index]) {
                    items[index].classList.add('selected');
                    this.highlightedIndex = index;
                    
                    // Scroll into view if needed
                    items[index].scrollIntoView({
                        block: 'nearest',
                        behavior: 'smooth'
                    });
                }
            }
            
            showMenu() {
                this.menu.classList.add('show');
                this.container.classList.add('open');
            }
            
            hideMenu() {
                this.menu.classList.remove('show');
                this.container.classList.remove('open');
                this.highlightedIndex = -1;
            }
            
            isMenuVisible() {
                return this.menu.classList.contains('show');
            }
            
            getStatusClass(status) {
                if (!status) return 'status-pending';
                
                const statusLower = status.toLowerCase();
                if (statusLower.includes('pending') || statusLower.includes('awaiting')) return 'status-pending';
                if (statusLower.includes('passed') || statusLower.includes('approved')) return 'status-passed';
                if (statusLower.includes('failed') || statusLower.includes('rejected')) return 'status-failed';
                if (statusLower.includes('hired')) return 'status-hired';
                
                return 'status-pending';
            }
            
            getSelectedApplicant() {
                return this.selectedApplicant;
            }
        }

        // Toggle active class for sidebar links
        document.querySelectorAll('.sidebar ul li a').forEach(link => {
            link.addEventListener('click', function() {
                document.querySelectorAll('.sidebar ul li a').forEach(link => link.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Toggle collapsible content
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', function() {
                var content = this.nextElementSibling;
                if (content.style.display === 'block') {
                    content.style.display = 'none';
                } else {
                    // Hide all other collapsible contents
                    document.querySelectorAll('.collapsible-content').forEach(item => {
                        if (item !== content) {
                            item.style.display = 'none';
                        }
                    });
                    content.style.display = 'block';
                }
            });
        });
    </script>
</body>
</html>