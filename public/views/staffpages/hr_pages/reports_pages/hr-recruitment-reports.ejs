<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recruitment Dashboard & Reports</title>
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/hr_pages.css">
    <link rel="stylesheet" href="/css/recruitment_reports.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <%- include('../../../partials/hr_partials') %>
    
    <div class="main-content">
        <!-- Header -->
        <div class="recruitment-header">
            <h1><i class="fas fa-users"></i> Recruitment Dashboard & Reports</h1>
            <p>Comprehensive recruitment analytics and detailed reporting for applicants, hirees, and recruitment processes</p>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" data-tab="dashboard">
                <i class="fas fa-chart-line"></i> Dashboard
            </button>
            <button class="tab-button" data-tab="reports">
                <i class="fas fa-file-alt"></i> Reports
            </button>
        </div>
        
        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard-tab">
            <!-- Statistics Overview -->
            <div class="stats-container">
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <h3>Total Applicants</h3>
                        <div class="stat-value" id="total-applicants">0</div>
                        <div class="stat-label">All time applications received</div>
                    </div>
                    
                    <div class="stat-card success">
                        <h3>Total Hirees</h3>
                        <div class="stat-value" id="total-hirees">0</div>
                        <div class="stat-label">Successfully hired candidates</div>
                    </div>
                    
                    <div class="stat-card warning">
                        <h3>Pending Applications</h3>
                        <div class="stat-value" id="pending-applications">0</div>
                        <div class="stat-label">Applications awaiting review</div>
                    </div>
                    
                    <div class="stat-card info">
                        <h3>Active MRFs</h3>
                        <div class="stat-value" id="active-mrfs">0</div>
                        <div class="stat-label">Open manpower requisitions</div>
                    </div>
                    
                    <div class="stat-card danger">
                        <h3>Avg. Processing Time</h3>
                        <div class="stat-value" id="avg-processing-time">0</div>
                        <div class="stat-label">Average days to hire</div>
                    </div>
                    
                    <div class="stat-card primary">
                        <h3>This Month Applications</h3>
                        <div class="stat-value" id="monthly-applicants">0</div>
                        <div class="stat-label">New applications this month</div>
                    </div>
                </div>
            </div>
            
            <!-- Charts -->
            <div class="charts-container">
                <div class="chart-card">
                    <h3>Application Status Distribution</h3>
                    <canvas id="statusDistributionChart"></canvas>
                </div>
                
                <div class="chart-card">
                    <h3>Monthly Application Trends</h3>
                    <canvas id="monthlyTrendsChart"></canvas>
                </div>
                
                <div class="chart-card">
                    <h3>Applications by Department</h3>
                    <canvas id="departmentChart"></canvas>
                </div>
                
                <div class="chart-card">
                    <h3>MRF to Hire Timeline</h3>
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Reports Tab -->
        <div class="tab-content" id="reports-tab">
            <div class="reports-container">
                <!-- 1. Applicants Report -->
                <div class="report-card">
                    <div class="report-card-header">
                        <div class="report-icon applicants">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div>
                            <h3 class="report-title">Applicants Report</h3>
                            <p class="report-description">Comprehensive overview of all job applicants with detailed information, screening scores, and status tracking across all recruitment phases</p>
                        </div>
                    </div>
                    
                    <form class="report-form" id="applicants-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="applicants-start">Start Date</label>
                                <input type="date" id="applicants-start" name="startDate">
                            </div>
                            <div class="form-group">
                                <label for="applicants-end">End Date</label>
                                <input type="date" id="applicants-end" name="endDate">
                            </div>
                            <div class="btn-group">
                                <button type="button" class="btn btn-primary" onclick="generateReport('applicants', 'view')">
                                    <i class="fas fa-eye"></i> View Report
                                </button>
                                <button type="button" class="btn btn-outline" onclick="generateReport('applicants', 'pdf')">
                                    <i class="fas fa-file-pdf"></i> Download PDF
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <div class="report-results" id="applicants-results"></div>
                </div>
                
                <!-- 2. Hirees Report -->
                <div class="report-card">
                    <div class="report-card-header">
                        <div class="report-icon hirees">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div>
                            <h3 class="report-title">Hirees Report</h3>
                            <p class="report-description">Track successfully hired candidates with onboarding timelines, job types, department distribution, and employment details</p>
                        </div>
                    </div>
                    
                    <form class="report-form" id="hirees-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="hirees-start">Start Date</label>
                                <input type="date" id="hirees-start" name="startDate">
                            </div>
                            <div class="form-group">
                                <label for="hirees-end">End Date</label>
                                <input type="date" id="hirees-end" name="endDate">
                            </div>
                            <div class="btn-group">
                                <button type="button" class="btn btn-primary" onclick="generateReport('hirees', 'view')">
                                    <i class="fas fa-eye"></i> View Report
                                </button>
                                <button type="button" class="btn btn-outline" onclick="generateReport('hirees', 'pdf')">
                                    <i class="fas fa-file-pdf"></i> Download PDF
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <div class="report-results" id="hirees-results"></div>
                </div>
                
                <!-- 3. Individual Applicant Status Report -->
                <div class="report-card">
                    <div class="report-card-header">
                        <div class="report-icon status">
                            <i class="fas fa-user-cog"></i>
                        </div>
                        <div>
                            <h3 class="report-title">Individual Applicant Status</h3>
                            <p class="report-description">Detailed status tracking and timeline for individual applicant progress through all recruitment stages with comprehensive history</p>
                        </div>
                    </div>
                    
                    <form class="report-form" id="status-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="applicant-search">Select Applicant</label>
                                <div class="searchable-dropdown" id="applicant-dropdown">
                                    <input 
                                        type="text" 
                                        id="applicant-search" 
                                        name="applicantName" 
                                        placeholder="Type applicant name to search..."
                                        autocomplete="off"
                                        required
                                    >
                                    <i class="fas fa-chevron-down dropdown-icon"></i>
                                    <div class="dropdown-menu" id="applicant-dropdown-menu"></div>
                                </div>
                            </div>
                            <div class="btn-group">
                                <button type="button" class="btn btn-primary" onclick="generateReport('status', 'view')">
                                    <i class="fas fa-eye"></i> View Status
                                </button>
                                <button type="button" class="btn btn-outline" onclick="generateReport('status', 'pdf')">
                                    <i class="fas fa-file-pdf"></i> Download PDF
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <div class="report-results" id="status-results"></div>
                </div>
                
                <!-- 4. MRF to Onboarding Timeline -->
                <div class="report-card">
                    <div class="report-card-header">
                        <div class="report-icon timeline">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <div>
                            <h3 class="report-title">MRF to Onboarding Timeline</h3>
                            <p class="report-description">Track manpower requisition forms from initial request through to successful onboarding completion with detailed timeline analysis</p>
                        </div>
                    </div>
                    
                    <form class="report-form" id="timeline-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="timeline-start">Start Date</label>
                                <input type="date" id="timeline-start" name="startDate">
                            </div>
                            <div class="form-group">
                                <label for="timeline-end">End Date</label>
                                <input type="date" id="timeline-end" name="endDate">
                            </div>
                            <div class="btn-group">
                                <button type="button" class="btn btn-primary" onclick="generateReport('timeline', 'view')">
                                    <i class="fas fa-eye"></i> View Report
                                </button>
                                <button type="button" class="btn btn-outline" onclick="generateReport('timeline', 'pdf')">
                                    <i class="fas fa-file-pdf"></i> Download PDF
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <div class="report-results" id="timeline-results"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        // Global chart variables
        let statusChart, trendsChart, departmentChart, timelineChart;
        let applicantDropdown;


        // Tab functionality
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all buttons and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding content
                    button.classList.add('active');
                    const tabId = `${button.dataset.tab}-tab`;
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Load dashboard data when page loads
            loadDashboardData();
            loadChartsData();
            setDefaultDates();

            // Initialize the searchable dropdown
            applicantDropdown = new SearchableApplicantDropdown();
        });
        
        // Load dashboard statistics
        async function loadDashboardData() {
            try {
                console.log('🔄 [Frontend] Loading dashboard data...');
                
                const response = await fetch('/hr/recruitment/dashboard/stats');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('📊 [Frontend] Dashboard response:', result);
                
                if (!result.success) {
                    throw new Error(result.message || 'Failed to fetch dashboard stats');
                }
                
                const stats = result.stats;
                
                // Update dashboard stats with real data
                document.getElementById('total-applicants').textContent = stats.totalApplicants;
                document.getElementById('total-hirees').textContent = stats.totalHirees;
                document.getElementById('pending-applications').textContent = stats.pendingApplications;
                document.getElementById('active-mrfs').textContent = stats.activeMRFs;
                document.getElementById('avg-processing-time').textContent = stats.avgProcessingTime;
                document.getElementById('monthly-applicants').textContent = stats.monthlyApplicants;
                
                console.log('✅ [Frontend] Dashboard updated successfully');
                
            } catch (error) {
                console.error('❌ [Frontend] Error loading dashboard data:', error);
                
                // Show user-friendly error and keep defaults
                alert('Could not load dashboard statistics. Please refresh the page.');
                
                // Fallback to default values on error
                document.getElementById('total-applicants').textContent = '0';
                document.getElementById('total-hirees').textContent = '0';
                document.getElementById('pending-applications').textContent = '0';
                document.getElementById('active-mrfs').textContent = '0';
                document.getElementById('avg-processing-time').textContent = '0';
                document.getElementById('monthly-applicants').textContent = '0';
            }
        }

        // Load real chart data
        async function loadChartsData() {
            try {
                console.log('🔄 [Frontend] Loading chart data...');
                
                const response = await fetch('/hr/recruitment/dashboard/charts');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('📊 [Frontend] Chart data response:', result);
                
                if (!result.success) {
                    throw new Error(result.message || 'Failed to fetch chart data');
                }
                
                const chartData = result.chartData;
                
                // Initialize charts with real data
                initializeChartsWithData(chartData);
                
                console.log('✅ [Frontend] Charts updated with real data');
                
            } catch (error) {
                console.error('❌ [Frontend] Error loading chart data:', error);
                
                // Fall back to mock data if real data fails
                console.log('📊 [Frontend] Falling back to mock data for charts');
                initializeChartsWithMockData();
            }
        }
        
        // Initialize charts with real data
        function initializeChartsWithData(chartData) {
            // Destroy existing charts if they exist
            if (statusChart) statusChart.destroy();
            if (trendsChart) trendsChart.destroy();
            if (departmentChart) departmentChart.destroy();
            if (timelineChart) timelineChart.destroy();

            // 1. Status Distribution Chart
            const statusCtx = document.getElementById('statusDistributionChart').getContext('2d');
            statusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: chartData.statusDistribution.labels,
                    datasets: [{
                        data: chartData.statusDistribution.data,
                        backgroundColor: [
                            '#ffc107', // Pending - Yellow
                            '#17a2b8', // P1 Passed - Teal
                            '#2385B0', // P2 Passed - Blue
                            '#28a745', // Hired - Green
                            '#dc3545'  // Failed - Red
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed * 100) / total).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // 2. Monthly Trends Chart
            const trendsCtx = document.getElementById('monthlyTrendsChart').getContext('2d');
            trendsChart = new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: chartData.monthlyTrends.labels,
                    datasets: [{
                        label: 'Applications',
                        data: chartData.monthlyTrends.applications,
                        borderColor: '#2385B0',
                        backgroundColor: 'rgba(35, 133, 176, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Hires',
                        data: chartData.monthlyTrends.hires,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
            
            // 3. Department Chart
            const deptCtx = document.getElementById('departmentChart').getContext('2d');
            departmentChart = new Chart(deptCtx, {
                type: 'bar',
                data: {
                    labels: chartData.departmentDistribution.labels,
                    datasets: [{
                        label: 'Applications',
                        data: chartData.departmentDistribution.data,
                        backgroundColor: '#2385B0',
                        borderColor: '#1a5f78',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed.y * 100) / total).toFixed(1);
                                    return `${context.dataset.label}: ${context.parsed.y} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // 4. Timeline Chart
            const timelineCtx = document.getElementById('timelineChart').getContext('2d');
            timelineChart = new Chart(timelineCtx, {
                type: 'bar',
                data: {
                    labels: chartData.timeline.labels,
                    datasets: [{
                        label: 'Number of Hires',
                        data: chartData.timeline.data,
                        backgroundColor: '#28a745',
                        borderColor: '#1e7e34',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y} candidate${context.parsed.y !== 1 ? 's' : ''}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // generateReport function
        async function generateReport(reportType, format) {

            // Special handling for status report with dropdown 
            if (reportType === 'status') {
                const selectedApplicant = applicantDropdown?.getSelectedApplicant();

                if (!selectedApplicant) {
                    alert('Please select an applicant from the dropdown first.');
                    return;
                }
            }

            
            const form = document.getElementById(`${reportType}-form`);
            const button = event.target;
            const resultsDiv = document.getElementById(`${reportType}-results`);
            
            // Add loading state
            button.classList.add('loading');
            button.disabled = true;
            
            try {
                console.log(`🔄 [Frontend] Generating ${reportType} report...`);
                
                // Get form data
                const formData = new FormData(form);
                const params = new URLSearchParams();

                if (reportType === 'status' && applicantDropdown?.getSelectedApplicant()) {
                    params.append('applicantName', applicantDropdown.getSelectedApplicant().name);
                } else {
                    for (let [key, value] of formData.entries()) {
                        if (value) params.append(key, value);
                    }
                }
                
                if (format) params.append('format', format);
                
                console.log(`📋 [Frontend] Form parameters:`, Object.fromEntries(params));
                
                // Endpoint based on report type
                let endpoint = '';
                switch(reportType) {
                    case 'applicants':
                        endpoint = '/hr/recruitment/reports/applicants';
                        break;
                    case 'hirees':
                        endpoint = '/hr/recruitment/reports/hirees';
                        break;
                    case 'status':
                        endpoint = '/hr/recruitment/reports/applicant-status';
                        break;
                    case 'timeline':
                        endpoint = '/hr/recruitment/reports/timeline';
                        break;
                    default:
                        throw new Error('Unknown report type: ' + reportType);
                }
                
                if (format === 'pdf') {
                    console.log(`📄 [Frontend] PDF generation requested for ${reportType}`);
                    
                    // Fetch data first
                    const response = await fetch(`${endpoint}?${params.toString()}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.message || 'Failed to generate report');
                    }
                    
                    // Generate PDF directly here
                    try {
                        // Check if jsPDF is loaded
                        if (typeof window.jspdf === 'undefined') {
                            throw new Error('jsPDF library is not loaded. Please refresh the page and try again.');
                        }
                        
                        // Import jsPDF
                        let jsPDF;
                        if (window.jspdf && window.jspdf.jsPDF) {
                            jsPDF = window.jspdf.jsPDF;
                        } else if (window.jsPDF) {
                            jsPDF = window.jsPDF;
                        } else {
                            throw new Error('jsPDF not found. Please refresh the page.');
                        }
                        
                        const doc = new jsPDF();
                        
                        // Set up document
                        doc.setFontSize(20);
                        doc.setTextColor(35, 133, 176);
                        doc.text('Recruitment Management System', 20, 20);
                        
                        doc.setFontSize(16);
                        doc.setTextColor(0, 0, 0);
                        const reportTitles = {
                            'applicants': 'Applicants Report',
                            'hirees': 'Hirees Report',
                            'status': 'Individual Applicant Status Report',
                            'timeline': 'MRF to Onboarding Timeline Report'
                        };
                        doc.text(reportTitles[reportType], 20, 35);
                        
                        // Add generation date
                        doc.setFontSize(10);
                        doc.setTextColor(100, 100, 100);
                        doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 45);
                        
                        let yPosition = 60;
                        
                        // Add summary
                        if (data.summary && reportType !== 'timeline') {
                            doc.setFontSize(14);
                            doc.setTextColor(0, 0, 0);
                            doc.text('Summary', 20, yPosition);
                            yPosition += 10;
                            
                            doc.setFontSize(10);
                            Object.entries(data.summary).forEach(([key, value]) => {
                                const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                                doc.text(`${label}: ${value}`, 25, yPosition);
                                yPosition += 6;
                            });
                            yPosition += 10;
                        }
                        
                        // Add data tables based on report type
                        if (reportType === 'applicants' && data.data) {
                            const tableData = data.data.map(applicant => [
                                applicant.applicantId || '',
                                `${applicant.firstName || ''} ${applicant.lastName || ''}`,
                                applicant.email || '',
                                applicant.jobTitle || '',
                                applicant.department || '',
                                applicant.status || '',
                                applicant.initialScreeningScore || 'N/A',
                                applicant.hrInterviewScore || 'N/A',
                                applicant.lineManagerScore || 'N/A',
                                applicant.totalScore || 'N/A'
                            ]);
                            
                            doc.autoTable({
                                startY: yPosition,
                                head: [['ID', 'Name', 'Email', 'Job Title', 'Department', 'Status', 'Initial Score', 'HR Score', 'Line Manager Score', 'Total Score']],
                                body: tableData,
                                styles: { fontSize: 8 },
                                headStyles: { fillColor: [35, 133, 176] },
                                margin: { top: 60 }
                            });
                        }
                        else if (reportType === 'hirees' && data.data) {
                            const tableData = data.data.map(hiree => [
                                hiree.hireId || '',
                                `${hiree.firstName || ''} ${hiree.lastName || ''}`,
                                hiree.email || '',
                                hiree.jobTitle || '',
                                hiree.department || '',
                                hiree.jobType || '',
                                hiree.hireDate || ''
                            ]);
                            
                            doc.autoTable({
                                startY: yPosition,
                                head: [['Hire ID', 'Name', 'Email', 'Job Title', 'Department', 'Job Type', 'Hire Date']],
                                body: tableData,
                                styles: { fontSize: 8 },
                                headStyles: { fillColor: [35, 133, 176] },
                                margin: { top: 60 }
                            });
                        }
                        else if (reportType === 'status' && data.applicant) {
                            // Enhanced applicant information table matching your exact format
                            const applicantInfo = [
                                ['Last Name', data.applicant.lastName || 'N/A'],
                                ['First Name', data.applicant.firstName || 'N/A'],
                                ['Middle Initial', data.applicant.middleInitial || 'N/A'],
                                ['Email', data.applicant.email || 'N/A'],
                                ['Phone', data.applicant.phoneNumber || 'N/A'],
                                ['Birth Date', data.applicant.birthDate || 'N/A'],
                                ['Job Position', data.applicant.jobPosition || 'N/A'],
                                ['Department', data.applicant.department || 'N/A'],
                                ['Application Date', data.applicant.applicationDate || 'N/A'],
                                ['Days in Process', `${data.applicant.daysInProcess || 0} days`],
                                ['Current Status', data.applicant.currentStatus || 'Pending'],
                                ['HR Screening Approved', data.applicant.hrScreeningApproved || 'Pending'],
                                ['Panel Screening Approved', data.applicant.panelScreeningApproved || 'Pending'],
                                ['Is Hired', data.applicant.isHired || 'Pending']
                            ];
                            
                            // Add enhanced title
                            doc.setFontSize(14);
                            doc.setTextColor(0, 0, 0);
                            doc.text('Applicant Information', 20, yPosition);
                            yPosition += 10;
                            
                            doc.autoTable({
                                startY: yPosition,
                                body: applicantInfo,
                                styles: { 
                                    fontSize: 9,
                                    cellPadding: 3,
                                    lineColor: [200, 200, 200],
                                    lineWidth: 0.1
                                },
                                columnStyles: { 
                                    0: { 
                                        fontStyle: 'bold', 
                                        fillColor: [240, 240, 240],
                                        cellWidth: 50
                                    },
                                    1: {
                                        cellWidth: 80
                                    }
                                },
                                margin: { top: 60, left: 20, right: 20 },
                                tableWidth: 130
                            });
                            
                            yPosition = doc.lastAutoTable.finalY + 20;
                            
                            // Enhanced status history section
                            if (data.statusHistory && data.statusHistory.length > 0) {
                                doc.setFontSize(14);
                                doc.setTextColor(0, 0, 0);
                                doc.text('Status History Timeline', 20, yPosition);
                                yPosition += 10;
                                
                                const historyData = data.statusHistory.map(history => [
                                    history.status || 'Status Update',
                                    history.date || 'N/A',
                                    history.notes || 'No additional notes'
                                ]);
                                
                                doc.autoTable({
                                    startY: yPosition,
                                    head: [['Status Update', 'Date', 'Notes & Comments']],
                                    body: historyData,
                                    styles: { 
                                        fontSize: 8,
                                        cellPadding: 3,
                                        overflow: 'linebreak'
                                    },
                                    headStyles: { 
                                        fillColor: [35, 133, 176],
                                        textColor: [255, 255, 255],
                                        fontStyle: 'bold'
                                    },
                                    columnStyles: {
                                        0: { cellWidth: 40 },
                                        1: { cellWidth: 25 },
                                        2: { cellWidth: 95 }
                                    },
                                    margin: { left: 20, right: 20 }
                                });
                            }
                        }
                        else if (reportType === 'timeline') {
                            // Enhanced MRF to Onboarding Timeline Report
                            doc.setFontSize(18);
                            doc.setTextColor(0, 0, 0);
                            doc.text('MRF To Onboarding Timeline Report (HR)', 20, 35);
                            
                            // Add generation date and filters
                            doc.setFontSize(10);
                            doc.setTextColor(100, 100, 100);
                            doc.text(`Generated on: ${data.generatedOn || new Date().toLocaleDateString()}`, 20, 45);
                            
                            if (data.filters && (data.filters.startDate || data.filters.endDate)) {
                                const dateFilter = `Date Range: ${data.filters.startDate || 'Start'} to ${data.filters.endDate || 'End'}`;
                                doc.text(dateFilter, 20, 52);
                            }
                            
                            let yPosition = 65;
                            
                            // MRF to Onboarding Summary Statistics
                            if (data.summaryStats) {
                                doc.setFontSize(14);
                                doc.setTextColor(0, 0, 0);
                                doc.text('MRF to Onboarding Summary Statistics', 20, yPosition);
                                yPosition += 10;
                                
                                const summaryData = [
                                    ['Average MRF to Onboarding', `${data.summaryStats.averageMrfToOnboarding} days`],
                                    ['Shortest Timeline', `${data.summaryStats.shortestTimeline} days`],
                                    ['Longest Timeline', `${data.summaryStats.longestTimeline} days`],
                                    ['Target Timeline', `${data.summaryStats.targetTimeline} days`]
                                ];
                                
                                doc.autoTable({
                                    startY: yPosition,
                                    body: summaryData,
                                    styles: { 
                                        fontSize: 10,
                                        cellPadding: 4
                                    },
                                    columnStyles: { 
                                        0: { fontStyle: 'bold', fillColor: [240, 240, 240], cellWidth: 70 },
                                        1: { cellWidth: 40, halign: 'center' }
                                    },
                                    margin: { left: 20, right: 20 }
                                });
                                
                                yPosition = doc.lastAutoTable.finalY + 20;
                            }
                            
                            // MRF to Onboarding Breakdown
                            if (data.summaryStats && data.summaryStats.averageStages) {
                                doc.setFontSize(14);
                                doc.setTextColor(0, 0, 0);
                                doc.text('MRF to Onboarding Breakdown', 20, yPosition);
                                yPosition += 10;
                                
                                const breakdownData = [
                                    ['MRF to Job Posting', `${data.summaryStats.averageStages.mrfToJobPosting} days`],
                                    ['Job Posting to Initial Interview', `${data.summaryStats.averageStages.jobPostingToInitialInterview} days`],
                                    ['Initial Interview to Final Interview', `${data.summaryStats.averageStages.initialInterviewToFinalInterview} days`],
                                    ['Final Interview to Onboarding', `${data.summaryStats.averageStages.finalInterviewToOnboarding} days`]
                                ];
                                
                                doc.autoTable({
                                    startY: yPosition,
                                    head: [['Stage', 'Days']],
                                    body: breakdownData,
                                    styles: { 
                                        fontSize: 10,
                                        cellPadding: 4
                                    },
                                    headStyles: { 
                                        fillColor: [35, 133, 176],
                                        textColor: [255, 255, 255],
                                        fontStyle: 'bold'
                                    },
                                    columnStyles: {
                                        0: { cellWidth: 100 },
                                        1: { cellWidth: 30, halign: 'center', fontStyle: 'bold' }
                                    },
                                    margin: { left: 20, right: 20 }
                                });
                                
                                yPosition = doc.lastAutoTable.finalY + 20;
                            }
                            
                            // Monthly Timeline Analysis
                            if (data.monthlyData && data.monthlyData.length > 0) {
                                // Check if we need a new page
                                if (yPosition > 180) {
                                    doc.addPage();
                                    yPosition = 20;
                                }
                                
                                doc.setFontSize(14);
                                doc.setTextColor(0, 0, 0);
                                doc.text('Monthly Timeline Analysis', 20, yPosition);
                                yPosition += 10;
                                
                                const monthlyTableData = data.monthlyData.map(month => [
                                    month.monthName || '',
                                    month.hires || 0,
                                    `${month.averageDays || 0} days`
                                ]);
                                
                                doc.autoTable({
                                    startY: yPosition,
                                    head: [['Month', 'Hires Completed', 'Average Days to Hire']],
                                    body: monthlyTableData,
                                    styles: { 
                                        fontSize: 9,
                                        cellPadding: 3
                                    },
                                    headStyles: { 
                                        fillColor: [35, 133, 176],
                                        textColor: [255, 255, 255],
                                        fontStyle: 'bold'
                                    },
                                    columnStyles: {
                                        0: { cellWidth: 60 },
                                        1: { cellWidth: 35, halign: 'center' },
                                        2: { cellWidth: 45, halign: 'center' }
                                    },
                                    margin: { left: 20, right: 20 }
                                });
                                
                                yPosition = doc.lastAutoTable.finalY + 20;
                            }
                            
                            // Individual Hiring Timelines
                            if (data.timelineData && data.timelineData.length > 0) {
                                // Check if we need a new page
                                if (yPosition > 150) {
                                    doc.addPage();
                                    yPosition = 20;
                                }
                                
                                doc.setFontSize(14);
                                doc.setTextColor(0, 0, 0);
                                doc.text('Individual Hiring Timelines', 20, yPosition);
                                yPosition += 10;
                                
                                const timelineTableData = data.timelineData.map(timeline => [
                                    timeline.name || '',
                                    timeline.position || '',
                                    timeline.department || '',
                                    timeline.applicationDate || '',
                                    `${timeline.totalDays || 0} days`,
                                    timeline.status || ''
                                ]);
                                
                                doc.autoTable({
                                    startY: yPosition,
                                    head: [['Name', 'Position', 'Department', 'Application Date', 'Total Days', 'Status']],
                                    body: timelineTableData,
                                    styles: { 
                                        fontSize: 8,
                                        cellPadding: 2,
                                        overflow: 'linebreak'
                                    },
                                    headStyles: { 
                                        fillColor: [35, 133, 176],
                                        textColor: [255, 255, 255],
                                        fontStyle: 'bold',
                                        fontSize: 8
                                    },
                                    columnStyles: {
                                        0: { cellWidth: 30 },
                                        1: { cellWidth: 35 },
                                        2: { cellWidth: 25 },
                                        3: { cellWidth: 25 },
                                        4: { cellWidth: 20, halign: 'center' },
                                        5: { cellWidth: 25 }
                                    },
                                    margin: { left: 10, right: 10 }
                                });
                            }
                            
                            // Add footer with page numbers and additional info
                            const pageCount = doc.internal.getNumberOfPages();
                            for (let i = 1; i <= pageCount; i++) {
                                doc.setPage(i);
                                doc.setFontSize(8);
                                doc.setTextColor(128, 128, 128);
                                doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10);
                                doc.text('MRF to Onboarding Timeline Report - Confidential', 20, doc.internal.pageSize.height - 10);
                                
                                // Add summary info on first page footer
                                if (i === 1 && data.totalMRFs !== undefined && data.totalHired !== undefined) {
                                    doc.text(`Total MRFs: ${data.totalMRFs} | Total Hired: ${data.totalHired}`, 20, doc.internal.pageSize.height - 20);
                                }
                            }
                        }
                        
                        // Download the PDF
                        const filename = `${reportType}_report_${new Date().toISOString().split('T')[0]}.pdf`;
                        doc.save(filename);
                        
                        console.log(`✅ PDF generated and downloaded: ${filename}`);
                        
                    } catch (pdfError) {
                        console.error('❌ Error generating PDF:', pdfError);
                        alert('Error generating PDF: ' + pdfError.message);
                    }
                    
                } else {
                    console.log(`👁️ [Frontend] View mode requested for ${reportType}`);
                    // Fetch actual data from backend for viewing
                    const response = await fetch(`${endpoint}?${params.toString()}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log(`✅ [Frontend] Received data:`, data);
                    
                    if (!data.success) {
                        throw new Error(data.message || 'Failed to fetch report data');
                    }
                    
                    // Display the real data
                    displayReportResults(resultsDiv, data, reportType);
                    console.log(`✅ [Frontend] ${reportType} report displayed successfully`);
                }
                
            } catch (error) {
                console.error(`❌ [Frontend] Error generating ${reportType} report:`, error);
                alert('Error generating report: ' + error.message);
            } finally {
                // Remove loading state
                button.classList.remove('loading');
                button.disabled = false;
            }
        }
        
        // Display report results in the UI
        function displayReportResults(resultsDiv, data, reportType) {
        resultsDiv.style.display = 'block';
        
        let html = '<div class="results-header"><h4>Report Results</h4></div>';
        
        // Add summary if available (for non-timeline reports)
        if (data.summary && reportType !== 'timeline') {
            html += '<div class="results-summary">';
            
            Object.entries(data.summary).forEach(([key, value]) => {
                html += `
                    <div class="summary-item">
                        <div class="summary-value">${value}</div>
                        <div class="summary-label">${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</div>
                    </div>
                `;
            });
            
            html += '</div>';
        }
        
        // Add data table based on report type
        if (reportType === 'applicants' && data.data && data.data.length > 0) {
            html += `
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Department</th>
                                <th>Applicant ID</th>
                                <th>Last Name</th>
                                <th>First Name</th>
                                <th>Middle Initial</th>
                                <th>Email</th>
                                <th>Phone Number</th>
                                <th>Job Title</th>
                                <th>Application Date</th>
                                <th>Status</th>
                                <th>Initial Screening Score</th>
                                <th>HR Interview Score</th>
                                <th>Line Manager Score</th>
                                <th>Total Score</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.data.forEach(applicant => {
                const statusClass = getStatusClass(applicant.status);
                html += `
                    <tr>
                        <td>${applicant.department}</td>
                        <td><strong>${applicant.applicantId}</strong></td>
                        <td>${applicant.lastName}</td>
                        <td>${applicant.firstName}</td>
                        <td>${applicant.middleInitial || ''}</td>
                        <td>${applicant.email}</td>
                        <td>${applicant.phoneNumber}</td>
                        <td>${applicant.jobTitle}</td>
                        <td>${applicant.applicationDate}</td>
                        <td><span class="status-badge ${statusClass}">${applicant.status}</span></td>
                        <td>${applicant.initialScreeningScore || 'N/A'}</td>
                        <td>${applicant.hrInterviewScore || 'N/A'}</td>
                        <td>${applicant.lineManagerScore || 'N/A'}</td>
                        <td><strong>${applicant.totalScore || 'N/A'}</strong></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
        }
        
        else if (reportType === 'hirees' && data.data && data.data.length > 0) {
            html += `
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Hire ID</th>
                                <th>Last Name</th>
                                <th>First Name</th>
                                <th>Job Title</th>
                                <th>Department</th>
                                <th>Job Type</th>
                                <th>Hire Date</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.data.forEach(hiree => {
                html += `
                    <tr>
                        <td><strong>${hiree.hireId}</strong></td>
                        <td>${hiree.lastName}</td>
                        <td>${hiree.firstName}</td>
                        <td>${hiree.jobTitle}</td>
                        <td>${hiree.department}</td>
                        <td>${hiree.jobType}</td>
                        <td>${hiree.hireDate}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
        }
        
        else if (reportType === 'status' && data.applicant) {
            html += `
                <div class="applicant-info-card">
                    <h4>Applicant Information</h4>
                    <div class="applicant-info-grid">
                        <div class="applicant-info-item">
                            <strong>Last Name</strong>
                            <span>${data.applicant.lastName}</span>
                        </div>
                        <div class="applicant-info-item">
                            <strong>First Name</strong>
                            <span>${data.applicant.firstName}</span>
                        </div>
                        <div class="applicant-info-item">
                            <strong>Middle Initial</strong>
                            <span>${data.applicant.middleInitial || 'N/A'}</span>
                        </div>
                        <div class="applicant-info-item">
                            <strong>Email</strong>
                            <span>${data.applicant.email}</span>
                        </div>
                        <div class="applicant-info-item">
                            <strong>Phone</strong>
                            <span>${data.applicant.phoneNumber}</span>
                        </div>
                        <div class="applicant-info-item">
                            <strong>Birth Date</strong>
                            <span>${data.applicant.birthDate}</span>
                        </div>
                        <div class="applicant-info-item">
                            <strong>Job Position</strong>
                            <span>${data.applicant.jobPosition}</span>
                        </div>
                        <div class="applicant-info-item">
                            <strong>Department</strong>
                            <span>${data.applicant.department}</span>
                        </div>
                        <div class="applicant-info-item">
                            <strong>Application Date</strong>
                            <span>${data.applicant.applicationDate}</span>
                        </div>
                        <div class="applicant-info-item">
                            <strong>Days in Process</strong>
                            <span>${data.applicant.daysInProcess} days</span>
                        </div>
                        <div class="applicant-info-item">
                            <strong>Current Status</strong>
                            <span class="status-badge ${getStatusClass(data.applicant.currentStatus)}">${data.applicant.currentStatus}</span>
                        </div>
                        <div class="applicant-info-item">
                            <strong>HR Screening Approved</strong>
                            <span class="approval-badge ${data.applicant.hrScreeningApproved.toLowerCase()}">${data.applicant.hrScreeningApproved}</span>
                        </div>
                        <div class="applicant-info-item">
                            <strong>Panel Screening Approved</strong>
                            <span class="approval-badge ${data.applicant.panelScreeningApproved.toLowerCase()}">${data.applicant.panelScreeningApproved}</span>
                        </div>
                        <div class="applicant-info-item">
                            <strong>Is Hired</strong>
                            <span class="approval-badge ${data.applicant.isHired.toLowerCase()}">${data.applicant.isHired}</span>
                        </div>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <h4>Status History Timeline</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Status Update</th>
                                <th>Date</th>
                                <th>Notes & Comments</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.statusHistory.forEach(history => {
                html += `
                    <tr>
                        <td><span class="status-badge ${getStatusClass(history.status)}">${history.status}</span></td>
                        <td>${history.date}</td>
                        <td>${history.notes}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
        }
        
        else if (reportType === 'timeline') {
            // Enhanced timeline report display with summary statistics
            if (data.summaryStats) {
                html += '<div class="results-summary">';
                
                html += `
                    <div class="summary-item">
                        <div class="summary-value">${data.summaryStats.averageMrfToOnboarding} days</div>
                        <div class="summary-label">Average MRF to Onboarding</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${data.summaryStats.shortestTimeline} days</div>
                        <div class="summary-label">Shortest Timeline</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${data.summaryStats.longestTimeline} days</div>
                        <div class="summary-label">Longest Timeline</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${data.summaryStats.targetTimeline} days</div>
                        <div class="summary-label">Target Timeline</div>
                    </div>
                `;
                
                html += '</div>';
            }

            // MRF to Onboarding Breakdown section
            if (data.summaryStats && data.summaryStats.averageStages) {
                html += `
                    <div class="breakdown-section">
                        <h4>MRF to Onboarding Breakdown</h4>
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Stage</th>
                                        <th>Days</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>MRF to Job Posting</td>
                                        <td><strong>${data.summaryStats.averageStages.mrfToJobPosting} days</strong></td>
                                    </tr>
                                    <tr>
                                        <td>Job Posting to Initial Interview</td>
                                        <td><strong>${data.summaryStats.averageStages.jobPostingToInitialInterview} days</strong></td>
                                    </tr>
                                    <tr>
                                        <td>Initial Interview to Final Interview</td>
                                        <td><strong>${data.summaryStats.averageStages.initialInterviewToFinalInterview} days</strong></td>
                                    </tr>
                                    <tr>
                                        <td>Final Interview to Onboarding</td>
                                        <td><strong>${data.summaryStats.averageStages.finalInterviewToOnboarding} days</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            // Monthly timeline data
            if (data.monthlyData && data.monthlyData.length > 0) {
                html += `
                    <div class="monthly-timeline-section">
                        <h4>Monthly Timeline Analysis</h4>
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Month</th>
                                        <th>Hires Completed</th>
                                        <th>Average Days to Hire</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                data.monthlyData.forEach(month => {
                    html += `
                        <tr>
                            <td><strong>${month.monthName}</strong></td>
                            <td><span class="status-badge status-hired">${month.hires}</span></td>
                            <td>${month.averageDays} days</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div></div>';
            }
            
            // Individual timeline details
            if (data.timelineData && data.timelineData.length > 0) {
                html += `
                    <div class="individual-timelines-section">
                        <h4>Individual Hiring Timelines</h4>
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Position</th>
                                        <th>Department</th>
                                        <th>Application Date</th>
                                        <th>Total Days</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                data.timelineData.forEach(timeline => {
                    const statusClass = getStatusClass(timeline.status);
                    const daysBadgeClass = timeline.totalDays <= 30 ? 'status-passed' : timeline.totalDays <= 45 ? 'status-pending' : 'status-failed';
                    
                    html += `
                        <tr>
                            <td>${timeline.name}</td>
                            <td>${timeline.position}</td>
                            <td>${timeline.department}</td>
                            <td>${timeline.applicationDate}</td>
                            <td><span class="status-badge ${daysBadgeClass}">${timeline.totalDays} days</span></td>
                            <td><span class="status-badge ${statusClass}">${timeline.status}</span></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div></div>';
            }
        }
        
        resultsDiv.innerHTML = html;
    }
        
        // Get status CSS class
        function getStatusClass(status) {
            if (!status) return '';
            
            const statusLower = status.toLowerCase();
            if (statusLower.includes('pending') || statusLower.includes('awaiting')) return 'status-pending';
            if (statusLower.includes('passed') || statusLower.includes('approved') || statusLower.includes('completed')) return 'status-passed';
            if (statusLower.includes('failed') || statusLower.includes('rejected')) return 'status-failed';
            if (statusLower.includes('hired')) return 'status-hired';
            if (statusLower.includes('progress')) return 'status-pending';
            
            return 'status-pending';
        }
        
        // Set default dates
        function setDefaultDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            // Set default date ranges for forms
            const startDateInputs = document.querySelectorAll('input[name="startDate"]');
            const endDateInputs = document.querySelectorAll('input[name="endDate"]');
            
            startDateInputs.forEach(input => {
                input.value = firstDay.toISOString().split('T')[0];
            });
            
            endDateInputs.forEach(input => {
                input.value = lastDay.toISOString().split('T')[0];
            });
        }

        // Searchable Dropdown Class
        class SearchableApplicantDropdown {
            constructor() {
                this.container = document.getElementById('applicant-dropdown');
                this.input = document.getElementById('applicant-search');
                this.menu = document.getElementById('applicant-dropdown-menu');
                this.icon = this.container?.querySelector('.dropdown-icon');
                
                this.searchTimeout = null;
                this.currentRequest = null;
                this.selectedApplicant = null;
                this.highlightedIndex = -1;
                this.applicants = [];
                this.allApplicants = []; // Store all applicants for filtering
                this.isLoaded = false; // Track if we've loaded all applicants
                
                if (this.container && this.input && this.menu) {
                    this.init();
                }
            }
            
            init() {
                this.bindEvents();
                // Load all applicants when initialized
                this.loadAllApplicants();
            }
            
            bindEvents() {
                // Input events
                this.input.addEventListener('input', (e) => this.handleInput(e));
                this.input.addEventListener('focus', (e) => this.handleFocus(e));
                this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
                
                // Click on dropdown icon to show all applicants
                if (this.icon) {
                    this.icon.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.input.focus();
                        if (this.isMenuVisible()) {
                            this.hideMenu();
                        } else {
                            this.showAllApplicants();
                        }
                    });
                }
                
                // Click outside to close
                document.addEventListener('click', (e) => {
                    if (!this.container.contains(e.target)) {
                        this.hideMenu();
                    }
                });
            }
            
            async loadAllApplicants() {
                try {
                    console.log('🔄 Loading all applicants for dropdown...');
                    
                    const response = await fetch('/hr/recruitment/reports/search-applicants?query=all&loadAll=true');
                    
                    if (!response.ok) {
                        throw new Error('Failed to load applicants');
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.allApplicants = data.applicants;
                        this.isLoaded = true;
                        console.log(`✅ Loaded ${this.allApplicants.length} applicants for dropdown`);
                    } else {
                        console.error('❌ Failed to load applicants:', data.message);
                    }
                    
                } catch (error) {
                    console.error('❌ Error loading all applicants:', error);
                }
            }
            
            handleInput(e) {
                const query = e.target.value.trim();
                
                // Clear previous timeout
                if (this.searchTimeout) {
                    clearTimeout(this.searchTimeout);
                }
                
                // Reset selection if input changes
                if (this.selectedApplicant && this.selectedApplicant.name !== query) {
                    this.selectedApplicant = null;
                }
                
                // If input is empty, show all applicants
                if (query.length === 0) {
                    this.showAllApplicants();
                    return;
                }
                
                // Filter applicants based on input
                this.searchTimeout = setTimeout(() => {
                    this.filterApplicants(query);
                }, 150); // Reduced debounce for better responsiveness
            }
            
            handleFocus(e) {
                // Show all applicants when focused
                if (this.isLoaded) {
                    this.showAllApplicants();
                } else {
                    this.showLoading();
                    // Wait for loading to complete, then show
                    const checkLoaded = setInterval(() => {
                        if (this.isLoaded) {
                            clearInterval(checkLoaded);
                            this.showAllApplicants();
                        }
                    }, 100);
                }
            }
            
            handleKeydown(e) {
                if (!this.isMenuVisible()) return;
                
                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        this.highlightNext();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        this.highlightPrevious();
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (this.highlightedIndex >= 0 && this.applicants[this.highlightedIndex]) {
                            this.selectApplicant(this.applicants[this.highlightedIndex]);
                        }
                        break;
                    case 'Escape':
                        this.hideMenu();
                        this.input.blur();
                        break;
                }
            }
            
            showAllApplicants() {
                if (!this.isLoaded) {
                    this.showLoading();
                    return;
                }
                
                this.applicants = this.allApplicants;
                this.displayResults(this.applicants);
            }
            
            filterApplicants(query) {
                if (!this.isLoaded) {
                    this.showLoading();
                    return;
                }
                
                const searchTerm = query.toLowerCase();
                
                // Filter from all applicants
                const filtered = this.allApplicants.filter(applicant => {
                    const name = applicant.name.toLowerCase();
                    const email = applicant.email.toLowerCase();
                    const position = applicant.position.toLowerCase();
                    const department = applicant.department.toLowerCase();
                    
                    return name.includes(searchTerm) || 
                        email.includes(searchTerm) || 
                        position.includes(searchTerm) ||
                        department.includes(searchTerm);
                });
                
                this.applicants = filtered;
                this.displayResults(this.applicants);
            }
            
            showLoading() {
                this.menu.innerHTML = `
                    <div class="dropdown-loading">
                        <span class="search-loading-spinner"></span>
                        Loading applicants...
                    </div>
                `;
                this.showMenu();
            }
            
            displayResults(applicants) {
                this.highlightedIndex = -1;
                
                if (applicants.length === 0) {
                    this.showNoResults();
                    return;
                }
                
                // Limit display to first 50 for performance
                const displayApplicants = applicants.slice(0, 50);
                
                const html = displayApplicants.map((applicant, index) => `
                    <div class="dropdown-item" data-index="${index}">
                        <div class="applicant-name">${applicant.name}</div>
                        <div class="applicant-details">
                            ${applicant.email} • ${applicant.position} • ${applicant.department}
                            <span class="applicant-status-badge ${this.getStatusClass(applicant.status)}">${applicant.status}</span>
                        </div>
                    </div>
                `).join('');
                
                // Add "showing X of Y" if there are more results
                let footerHtml = '';
                if (applicants.length > 50) {
                    footerHtml = `
                        <div class="dropdown-footer">
                            Showing 50 of ${applicants.length} applicants. Type to narrow results.
                        </div>
                    `;
                }
                
                this.menu.innerHTML = html + footerHtml;
                
                // Add click listeners
                this.menu.querySelectorAll('.dropdown-item').forEach((item, index) => {
                    item.addEventListener('click', () => this.selectApplicant(displayApplicants[index]));
                    item.addEventListener('mouseenter', () => this.highlightItem(index));
                });
                
                this.showMenu();
            }
            
            showNoResults() {
                const query = this.input.value.trim();
                this.menu.innerHTML = `
                    <div class="dropdown-no-results">
                        ${query ? `No applicants found for "${query}".` : 'No applicants found.'} 
                        <br><small>Try a different search term.</small>
                    </div>
                `;
                this.showMenu();
            }
            
            showError() {
                this.menu.innerHTML = `
                    <div class="dropdown-no-results">
                        Error loading applicants. Please try again.
                    </div>
                `;
                this.showMenu();
            }
            
            selectApplicant(applicant) {
                this.selectedApplicant = applicant;
                this.input.value = applicant.name;
                this.hideMenu();
                
                console.log('Selected applicant:', applicant);
            }
            
            highlightNext() {
                const maxIndex = Math.min(this.applicants.length - 1, 49); // Max 50 displayed items
                if (this.highlightedIndex < maxIndex) {
                    this.highlightItem(this.highlightedIndex + 1);
                }
            }
            
            highlightPrevious() {
                if (this.highlightedIndex > 0) {
                    this.highlightItem(this.highlightedIndex - 1);
                }
            }
            
            highlightItem(index) {
                // Remove previous highlight
                this.menu.querySelectorAll('.dropdown-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Add new highlight
                const items = this.menu.querySelectorAll('.dropdown-item');
                if (items[index]) {
                    items[index].classList.add('selected');
                    this.highlightedIndex = index;
                    
                    // Scroll into view if needed
                    items[index].scrollIntoView({
                        block: 'nearest',
                        behavior: 'smooth'
                    });
                }
            }
            
            showMenu() {
                this.menu.classList.add('show');
                this.container.classList.add('open');
            }
            
            hideMenu() {
                this.menu.classList.remove('show');
                this.container.classList.remove('open');
                this.highlightedIndex = -1;
            }
            
            isMenuVisible() {
                return this.menu.classList.contains('show');
            }
            
            getStatusClass(status) {
                if (!status) return 'status-pending';
                
                const statusLower = status.toLowerCase();
                if (statusLower.includes('pending') || statusLower.includes('awaiting')) return 'status-pending';
                if (statusLower.includes('passed') || statusLower.includes('approved')) return 'status-passed';
                if (statusLower.includes('failed') || statusLower.includes('rejected')) return 'status-failed';
                if (statusLower.includes('hired')) return 'status-hired';
                
                return 'status-pending';
            }
            
            getSelectedApplicant() {
                return this.selectedApplicant;
            }
        }

        // Toggle active class for sidebar links
        document.querySelectorAll('.sidebar ul li a').forEach(link => {
            link.addEventListener('click', function() {
                document.querySelectorAll('.sidebar ul li a').forEach(link => link.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Toggle collapsible content
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', function() {
                var content = this.nextElementSibling;
                if (content.style.display === 'block') {
                    content.style.display = 'none';
                } else {
                    // Hide all other collapsible contents
                    document.querySelectorAll('.collapsible-content').forEach(item => {
                        if (item !== content) {
                            item.style.display = 'none';
                        }
                    });
                    content.style.display = 'block';
                }
            });
        });
    </script>
</body>
</html>