<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Information & Career Progression</title>
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/hr_pages.css">
    <link rel="stylesheet" href="/css/recordsandperformancetracker.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<style>
    h2 {
    margin-bottom: 20px; /* Adjust the value as needed for spacing */
}
.employee-info {
    margin-top: 20px; /* Adjust the value as needed for spacing */
}


</style>

<body>
    <%- include('../../partials/linemanager_partials') %>

    <!-- Main content area -->
    <div class="main-content">
        <div class="container">
            <div class="columns">
                <!-- Column 1: Personal Information -->
                <div class="column" id="personal-info">
                    <div class="section">
                        <img src="/images/profile.png" alt="Profile Picture" class="profile-pic">
                        <h2>Personal Information</h2>
                        <p><strong>Name:</strong> <span id="nameDisplay"><%= user.firstName %> <%= user.lastName %></span></p>
                        <p><strong>Phone:</strong> <span id="phoneDisplay"><%= user.phoneNumber %></span></p>
                        <p><strong>Date of Birth:</strong> <span id="dobDisplay"><%= user.dateOfBirth %></span></p>
                        <p><strong>Emergency Contact:</strong> <span id="emergencyDisplay"><%= user.emergencyContactName %> (<%= user.emergencyContactNumber %>)</span></p>
                    </div>
                    <div class="section">
                        <h2>Employment Details</h2>
                        <p><strong>Job Title:</strong> <span id="jobTitleDisplay"><%= user.jobTitle %></span></p>
                        <p><strong>Department:</strong> <span id="departmentDisplay"><%= user.departmentName %></span></p>
                        <p><strong>Employment Type:</strong> <span id="employmentTypeDisplay"><%= user.employmentType %></span></p>
                        <p><strong>Hire Date:</strong> <span id="hireDateDisplay"><%= user.hireDate %></span></p>
                    </div>
                </div>
        
                <!-- Column 2: Career Progression -->
                <div class="column" id="career-progression">
                    <div class="section">
                        <h2>Career Progression</h2>
                        <div class="milestone-container">
                            <div class="milestone">
                                <div class="milestone-label">
                                    <h4>Milestone 1</h4>
                                    <p>Joined Company</p>
                                </div>
                            </div>
                            <div class="milestone">
                                <div class="milestone-label">
                                    <h4>Milestone 2</h4>
                                    <p>Promoted to Junior Developer</p>
                                </div>
                            </div>
                            <div class="milestone">
                                <div class="milestone-label">
                                    <h4>Milestone 3</h4>
                                    <p>Completed Major Project</p>
                                </div>
                            </div>
                            <div class="milestone">
                                <div class="milestone-label">
                                    <h4>Milestone 4</h4>
                                    <p>Promoted to Developer</p>
                                </div>
                            </div>
                            <div class="milestone">
                                <div class="milestone-label">
                                    <h4>Milestone 5</h4>
                                    <p>Achieved Team Lead Role</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        
                <!-- Column 3: Degree, Experiences, and Uploaded Certifications -->
                <div class="column" id="degree-experience-certifications">
                    <div class="section">
                        <h2>Degree</h2>
                        <p>Bachelor of Science in Computer Science</p>
                        <p>University of Technology - Graduated 2012</p>
                    </div>
        
                    <div class="section">
                        <h2>Experiences</h2>
                        <p>Software Engineer at XYZ Corp (2015 - Present)</p>
                        <p>Junior Developer at ABC Inc. (2012 - 2015)</p>
                    </div>
        
                    <div class="section">
                        <h2>Uploaded Certifications</h2>
                        <p>Certified Scrum Master (CSM)</p>
                        <p>Oracle Certified Java Programmer</p>
                        <p>Microsoft Certified: Azure Developer Associate</p>
                    </div>
                </div>
            </div>
        
            <!-- Below the three columns -->
            <section id="attendance-logs">
                <h2>Attendance Logs</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Last Name</th>
                            <th>First Name</th>
                            <th>Date</th>
                            <th>Department</th>
                            <th>Job Position</th>
                            <th>Time In</th>
                            <th>Time Out</th>
                            <th>Active Working Hours</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Doe</td>
                            <td>John</td>
                            <td>2024-10-30</td>
                            <td>Finance</td>
                            <td>Financial Analyst</td>
                            <td>08:00 AM</td>
                            <td>05:00 PM</td>
                            <td>8 Hours</td>
                        </tr>
                    </tbody>
                </table>
            </section>
        
            <section id="objective-skill-progress">
                <h2>Objective-based Skill Quarterly Progress Overview</h2>
                <table>
                    <thead>
                        <tr>
                            <th>KRA/Objectives</th>
                            <th>KPI</th>
                            <th>Target</th>
                            <th>UOM</th>
                            <th>Assigned Weight</th>
                            <th>Current Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Improve Financial Reporting</td>
                            <td>Accuracy Rate</td>
                            <td>95%</td>
                            <td>%</td>
                            <td>20%</td>
                            <td>90%</td>
                        </tr>
                    </tbody>
                </table>
            </section>
        
            <section id="skill-gap-analysis">
                <h2>Job Required Skill and Gap Analysis Quarterly Overview</h2>
                <h3>Hard Skills</h3>
                <p>Analysis, Reporting, Forecasting</p>
                <h3>Soft Skills</h3>
                <p>Communication, Teamwork, Adaptability</p>
            </section>


            <section class="stepper">
                <h2>Objective and Performance Review Tracker</h2>
                <div class="stepper-container">
                    <div class="step" onclick="handleObjectiveClick()">
                        <div class="step-icon"><i class="fa fa-bullseye"></i></div>
                        <div class="step-label">
                            Objective Setting
                            <% 
                            // Log the viewOnlyStatus for debugging
                            console.log(viewState.viewOnlyStatus); 
                            %>
                            <% if (viewState.viewOnlyStatus['objectivesettings']) { %>
                                (View-Only)
                            <% } else { %>
                                (Editable)
                            <% } %>
                        </div>
                    </div>
            
                    <div class="step">
                        <div class="step-icon"><i class="fa fa-users"></i></div>
                        <div class="step-label">
                            [1/4] 360 Degree Feedback
                            <% if (viewState.viewOnlyStatus['360degreefeedback_1']) { %>
                                (View-Only)
                            <% } else { %>
                                (Editable)
                            <% } %>
                        </div>
                    </div>
            
                    <div class="step">
                        <div class="step-icon"><i class="fa fa-users"></i></div>
                        <div class="step-label">
                            [2/4] 360 Degree Feedback
                            <% if (viewState.viewOnlyStatus['360degreefeedback_2']) { %>
                                (View-Only)
                            <% } else { %>
                                (Editable)
                            <% } %>
                        </div>
                    </div>
            
                    <div class="step">
                        <div class="step-icon"><i class="fa fa-clipboard-check"></i></div>
                        <div class="step-label">
                            Mid-Year IDP
                            <% if (viewState.viewOnlyStatus.midyearidp) { %>
                                (View-Only)
                            <% } else { %>
                                (Editable)
                            <% } %>
                        </div>
                    </div>
            
                    <div class="step">
                        <div class="step-icon"><i class="fa fa-users"></i></div>
                        <div class="step-label">
                            [3/4] 360 Degree Feedback
                            <% if (viewState.viewOnlyStatus['360degreefeedback_3']) { %>
                                (View-Only)
                            <% } else { %>
                                (Editable)
                            <% } %>
                        </div>
                    </div>
            
                    <div class="step">
                        <div class="step-icon"><i class="fa fa-users"></i></div>
                        <div class="step-label">
                            [4/4] 360 Degree Feedback
                            <% if (viewState.viewOnlyStatus['360degreefeedback_4']) { %>
                                (View-Only)
                            <% } else { %>
                                (Editable)
                            <% } %>
                        </div>
                    </div>
            
                    <div class="step">
                        <div class="step-icon"><i class="fa fa-clipboard-check"></i></div>
                        <div class="step-label">
                            Final-Year IDP
                            <% if (viewState.viewOnlyStatus.finalyearidp) { %>
                                (View-Only)
                            <% } else { %>
                                (Editable)
                            <% } %>
                        </div>
                    </div>
            
                </div>
            </section>
            <form id="objectiveSettingsForm" method="POST" action="/linemanager/records-performance-tracker/objectivesetting/<%= user.userId %>">
                <% if (!viewState.viewOnlyStatus['objectivesettings']) { %>
                    <section id="objective-skill-progress-form" class="fade-out">
                        <h2>Objective-based Skill Quarterly Progress Overview</h2>
                        <p class="employee-info"><strong>Employee Name:</strong> <%= user.lastName %>, <%= user.firstName %></p>
                        <p><strong>Position:</strong> <%= user.jobTitle %></p>
                        <p><strong>Company:</strong> Prime Infrastructure</p>
                        <p><strong>Department:</strong> <%= user.departmentName %></p>
                        <p><strong>Performance Period:</strong> <span id="performanceDate"><%= new Date().toLocaleDateString('en-US') %></span></p>
                    
                        <input type="hidden" name="userId" value="<%= user.userId %>">
                        <input type="hidden" id="jobId" name="jobId" value="<%= user.jobId %>">
                        <input type="hidden" id="departmentId" name="departmentId" value="<%= user.departmentId %>">
                        <table>
                            <thead>
                                <tr>
                                    <th>KRA/Objectives</th>
                                    <th>KPI</th>
                                    <th>Target</th>
                                    <th>UOM</th>
                                    <th>Assigned Weight</th>
                                    <th>Actions</th>
                                </tr>
                                <tr>
                                    <th><small>Sample Input: Improve Customer Satisfaction</small></th>
                                    <th><small>Sample Input: Satisfaction Rate</small></th>
                                    <th><small>Sample Input: 90 (Numerical)</small></th>
                                    <th><small>Sample Input: %</small></th>
                                    <th><small>Sample Input: 20 (Input with no percentage)</small></th>
                                    <th><small>Click to Remove a Row</small></th>
                                </tr>
                            </thead>
                            <tbody id="progress-table-body">
                                <tr>
                                    <td><input type="text" placeholder="Enter Objective" name="objectiveDescrpt" required></td>
                                    <td><input type="text" placeholder="Enter KPI" name="objectiveKPI" required></td>
                                    <td><input type="text" placeholder="Enter Target" name="objectiveTarget" required></td>
                                    <td><input type="text" placeholder="Enter UOM" name="objectiveUOM" required></td>
                                    <td><input type="number" class="weight-input" oninput="updateTotalWeight()" placeholder="Enter Weight (%)" name="objectiveAssignedWeight" min="0" max="100" required></td>
                                    <td><button type="button" onclick="removeRow(this)">Remove</button></td>
                                </tr>
                            </tbody>
                        </table>
                        <button id="addRowBtn" type="button" onclick="addRow()">Add Row</button>
                        <p><strong>Total Assigned Weight:</strong> <input id="totalWeight" type="number" value="0" readonly>%</p>
                    
                        <label>
                            <input type="checkbox" id="confirmationCheckbox" required>
                            I confirm that the objective weights have been accurately consolidated and reviewed.
                        </label>
                    
                        <div id="submitButtonContainer">
                            <button id="saveButton" type="submit">Save</button>
                        </div>
                    </section>
                <% } else { %>
                    <!-- View-Only Page for Submitted Data -->
                    <section id="view-only-page" class="fade-out">
                        <h2>View Objectives and Performance Review Data</h2>
                        <p><strong>Submission Date:</strong> <span id="submissionDate"><%= new Date().toLocaleDateString('en-US') %></span></p>
                        
                        <div class="step-icon"><i class="fa fa-check-circle"></i></div>
                        <div id="objectivesData" class="view-only-section">
                            <strong>Submitted Objectives:</strong>
                            <ul>
                                <% if (viewState.submittedObjectives && viewState.submittedObjectives.length > 0) { %>
                                    <% viewState.submittedObjectives.forEach(obj => { %>
                                        <li>
                                            <strong>KRA/Objectives:</strong> <%= obj.objectiveDescrpt %>, 
                                            <strong>KPI:</strong> <%= obj.objectiveKPI %>, 
                                            <strong>Target:</strong> <%= obj.objectiveTarget %>, 
                                            <strong>UOM:</strong> <%= obj.objectiveUOM %>, 
                                            <strong>Assigned Weight:</strong> <%= obj.objectiveAssignedWeight %>%
                                        </li>
                                    <% }); %>
                                <% } else { %>
                                    <li>No objectives submitted yet.</li>
                                <% } %>
                            </ul>
                        </div>
                        <button id="prepareFeedbackBtn" style="float: right; margin-top: 20px;">Proceed to Prepare 360 Degree Feedback</button>
                    </section>
                <% } %>
            </form>
            <script>
                // Placeholder for viewState object
                const viewState = {
        viewOnlyStatus: {
            objectivesettings: false // TODO: Change this value based on your logic
        },
        submittedObjectives: [] // Default to an empty array
    };

    // Function to handle objective click
    function handleObjectiveClick() {
        console.log("Objective clicked. View only status:", viewState.viewOnlyStatus.objectivesettings);
        if (!viewState.viewOnlyStatus.objectivesettings) {
            showObjectiveForm();
        } else {
            displaySubmittedObjectives(viewState.submittedObjectives); // Show existing objectives if in view-only mode
        }
    }

    function showObjectiveForm() {
        console.log("Showing objective form.");
        const objectiveForm = document.getElementById("objective-skill-progress-form");
        if (objectiveForm) { // Check if the element exists
            objectiveForm.style.display = "block"; // Ensure the form is visible

            // Hide other sections
            const otherSections = document.querySelectorAll('#attendance-logs, #objective-skill-progress, #skill-gap-analysis, #view-only-page');
            otherSections.forEach(section => {
                section.style.display = "none"; // Hide other sections
            });

            // Fade out all other steps
            document.querySelectorAll('.step').forEach(step => {
                step.classList.add('faded');
            });

            // Show the specific step for the objective form
            const currentStep = document.querySelector('.step');
            if (currentStep) {
                currentStep.classList.remove('faded');
            }
        } else {
            console.error("Objective form element not found.");
        }
    }

            
                // Function to add a new row in the progress table
                function addRow() {
                    console.log("Adding a new row to the progress table.");
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td><input type="text" placeholder="Enter Objective" name="objectiveDescrpt" required></td>
                        <td><input type="text" placeholder="Enter KPI" name="objectiveKPI" required></td>
                        <td><input type="text" placeholder="Enter Target" name="objectiveTarget" required></td>
                        <td><input type="text" placeholder="Enter UOM" name="objectiveUOM" required></td>
                        <td><input type="number" class="weight-input" oninput="updateTotalWeight()" placeholder="Enter Weight (%)" name="objectiveAssignedWeight" min="0" max="100" required></td>
                        <td><button type="button" onclick="removeRow(this)">Remove</button></td>
                    `;
                    document.getElementById('progress-table-body').appendChild(newRow);
                    updateTotalWeight(); // Update the total weight after adding a new row
                }
            
                // Function to remove a row from the progress table
                function removeRow(button) {
                    console.log("Removing a row from the progress table.");
                    const row = button.parentElement.parentElement; // Get the row to remove
                    row.remove(); // Remove the row from the table
                    updateTotalWeight(); // Update total weight after removing a row
                }
            
                // Function to update the total weight
                function updateTotalWeight() {
                    const weightInputs = document.querySelectorAll('.weight-input');
                    let totalWeight = 0;
            
                    weightInputs.forEach(input => {
                        const weight = parseFloat(input.value) || 0; // Get weight, default to 0 if empty
                        totalWeight += weight; // Accumulate total weight
                    });
            
                    // Update the total weight display
                    document.getElementById("totalWeight").value = totalWeight;
                    console.log("Total weight updated:", totalWeight);
                }
            
                async function saveObjectives() {
                    const userId = document.querySelector('input[name="userId"]').value;
                    const jobId = document.getElementById("jobId").value;
                    const performancePeriod = document.getElementById("performanceDate").textContent;
            
                    const objectives = [];
                    const rows = document.querySelectorAll("#progress-table-body tr");
            
                    rows.forEach(row => {
                        const description = row.querySelector('input[name="objectiveDescrpt"]').value ;
                        const kpi = row.querySelector('input[name="objectiveKPI"]').value;
                        const target = row.querySelector('input[name="objectiveTarget"]').value;
                        const uom = row.querySelector('input[name="objectiveUOM"]').value;
                        const weight = parseFloat(row.querySelector('input[name="objectiveAssignedWeight"]').value) || 0;
            
                        if (description && kpi && target && uom && weight) {
                            objectives.push({ description, kpi, target, uom, weight });
                        }
                    });
            
                    const totalWeight = parseFloat(document.getElementById("totalWeight").value);
                    if (totalWeight !== 100) {
                        alert("Total weight of all objectives must be 100%.");
                        return;
                    }
            
                    if (!document.getElementById("confirmationCheckbox").checked) {
                        alert("Please confirm that the objective weights have been reviewed.");
                        return;
                    }
            
                    try {
                        const response = await fetch(`/linemanager/records-performance-tracker/objectivesetting/${userId}`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ jobId, performancePeriod, objectives })
                        });
            
                        const result = await response.json();
                        if (response.ok && result.success) {
                            alert(result.message); // Display success message
                            displaySubmittedObjectives(objectives); // Display objectives in view-only section
            
                            // Fetch and display objectives on the redirected page
                            fetchObjectives(userId);
                        } else {
                            alert("Failed to save objectives: " + result.message);
                        }
                    } catch (error) {
                        alert("An error occurred. Please try again later.");
                    }
                }
            
                // Function to display submitted objectives in the view-only section
                function displaySubmittedObjectives(objectives) {
    console.log("Displaying submitted objectives.");
    const objectivesData = document.getElementById("objectivesData");
    objectivesData.innerHTML = ""; // Clear previous data

    if (objectives && objectives.length > 0) {
        objectives.forEach(obj => {
            objectivesData.innerHTML += `<strong>KRA/Objectives:</strong> ${obj.objectiveDescrpt}, <strong>KPI:</strong> ${obj.objectiveKPI}, <strong>Target:</strong> ${obj.objectiveTarget}, <strong>UOM:</strong> ${obj.objectiveUOM}, <strong>Assigned Weight:</strong> ${obj.objectiveAssignedWeight}%<br>`;
        });
    } else {
        objectivesData.innerHTML = "No objectives found.";
    }

    // Set submission date to the current date
    document.getElementById("submissionDate").textContent = new Date().toLocaleDateString('en-US');
}

// Call the function to display existing objectives when the page loads
window.onload = function() {
    if (viewState.viewOnlyStatus['objectivesettings'] && viewState.submittedObjectives && viewState.submittedObjectives.length > 0) {
        displaySubmittedObjectives(viewState.submittedObjectives);
    }
};
            </script>
</body>
</html>
