<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Training & Development Tracker</title>
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/recordsandperformancetracker.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
.view-all-btn {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    width: 100%;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
}

.view-all-btn:hover {
    background: linear-gradient(135deg, #d97706, #b45309);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
}

.view-all-btn i {
    font-size: 10px;
}

/* Modal Close Button */
.close-modal-btn {
    background: none;
    border: none;
    font-size: 24px;
    color: #64748b;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.close-modal-btn:hover {
    background-color: #f1f5f9;
    color: #334155;
}

/* Pending Requests Controls */
.pending-requests-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding: 20px;
    background-color: #f8fafc;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    gap: 20px;
}

.pending-stats-summary {
    display: flex;
    align-items: center;
    gap: 15px;
}

.pending-count-badge {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
}

/* Pending Requests List */
.pending-requests-list {
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    background-color: white;
}

.pending-request-item {
    display: flex;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #f1f5f9;
    transition: all 0.2s ease;
    cursor: pointer;
}

.pending-request-item:hover {
    background-color: #f8fafc;
}

.pending-request-item:last-child {
    border-bottom: none;
}

.pending-request-checkbox {
    margin-right: 15px;
    width: 18px;
    height: 18px;
    accent-color: #f59e0b;
}

.pending-request-info {
    flex: 1;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.pending-request-details {
    flex: 1;
}

.pending-employee-name {
    font-size: 16px;
    font-weight: 600;
    color: #334155;
    margin: 0 0 6px 0;
}

.pending-training-title {
    font-size: 14px;
    color: #f59e0b;
    font-weight: 500;
    margin-bottom: 4px;
}

.pending-request-meta {
    font-size: 13px;
    color: #64748b;
    line-height: 1.4;
}

.pending-request-actions {
    display: flex;
    gap: 8px;
    margin-left: 20px;
}

.action-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 4px;
}

.approve-btn {
    background-color: #10b981;
    color: white;
}

.approve-btn:hover {
    background-color: #059669;
    transform: translateY(-1px);
}

.reject-btn {
    background-color: #ef4444;
    color: white;
}

.reject-btn:hover {
    background-color: #dc2626;
    transform: translateY(-1px);
}

.view-details-btn {
    background-color: #6366f1;
    color: white;
}

.view-details-btn:hover {
    background-color: #4f46e5;
    transform: translateY(-1px);
}

/* Empty State */
.no-pending-requests {
    text-align: center;
    padding: 60px 20px;
    color: #64748b;
}

.no-pending-requests i {
    font-size: 48px;
    color: #cbd5e1;
    margin-bottom: 15px;
}

.no-pending-requests h3 {
    margin: 0 0 10px 0;
    color: #475569;
    font-size: 18px;
}

.no-pending-requests p {
    margin: 0;
    font-size: 14px;
}

/* Priority Badges */
.priority-badge {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
    margin-left: 8px;
}

.priority-high {
    background-color: #fecaca;
    color: #dc2626;
}

.priority-medium {
    background-color: #fef3c7;
    color: #d97706;
}

.priority-low {
    background-color: #dcfce7;
    color: #166534;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .pending-requests-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
    
    .pending-request-item {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
    
    .pending-request-actions {
        margin-left: 0;
        justify-content: flex-end;
    }
}
        /* Import Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

        /* Main content styling */
        .main-content {
            margin-left: 270px;
            padding: 20px;
            font-family: 'Inter', sans-serif;
        }

        /* Dashboard header */
        .dashboard-header {
            margin-bottom: 25px;
        }

        .dashboard-header h2 {
            margin-bottom: 10px;
            color: #333;
            font-size: 24px;
        }

        .dashboard-header p {
            color: #666;
            font-size: 0.95rem;
            max-width: 800px;
        }

        /* Tabs styling */
        .tabs-container {
            width: 100%;
            margin-bottom: 30px;
        }

        .tabs-nav {
            display: flex;
            border-bottom: 2px solid #eee;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .tab-button {
            padding: 12px 20px;
            background-color: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            color: #666;
            transition: all 0.3s ease;
            margin-right: 10px;
            display: flex;
            align-items: center;
        }

        .tab-button i {
            margin-right: 8px;
            font-size: 16px;
        }

        .tab-button.active {
            color: #07ACB9;
            border-bottom: 3px solid #07ACB9;
            background-color: #f8fdfd;
        }

        .tab-button:hover:not(.active) {
            color: #124A5C;
            border-bottom: 3px solid #ddd;
        }

        .tab-content {
            display: none;
            padding: 25px 0;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Card styling */
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-bottom: 25px;
        }

        .card-header {
            margin-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 {
            margin: 0;
            font-size: 1.2rem;
            color: #333;
        }

        /* Search and Filter Section */
        .search-filter-section {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-container {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 45px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }

        .search-input:focus {
            outline: none;
            border-color: #07ACB9;
            box-shadow: 0 0 0 3px rgba(7, 172, 185, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            font-size: 14px;
        }

        /* Filter dropdown */
        .filter-dropdown {
            position: relative;
        }

        .filter-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background-color: #fff;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .filter-button:hover {
            border-color: #07ACB9;
        }

        .filter-dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            padding: 10px;
            min-width: 200px;
        }

        .filter-dropdown.open .filter-dropdown-content {
            display: block;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }

        .filter-option:hover {
            background-color: #f8fafc;
        }

        .filter-option input[type="checkbox"] {
            margin: 0;
        }

        /* Add training button */
        .add-training-btn {
            background-color: #124A5C;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .add-training-btn:hover {
            background-color: #0d3c4a;
            transform: translateY(-2px);
        }

        /* Active filters display */
        .active-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .filter-tag {
            background-color: #07ACB9;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .filter-tag .remove-filter {
            cursor: pointer;
            font-size: 10px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Training courses grid */
        .training-courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .training-course-card {
            background-color: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .training-course-card:hover {
            border-color: #07ACB9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .course-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #334155;
            margin: 0 0 10px 0;
        }

        .course-description {
            color: #475569;
            font-size: 14px;
            margin-bottom: 12px;
            line-height: 1.5;
            font-weight: 400;
        }

        .course-details {
            color: #64748b;
            font-size: 13px;
            margin-bottom: 15px;
            line-height: 1.4;
            font-weight: 500;
        }

        .course-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .course-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .course-badge.online {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .course-badge.onsite {
            background-color: #fef3c7;
            color: #d97706;
        }

        .course-badge.required {
            background-color: #fecaca;
            color: #dc2626;
        }

        /* Employee assignments list */
        .assignments-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        .assignment-item {
            background-color: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px 20px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .assignment-item:hover {
            border-color: #07ACB9;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .assignment-info {
            flex: 1;
        }

        .employee-name {
            font-size: 1rem;
            font-weight: 600;
            color: #334155;
            margin: 0 0 4px 0;
        }

        .assignment-details {
            font-size: 14px;
            color: #64748b;
            line-height: 1.4;
        }

        .assignment-status {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.in-progress {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .status-badge.completed {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-badge.not-started {
            background-color: #f1f5f9;
            color: #475569;
        }

        /* Modal styling */
      .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
}

.modal-overlay.show {
    display: flex;
}
        .modal-content {
    background-color: white;
    border-radius: 16px;
    padding: 30px;
    max-width: 900px; /* Increased from 800px */
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    font-family: 'Inter', sans-serif; /* Ensure modal uses Inter font */
}


        .modal-header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 15px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #334155;
            margin: 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    color: #374151;
    margin-bottom: 8px;
    font-family: 'Inter', sans-serif; /* Consistent font */
}


        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #07ACB9;
            box-shadow: 0 0 0 3px rgba(7, 172, 185, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px; /* Increased gap */
}s
        /* country add */
label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        select, input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .location-fields {
            display: none;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 4px solid #007bff;
        }
        .location-fields.show {
            display: block;
        }
        #countryDropdown {
            max-height: 200px;
            overflow-y: auto;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .demo-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
s
.add-item-section {
    background-color: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 20px; /* Increased padding */
    margin-bottom: 20px;
}


        .add-item-header {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .add-item-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        .add-btn {
            background-color: #07ACB9;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s ease;
            white-space: nowrap;
        }

        .add-btn:hover {
            background-color: #059ca4;
        }

        .dynamic-list {
            margin-top: 10px;
        }

        .dynamic-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 8px;
        }

        .remove-btn {
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-btn:hover {
            background-color: #dc2626;
        }

        /* Updated pill-style tags for objectives and skills */
        .pill-tag {
            display: inline-flex;
            align-items: center;
            background-color: #07ACB9;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            margin: 4px;
            gap: 6px;
        }

        .pill-tag .remove-pill {
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .pill-tag .remove-pill:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }

        .pills-container {
            display: flex;
            flex-wrap: wrap;
            margin-top: 10px;
            min-height: 30px;
            padding: 5px;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }

       .activity-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px; /* Increased gap */
    margin-bottom: 15px;
}



        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .activity-details {
            flex: 1;
        }

        .activity-details strong {
            color: #334155;
        }

        .activity-details span {
            color: #64748b;
            font-size: 13px;
        }

        /* Certificate item styling */
        .certificate-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .certificate-details {
            flex: 1;
        }

        .certificate-details strong {
            color: #334155;
            display: block;
            margin-bottom: 4px;
        }

        .certificate-details span {
            color: #64748b;
            font-size: 13px;
            line-height: 1.4;
        }

.duration-display {
    background-color: #f0fdff;
    border: 1px solid #07ACB9;
    border-radius: 8px;
    padding: 20px; /* Increased padding */
    text-align: center;
    margin: 20px 0; /* Increased margin */
}

.duration-value {
    font-size: 28px; /* Slightly larger */
}

        .duration-label {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 5px;
        }

        

        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .btn-secondary {
            background-color: #f8fafc;
            color: #64748b;
            border: 1px solid #e2e8f0;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background-color: #e2e8f0;
        }

        .btn-primary {
            background-color: #124A5C;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background-color: #0d3c4a;
        }

        /* Employee Training Details Modal */
        .employee-info-section {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .employee-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .employee-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #07ACB9;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 600;
        }

        .employee-details h3 {
            margin: 0 0 5px 0;
            color: #334155;
            font-size: 1.2rem;
        }

        .employee-job-role {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .employee-email {
            color: #64748b;
            font-size: 14px;
        }

        /* Training Statistics Cards */
        .training-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background-color: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #64748b;
            font-weight: 500;
        }

        .stat-card.in-progress .stat-number {
            color: #3b82f6;
        }

        .stat-card.completed .stat-number {
            color: #10b981;
        }

        .stat-card.overdue .stat-number {
            color: #ef4444;
        }

        /* Training Progress List */
        .training-progress-list {
            margin-top: 20px;
        }

        .training-progress-item {
            background-color: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .training-progress-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .training-title {
            font-size: 1rem;
            font-weight: 600;
            color: #334155;
            margin: 0 0 5px 0;
        }

        .training-meta {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 10px;
        }

        .progress-bar-container {
            background-color: #f1f5f9;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-bar-fill.in-progress {
            background-color: #3b82f6;
        }

        .progress-bar-fill.completed {
            background-color: #10b981;
        }

        .progress-bar-fill.overdue {
            background-color: #ef4444;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .progress-percentage {
            font-weight: 600;
            color: #334155;
        }

        .progress-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .progress-status.in-progress {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .progress-status.completed {
            background-color: #dcfce7;
            color: #166534;
        }

        .progress-status.overdue {
            background-color: #fecaca;
            color: #dc2626;
        }

        /* Training Description Styling */
        .training-description {
            color: #475569;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .training-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                padding: 15px;
            }

            .search-filter-section {
                flex-direction: column;
                align-items: stretch;
            }

            .search-container {
                min-width: auto;
            }

            .training-courses-grid {
                grid-template-columns: 1fr;
            }

            .assignment-item {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
        }

        /* ACTIVITY TYPE MODAL */

        /* Activity type actions styling */
    .activity-type-actions {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .add-type-btn {
        background-color: #07ACB9;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        transition: background-color 0.2s ease;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .add-type-btn:hover {
        background-color: #059ca4;
    }

    .add-type-btn i {
        font-size: 10px;
    }

/* Mini modal styling */
.mini-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 20000; /* Higher than main modal */
}

.mini-modal-overlay.show {
    display: flex;
}

/* Mini modal adjustments */
.mini-modal-content {
    background-color: white;
    border-radius: 12px;
    padding: 25px; /* Increased padding */
    max-width: 700px; /* Wider mini modal */
    width: 100%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    animation: miniModalSlideIn 0.3s ease;
    font-family: 'Inter', sans-serif; /* Consistent font */
}


/* Consistent form input styling */
.form-input, 
.form-select, 
.form-textarea,
.add-item-input,
#countryDropdown,
#addressField,
#newActivityTypeName,
#certificateTitle,
#certificateDescription {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
    font-family: 'Inter', sans-serif; /* Consistent font */
    transition: border-color 0.2s ease;
    box-sizing: border-box;
    color: #334155; /* Consistent text color */
}

.form-input:focus, 
.form-select:focus, 
.form-textarea:focus,
.add-item-input:focus,
#countryDropdown:focus,
#addressField:focus,
#newActivityTypeName:focus,
#certificateTitle:focus,
#certificateDescription:focus {
    outline: none;
    border-color: #07ACB9;
    box-shadow: 0 0 0 3px rgba(7, 172, 185, 0.1);
}


@keyframes miniModalSlideIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}


    .mini-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e2e8f0;
    }

    .mini-modal-header h4 {
        margin: 0;
        color: #334155;
        font-size: 1.1rem;
    }
.close-mini-modal {
    background: none;
    border: none;
    font-size: 24px;
    color: #64748b;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.close-mini-modal:hover {
    background-color: #f1f5f9;
    color: #334155;
}

.mini-modal-body {
    margin-bottom: 0;
}

.mini-modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #e2e8f0;
}

.mini-modal-actions .btn-secondary,
.mini-modal-actions .btn-primary {
    padding: 8px 16px;
    font-size: 14px;
}
    /* Responsive adjustments */
    @media (max-width: 1000px) {
        .activity-form-grid {
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .activity-type-actions {
            justify-content: flex-start;
        }

        .add-type-btn {
            font-size: 11px;
            padding: 6px 10px;
        }
    }

    /* Training Request Statistics */
.training-request-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.request-stat-card {
    background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.request-stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--accent-color);
}

.request-stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.request-stat-card.pending {
    --accent-color: #f59e0b;
}

.request-stat-card.approved {
    --accent-color: #10b981;
}

.request-stat-card.rejected {
    --accent-color: #ef4444;
}

.request-stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px;
    font-size: 24px;
    color: white;
}

.request-stat-card.pending .request-stat-icon {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.request-stat-card.approved .request-stat-icon {
    background: linear-gradient(135deg, #10b981, #059669);
}

.request-stat-card.rejected .request-stat-icon {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.request-stat-number {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 5px;
    color: #1f2937;
    line-height: 1;
}

.request-stat-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.request-stat-change {
    font-size: 0.75rem;
    margin-top: 8px;
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: 500;
}

.request-stat-change.increase {
    background-color: #dcfce7;
    color: #166534;
}

.request-stat-change.decrease {
    background-color: #fecaca;
    color: #dc2626;
}

.request-stat-change.neutral {
    background-color: #f3f4f6;
    color: #6b7280;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .training-request-stats {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .request-stat-card {
        padding: 15px;
    }
    
    .request-stat-number {
        font-size: 1.75rem;
    }
}

</style>
    </style>
</head>
<body>
    <%- include('../../partials/linemanager_partials') %>
    
    <!-- Main content area -->
    <div class="main-content">
        <div class="dashboard-header">
            <h2>Employee Training & Development Tracker</h2>
            <p>Manage training courses, track employee progress, and oversee professional development initiatives.</p>
        </div>

 <!-- Add New Training Modal -->
<div class="modal-overlay" id="addTrainingModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Add New Training Course</h2>
        </div>
        
        <form id="addTrainingForm">
            <!-- Training Course Name -->
            <div class="form-group">
                <label class="form-label">Training Course Name:</label>
                <input type="text" class="form-input" id="courseName" placeholder="Enter training course name" required>
            </div>

            <!-- UPDATED: Job-based Suggested Trainings Dropdown -->
            <div class="form-group">
                <label class="form-label">Suggested Trainings:</label>
                <select class="form-select" id="suggestedTrainings" onchange="fillFromSuggested()" disabled>
                    <option value="">Please select a job position first</option>
                </select>
                <small class="form-text text-muted" style="font-size: 12px; color: #6c757d; margin-top: 5px; display: block;">
                    This dropdown will populate with relevant trainings once you select a job position below.
                </small>
            </div>

            <!-- Description -->
            <div class="form-group">
                <label class="form-label">Description:</label>
                <textarea class="form-textarea" id="courseDescription" placeholder="Enter detailed description of the training course" required></textarea>
            </div>

            <!-- Job Positions and Training Mode -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Job Positions Applicable:</label>
                    <select class="form-select" id="jobPositions" required>
                        <option value="">Select applicable positions</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                
                <!-- Replace your existing training mode field with this -->
                <div class="form-group">
                    <label for="trainingMode">Training Mode <span style="color: red;">*</span></label>
                    <select id="trainingMode" name="trainingMode" required>
                        <option value="">Select Training Mode</option>
                        <option value="online">Online</option>
                        <option value="onsite">Onsite</option>
                    </select>
                </div>

                <!-- Add these location fields after the training mode field -->
                <div id="locationFields" class="location-fields">
                    <div class="form-group">
                        <label for="countryDropdown">Country <span style="color: red;">*</span></label>
                        <select id="countryDropdown" name="country">
                            <option value="">Loading countries...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="addressField">Address <span style="color: red;">*</span></label>
                        <textarea id="addressField" name="address" rows="3" placeholder="Enter the full address for the training venue"></textarea>
                    </div>
                </div>
            </div>

            <!-- Updated Cost section with PHP currency -->
            <div class="form-group">
                <label class="form-label">Cost (PHP):</label>
                <input type="number" class="form-input" id="trainingCost" placeholder="Enter training cost in Philippine Pesos (PHP)" min="0" step="0.01">
            </div>

            <!-- Focus on Objective Areas with Dropdown -->
            <div class="form-group">
                <label class="form-label">Objective Focus Areas:</label>
                <div class="add-item-section">
                    <div class="add-item-header">
                        <select class="add-item-input" id="objectiveDropdown">
                            <option value="">Select objective area</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                        <button type="button" class="add-btn" onclick="addObjective()">Add Objective</button>
                    </div>
                    <div class="pills-container" id="objectivesList"></div>
                </div>
            </div>

            <!-- Focus Skill Areas with Dropdown -->
            <div class="form-group">
                <label class="form-label">Skill Focus Areas:</label>
                <div class="add-item-section">
                    <div class="add-item-header">
                        <select class="add-item-input" id="skillDropdown">
                            <option value="">Select skill area</option>
                            <!-- Options will be populated dynamically with format: "Skill Name (Skill Type)" -->
                            <!-- Example: "JavaScript Programming (Hard)" or "Communication (Soft)" -->
                        </select>
                        <button type="button" class="add-btn" onclick="addSkill()">Add Skill Area</button>
                    </div>
                    <div class="pills-container" id="skillsList"></div>
                </div>
            </div>

            <!-- Total Duration Display -->
            <div class="duration-display">
                <div class="duration-label">Total Duration to Complete</div>
                <div class="duration-value"><span id="totalDuration">0</span></div>
            </div>

            <!-- Activities Needed -->
            <div class="form-group">
                <label class="form-label">Activities Needed:</label>
                <div class="add-item-section">
                    <div class="activity-form-grid">
                        <input type="text" class="add-item-input" id="moduleName" placeholder="Module name">
                        <input type="number" class="add-item-input" id="estimatedTime" placeholder="Estimated time (hours)" min="0" step="0.5">
                    </div>
                    <div class="activity-form-grid">
                        <select class="form-select" id="activityType">
                            <option value="">Select type</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                        <div class="activity-type-actions">
                            <button type="button" class="add-type-btn" onclick="showAddActivityTypeModal()">
                                <i class="fas fa-plus"></i> Add New Type
                            </button>
                        </div>
                    </div>

                    <!-- Add Activity Type Mini Modal -->
                    <div class="mini-modal-overlay" id="addActivityTypeModal">
                        <div class="mini-modal-content">
                            <div class="mini-modal-header">
                                <h4>Add New Activity Type</h4>
                                <button type="button" class="close-mini-modal" onclick="closeAddActivityTypeModal()">Ã—</button>
                            </div>
                            <div class="mini-modal-body">
                                <div class="form-group">
                                    <label class="form-label">Activity Type Name:</label>
                                    <input type="text" class="form-input" id="newActivityTypeName" placeholder="Enter activity type name" maxlength="50">
                                </div>
                                <div class="mini-modal-actions">
                                    <button type="button" class="btn-secondary" onclick="closeAddActivityTypeModal()">Cancel</button>
                                    <button type="button" class="btn-primary" onclick="saveNewActivityType()">Add Type</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="text" class="add-item-input" id="activityRemarks" placeholder="Remarks (optional)">
                    <button type="button" class="add-btn" onclick="addActivity()" style="width: 100%; margin-top: 10px;">Add Activity</button>
                    <div class="dynamic-list" id="activitiesList"></div>
                </div>
            </div>

            <!-- Certificates -->
            <div class="form-group">
                <label class="form-label">Certificate/s:</label>
                <div class="add-item-section">
                    <div class="activity-form-grid">
                        <input type="text" class="add-item-input" id="certificateTitle" placeholder="Enter certificate title">
                        <textarea class="add-item-input" id="certificateDescription" placeholder="Enter certificate description" style="min-height: 60px; resize: vertical;"></textarea>
                    </div>
                    <button type="button" class="add-btn" onclick="addCertificate()" style="width: 100%; margin-top: 10px;">Add Certificate</button>
                    <div class="dynamic-list" id="certificatesList"></div>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="closeAddTrainingModal()">Cancel</button>
                <button type="submit" class="btn-primary">Create Training Course</button>
            </div>
        </form>
    </div>
</div>

<!-- Tabs Container -->
        <div class="tabs-container">
            <ul class="tabs-nav">
                <li><button class="tab-button active" data-tab="training-courses-tab">
                    <i class="fas fa-graduation-cap"></i> Training Courses
                </button></li>
                <li><button class="tab-button" data-tab="employee-assignments-tab">
                    <i class="fas fa-users"></i> View Employee Training Assignments
                </button></li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-contents">
                <!-- Training Courses Tab -->
                <div id="training-courses-tab" class="tab-content active">
                    <div class="card">
                        <div class="card-header">
                            <h3>Available Training Courses</h3>
                        </div>
                        
                        <!-- Search and Filter Section -->
                        <div class="search-filter-section">
                            <div class="search-container">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="search-input" placeholder="Search training courses..." id="courseSearch">
                            </div>
                            
                            <div class="filter-dropdown" id="filter-dropdown">
                                <div class="filter-button" onclick="toggleFilterDropdown()">
                                    <i class="fas fa-filter"></i>
                                    <span>Filters</span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="filter-dropdown-content">
                                    <div class="filter-option">
                                        <input type="checkbox" id="filter-online" value="online" onchange="updateFilters()">
                                        <label for="filter-online">Online</label>
                                    </div>
                                    <div class="filter-option">
                                        <input type="checkbox" id="filter-onsite" value="onsite" onchange="updateFilters()">
                                        <label for="filter-onsite">Onsite</label>
                                    </div>
                                    <div class="filter-option">
                                        <input type="checkbox" id="filter-required" value="required" onchange="updateFilters()">
                                        <label for="filter-required">Required</label>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="add-training-btn" onclick="addNewTraining()">
                                <i class="fas fa-plus"></i>
                                Add New Training
                            </button>
                        </div>

                        <!-- Active filters display -->
                        <div class="active-filters" id="active-filters"></div>

                       <!-- Training courses grid -->
<div class="training-courses-grid">
    <% if (typeof trainings !== 'undefined' && trainings && trainings.length > 0) { %>
        <% trainings.forEach(training => { %>
            <div class="training-course-card" data-type="<%= training.badges ? training.badges.join(' ') : '' %>">
                <h4 class="course-title"><%= training.title || 'Untitled Training' %></h4>
                <div class="course-description">
                    <%= training.description || 'No description available' %>
                </div>
                <div class="course-details">
                    Duration: <%= training.duration || 0 %> hours<br>
                    Department: <%= training.department || 'Not specified' %><br>
                    Job Position: <%= training.jobTitle || 'Not specified' %><br>
                    <% if (training.mode === 'onsite' && training.location) { %>
                        Location: <%= training.location.address || 'Address not specified' %>, <%= training.location.country || 'Country not specified' %><br>
                    <% } %>
                    <% if (training.cost && training.cost > 0) { %>
                        Cost: â‚±<%= training.cost.toLocaleString() %>
                    <% } %>
                </div>
                <div class="course-badges">
                    <% if (training.badges && training.badges.length > 0) { %>
                        <% training.badges.forEach(badge => { %>
                            <span class="course-badge <%= badge %>"><%= badge.charAt(0).toUpperCase() + badge.slice(1) %></span>
                        <% }); %>
                    <% } %>
                </div>
            </div>
        <% }); %>
    <% } else { %>
        <div class="no-trainings-message" style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #64748b;">
            <i class="fas fa-graduation-cap" style="font-size: 48px; margin-bottom: 15px; color: #cbd5e1;"></i>
            <h3 style="margin: 0 0 10px 0; color: #475569;">No Training Courses Available</h3>
            <p style="margin: 0;">Click "Add New Training" to create your first training course.</p>
        </div>
    <% } %>
</div>
                    </div>
                </div>

                <!-- Updated Employee Training Assignments Tab Content -->
<div id="employee-assignments-tab" class="tab-content">
    <div class="card">
        <div class="card-header">
            <h3>Employee Training Assignments</h3>
        </div>
        
        
<!-- Training Request Statistics with Database Data -->
<div class="training-request-stats">
    <div class="request-stat-card pending">
        <div class="request-stat-icon">
            <i class="fas fa-clock"></i>
        </div>
        <div class="request-stat-number" id="pendingRequestsCount">
            <%
            // Calculate pending requests from training_records where isApproved = FALSE
            let pendingFromDB = 0;
            let ongoingFromDB = 0;
            let completedFromDB = 0;
            let overdueFromDB = 0;
            
            if (typeof allAssignments !== 'undefined' && allAssignments && allAssignments.length > 0) {
                allAssignments.forEach(assignment => {
                    // Check trainingStatus and isApproved to categorize
                    if (assignment.trainingStatus === 'For Approval' || assignment.isApproved === null) {
                        pendingFromDB++; // For Approval status = pending requests
                    } else if (assignment.trainingStatus === 'Cancelled' || assignment.isApproved === false) {
                        // Cancelled trainings - could be counted separately or ignored
                        // For now, we'll count them as a different category or skip them
                    } else if (assignment.isApproved === true) {
                        // For approved trainings, categorize by trainingStatus
                        switch(assignment.trainingStatus) {
                            case 'In Progress':
                                ongoingFromDB++;
                                break;
                            case 'Completed':
                                completedFromDB++;
                                break;
                            case 'Not Started':
                                ongoingFromDB++; // Count Not Started as ongoing since they're approved
                                break;
                            default:
                                // Handle any other status or check if overdue
                                if (assignment.isOverdue) {
                                    overdueFromDB++;
                                } else {
                                    ongoingFromDB++;
                                }
                        }
                    }
                });
            }
            %>
            <%= pendingFromDB %>
        </div>
        <div class="request-stat-label">Pending Requests</div>
        <div class="request-stat-change neutral">
            <i class="fas fa-minus"></i> No change
        </div>
        <!-- Add View All Button -->
        <div class="stat-card-action" style="margin-top: 15px;">
            <button class="view-all-btn" onclick="openPendingRequestsModal()">
                <i class="fas fa-eye"></i> View All
            </button>
        </div>
    </div>
    
    <div class="request-stat-card approved">
        <div class="request-stat-icon">
            <i class="fas fa-play-circle"></i>
        </div>
        <div class="request-stat-number" id="ongoingRequestsCount">
            <%= ongoingFromDB %>
        </div>
        <div class="request-stat-label">Ongoing Active Trainings</div>
        <div class="request-stat-change increase">
            <i class="fas fa-arrow-up"></i> +2 this week
        </div>
    </div>
    
    <div class="request-stat-card completed" style="--accent-color: #3b82f6;">
        <div class="request-stat-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
            <i class="fas fa-graduation-cap"></i>
        </div>
        <div class="request-stat-number" id="completedRequestsCount">
            <%= completedFromDB %>
        </div>
        <div class="request-stat-label">Completed Active Trainings</div>
        <div class="request-stat-change increase">
            <i class="fas fa-arrow-up"></i> +3 this week
        </div>
    </div>
    
    <div class="request-stat-card rejected">
        <div class="request-stat-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="request-stat-number" id="overdueRequestsCount">
            <%= overdueFromDB %>
        </div>
        <div class="request-stat-label">Overdue Trainings</div>
        <div class="request-stat-change decrease">
            <i class="fas fa-arrow-down"></i> -1 this week
        </div>
    </div>
</div>

<!-- Pending Requests Modal -->
<div class="modal-overlay" id="pendingRequestsModal">
    <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header">
            <h2 class="modal-title">Pending Training Requests</h2>
            <button type="button" class="close-modal-btn" onclick="closePendingRequestsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Filter and Search Section -->
        <div class="pending-requests-controls">
            <div class="search-container" style="flex: 1; max-width: 400px;">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Search pending requests..." id="pendingRequestsSearch">
            </div>
            
            <div class="pending-stats-summary">
                <span class="pending-count-badge">
                    <i class="fas fa-clock"></i>
                    <span id="pendingModalCount">0</span> Pending
                </span>
            </div>
        </div>

        <!-- Pending Requests List -->
        <div class="pending-requests-list" id="pendingRequestsList">
            <!-- Requests will be populated by JavaScript from database -->
        </div>

        <!-- Modal Actions -->
        <div class="modal-actions">
            <button type="button" class="btn-secondary" onclick="closePendingRequestsModal()">Close</button>
            <button type="button" class="btn-primary" onclick="approveAllSelected()">
                <i class="fas fa-check"></i> Approve Selected
            </button>
            <button type="button" class="btn-primary" onclick="rejectAllSelected()" style="background-color: #ef4444; margin-left: 10px;">
                <i class="fas fa-times"></i> Reject Selected
            </button>
        </div>
    </div>
</div>
        
        <!-- Search and Filter Section -->
        <div class="search-filter-section">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Search employees..." id="employeeSearch">
            </div>
            
            <div class="filter-dropdown" id="status-filter-dropdown">
                <div class="filter-button" onclick="toggleStatusFilterDropdown()">
                    <i class="fas fa-filter"></i>
                    <span>Status</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="filter-dropdown-content">
                    <div class="filter-option">
                        <input type="checkbox" id="filter-in-progress" value="in-progress" onchange="updateStatusFilters()">
                        <label for="filter-in-progress">In Progress</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-completed" value="completed" onchange="updateStatusFilters()">
                        <label for="filter-completed">Completed</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-not-started" value="not-started" onchange="updateStatusFilters()">
                        <label for="filter-not-started">Not Started</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- FIXED Employee assignments list -->
        <div class="assignments-list">
            <%
            // Use the allAssignments data for JavaScript and assignments for display
            let hasAssignments = false;
            let assignmentsToShow = [];
            
            if (typeof assignments !== 'undefined' && assignments && assignments.length > 0) {
                hasAssignments = true;
                assignmentsToShow = assignments;
            } else {
                // Fallback sample data for testing
                assignmentsToShow = [
                    {
                        employeeId: 'john-doe',
                        employeeName: 'John Doe',
                        trainingTitle: 'JavaScript Fundamentals',
                        jobTitle: 'Frontend Developer',
                        status: 'in-progress',
                        progress: 75,
                        startDate: new Date('2024-01-15'),
                        hasMultipleTrainings: false,
                        trainingCount: 1
                    },
                    {
                        employeeId: 'jane-smith',
                        employeeName: 'Jane Smith',
                        trainingTitle: 'Multiple Trainings (3)',
                        jobTitle: 'Operations Manager',
                        status: 'in-progress',
                        progress: 67,
                        startDate: new Date('2024-01-10'),
                        hasMultipleTrainings: true,
                        trainingCount: 3,
                        trainingsSummary: '3 trainings assigned â€¢ 1 completed â€¢ 2 in progress'
                    },
                    {
                        employeeId: 'mike-johnson',
                        employeeName: 'Mike Johnson',
                        trainingTitle: 'Data Analysis Bootcamp',
                        jobTitle: 'Data Analyst',
                        status: 'not-started',
                        progress: 0,
                        startDate: new Date('2024-01-20'),
                        dueDate: new Date('2024-02-20'),
                        hasMultipleTrainings: false,
                        trainingCount: 1
                    }
                ];
            }
            %>
            
            <!-- Debug info (remove in production) -->
            <% if (!hasAssignments) { %>
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin-bottom: 20px; border-radius: 5px; font-size: 12px; color: #856404;">
                    <strong>Debug Info:</strong> No assignments data from server. Showing sample data for testing.
                    <br>Server assignments variable: <%= typeof assignments %> 
                    <% if (typeof assignments !== 'undefined') { %>
                        (length: <%= assignments ? assignments.length : 'null' %>)
                    <% } %>
                </div>
            <% } %>
            
            <% if (assignmentsToShow && assignmentsToShow.length > 0) { %>
                <% assignmentsToShow.forEach(assignment => { %>
                    <div class="assignment-item" 
                         data-status="<%= assignment.status %>" 
                         data-employee-id="<%= assignment.employeeId %>"
                         onclick="console.log('ðŸ” CLICKED EMPLOYEE:', '<%= assignment.employeeName %>', 'ID:', '<%= assignment.employeeId %>', 'Type:', typeof '<%= assignment.employeeId %>'); openEmployeeModal('<%= assignment.employeeId %>')">
                        <div class="assignment-info">
                            <h4 class="employee-name">
                                <%= assignment.employeeName %>
                                <small style="color: #999; font-weight: normal;">(ID: <%= assignment.employeeId %>)</small>
                                <% if (assignment.hasMultipleTrainings) { %>
                                    <span style="background: #07ACB9; color: white; font-size: 11px; padding: 2px 6px; border-radius: 10px; margin-left: 8px; font-weight: normal;">
                                        <%= assignment.trainingCount %> trainings
                                    </span>
                                <% } %>
                            </h4>
                            <div class="assignment-details">
                                <% if (assignment.hasMultipleTrainings) { %>
                                    <%= assignment.trainingsSummary || `${assignment.trainingCount} trainings assigned` %><br>
                                <% } else { %>
                                    Training: <%= assignment.trainingTitle %><br>
                                <% } %>
                                Job Title: <%= assignment.jobTitle %><br>
                                <% if (assignment.status === 'completed') { %>
                                    <% if (assignment.hasMultipleTrainings) { %>
                                        Overall Progress: <%= assignment.progress || 0 %>% â€¢ Click to view details
                                    <% } else { %>
                                        Completed: <%= assignment.startDate ? assignment.startDate.toLocaleDateString() : 'Date not available' %> â€¢ Progress: <%= assignment.progress || 0 %>%
                                    <% } %>
                                <% } else if (assignment.status === 'in-progress') { %>
                                    <% if (assignment.hasMultipleTrainings) { %>
                                        Overall Progress: <%= assignment.progress || 0 %>% â€¢ Click to view details
                                    <% } else { %>
                                        Progress: <%= assignment.progress || 0 %>% â€¢ Started: <%= assignment.startDate ? assignment.startDate.toLocaleDateString() : 'Date not available' %>
                                    <% } %>
                                <% } else { %>
                                    <% if (assignment.hasMultipleTrainings) { %>
                                        Multiple assignments â€¢ Click to view details
                                    <% } else { %>
                                        Assigned: <%= assignment.startDate ? assignment.startDate.toLocaleDateString() : 'Date not available' %> â€¢ Due: <%= assignment.dueDate ? assignment.dueDate.toLocaleDateString() : 'No due date' %>
                                    <% } %>
                                <% } %>
                            </div>
                        </div>
                        <div class="assignment-status">
                            <span class="status-badge <%= assignment.status %>">
                                <% if (assignment.status === 'in-progress') { %>
                                    <% if (assignment.hasMultipleTrainings) { %>Mixed Progress<% } else { %>In Progress<% } %>
                                <% } else if (assignment.status === 'completed') { %>
                                    <% if (assignment.hasMultipleTrainings) { %>All Complete<% } else { %>Completed<% } %>
                                <% } else if (assignment.status === 'overdue') { %>
                                    <% if (assignment.hasMultipleTrainings) { %>Has Overdue<% } else { %>Overdue<% } %>
                                <% } else { %>
                                    <% if (assignment.hasMultipleTrainings) { %>Not Started<% } else { %>Not Started<% } %>
                                <% } %>
                            </span>
                            <% if (assignment.hasMultipleTrainings) { %>
                                <i class="fas fa-chevron-right" style="margin-left: 8px; color: #64748b; font-size: 12px;"></i>
                            <% } %>
                        </div>
                    </div>
                <% }); %>
            <% } else { %>
                <div class="no-assignments-message" style="text-align: center; padding: 40px; color: #64748b;">
                    <i class="fas fa-users" style="font-size: 48px; margin-bottom: 15px; color: #cbd5e1;"></i>
                    <h3 style="margin: 0 0 10px 0; color: #475569;">No Training Assignments</h3>
                    <p style="margin: 0;">Training assignments will appear here once employees are enrolled in courses.</p>
                </div>
            <% } %>
        </div>
    </div>
</div>

<!-- Employee Training Details Modal -->
<div class="modal-overlay" id="employeeTrainingModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Employee Training Details</h2>
        </div>
        
        <!-- Employee Information Section -->
        <div class="employee-info-section">
            <div class="employee-header">
                <div class="employee-avatar" id="employeeAvatar">JD</div>
                <div class="employee-details">
                    <h3 id="employeeName">John Doe</h3>
                    <div class="employee-job-role" id="employeeJobRole">Software Engineer</div>
                    <div class="employee-email" id="employeeEmail">john.doe@company.com</div>
                </div>
            </div>
        </div>

        <!-- Training Statistics -->
        <div class="training-stats">
            <div class="stat-card in-progress">
                <div class="stat-number" id="inProgressCount">2</div>
                <div class="stat-label">IN PROGRESS</div>
            </div>
            <div class="stat-card completed">
                <div class="stat-number" id="completedCount">5</div>
                <div class="stat-label">COMPLETED</div>
            </div>
            <div class="stat-card overdue">
                <div class="stat-number" id="overdueCount">1</div>
                <div class="stat-label">OVERDUE</div>
            </div>
        </div>

        <!-- Training Progress List -->
        <div class="training-progress-list" id="employeeTrainingList">
            <!-- Training items will be populated by JavaScript -->
        </div>

        <div class="modal-actions">
            <button type="button" class="btn-secondary" onclick="closeEmployeeTrainingModal()">Close</button>
            <button type="button" class="btn-primary" onclick="assignNewTraining()">Assign New Training</button>
            <button type="button" class="btn-primary" onclick="visitPerformanceTracker()">Visit Performance Tracker</button>
        </div>
    </div>
</div>
    <!-- JavaScript for functionality -->
    <script>

        // ADD this global variable to store all suggested trainings
        window.employeeAssignmentsData = [];
let allSuggestedTrainings = [];

// INITIALIZE the suggested trainings data when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Get suggested trainings data from the server
    <% if (typeof suggestedTrainings !== 'undefined' && suggestedTrainings) { %>
        allSuggestedTrainings = <%- JSON.stringify(suggestedTrainings) %>;
        console.log('Loaded suggested trainings:', allSuggestedTrainings.length, 'trainings');
        console.log('Sample training:', allSuggestedTrainings[0]);
    <% } %>
});

// Initialize database data for pending requests
let dbPendingRequests = [];

// Initialize when DOM loads
document.addEventListener('DOMContentLoaded', function() {
    // Get all assignments data from server
    <% if (typeof allAssignments !== 'undefined' && allAssignments) { %>
        const allServerAssignments = <%- JSON.stringify(allAssignments) %>;
        
        console.log('ðŸ“¥ Loading pending requests from database...');
        console.log('Total assignments from server:', allServerAssignments.length);
        
        // Filter for pending requests (trainingStatus = 'For Approval' OR isApproved = null)
        dbPendingRequests = allServerAssignments.filter(assignment => {
            // Only show records that are waiting for approval
            const isPendingApproval = assignment.trainingStatus === 'For Approval' || 
                                    (assignment.isApproved === null || assignment.isApproved === undefined);
            
            console.log(`Assignment ${assignment.employeeName}: isApproved = ${assignment.isApproved}, trainingStatus = ${assignment.trainingStatus}, isPendingApproval = ${isPendingApproval}`);
            
            return isPendingApproval;
        });
        
        console.log(`Found ${dbPendingRequests.length} pending requests (isApproved = false)`);
        
        // Log some examples
        if (dbPendingRequests.length > 0) {
            console.log('Sample pending request:', {
                employee: dbPendingRequests[0].employeeName,
                training: dbPendingRequests[0].trainingTitle,
                isApproved: dbPendingRequests[0].isApproved,
                recordId: dbPendingRequests[0].recordId
            });
        }
        
    <% } else { %>
        console.log('âŒ No allAssignments data available');
        dbPendingRequests = [];
    <% } %>
});

// Open Pending Requests Modal
function openPendingRequestsModal() {
    console.log('Opening pending requests modal...');
    
    // Load pending requests data from database
    loadPendingRequestsFromDB();
    
    // Show modal
    document.getElementById('pendingRequestsModal').classList.add('show');
}

// Close Pending Requests Modal
function closePendingRequestsModal() {
    document.getElementById('pendingRequestsModal').classList.remove('show');
}

// Load and display pending requests from database
function loadPendingRequestsFromDB() {
    const pendingRequestsList = document.getElementById('pendingRequestsList');
    const pendingModalCount = document.getElementById('pendingModalCount');
    
    console.log(`Loading ${dbPendingRequests.length} pending requests from database`);
    
    // Update count
    pendingModalCount.textContent = dbPendingRequests.length;
    
    // Clear existing content
    pendingRequestsList.innerHTML = '';
    
    if (dbPendingRequests.length === 0) {
        // Show empty state
        pendingRequestsList.innerHTML = `
            <div class="no-pending-requests">
                <i class="fas fa-inbox"></i>
                <h3>No Pending Requests</h3>
                <p>All training requests have been processed.</p>
            </div>
        `;
        return;
    }

 // ADD THIS DEBUG CODE HERE - RIGHT BEFORE THE forEach LOOP
    console.log('ðŸ” === DEBUGGING PENDING REQUESTS ===');
    console.log('Total pending requests:', dbPendingRequests.length);
    
    
    // Populate pending requests from database
    dbPendingRequests.forEach((request, index) => {
        
        console.log(`Request ${index + 1}:`, {
            employeeName: request.employeeName,
            trainingTitle: request.trainingTitle,
            trainingStatus: request.trainingStatus,
            isApproved: request.isApproved,
            recordId: request.recordId || request.id
        });

        const requestItem = document.createElement('div');
        requestItem.className = 'pending-request-item';
        requestItem.setAttribute('data-request-id', request.recordId || request.id);
        requestItem.setAttribute('data-training-record-id', request.recordId);
        
        // Format dates
        const requestDate = request.enrollmentDate || request.startDate || request.createdAt;
        const dueDate = request.dueDate;
        const requestDateFormatted = requestDate ? new Date(requestDate).toLocaleDateString() : 'Not specified';
        const dueDateFormatted = dueDate ? new Date(dueDate).toLocaleDateString() : 'No due date';
        
        // Determine priority based on due date or default to medium
        let priority = 'medium';
        if (dueDate) {
            const daysUntilDue = Math.ceil((new Date(dueDate) - new Date()) / (1000 * 60 * 60 * 24));
            if (daysUntilDue < 7) {
                priority = 'high';
            } else if (daysUntilDue > 30) {
                priority = 'low';
            }
        }
        
        requestItem.innerHTML = `
            <input type="checkbox" class="pending-request-checkbox" data-request-id="${request.recordId || request.id}">
            <div class="pending-request-info">
                <div class="pending-request-details">
                    <h4 class="pending-employee-name">
                        ${request.employeeName || 'Unknown Employee'}
                        <span class="priority-badge priority-${priority}">${priority.toUpperCase()}</span>
                    </h4>
                    <div class="pending-training-title">${request.trainingTitle || 'Unknown Training'}</div>
                    <div class="pending-request-meta">
                        Job Position: ${request.jobTitle || 'Not specified'}<br>
                        Request Date: ${requestDateFormatted} â€¢ Due Date: ${dueDateFormatted}<br>
                        Duration: ${request.trainingDuration || 'Not specified'} hours<br>
                        Current Status: ${request.trainingStatus || 'For Approval'}<br>
                        Email: ${request.employeeEmail || 'Not specified'}
                        ${request.reason ? `<br>Reason: ${request.reason}` : ''}
                    </div>
                </div>
                <div class="pending-request-actions">
                    <button class="action-btn approve-btn" onclick="approveTrainingRequest('${request.recordId || request.id}')">
                        <i class="fas fa-check"></i> Approve
                    </button>
                    <button class="action-btn reject-btn" onclick="rejectTrainingRequest('${request.recordId || request.id}')">
                        <i class="fas fa-times"></i> Reject
                    </button>
                    <button class="action-btn view-details-btn" onclick="viewTrainingRequestDetails('${request.recordId || request.id}')">
                        <i class="fas fa-eye"></i> Details
                    </button>
                </div>
            </div>
        `;
        
        pendingRequestsList.appendChild(requestItem);
    });
    
    // Initialize search functionality
    initializePendingRequestsSearch();
}

// Initialize search functionality for pending requests
function initializePendingRequestsSearch() {
    const searchInput = document.getElementById('pendingRequestsSearch');
    if (!searchInput) return;
    
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        const requestItems = document.querySelectorAll('.pending-request-item');
        
        requestItems.forEach(item => {
            const employeeName = item.querySelector('.pending-employee-name').textContent.toLowerCase();
            const trainingTitle = item.querySelector('.pending-training-title').textContent.toLowerCase();
            const meta = item.querySelector('.pending-request-meta').textContent.toLowerCase();
            
            const matches = employeeName.includes(searchTerm) || 
                           trainingTitle.includes(searchTerm) || 
                           meta.includes(searchTerm);
            
            item.style.display = matches ? 'flex' : 'none';
        });
    });
}

// Approve individual training request
async function approveTrainingRequest(requestId) {
    if (!confirm('Are you sure you want to approve this training request?')) {
        return;
    }
    
    console.log('Approving training request:', requestId);
    
    try {
        const response = await fetch('/linemanager/training-request/approve', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                recordId: requestId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Training request approved successfully! Status changed to Not Started.', 'success');
            
            // Update the underlying data object
            const requestIndex = dbPendingRequests.findIndex(req => (req.recordId || req.id) === requestId);
            if (requestIndex !== -1) {
                dbPendingRequests[requestIndex].trainingStatus = 'Not Started';
                dbPendingRequests[requestIndex].isApproved = true;
            }
            
            // Update the UI to show the new status before removing
            const requestItem = document.querySelector(`[data-request-id="${requestId}"]`);
            if (requestItem) {
                // Update the status in the UI to show "Not Started"
                const statusElement = requestItem.querySelector('.pending-request-meta');
                if (statusElement) {
                    // Update the status line in the meta information
                    const currentMeta = statusElement.innerHTML;
                    const updatedMeta = currentMeta.replace(
                        /Current Status: [^<]*/,
                        'Current Status: Not Started'
                    );
                    statusElement.innerHTML = updatedMeta;
                }
                
                // Add a visual indicator that it's been approved
                requestItem.style.backgroundColor = '#f0fdf4'; // Light green background
                requestItem.style.border = '2px solid #10b981'; // Green border
                
                // Wait a moment to show the status change, then remove from pending list
                setTimeout(() => {
                    requestItem.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => {
                        requestItem.remove();
                        updateRequestCounts();
                    }, 300);
                }, 1500); // Show the updated status for 1.5 seconds
            }
        } else {
            showNotification('Error approving request: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Error approving request:', error);
        showNotification('Error approving request. Please try again.', 'error');
    }
}

// Reject individual training request
async function rejectTrainingRequest(requestId) {
    const reason = prompt('Please provide a reason for rejection (optional):');
    if (reason === null) return; // User cancelled
    
    console.log('Rejecting training request:', requestId, 'Reason:', reason);
    
    try {
        const response = await fetch('/linemanager/training-request/reject', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                recordId: requestId,
                reason: reason || 'No reason provided'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Training request rejected.', 'warning');
            
            // Update the underlying data object
            const requestIndex = dbPendingRequests.findIndex(req => (req.recordId || req.id) === requestId);
            if (requestIndex !== -1) {
                dbPendingRequests[requestIndex].trainingStatus = 'Cancelled';
                dbPendingRequests[requestIndex].isApproved = false;
            }
            
            // Remove from pending list with animation
            const requestItem = document.querySelector(`[data-request-id="${requestId}"]`);
            if (requestItem) {
                requestItem.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    requestItem.remove();
                    updateRequestCounts();
                }, 300);
            }
        } else {
            showNotification('Error rejecting request: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Error rejecting request:', error);
        showNotification('Error rejecting request. Please try again.', 'error');
    }
}

// View training request details
function viewTrainingRequestDetails(requestId) {
    console.log('Viewing details for training request:', requestId);
    
    // Find the request in database data
    const request = dbPendingRequests.find(req => (req.recordId || req.id) === requestId);
    if (request) {
        const enrollmentDate = request.enrollmentDate || request.startDate || request.createdAt;
        const details = `
Employee: ${request.employeeName || 'Unknown'}
Email: ${request.employeeEmail || 'Not specified'}
Training: ${request.trainingTitle || 'Unknown Training'}
Job Position: ${request.jobTitle || 'Not specified'}
Enrollment Date: ${enrollmentDate ? new Date(enrollmentDate).toLocaleDateString() : 'Not specified'}
Due Date: ${request.dueDate ? new Date(request.dueDate).toLocaleDateString() : 'No due date'}
Duration: ${request.trainingDuration || 'Not specified'} hours
Current Status: ${request.trainingStatus || 'For Approval'}
Progress: ${request.progress || 0}%
Training Record ID: ${request.recordId}
        `;
        alert('Training Request Details:\n\n' + details);
    } else {
        alert('Request details not found.');
    }
}

// Approve all selected requests
async function approveAllSelected() {
    const selectedCheckboxes = document.querySelectorAll('.pending-request-checkbox:checked');
    
    if (selectedCheckboxes.length === 0) {
        alert('Please select at least one request to approve.');
        return;
    }
    
    if (!confirm(`Are you sure you want to approve ${selectedCheckboxes.length} selected request(s)?`)) {
        return;
    }
    
    const requestIds = Array.from(selectedCheckboxes).map(cb => cb.getAttribute('data-request-id'));
    
    try {
        const response = await fetch('/linemanager/training-request/approve-bulk', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                recordIds: requestIds
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(`${requestIds.length} requests approved successfully! All statuses changed to Not Started.`, 'success');
            
            // Update the underlying data objects
            requestIds.forEach(requestId => {
                const requestIndex = dbPendingRequests.findIndex(req => (req.recordId || req.id) === requestId);
                if (requestIndex !== -1) {
                    dbPendingRequests[requestIndex].trainingStatus = 'Not Started';
                    dbPendingRequests[requestIndex].isApproved = true;
                }
            });
            
            // Update UI for all selected items to show new status
            selectedCheckboxes.forEach((checkbox, index) => {
                const requestItem = checkbox.closest('.pending-request-item');
                
                // Update the status in the UI to show "Not Started"
                const statusElement = requestItem.querySelector('.pending-request-meta');
                if (statusElement) {
                    const currentMeta = statusElement.innerHTML;
                    const updatedMeta = currentMeta.replace(
                        /Current Status: [^<]*/,
                        'Current Status: Not Started'
                    );
                    statusElement.innerHTML = updatedMeta;
                }
                
                // Add visual indicator that it's been approved
                requestItem.style.backgroundColor = '#f0fdf4'; // Light green background
                requestItem.style.border = '2px solid #10b981'; // Green border
                
                // Remove with staggered animation after showing status change
                setTimeout(() => {
                    requestItem.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => {
                        requestItem.remove();
                        if (index === selectedCheckboxes.length - 1) {
                            updateRequestCounts();
                        }
                    }, 300);
                }, 1500 + (index * 100)); // Show status for 1.5s + stagger
            });
        } else {
            showNotification('Error approving requests: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Error approving requests:', error);
        showNotification('Error approving requests. Please try again.', 'error');
    }
}

// Reject all selected requests
async function rejectAllSelected() {
    const selectedCheckboxes = document.querySelectorAll('.pending-request-checkbox:checked');
    
    if (selectedCheckboxes.length === 0) {
        alert('Please select at least one request to reject.');
        return;
    }
    
    const reason = prompt('Please provide a reason for rejecting these requests:');
    if (reason === null) return; // User cancelled
    
    if (!confirm(`Are you sure you want to reject ${selectedCheckboxes.length} selected request(s)?`)) {
        return;
    }
    
    const requestIds = Array.from(selectedCheckboxes).map(cb => cb.getAttribute('data-request-id'));
    
    try {
        const response = await fetch('/linemanager/training-request/reject-bulk', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                recordIds: requestIds,
                reason: reason || 'No reason provided'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(`${requestIds.length} requests rejected.`, 'warning');
            
            // Update the underlying data objects
            requestIds.forEach(requestId => {
                const requestIndex = dbPendingRequests.findIndex(req => (req.recordId || req.id) === requestId);
                if (requestIndex !== -1) {
                    dbPendingRequests[requestIndex].trainingStatus = 'Cancelled';
                    dbPendingRequests[requestIndex].isApproved = false;
                }
            });
            
            // Remove rejected items with staggered animation
            selectedCheckboxes.forEach((checkbox, index) => {
                const requestItem = checkbox.closest('.pending-request-item');
                setTimeout(() => {
                    requestItem.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => {
                        requestItem.remove();
                        if (index === selectedCheckboxes.length - 1) {
                            updateRequestCounts();
                        }
                    }, 300);
                }, index * 100);
            });
        } else {
            showNotification('Error rejecting requests: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Error rejecting requests:', error);
        showNotification('Error rejecting requests. Please try again.', 'error');
    }
}

// Update request counts after actions
function updateRequestCounts() {
    const remainingRequests = document.querySelectorAll('.pending-request-item').length;
    
    // Update modal count
    const pendingModalCount = document.getElementById('pendingModalCount');
    if (pendingModalCount) {
        pendingModalCount.textContent = remainingRequests;
    }
    
    // Update main dashboard count
    const pendingRequestsCount = document.getElementById('pendingRequestsCount');
    if (pendingRequestsCount) {
        pendingRequestsCount.textContent = remainingRequests;
    }
    
    // Update the database array
    dbPendingRequests = dbPendingRequests.filter(req => {
        const requestId = req.recordId || req.id;
        return document.querySelector(`[data-request-id="${requestId}"]`) !== null;
    });
    
    // If no more pending requests, show empty state
    if (remainingRequests === 0) {
        const pendingRequestsList = document.getElementById('pendingRequestsList');
        pendingRequestsList.innerHTML = `
            <div class="no-pending-requests">
                <i class="fas fa-check-circle"></i>
                <h3>All Requests Processed</h3>
                <p>Great job! All pending training requests have been processed.</p>
            </div>
        `;
    }
}

// Show notification function
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 30000;
        animation: slideInRight 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    `;
    
    // Set background color based on type
    switch(type) {
        case 'success':
            notification.style.backgroundColor = '#10b981';
            break;
        case 'warning':
            notification.style.backgroundColor = '#f59e0b';
            break;
        case 'error':
            notification.style.backgroundColor = '#ef4444';
            break;
        default:
            notification.style.backgroundColor = '#6366f1';
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeOut {
        from { opacity: 1; transform: translateX(0); }
        to { opacity: 0; transform: translateX(-20px); }
    }
    
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('pendingRequestsModal');
    if (!modal) return;
    
    const modalContent = modal.querySelector('.modal-content');
    
    if (modal.classList.contains('show') && 
        !modalContent.contains(event.target) && 
        !event.target.classList.contains('view-all-btn')) {
        closePendingRequestsModal();
    }
});

// Handle Escape key to close modal
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('pendingRequestsModal');
        if (modal && modal.classList.contains('show')) {
            closePendingRequestsModal();
        }
    }
});

// Update the main statistics function to use database data
function updateTrainingStats() {
    // This function should be called after approve/reject actions
    // to update the main dashboard statistics
    
    <% if (typeof allAssignments !== 'undefined' && allAssignments) { %>
        const allServerAssignments = <%- JSON.stringify(allAssignments) %>;
        
        let pendingCount = 0;
        let ongoingCount = 0;
        let completedCount = 0;
        let overdueCount = 0;
        
        allServerAssignments.forEach(assignment => {
            // Check trainingStatus and isApproved to categorize
            if (assignment.trainingStatus === 'For Approval' || assignment.isApproved === null) {
                pendingCount++; // For Approval status = pending requests
            } else if (assignment.trainingStatus === 'Cancelled' || assignment.isApproved === false) {
                // Cancelled trainings - you might want to count these separately
                // For now, we'll not count them in any category
            } else if (assignment.isApproved === true) {
                // For approved trainings, categorize by trainingStatus
                switch(assignment.trainingStatus) {
                    case 'In Progress':
                        ongoingCount++;
                        break;
                    case 'Completed':
                        completedCount++;
                        break;
                    case 'Not Started':
                        ongoingCount++; // Count Not Started as ongoing since they're approved
                        break;
                    default:
                        if (assignment.isOverdue) {
                            overdueCount++;
                        } else {
                            ongoingCount++;
                        }
                }
            }
        });
        
        // Update the counts in the DOM
        const pendingElement = document.getElementById('pendingRequestsCount');
        const ongoingElement = document.getElementById('ongoingRequestsCount');
        const completedElement = document.getElementById('completedRequestsCount');
        const overdueElement = document.getElementById('overdueRequestsCount');
        
        if (pendingElement) pendingElement.textContent = pendingCount;
        if (ongoingElement) ongoingElement.textContent = ongoingCount;
        if (completedElement) completedElement.textContent = completedCount;
        if (overdueElement) overdueElement.textContent = overdueCount;
    <% } %>
}

        // Add this JavaScript function to handle the suggested training selection
// UPDATE your fillFromSuggested function to handle more training data
// Updated fillFromSuggested function with objective fetching
// Updated fillFromSuggested function with both objective and skill fetching
async function fillFromSuggested() {
    const suggestedSelect = document.getElementById('suggestedTrainings');
    const selectedValue = suggestedSelect.value;
    const selectedOption = suggestedSelect.options[suggestedSelect.selectedIndex];
    
    // Check if it's a database training (starts with 'db_')
    if (selectedValue.startsWith('db_')) {
        const trainingId = selectedValue.replace('db_', ''); // Remove 'db_' prefix
        
        // Use data from database training
        const trainingName = selectedOption.getAttribute('data-name');
        const trainingDescription = selectedOption.getAttribute('data-description');
        const trainingCost = selectedOption.getAttribute('data-cost');
        const trainingMode = selectedOption.getAttribute('data-mode');
        const trainingCountry = selectedOption.getAttribute('data-country');
        const trainingAddress = selectedOption.getAttribute('data-address');
        
        // Fill form fields
        document.getElementById('courseName').value = trainingName;
        document.getElementById('courseDescription').value = trainingDescription;
        
        // Fill cost if available
        if (trainingCost && trainingCost !== '0') {
            document.getElementById('trainingCost').value = trainingCost;
        }
        
        // Set training mode if available
        if (trainingMode) {
            document.getElementById('trainingMode').value = trainingMode;
            // Trigger the training mode change event to show/hide location fields
            toggleLocationFields();
            
            // If it's onsite training and we have location data, fill it
            if (trainingMode === 'onsite') {
                if (trainingCountry) {
                    // Wait a bit for countries to load, then set the country
                    setTimeout(() => {
                        const countryDropdown = document.getElementById('countryDropdown');
                        if (countryDropdown) {
                            countryDropdown.value = trainingCountry;
                        }
                    }, 500);
                }
                if (trainingAddress) {
                    document.getElementById('addressField').value = trainingAddress;
                }
            }
        }
        
        // Fetch both objectives and skills concurrently
        try {
            console.log('Fetching objectives and skills for training ID:', trainingId);
            
            // Fetch objectives and skills at the same time
            const [objectivesResponse, skillsResponse] = await Promise.all([
                fetch(`/linemanager/training/${trainingId}/objectives`),
                fetch(`/linemanager/training/${trainingId}/skills`)
            ]);
            
            const objectivesResult = await objectivesResponse.json();
            const skillsResult = await skillsResponse.json();
            
            console.log('Objectives fetch result:', objectivesResult);
            console.log('Skills fetch result:', skillsResult);
            
            // Handle objectives
            if (objectivesResult.success && objectivesResult.objectives && objectivesResult.objectives.length > 0) {
                // Clear existing objectives
                selectedObjectives = [];
                
                // Add fetched objectives
                objectivesResult.objectives.forEach(objective => {
                    selectedObjectives.push({
                        id: objective.id,
                        text: objective.description
                    });
                });
                
                // Update the display
                updateObjectivesDisplay();
                console.log('Successfully loaded objectives for training:', objectivesResult.objectives);
            } else {
                console.log('No objectives found for this training');
                // Clear objectives if none found
                selectedObjectives = [];
                updateObjectivesDisplay();
            }
            
            // Handle skills
            if (skillsResult.success && skillsResult.skills && skillsResult.skills.length > 0) {
                // Clear existing skills
                selectedSkills = [];
                
                // Add fetched skills
                skillsResult.skills.forEach(skill => {
                    selectedSkills.push({
                        id: skill.id,
                        text: `${skill.name} (${skill.type})`
                    });
                });
                
                // Update the display
                updateSkillsDisplay();
                console.log('Successfully loaded skills for training:', skillsResult.skills);
            } else {
                console.log('No skills found for this training');
                // Clear skills if none found
                selectedSkills = [];
                updateSkillsDisplay();
            }
            
        } catch (error) {
            console.error('Error fetching training objectives and skills:', error);
            // Clear both objectives and skills on error
            selectedObjectives = [];
            selectedSkills = [];
            updateObjectivesDisplay();
            updateSkillsDisplay();
        }
        
        console.log('Filled form with database training:', trainingName);
        return;
    }
    
    // Static training templates (your existing code)
    const suggestedTrainings = {
        leadership: {
            name: "Leadership Development Program",
            description: "Develop essential leadership skills including team management, strategic thinking, communication, and decision-making to effectively lead teams and drive organizational success."
        },
        safety: {
            name: "Safety and Compliance Training",
            description: "Essential workplace safety protocols, emergency procedures, and regulatory compliance requirements to ensure a safe and compliant work environment."
        },
        communication: {
            name: "Communication Excellence",
            description: "Improve interpersonal and communication skills for better workplace interactions, team collaboration, and professional relationships."
        },
        timemanagement: {
            name: "Time Management Skills",
            description: "Learn effective time management strategies, prioritization techniques, and productivity optimization methods to maximize efficiency and work-life balance."
        },
        customerservice: {
            name: "Customer Service Training",
            description: "Enhance customer interaction skills, learn problem-solving techniques, and understand customer psychology to deliver exceptional service experiences."
        },
        projectmanagement: {
            name: "Project Management Fundamentals",
            description: "Learn essential project management methodologies, tools, and techniques for successful project planning, execution, and delivery."
        },
        dataanalysis: {
            name: "Data Analysis and Reporting",
            description: "Master data analysis techniques, statistical methods, and reporting tools to make data-driven decisions and create meaningful insights."
        },
        teambuilding: {
            name: "Team Building Workshop",
            description: "Interactive workshop focused on building stronger team relationships, improving collaboration, and enhancing group dynamics for better team performance."
        },
        cybersecurity: {
            name: "Cybersecurity Awareness",
            description: "Essential cybersecurity practices, threat recognition, and data protection protocols to maintain secure digital environments and prevent security breaches."
        },
        diversity: {
            name: "Diversity and Inclusion Training",
            description: "Promote inclusive workplace culture, understand diversity benefits, and develop skills for creating equitable and respectful work environments."
        }
    };
    
    // Handle static training templates
    if (selectedValue && suggestedTrainings[selectedValue]) {
        const suggestion = suggestedTrainings[selectedValue];
        
        // Fill the course name and description fields
        document.getElementById('courseName').value = suggestion.name;
        document.getElementById('courseDescription').value = suggestion.description;
        
        // Clear objectives and skills for static templates
        selectedObjectives = [];
        selectedSkills = [];
        updateObjectivesDisplay();
        updateSkillsDisplay();
        
        console.log('Filled form with static template:', suggestion.name);
    }
}

        // Function to update statistics based on current assignments
// Function to update statistics based on current assignments
function updateTrainingStats() {
    const assignmentItems = document.querySelectorAll('.assignment-item');
    
    let pendingCount = 0;
    let ongoingCount = 0;
    let completedCount = 0;
    let overdueCount = 0;
    
    assignmentItems.forEach(item => {
        const status = item.getAttribute('data-status');
        
        switch(status) {
            case 'not-started':
            case 'pending':
                pendingCount++;
                break;
            case 'in-progress':
            case 'approved':
                ongoingCount++;
                break;
            case 'completed':
                completedCount++;
                break;
            case 'overdue':
                overdueCount++;
                break;
        }
    });
    
    // Update the counts in the DOM with new IDs
    const pendingElement = document.getElementById('pendingRequestsCount');
    const ongoingElement = document.getElementById('ongoingRequestsCount');
    const completedElement = document.getElementById('completedRequestsCount');
    const overdueElement = document.getElementById('overdueRequestsCount');
    
    if (pendingElement) pendingElement.textContent = pendingCount;
    if (ongoingElement) ongoingElement.textContent = ongoingCount;
    if (completedElement) completedElement.textContent = completedCount;
    if (overdueElement) overdueElement.textContent = overdueCount;
}

// Call this function whenever the assignment list is updated
document.addEventListener('DOMContentLoaded', function() {
    // Update stats when page loads
    setTimeout(updateTrainingStats, 100);
    
    // Update stats when filters are applied
    const originalUpdateStatusFilters = window.updateStatusFilters;
    window.updateStatusFilters = function() {
        originalUpdateStatusFilters();
        setTimeout(updateTrainingStats, 50);
    };
});

        // Arrays to store selected objectives and skills
        let selectedObjectives = [];
        let selectedSkills = [];
        let addedActivities = [];
        let addedCertificates = [];
        let countriesData = [];
        let allFormData = {
            jobPositions: [],
            objectives: [],
            skills: [],
            activityTypes: []
        };


        document.addEventListener('DOMContentLoaded', () => {
            // Tab functionality
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all buttons and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    // Add active class to clicked button
                    button.classList.add('active');

                    // Show corresponding content
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });

            // Search functionality for courses
            document.getElementById('courseSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const courseCards = document.querySelectorAll('.training-course-card');
                
                courseCards.forEach(card => {
                    const title = card.querySelector('.course-title').textContent.toLowerCase();
                    const details = card.querySelector('.course-details').textContent.toLowerCase();
                    
                    if (title.includes(searchTerm) || details.includes(searchTerm)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });

            // Search functionality for employees
            document.getElementById('employeeSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const assignmentItems = document.querySelectorAll('.assignment-item');
                
                assignmentItems.forEach(item => {
                    const name = item.querySelector('.employee-name').textContent.toLowerCase();
                    const details = item.querySelector('.assignment-details').textContent.toLowerCase();
                    
                    if (name.includes(searchTerm) || details.includes(searchTerm)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });


// Get modal element
const addTrainingModal = document.getElementById('addTrainingModal');

// Load dropdown data when modal is opened
document.querySelector('.add-training-btn').addEventListener('click', function() {
    loadTrainingFormData();
});
        });

        // Filter dropdown functionality
        function toggleFilterDropdown() {
            const dropdown = document.getElementById('filter-dropdown');
            dropdown.classList.toggle('open');
        }

        function toggleStatusFilterDropdown() {
            const dropdown = document.getElementById('status-filter-dropdown');
            dropdown.classList.toggle('open');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            const filterDropdown = document.getElementById('filter-dropdown');
            const statusFilterDropdown = document.getElementById('status-filter-dropdown');
            
            if (!filterDropdown.contains(event.target)) {
                filterDropdown.classList.remove('open');
            }
            
            if (!statusFilterDropdown.contains(event.target)) {
                statusFilterDropdown.classList.remove('open');
            }
        });

        // Update filters for training courses
        function updateFilters() {
            const activeFilters = [];
            const checkboxes = document.querySelectorAll('#filter-dropdown input[type="checkbox"]:checked');
            
            checkboxes.forEach(checkbox => {
                activeFilters.push(checkbox.value);
            });
            
            updateActiveFiltersDisplay(activeFilters);
            filterCourses(activeFilters);
        }

        // Update filters for employee assignments
        function updateStatusFilters() {
            const activeFilters = [];
            const checkboxes = document.querySelectorAll('#status-filter-dropdown input[type="checkbox"]:checked');
            
            checkboxes.forEach(checkbox => {
                activeFilters.push(checkbox.value);
            });
            
            filterAssignments(activeFilters);
        }

        // Display active filters
        function updateActiveFiltersDisplay(filters) {
            const activeFiltersContainer = document.getElementById('active-filters');
            activeFiltersContainer.innerHTML = '';
            
            filters.forEach(filter => {
                const filterTag = document.createElement('div');
                filterTag.className = 'filter-tag';
                filterTag.innerHTML = `
                    ${filter.charAt(0).toUpperCase() + filter.slice(1)}
                    <span class="remove-filter" onclick="removeFilter('${filter}')">Ã—</span>
                `;
                activeFiltersContainer.appendChild(filterTag);
            });
        }

        // Remove individual filter
        function removeFilter(filterToRemove) {
            const checkbox = document.getElementById(`filter-${filterToRemove}`);
            if (checkbox) {
                checkbox.checked = false;
                updateFilters();
            }
        }

        // Filter courses based on selected filters
        function filterCourses(activeFilters) {
            const courseCards = document.querySelectorAll('.training-course-card');
            
            courseCards.forEach(card => {
                if (activeFilters.length === 0) {
                    card.style.display = 'block';
                } else {
                    const cardTypes = card.getAttribute('data-type') || '';
                    const hasMatchingFilter = activeFilters.some(filter => 
                        cardTypes.includes(filter)
                    );
                    
                    card.style.display = hasMatchingFilter ? 'block' : 'none';
                }
            });
        }

        // Filter assignments based on status
        function filterAssignments(activeFilters) {
            const assignmentItems = document.querySelectorAll('.assignment-item');
            
            assignmentItems.forEach(item => {
                if (activeFilters.length === 0) {
                    item.style.display = 'flex';
                } else {
                    const itemStatus = item.getAttribute('data-status');
                    const hasMatchingStatus = activeFilters.includes(itemStatus);
                    
                    item.style.display = hasMatchingStatus ? 'flex' : 'none';
                }
            });
        }

        // ============================
        // ADD TRAINING MODULE SCRIPTS
        // ============================


        // Add new training function
   // Open modal function
function addNewTraining() {
    // Reset form and arrays
    selectedObjectives = [];
    selectedSkills = [];
    addedActivities = [];
    addedCertificates = [];
    
    // Clear form fields
    const form = document.getElementById('addTrainingForm');
    if (form) {
        form.reset();
    }
    
    // Clear displayed items
    updateObjectivesDisplay();
    updateSkillsDisplay();
    updateActivitiesDisplay();
    updateCertificatesDisplay();
    
    const totalDurationElement = document.getElementById('totalDuration');
    if (totalDurationElement) {
        totalDurationElement.textContent = '0';
    }
    
    // Load dropdown data
    loadTrainingFormData();
    
    const modal = document.getElementById('addTrainingModal');
    if (modal) {
        modal.classList.add('show');
    }
}



// Enhanced objective addition with validation
function addObjective() {
    const objectiveDropdown = document.getElementById('objectiveDropdown');
    const selectedValue = objectiveDropdown.value;
    const selectedOption = objectiveDropdown.options[objectiveDropdown.selectedIndex];
    
    console.log('Adding objective:', selectedValue, selectedOption.text);
    
    if (!selectedValue) {
        alert('Please select an objective from the dropdown.');
        return;
    }
    
    if (selectedObjectives.find(obj => obj.id === selectedValue)) {
        alert('This objective has already been added.');
        return;
    }
    
    const objective = {
        id: selectedValue,
        text: selectedOption.getAttribute('data-objective-desc') || selectedOption.text
    };
    
    selectedObjectives.push(objective);
    updateObjectivesDisplay();
    objectiveDropdown.value = ''; // Reset dropdown
    
    console.log('Objective added. Current objectives:', selectedObjectives);
}

// Update objectives display
function updateObjectivesDisplay() {
    const objectivesList = document.getElementById('objectivesList');
    objectivesList.innerHTML = '';
    
    selectedObjectives.forEach(objective => {
        const pillTag = document.createElement('div');
        pillTag.className = 'pill-tag';
        pillTag.innerHTML = `
            ${objective.text}
            <span class="remove-pill" onclick="removeObjective('${objective.id}')">Ã—</span>
        `;
        objectivesList.appendChild(pillTag);
    });
}

// Remove objective function
function removeObjective(objectiveIdToRemove) {
    selectedObjectives = selectedObjectives.filter(obj => obj.id !== objectiveIdToRemove);
    updateObjectivesDisplay();
}

// Enhanced skill addition with validation
function addSkill() {
    const skillDropdown = document.getElementById('skillDropdown');
    const selectedValue = skillDropdown.value;
    const selectedOption = skillDropdown.options[skillDropdown.selectedIndex];
    
    console.log('Adding skill:', selectedValue, selectedOption.text);
    
    if (!selectedValue) {
        alert('Please select a skill from the dropdown.');
        return;
    }
    
    if (selectedSkills.find(skill => skill.id === selectedValue)) {
        alert('This skill has already been added.');
        return;
    }
    
    const skill = {
        id: selectedValue,
        text: selectedOption.getAttribute('data-name') + ' (' + selectedOption.getAttribute('data-type') + ')' || selectedOption.text
    };
    
    selectedSkills.push(skill);
    updateSkillsDisplay();
    skillDropdown.value = ''; // Reset dropdown
    
    console.log('Skill added. Current skills:', selectedSkills);
}
function updateSkillsDisplay() {
    const skillsList = document.getElementById('skillsList');
    skillsList.innerHTML = '';
    
    selectedSkills.forEach(skill => {
        const pillTag = document.createElement('div');
        pillTag.className = 'pill-tag';
        pillTag.innerHTML = `
            ${skill.text}
            <span class="remove-pill" onclick="removeSkill('${skill.id}')">Ã—</span>
        `;
        skillsList.appendChild(pillTag);
    });
}

// Remove skill function
function removeSkill(skillIdToRemove) {
    selectedSkills = selectedSkills.filter(skill => skill.id !== skillIdToRemove);
    updateSkillsDisplay();
}

// Add activity function
function addActivity() {
    const moduleName = document.getElementById('moduleName').value.trim();
    const estimatedTime = document.getElementById('estimatedTime').value.trim();
    const activityType = document.getElementById('activityType').value;
    const remarks = document.getElementById('activityRemarks').value.trim();
    
    if (!moduleName || !estimatedTime || !activityType) {
        alert('Please fill in module name, estimated time, and activity type.');
        return;
    }
    
    const activity = {
        name: moduleName,
        duration: parseFloat(estimatedTime),
        type: activityType,
        remarks: remarks
    };
    
    addedActivities.push(activity);
    updateActivitiesDisplay();
    calculateTotalDuration();
    
    // Clear fields
    document.getElementById('moduleName').value = '';
    document.getElementById('estimatedTime').value = '';
    document.getElementById('activityType').value = '';
    document.getElementById('activityRemarks').value = '';
}

// Update activities display
function updateActivitiesDisplay() {
    const activitiesList = document.getElementById('activitiesList');
    if (!activitiesList) return;
    
    activitiesList.innerHTML = '';
    
    addedActivities.forEach((activity, index) => {
        const activityItem = document.createElement('div');
        activityItem.className = 'activity-item';
        activityItem.innerHTML = `
            <div class="activity-details">
                <strong>${activity.name}</strong><br>
                <span>Time: ${activity.duration} hours â€¢ Type: ${activity.type}</span><br>
                ${activity.remarks ? `<span>Remarks: ${activity.remarks}</span>` : ''}
            </div>
            <button type="button" class="remove-btn" onclick="removeActivity(${index})">Ã—</button>
        `;
        activitiesList.appendChild(activityItem);
    });
}

// Submit training form
async function submitTrainingForm(event) {
    event.preventDefault();
    
    const locationData = getLocationData();

    // Add this debug code right before you prepare the formData object:

console.log('=== LOCATION DEBUG ===');
console.log('Training mode:', trainingMode);

if (trainingMode === 'onsite') {
    const countryElement = document.getElementById('countryDropdown');
    const addressElement = document.getElementById('addressField');
    
    console.log('Country element found:', !!countryElement);
    console.log('Address element found:', !!addressElement);
    
    if (countryElement) {
        console.log('Country value:', countryElement.value);
        console.log('Country options count:', countryElement.options.length);
    }
    
    if (addressElement) {
        console.log('Address value:', addressElement.value);
    }
}

const formData = {
    trainingName: courseName,
    trainingDesc: courseDescription,
    jobId: parseInt(jobPosition),
    objectives: selectedObjectives.map(obj => parseInt(obj.id)),
    skills: selectedSkills.map(skill => parseInt(skill.id)),
    isOnlineArrangement: trainingMode === 'online',
    cost: parseFloat(trainingCost) || 0,
    totalDuration: calculatedTotalDuration,
    activities: addedActivities.map(activity => ({
        name: activity.name,
        duration: parseFloat(activity.duration),
        type: activity.type,
        remarks: activity.remarks || ''
    })),
    certifications: addedCertificates.map(cert => ({
        title: cert.title,
        description: cert.description
    }))
};



    try {
        const response = await fetch('/line-manager/training', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });

        const result = await response.json();
        
        if (result.success) {
            // Close modal and refresh training list
            closeModal();
            loadTrainings();
            // Show success notification
        }
    } catch (error) {
        console.error('Error submitting form:', error);
        // Show error notification
    }
}

// Helper function to get activities from form
function getActivitiesFromForm() {
    const activities = [];
    const activityContainer = document.getElementById('activitiesList');
    const activityItems = activityContainer.getElementsByClassName('activity-item');
    
    for (const item of activityItems) {
        activities.push({
            name: item.querySelector('[name="activityName"]').value,
            duration: parseFloat(item.querySelector('[name="activityDuration"]').value),
            type: item.querySelector('[name="activityType"]').value,
            remarks: item.querySelector('[name="activityRemarks"]').value
        });
    }
    
    return activities;
}

// Helper function to get certifications from form
function getCertificationsFromForm() {
    const certifications = [];
    const certContainer = document.getElementById('certificationsList');
    const certItems = certContainer.getElementsByClassName('certificate-item');
    
    for (const item of certItems) {
        certifications.push({
            title: item.querySelector('[name="certTitle"]').value,
            description: item.querySelector('[name="certDescription"]').value
        });
    }
    
    return certifications;
}



        // Close modal function
        function closeAddTrainingModal() {
            document.getElementById('addTrainingModal').classList.remove('show');
        }

      

// Update activities display
function updateActivitiesDisplay() {
    const activitiesList = document.getElementById('activitiesList');
    if (!activitiesList) return;
    
    activitiesList.innerHTML = '';
    
    addedActivities.forEach((activity, index) => {
        const activityItem = document.createElement('div');
        activityItem.className = 'activity-item';
        activityItem.innerHTML = `
            <div class="activity-details">
                <strong>${activity.name}</strong><br>
                <span>Time: ${activity.duration} hours â€¢ Type: ${activity.type}</span><br>
                ${activity.remarks ? `<span>Remarks: ${activity.remarks}</span>` : ''}
            </div>
            <button type="button" class="remove-btn" onclick="removeActivity(${index})">Ã—</button>
        `;
        activitiesList.appendChild(activityItem);
    });
}

// Remove activity
function removeActivity(index) {
    addedActivities.splice(index, 1);
    updateActivitiesDisplay();
    calculateTotalDuration();
}

// Add certificate function
function addCertificate() {
    const certificateTitle = document.getElementById('certificateTitle').value.trim();
    const certificateDescription = document.getElementById('certificateDescription').value.trim();
    
    if (!certificateTitle || !certificateDescription) {
        alert('Please fill in both certificate title and description.');
        return;
    }
    
    const certificate = {
        title: certificateTitle,
        description: certificateDescription
    };
    
    addedCertificates.push(certificate);
    updateCertificatesDisplay();
    
    // Clear fields
    document.getElementById('certificateTitle').value = '';
    document.getElementById('certificateDescription').value = '';
}

// Update certificates display
function updateCertificatesDisplay() {
    const certificatesList = document.getElementById('certificatesList');
    if (!certificatesList) return;
    
    certificatesList.innerHTML = '';
    
    addedCertificates.forEach((certificate, index) => {
        const certificateItem = document.createElement('div');
        certificateItem.className = 'certificate-item';
        certificateItem.innerHTML = `
            <div class="certificate-details">
                <strong>${certificate.title}</strong>
                <span>${certificate.description}</span>
            </div>
            <button type="button" class="remove-btn" onclick="removeCertificate(${index})">Ã—</button>
        `;
        certificatesList.appendChild(certificateItem);
    });
}

// Remove certificate
function removeCertificate(index) {
    addedCertificates.splice(index, 1);
    updateCertificatesDisplay();
}

// Calculate total duration
function calculateTotalDuration() {
    let totalHours = 0;
    
    addedActivities.forEach(activity => {
        totalHours += activity.duration;
    });
    
    const totalHoursRounded = totalHours.toFixed(1);
    const totalDays = (totalHours / 8).toFixed(1);
    
    const totalDurationElement = document.getElementById('totalDuration');
    if (totalDurationElement) {
        totalDurationElement.textContent = `${totalHoursRounded} hours (${totalDays} days)`;
    }
}


// Load training form data from backend
async function loadTrainingFormData() {
    try {
        console.log('Loading training form data...');
        
        // Check if required DOM elements exist before proceeding
        const requiredElements = [
            'jobPositions',
            'objectiveDropdown', 
            'skillDropdown',
            'activityType'
        ];
        
        const missingElements = requiredElements.filter(id => !document.getElementById(id));
        if (missingElements.length > 0) {
            console.error('Missing required DOM elements:', missingElements);
            return;
        }
        
        // Fix the URL - it should match your backend route
        const response = await fetch('/linemanager/training-form-data', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include' // Include session cookies
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error(`HTTP error! status: ${response.status}, response: ${errorText}`);
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            console.log('Data received:', result.data);
            console.log('Metadata:', result.metadata);
            
            // Store all data globally
            allFormData = result.data;
            
            // Log counts for debugging
            console.log(`Found ${result.data.jobPositions.length} job positions`);
            console.log(`Found ${result.data.objectives.length} objectives`);
            console.log(`Found ${result.data.skills.all.length} total skills`);
            console.log(`Found ${result.data.activityTypes.length} activity types`);
            
            // Populate all dropdowns - initially show all data
            populateJobPositions(result.data.jobPositions);
            populateObjectives(result.data.objectives);
            populateSkills(result.data.skills.all);
            populateActivityTypes(result.data.activityTypes);
            
            // Add event listener for job position changes (remove existing first)
            const jobPositionsSelect = document.getElementById('jobPositions');
            if (jobPositionsSelect) {
                // Remove existing listeners to prevent duplicates
                jobPositionsSelect.removeEventListener('change', onJobPositionChange);
                jobPositionsSelect.addEventListener('change', onJobPositionChange);
            }
            
        } else {
            console.error('Failed to load form data:', result.message);
            alert('Failed to load form data: ' + result.message);
        }
    } catch (error) {
        console.error('Error loading form data:', error);
        alert('Error loading form data. Please check your connection and try again.\n\nError: ' + error.message);
    }
}
// ENHANCED: Form submission with better debugging
// ENHANCED: Form submission with better debugging and location data
document.addEventListener('DOMContentLoaded', function() {
    const addTrainingForm = document.getElementById('addTrainingForm');
    if (addTrainingForm) {
        addTrainingForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            console.log('=== FORM SUBMISSION DEBUG ===');
            
            // Collect all form data
            const courseName = document.getElementById('courseName').value.trim();
            const courseDescription = document.getElementById('courseDescription').value.trim();
            const jobPosition = document.getElementById('jobPositions').value;
            const trainingMode = document.getElementById('trainingMode').value;
            const trainingCost = document.getElementById('trainingCost').value;
            
            console.log('Form field values:');
            console.log('- Course Name:', courseName);
            console.log('- Course Description:', courseDescription);
            console.log('- Job Position:', jobPosition);
            console.log('- Training Mode:', trainingMode);
            console.log('- Training Cost:', trainingCost);
            console.log('- Selected Objectives:', selectedObjectives);
            console.log('- Selected Skills:', selectedSkills);
            console.log('- Added Activities:', addedActivities);
            console.log('- Added Certificates:', addedCertificates);
            
            // Enhanced validation with specific error messages
            const errors = [];
            
            // Required fields validation
            if (!courseName) errors.push('Course name is required');
            if (!courseDescription) errors.push('Course description is required');
            if (!jobPosition) errors.push('Job position must be selected');
            if (!trainingMode) errors.push('Training mode must be selected');
            
            // Modified validation for objectives/skills - either one is required
            if (selectedObjectives.length === 0 && selectedSkills.length === 0) {
                errors.push('You must select at least one Objective Focus Area OR one Skill Focus Area');
            }
            
            // Activities validation
            if (addedActivities.length === 0) {
                errors.push('At least one activity must be added');
            }
            
            // Validate activities have required fields
            const invalidActivities = addedActivities.filter(activity => 
                !activity.name || !activity.duration || !activity.type
            );
            
            if (invalidActivities.length > 0) {
                errors.push(`${invalidActivities.length} activities are missing required information`);
            }

            // NEW: Validate location fields for onsite training
            if (trainingMode === 'onsite') {
                const country = document.getElementById('countryDropdown').value;
                const address = document.getElementById('addressField').value.trim();
                
                if (!country) {
                    errors.push('Country must be selected for onsite training');
                }
                
                if (!address) {
                    errors.push('Address must be provided for onsite training');
                }
                
                console.log('Onsite training location validation:', { 
                    country: country || 'MISSING', 
                    address: address || 'MISSING' 
                });
            }
            
            if (errors.length > 0) {
                console.error('Validation errors:', errors);
                alert('Please fix the following errors:\n\n' + errors.join('\n'));
                return;
            }
            
            console.log('All validations passed, preparing form data...');
            
            // Calculate total duration from activities
            const calculatedTotalDuration = addedActivities.reduce((sum, activity) => {
                return sum + (parseFloat(activity.duration) || 0);
            }, 0);
            
            console.log('Calculated total duration:', calculatedTotalDuration);

            // Add this debug code right before you prepare the formData object:
            console.log('=== LOCATION DEBUG ===');
            console.log('Training mode:', trainingMode);

            if (trainingMode === 'onsite') {
                const countryElement = document.getElementById('countryDropdown');
                const addressElement = document.getElementById('addressField');
                
                console.log('Country element found:', !!countryElement);
                console.log('Address element found:', !!addressElement);
                
                if (countryElement) {
                    console.log('Country value:', countryElement.value);
                    console.log('Country options count:', countryElement.options.length);
                }
                
                if (addressElement) {
                    console.log('Address value:', addressElement.value);
                }
            }
            
            // Prepare the final form data object
            const formData = {
                trainingName: courseName,
                trainingDesc: courseDescription,
                jobId: parseInt(jobPosition),
                objectives: selectedObjectives.map(obj => parseInt(obj.id)),
                skills: selectedSkills.map(skill => parseInt(skill.id)),
                isOnlineArrangement: trainingMode === 'online',
                cost: parseFloat(trainingCost) || 0,
                totalDuration: calculatedTotalDuration,
                activities: addedActivities.map(activity => ({
                    name: activity.name,
                    duration: parseFloat(activity.duration),
                    type: activity.type,
                    remarks: activity.remarks || ''
                })),
                certifications: addedCertificates.map(cert => ({
                    title: cert.title,
                    description: cert.description
                }))
            };

            // FIX: Add country and address for onsite training
            if (trainingMode === 'onsite') {
                const countryElement = document.getElementById('countryDropdown');
                const addressElement = document.getElementById('addressField');
                
                formData.country = countryElement ? countryElement.value : null;
                formData.address = addressElement ? addressElement.value.trim() : null;
                
                console.log('Added location data to form:', { 
                    country: formData.country, 
                    address: formData.address 
                });
            } else {
                // Explicitly set to null for online training
                formData.country = null;
                formData.address = null;
            }
            
            console.log('Final form data to submit:', JSON.stringify(formData, null, 2));
            
            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Creating...';
            submitBtn.disabled = true;
            
            // Send to backend
            console.log('Sending request to /linemanager/training...');
            fetch('/linemanager/training', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                return response.json();
            })
            .then(data => {
                console.log('Server response:', data);
                if (data.success) {
                    alert('Training course created successfully!');
                    closeAddTrainingModal();
                    this.reset();
                    // Reset arrays
                    selectedObjectives = [];
                    selectedSkills = [];
                    addedActivities = [];
                    addedCertificates = [];
                    // Clear displays
                    document.getElementById('objectivesList').innerHTML = '';
                    document.getElementById('skillsList').innerHTML = '';
                    document.getElementById('activitiesList').innerHTML = '';
                    document.getElementById('certificatesList').innerHTML = '';
                    document.getElementById('totalDuration').textContent = '0';
                    
                    // Reset location fields
                    document.getElementById('locationFields').classList.remove('show');
                    
                    // Optionally refresh the training courses display
                    // loadTrainingCourses();
                } else {
                    console.error('Server returned error:', data);
                    alert('Error creating training course:\n\n' + (data.message || 'Unknown error occurred'));
                }
            })
            .catch(error => {
                console.error('Network/Parse Error:', error);
                alert('Error creating training course. Please check your connection and try again.\n\nError: ' + error.message);
            })
            .finally(() => {
                // Reset button state
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });
    }
});

// Show add activity type modal
function showAddActivityTypeModal() {
    document.getElementById('newActivityTypeName').value = '';
    document.getElementById('addActivityTypeModal').classList.add('show');
}

// Close add activity type modal
function closeAddActivityTypeModal() {
    document.getElementById('addActivityTypeModal').classList.remove('show');
}

// Save new activity type
async function saveNewActivityType() {
    const activityTypeName = document.getElementById('newActivityTypeName').value.trim();
    
    if (!activityTypeName) {
        alert('Please enter an activity type name.');
        return;
    }

    // Check if activity type already exists
    const activityTypeSelect = document.getElementById('activityType');
    const existingOptions = Array.from(activityTypeSelect.options);
    const exists = existingOptions.some(option => 
        option.textContent.toLowerCase() === activityTypeName.toLowerCase()
    );

    if (exists) {
        alert('This activity type already exists.');
        return;
    }

    // Show loading state
    const saveBtn = document.querySelector('#addActivityTypeModal .btn-primary');
    const originalText = saveBtn.textContent;
    saveBtn.textContent = 'Adding...';
    saveBtn.disabled = true;

    try {
        const response = await fetch('/linemanager/activity-type', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                activityType: activityTypeName
            })
        });

        const result = await response.json();

        if (result.success) {
            // Add the new option to the dropdown
            const newOption = document.createElement('option');
            newOption.value = result.data.activityType;
            newOption.textContent = result.data.activityType;
            newOption.setAttribute('data-id', result.data.activityTypeId);
            activityTypeSelect.appendChild(newOption);

            // Select the newly added option
            activityTypeSelect.value = result.data.activityType;

            // Close modal
            closeAddActivityTypeModal();

            // Show success message
            showSuccessToast('Activity type added successfully!');
        } else {
            alert('Error adding activity type: ' + result.message);
        }
    } catch (error) {
        console.error('Error adding activity type:', error);
        alert('Error adding activity type. Please try again.');
    } finally {
        // Reset button state
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
    }
}

// Helper function to show success toast (optional)
function showSuccessToast(message) {
    // Create a simple toast notification
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #10b981;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 30000;
        font-size: 14px;
        font-weight: 500;
        animation: slideInRight 0.3s ease;
    `;
    toast.textContent = message;
    
    // Add animation keyframes
    if (!document.getElementById('toast-styles')) {
        const style = document.createElement('style');
        style.id = 'toast-styles';
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(toast);
    
    // Remove toast after 3 seconds
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// Close mini modal when clicking outside
document.addEventListener('click', function(event) {
    const miniModal = document.getElementById('addActivityTypeModal');
    const miniModalContent = miniModal.querySelector('.mini-modal-content');
    
    if (miniModal.classList.contains('show') && 
        !miniModalContent.contains(event.target) && 
        !event.target.classList.contains('add-type-btn')) {
        closeAddActivityTypeModal();
    }
});

// Handle Enter key in the activity type input
document.addEventListener('DOMContentLoaded', function() {
    const newActivityTypeInput = document.getElementById('newActivityTypeName');
    if (newActivityTypeInput) {
        newActivityTypeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveNewActivityType();
            }
        });
    }
});

        // Function to fetch countries from REST API
        async function fetchCountries() {
            try {
                console.log('Fetching countries from API...');
                const response = await fetch('https://restcountries.com/v3.1/all?fields=name,cca2');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const countries = await response.json();
                
                // Sort countries alphabetically by common name
                countriesData = countries
                    .map(country => ({
                        code: country.cca2,
                        name: country.name.common
                    }))
                    .sort((a, b) => a.name.localeCompare(b.name));
                
                console.log(`Loaded ${countriesData.length} countries`);
                populateCountryDropdown();
                
            } catch (error) {
                console.error('Error fetching countries:', error);
                // Fallback to basic country list
                loadFallbackCountries();
            }
        }

        // Function to populate the country dropdown
        function populateCountryDropdown() {
            const countryDropdown = document.getElementById('countryDropdown');
            
            // Clear existing options
            countryDropdown.innerHTML = '<option value="">Select Country</option>';
            
            // Add countries to dropdown
            countriesData.forEach(country => {
                const option = document.createElement('option');
                option.value = country.code;
                option.textContent = country.name;
                countryDropdown.appendChild(option);
            });
        }

        // Fallback country list in case API fails
        function loadFallbackCountries() {
            const fallbackCountries = [
                { code: 'PH', name: 'Philippines' },
                { code: 'US', name: 'United States' },
                { code: 'GB', name: 'United Kingdom' },
                { code: 'CA', name: 'Canada' },
                { code: 'AU', name: 'Australia' },
                { code: 'SG', name: 'Singapore' },
                { code: 'MY', name: 'Malaysia' },
                { code: 'JP', name: 'Japan' },
                { code: 'KR', name: 'South Korea' },
                { code: 'CN', name: 'China' },
                { code: 'IN', name: 'India' },
                { code: 'DE', name: 'Germany' },
                { code: 'FR', name: 'France' },
                { code: 'IT', name: 'Italy' },
                { code: 'ES', name: 'Spain' }
            ].sort((a, b) => a.name.localeCompare(b.name));
            
            countriesData = fallbackCountries;
            populateCountryDropdown();
        }

        // Function to toggle location fields based on training mode
        function toggleLocationFields() {
            const trainingMode = document.getElementById('trainingMode').value;
            const locationFields = document.getElementById('locationFields');
            
            if (trainingMode === 'onsite') {
                locationFields.classList.add('show');
                // Make fields required when onsite is selected
                document.getElementById('countryDropdown').required = true;
                document.getElementById('addressField').required = true;
            } else {
                locationFields.classList.remove('show');
                // Remove required when online is selected
                document.getElementById('countryDropdown').required = false;
                document.getElementById('addressField').required = false;
                // Clear values
                document.getElementById('countryDropdown').value = '';
                document.getElementById('addressField').value = '';
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Load countries when page loads
            fetchCountries();
            
            // Add event listener to training mode dropdown
            const trainingModeSelect = document.getElementById('trainingMode');
            if (trainingModeSelect) {
                trainingModeSelect.addEventListener('change', toggleLocationFields);
            }
        });

        // Updated form validation function (add this to your existing validation)
        function validateLocationFields() {
            const trainingMode = document.getElementById('trainingMode').value;
            const errors = [];
            
            if (trainingMode === 'onsite') {
                const country = document.getElementById('countryDropdown').value;
                const address = document.getElementById('addressField').value.trim();
                
                if (!country) {
                    errors.push('Country is required for onsite training');
                }
                
                if (!address) {
                    errors.push('Address is required for onsite training');
                }
            }
            
            return errors;
        }

        // Function to get location data for form submission
        function getLocationData() {
            const trainingMode = document.getElementById('trainingMode').value;
            
            if (trainingMode === 'onsite') {
                return {
                    isOnlineArrangement: false,
                    country: document.getElementById('countryDropdown').value,
                    address: document.getElementById('addressField').value.trim()
                };
            } else {
                return {
                    isOnlineArrangement: true,
                    country: null,
                    address: null
                };
            }
        }

        // Demo function to show how data would be collected
        function showFormData() {
            const locationData = getLocationData();
            const validationErrors = validateLocationFields();
            
            console.log('Location Data:', locationData);
            console.log('Validation Errors:', validationErrors);
            
            alert('Check console for location data and validation results');
        }

function populateJobPositions(jobPositions) {
    const jobPositionsSelect = document.getElementById('jobPositions');
    // Clear existing options except the first one
    jobPositionsSelect.innerHTML = '<option value="">Select applicable positions</option>';
    
    console.log('Populating job positions:', jobPositions.length, 'positions found');
    
    jobPositions.forEach(job => {
        const option = document.createElement('option');
        option.value = job.jobId;  // Use jobId as value
        option.textContent = job.jobTitle;  // Use jobTitle for display
        option.setAttribute('data-job-title', job.jobTitle);
        option.setAttribute('data-job-description', job.jobDescrpt);
        option.setAttribute('data-department', job.departmentId);
        jobPositionsSelect.appendChild(option);
    });
}

// Populate objectives dropdown with job title prefix - now properly linked
function populateObjectives(objectives) {
    const objectiveDropdown = document.getElementById('objectiveDropdown');
    objectiveDropdown.innerHTML = ''; // Clear existing options

    if (!objectives || objectives.length === 0) {
        // If no objectives found
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Objectives are being fetched when set with an employee in Objective Settings. Please assign objectives to the employee first.';
        objectiveDropdown.appendChild(option);
        return;
    }

    // Sort objectives by staffName alphabetically
    objectives.sort((a, b) => {
        const nameA = a.staffName.toUpperCase();
        const nameB = b.staffName.toUpperCase();
        return nameA.localeCompare(nameB);
    });

    // Default first option
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Select objective area';
    objectiveDropdown.appendChild(defaultOption);

    // Populate the dropdown with sorted objectives
    objectives.forEach(obj => {
        const option = document.createElement('option');
        option.value = obj.objectiveId;
        option.textContent = `${obj.staffName} - ${obj.objectiveDescrpt}`;
        option.setAttribute('data-objective-desc', obj.objectiveDescrpt);
        objectiveDropdown.appendChild(option);
    });
}

// Populate skills dropdown with skill type and name
function populateSkills(skills) {
    const skillDropdown = document.getElementById('skillDropdown');
    skillDropdown.innerHTML = ''; // Clear existing options

    if (!skills || skills.length === 0) {
        // If no skills found
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No skills available. Please coordinate with HR to set up the skills for the respective job position.';
        skillDropdown.appendChild(option);
        return;
    }

    // Default first option
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Select skill area';
    skillDropdown.appendChild(defaultOption);

    // Group skills by type
    const groupedSkills = skills.reduce((acc, skill) => {
        if (!acc[skill.jobReqSkillType]) {
            acc[skill.jobReqSkillType] = [];
        }
        acc[skill.jobReqSkillType].push(skill);
        return acc;
    }, {});

    // Create optgroups for each skill type
    Object.entries(groupedSkills).forEach(([type, typeSkills]) => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = `${type} Skills`;

        typeSkills.forEach(skill => {
            const option = document.createElement('option');
            option.value = skill.jobReqSkillId;
            option.textContent = skill.jobReqSkillName;
            option.setAttribute('data-job-id', skill.jobId);
            option.setAttribute('data-job-title', skill.jobTitle);
            option.setAttribute('data-type', skill.jobReqSkillType);
            option.setAttribute('data-name', skill.jobReqSkillName);
            optgroup.appendChild(option);
        });

        skillDropdown.appendChild(optgroup);
    });
}


// Function to populate activity types
function populateActivityTypes(activityTypes) {
    const activityTypeSelect = document.getElementById('activityType');
    // Clear existing options except the first one
    activityTypeSelect.innerHTML = '<option value="">Select type</option>';
    
    activityTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type.label;
        option.textContent = type.label;
        option.setAttribute('data-id', type.id);
        activityTypeSelect.appendChild(option);
    });
}

// UPDATE your onJobPositionChange function to populate suggested trainings
function onJobPositionChange() {
    const jobPositionsSelect = document.getElementById('jobPositions');
    const selectedJobId = jobPositionsSelect.value;
    const suggestedTrainingsSelect = document.getElementById('suggestedTrainings');
    
    console.log('Job position changed to:', selectedJobId);
    
    // Clear current selections
    selectedObjectives = [];
    selectedSkills = [];
    updateObjectivesDisplay();
    updateSkillsDisplay();
    
    // Clear and reset suggested trainings dropdown
    suggestedTrainingsSelect.innerHTML = '';
    
    if (!selectedJobId) {
        // No job selected
        suggestedTrainingsSelect.disabled = true;
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Please select a job position first';
        suggestedTrainingsSelect.appendChild(option);
        
        // Reset to show all objectives and skills
        console.log('No job selected, showing all data');
        populateObjectives(allFormData.objectives);
        populateSkills(allFormData.skills.all);
        return;
    }
    
    // Enable suggested trainings dropdown
    suggestedTrainingsSelect.disabled = false;
    
    // Add default option
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Select from suggested trainings (optional)';
    suggestedTrainingsSelect.appendChild(defaultOption);
    
    // Add static training templates
    const staticTrainings = [
        { value: 'leadership', text: 'Leadership Development Program' },
        { value: 'safety', text: 'Safety and Compliance Training' },
        { value: 'communication', text: 'Communication Excellence' },
        { value: 'timemanagement', text: 'Time Management Skills' },
        { value: 'customerservice', text: 'Customer Service Training' },
        { value: 'projectmanagement', text: 'Project Management Fundamentals' },
        { value: 'dataanalysis', text: 'Data Analysis and Reporting' },
        { value: 'teambuilding', text: 'Team Building Workshop' },
        { value: 'cybersecurity', text: 'Cybersecurity Awareness' },
        { value: 'diversity', text: 'Diversity and Inclusion Training' }
    ];
    
    // Add optgroup for static templates
    const staticOptgroup = document.createElement('optgroup');
    staticOptgroup.label = 'General Training Templates';
    
    staticTrainings.forEach(training => {
        const option = document.createElement('option');
        option.value = training.value;
        option.textContent = training.text;
        staticOptgroup.appendChild(option);
    });
    
    suggestedTrainingsSelect.appendChild(staticOptgroup);
    
    // Filter and add database trainings for this specific job
    const filteredTrainings = allSuggestedTrainings.filter(training => 
        training.jobId === parseInt(selectedJobId)
    );
    
    console.log(`Found ${filteredTrainings.length} suggested trainings for job ID ${selectedJobId}`);
    
    if (filteredTrainings.length > 0) {
        // Add optgroup for database trainings
        const dbOptgroup = document.createElement('optgroup');
        dbOptgroup.label = `Existing Trainings for ${jobPositionsSelect.options[jobPositionsSelect.selectedIndex].text}`;
        
        filteredTrainings.forEach(training => {
            const option = document.createElement('option');
            option.value = `db_${training.id}`;
            option.textContent = training.name;
            option.setAttribute('data-name', training.name);
            option.setAttribute('data-description', training.description);
            option.setAttribute('data-job-title', training.jobTitle);
            option.setAttribute('data-department', training.department);
            option.setAttribute('data-mode', training.mode);
            option.setAttribute('data-cost', training.cost);
            option.setAttribute('data-duration', training.duration);
            option.setAttribute('data-country', training.location?.country || '');
            option.setAttribute('data-address', training.location?.address || '');
            dbOptgroup.appendChild(option);
        });
        
        suggestedTrainingsSelect.appendChild(dbOptgroup);
    }
    
    // Continue with existing job position change logic for objectives and skills
    const filteredObjectives = allFormData.objectives.filter(obj => 
        obj.jobId === parseInt(selectedJobId)
    );
    
    const filteredSkills = allFormData.skills.all.filter(skill => 
        skill.jobId === parseInt(selectedJobId)
    );
    
    console.log(`Job ID ${selectedJobId} selected:`);
    console.log(`- Found ${filteredObjectives.length} matching objectives`);
    console.log(`- Found ${filteredSkills.length} matching skills`);
    console.log(`- Found ${filteredTrainings.length} matching suggested trainings`);
    
    // Update dropdowns with filtered data
    populateObjectives(filteredObjectives);
    populateSkills(filteredSkills);
}
function openEmployeeModal(employeeId) {
    console.log('ðŸ” === OPENING EMPLOYEE MODAL ===');
    console.log('Requested employee ID:', employeeId, '(type:', typeof employeeId, ')');
    
    // Ensure data is loaded
    if (!window.employeeAssignmentsData || window.employeeAssignmentsData.length === 0) {
        console.error('âŒ No assignment data available');
        alert('Error: Assignment data not loaded. Please refresh the page.');
        return;
    }
    
    console.log('ðŸ“Š Available data:', window.employeeAssignmentsData.length, 'assignments');
    
    // Get all assignments for this employee using loose equality to handle type differences
    const employeeAssignments = window.employeeAssignmentsData.filter(assignment => {
        const match = assignment.employeeId == employeeId; // Use == for type coercion
        if (match) {
            console.log(`âœ… Match found: ${assignment.employeeName} - ${assignment.trainingTitle}`);
        }
        return match;
    });
    
    console.log(`ðŸŽ¯ Found ${employeeAssignments.length} assignments for employee ${employeeId}`);
    
    if (employeeAssignments.length === 0) {
        console.error('âŒ No assignments found for employee:', employeeId);
        
        // Show available IDs for debugging
        const availableIds = [...new Set(window.employeeAssignmentsData.map(a => a.employeeId))];
        console.log('Available employee IDs:', availableIds);
        
        alert(`No training data found for employee ID: ${employeeId}\n\nAvailable IDs: ${availableIds.join(', ')}`);
        return;
    }
    
    // Get employee info from first assignment
    const firstAssignment = employeeAssignments[0];
    console.log('ðŸ‘¤ Employee info:', {
        name: firstAssignment.employeeName,
        email: firstAssignment.employeeEmail,
        jobTitle: firstAssignment.jobTitle
    });
    
    // Calculate statistics
    const stats = {
        inProgress: employeeAssignments.filter(a => a.status === 'in-progress').length,
        completed: employeeAssignments.filter(a => a.status === 'completed').length,
        overdue: employeeAssignments.filter(a => a.status === 'overdue').length
    };
    
    console.log('ðŸ“Š Training stats:', stats);
    
    // Update modal content
    try {
        document.getElementById('employeeName').textContent = firstAssignment.employeeName;
        document.getElementById('employeeJobRole').textContent = firstAssignment.jobTitle;
        document.getElementById('employeeEmail').textContent = firstAssignment.employeeEmail;
        document.getElementById('employeeAvatar').textContent = generateAvatar(firstAssignment.employeeName);
        
        document.getElementById('inProgressCount').textContent = stats.inProgress;
        document.getElementById('completedCount').textContent = stats.completed;
        document.getElementById('overdueCount').textContent = stats.overdue;
        
        // Update training list
        updateEmployeeTrainingList(employeeAssignments);
        
        // Show modal
        document.getElementById('employeeTrainingModal').classList.add('show');
        console.log('âœ… Modal opened successfully');
        
    } catch (error) {
        console.error('âŒ Error updating modal:', error);
        alert('Error updating modal content: ' + error.message);
    }
}

// Function to get employee assignments from the server data
function getEmployeeAssignments(employeeId) {
    // Get assignments data that was passed from the server
    const serverAssignments = window.employeeAssignmentsData || [];
    
    // Filter assignments for the specific employee
    const employeeAssignments = serverAssignments.filter(assignment => 
        assignment.employeeId === employeeId || 
        assignment.employeeId === employeeId.toString()
    );
    
    console.log(`Found ${employeeAssignments.length} assignments for employee ${employeeId}`);
    return employeeAssignments;
}

// Function to calculate employee statistics
function calculateEmployeeStats(assignments) {
    const stats = {
        inProgress: 0,
        completed: 0,
        overdue: 0
    };

    assignments.forEach(assignment => {
        switch(assignment.status) {
            case 'in-progress':
                stats.inProgress++;
                break;
            case 'completed':
                stats.completed++;
                break;
            case 'overdue':
            case 'not-started':
                // Check if it's actually overdue
                if (assignment.isOverdue || (assignment.dueDate && new Date(assignment.dueDate) < new Date())) {
                    stats.overdue++;
                }
                break;
        }
    });

    return stats;
}

// Function to generate avatar initials
function generateAvatar(name) {
    if (!name) return 'NA';
    
    const nameParts = name.split(' ');
    if (nameParts.length >= 2) {
        return nameParts[0].charAt(0).toUpperCase() + nameParts[1].charAt(0).toUpperCase();
    } else {
        return nameParts[0].charAt(0).toUpperCase() + (nameParts[0].charAt(1) || '').toUpperCase();
    }
}

function updateEmployeeTrainingList(assignments) {
    const trainingList = document.getElementById('employeeTrainingList');
    if (!trainingList) {
        console.error('Training list element not found');
        return;
    }
    
    trainingList.innerHTML = '';
    
    console.log('ðŸ“‹ Updating training list with', assignments.length, 'assignments');
    
    assignments.forEach((assignment, index) => {
        console.log(`${index + 1}. ${assignment.trainingTitle} (${assignment.status})`);
        
        const trainingItem = document.createElement('div');
        trainingItem.className = 'training-progress-item';
        
        const badges = [];
        if (assignment.trainingMode) badges.push(assignment.trainingMode);
        if (assignment.isOverdue) badges.push('overdue');
        
        const badgesHTML = badges.map(badge => {
            const badgeClass = badge === 'online' ? 'online' : badge === 'onsite' ? 'onsite' : 'required';
            const badgeText = badge.charAt(0).toUpperCase() + badge.slice(1);
            return `<span class="course-badge ${badgeClass}">${badgeText}</span>`;
        }).join('');
        
        const startDate = assignment.startDate ? new Date(assignment.startDate).toLocaleDateString() : 'Not started';
        const dueDate = assignment.dueDate ? new Date(assignment.dueDate).toLocaleDateString() : 'No due date';
        
        let metaInfo = `Started: ${startDate}`;
        if (assignment.dueDate) metaInfo += ` â€¢ Due: ${dueDate}`;
        if (assignment.trainingDuration) metaInfo += ` â€¢ Duration: ${assignment.trainingDuration} hours`;
        
        trainingItem.innerHTML = `
            <div class="training-progress-header">
                <h4 class="training-title">${assignment.trainingTitle || 'Untitled Training'}</h4>
            </div>
            <div class="training-description">${assignment.trainingDescription || 'No description available'}</div>
            <div class="training-meta">${metaInfo}</div>
            <div class="training-badges" style="margin: 10px 0;">${badgesHTML}</div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill ${assignment.status}" style="width: ${assignment.progress || 0}%"></div>
            </div>
            <div class="progress-text">
                <span class="progress-percentage">${assignment.progress || 0}% Complete</span>
                <span class="progress-status ${assignment.status}">${formatStatus(assignment.status)}</span>
            </div>
        `;
        
        trainingList.appendChild(trainingItem);
    });
    
    console.log('âœ… Training list updated successfully');
}

// Helper function to format status text
function formatStatus(status) {
    switch(status) {
        case 'in-progress':
            return 'In Progress';
        case 'completed':
            return 'Completed';
        case 'not-started':
            return 'Not Started';
        case 'overdue':
            return 'Overdue';
        case 'no-training':
            return 'No Training';
        default:
            return status.charAt(0).toUpperCase() + status.slice(1);
    }
}

// Initialize employee assignments data when page loads
function initializeEmployeeAssignments() {
    console.log('ðŸ“¥ Initializing employee assignments data...');
    
    <% if (typeof allAssignments !== 'undefined' && allAssignments) { %>
        try {
            window.employeeAssignmentsData = <%- JSON.stringify(allAssignments) %>;
            console.log('âœ… Successfully loaded allAssignments:', window.employeeAssignmentsData.length, 'assignments');
            
            if (window.employeeAssignmentsData.length > 0) {
                console.log('ðŸ“‹ Sample assignment structure:', window.employeeAssignmentsData[0]);
                
                // Group by employee to verify multiple trainings
                const grouped = {};
                window.employeeAssignmentsData.forEach(assignment => {
                    if (!grouped[assignment.employeeId]) {
                        grouped[assignment.employeeId] = [];
                    }
                    grouped[assignment.employeeId].push(assignment);
                });
                
                console.log('ðŸ‘¥ Employee groups found:', Object.keys(grouped).length);
                
                // Find employees with multiple trainings
                const multipleTrainings = Object.entries(grouped).filter(([_, assignments]) => assignments.length > 1);
                console.log('ðŸŽ¯ Employees with multiple trainings:', multipleTrainings.length);
                
                if (multipleTrainings.length > 0) {
                    console.log('âœ… MULTIPLE TRAINING EMPLOYEES:');
                    multipleTrainings.forEach(([empId, assignments]) => {
                        console.log(`  - Employee ${empId} (${assignments[0].employeeName}): ${assignments.length} trainings`);
                        assignments.forEach((assignment, index) => {
                            console.log(`    ${index + 1}. ${assignment.trainingTitle}`);
                        });
                    });
                } else {
                    console.log('âŒ No employees with multiple trainings found in data');
                }
            }
        } catch (error) {
            console.error('âŒ Error loading allAssignments:', error);
            window.employeeAssignmentsData = [];
        }
    <% } else { %>
        console.log('âŒ No allAssignments data available from server');
        window.employeeAssignmentsData = [];
    <% } %>
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeEmployeeAssignments();
});

        function closeEmployeeTrainingModal() {
            document.getElementById('employeeTrainingModal').classList.remove('show');
        }

        function assignNewTraining() {
            // This would typically open another modal or navigate to assignment page
            alert('Assign New Training functionality would be implemented here.');
        }

        function visitPerformanceTracker() {
            // Get current employee name for context
            const employeeName = document.getElementById('employeeName').textContent;
            
            // This would typically navigate to the performance tracker page
            // You can customize this URL based on your routing structure
            const performanceTrackerUrl = '/performance-tracker'; // or '/employee/performance-tracker'
            
            // Option 1: Navigate to performance tracker
            window.location.href = performanceTrackerUrl;
            
            // Option 2: Open in new tab (uncomment if preferred)
            // window.open(performanceTrackerUrl, '_blank');
            
            // Option 3: For demonstration - show alert (remove in production)
            // alert(`Navigating to Performance Tracker for ${employeeName}...`);
        }

        // Toggle active class for sidebar links
        document.querySelectorAll('.sidebar ul li a').forEach(link => {
            link.addEventListener('click', function() {
                document.querySelectorAll('.sidebar ul li a').forEach(link => link.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Toggle collapsible content
        document.querySelectorAll('.collapsible-header').forEach(header => {
            header.addEventListener('click', function() {
                var content = this.nextElementSibling;
                if (content.style.display === 'block') {
                    content.style.display = 'none';
                } else {
                    // Hide all other collapsible contents
                    document.querySelectorAll('.collapsible-content').forEach(item => {
                        if (item !== content) {
                            item.style.display = 'none';
                        }
                    });
                    content.style.display = 'block';
                }
            });
        });


    </script>
</body>
</html>